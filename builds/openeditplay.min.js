!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(0,function(){"use strict";function t(t){for(var e=arguments,n=[],r=1;r<arguments.length;r++)n[r-1]=e[r];if(!t&&(console.warn.apply(console,["Assert"].concat(n,["\norigin",wt.get()])),console.log((new Error).stack),!window.force))throw new Error(n.join("; "))}function e(t,e){function n(){this.constructor=t}Et(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function n(t,e){for(var n=0,r=t.length,i=e.priority;n<r;){var o=n+r>>>1;t[o].priority<i?n=o+1:r=o}return n}function r(){At=null}function i(){return At}function o(t){t!==At&&(At=t,setTimeout(r,0))}function a(e,n){t(At,"Change without origin!");var r=e+(n&&n.threeLetterType);if(Mt.enter(r),!n.id)return Mt.leave(r);var i={type:e,reference:n,id:n.id,external:Rt,origin:At};e===Lt.setPropertyValue?i.value=n._value:e===Lt.move?i.parent=n._parent:e===Lt.addSerializableToTree&&(i.parent=n._parent,delete i.id);var o=At;xt.dispatch(Pt.GLOBAL_CHANGE_OCCURED,i),At!==o&&(At=o),Mt.leave(r)}function s(t){p("external",function(){if(Rt)return t();Rt=!0,t(),Rt=!1})}function p(t,e){var n=t;o(t),e(),o(n)}function l(t,e){void 0===t&&(t="???"),void 0===e&&(e=16);for(var n=t,r=e-1;r>=0;--r)n+=Bt[jt()*Ut|0];return n}function c(e){var n=e.name,r=void 0===n?"":n,i=e.validators,o=void 0===i?{default:function(t){return t}}:i,a=e.toJSON,s=void 0===a?function(t){return t}:a,p=e.fromJSON,l=void 0===p?function(t){return t}:p,c=e.clone,u=void 0===c?function(t){return t}:c,d=e.equal,f=void 0===d?function(t,e){return t===e}:d;t(r,"name missing from property type"),t("function"==typeof o.default,"default validator missing from property type: "+r),t("function"==typeof s,"invalid toJSON for property type: "+r),t("function"==typeof l,"invalid fromJSON for property type: "+r);var y={name:r,validators:o,toJSON:s,fromJSON:l,clone:u,equal:f},m=function(){return y};return Object.keys(o).forEach(function(t){m[t]=h(t,o[t]),o[t]=m[t]}),m}function h(t,e){var n=function(){for(var n=arguments,r=[],i=0;i<arguments.length;i++)r[i]=n[i];var o=r,a=[null].concat(r);return{validatorName:t,validate:function(t){return a[0]=t,e.apply(null,a)},parameters:o}};return n.validatorName=t,n.validate=e,n}function u(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function d(t){var e=t.toString(16);return 1==e.length?"0"+e:e}function f(t,e,n){return"#"+d(t)+d(e)+d(n)}function y(t){if(isNaN(t)||t===1/0||t===-1/0)throw new Error("Invalid float: "+t)}function m(t,e){for(var n in e)t.setAttributeNS(ue,n,e[n])}function v(t,e){for(var n in e)t.dataset[n]=e[n]}function g(t){document.body.style.filter="contrast(70%) brightness(130%) saturate(200%) sepia(40%) hue-rotate(300deg)";var e=be("div",t,{style:{position:"fixed",display:"inline-block","max-width":"600%",top:"20%",width:"100%",padding:"40px 10%","font-size":"20px","z-index":"100000",color:"white",background:"#0c0c0c","text-align":"center","user-select":"auto !important","box-sizing":"border-box"}});pe(document.body,e)}function C(t){return Ie||(Ie=Pe.autoDetectRenderer({view:t,autoResize:!0,antialias:!0})),Ie}function T(t){t.children.sort(_)}function _(t,e){return t.y<e.y?-1:t.y>e.y?1:0}function w(t){return Ne[t]}function E(t,e){if(!Ne[e]){var n=t.getLocalBounds(),r={x:-n.x/n.width,y:-n.y/n.height};Ne[e]={texture:Ie.generateTexture(t,Pe.SCALE_MODES.LINEAR,2),anchor:r,graphicsObject:t,containsPoint:function(e){for(var n=0;n<t.graphicsData.length;++n){var r=t.graphicsData[n];if(r.fill&&(r.shape&&r.shape.contains(e.x,e.y)))return!0}return!1}}}return Ne[e]}function b(t,e,n){var r=t.getLocalBounds(),i=t.texture.baseTexture.source,o=t.toLocal(e,n),a=(o.x-r.x)/r.width,s=(o.y-r.y)/r.height;return!(a<0||a>1||s<0||s>1)&&(xe.width=xe.width,Ae.drawImage(i,i.width*a|0,i.height*s|0,1,1,0,0,1,1),Ae.getImageData(0,0,1,1).data[3]>30)}function P(){var t=document.createElement("canvas");t.width=1,t.height=10;var e=t.getContext("2d"),n=e.createLinearGradient(0,0,0,8);return n.addColorStop(0,"#5c77ff"),n.addColorStop(1,"#90c9f6"),e.fillStyle=n,e.fillRect(0,0,1,10),t}function S(t){t.canvas&&t.backgroundGradient&&(t.backgroundGradient.width=t.canvas.width,t.backgroundGradient.height=t.canvas.height)}function I(e,n){t(!e._p2World),e._p2World=new Re.World({gravity:[0,9.81]}),e._p2World.sleepMode=Re.World.BODY_SLEEPING}function N(t,e){t._p2World.step(Fe,e,5)}function x(t){t._p2World&&t._p2World.clear(),delete t._p2World,delete t._p2Materials}function A(t){return t._p2World}function O(t,e){t._p2World.addBody(e)}function D(t,e){t._p2World.removeBody(e)}function L(t,e){t._p2Materials||(t._p2Materials={});var n=t._p2Materials;e=Object.assign({},Ge,e);var r=[e.friction,e.restitution,e.stiffness,e.relaxation,e.frictionStiffness,e.frictionRelaxation,e.surfaceVelocity].join(";");if(n[r])return n[r];var i=new Re.Material;i.options=e,n[r]=i;for(var o in n){var a=n[o],s=i.options,p=a.options,l=new Re.ContactMaterial(i,a,{friction:Math.min(s.friction,p.friction),restitution:Math.max(s.restitution,p.restitution),stiffness:Math.min(s.stiffness,p.stiffness),relaxation:(s.relaxation+p.relaxation)/2,frictionStiffness:Math.min(s.frictionStiffness,p.frictionStiffness),frictionRelaxation:(s.frictionRelaxation+p.frictionRelaxation)/2,surfaceVelocity:Math.max(s.surfaceVelocity,p.surfaceVelocity)});t._p2World.addContactMaterial(l)}return i}function M(t){return je[t]||!1}function R(t){return Ve.push(t),function(){return Ve.splice(Ve.indexOf(t),1)}}function k(t,e){var n=function(n){for(var r=n.pageX,i=n.pageY,o=t;null!=o;)r-=o.offsetLeft,i-=o.offsetTop,o=o.offsetParent;t._mx=r,t._my=i,e&&e(new Xt(r,i),n)};return t.addEventListener("mousemove",n),function(){return t.removeEventListener("mousemove",n)}}function F(t,e){var n=function(n){0===n.button&&("number"==typeof t._mx?e(new Xt(t._mx,t._my),n):e(null,n))};return t.addEventListener("mousedown",n),function(){return t.removeEventListener("mousedown",n)}}function G(t,e){var n=function(n){"number"==typeof t._mx?e(new Xt(t._mx,t._my),n):e(null,n)};return document.body.addEventListener("mouseup",n),function(){return document.body.removeEventListener("mouseup",n)}}function B(t,e){"keydown"===t?window.onkeydown({keyCode:e}):"keyup"===t&&window.onkeyup({keyCode:e})}function U(t,e){void 0===e&&(e=1),["Event performance snapshot","Event perSecond snapshot"].includes(t)||(Xe[t]=(Xe[t]||0)+e)}function j(t){Ze[t]=qe.now()}function V(t){var e=qe.now()-Ze[t];Ye[t]?Ye[t]+=e:Ye[t]=e}function J(t){xt.listen(Pt.GLOBAL_SCENE_CREATED,t),Ke&&t(Ke)}function z(e){void 0!==on[e.id]&&t(!1,"Serializable id clash "+e.id),on[e.id]=e}function W(t){return on[t]||null}function H(t){delete on[t]}function q(t,e,n,r){void 0===r&&(r=0);var i=null,o=t.getParentPrototype();i=o?q(o,e,n,r+1):{};var a=t.getChildren("cda");n&&(a=a.filter(n));for(var s=null,p=0;p<a.length;++p){s=a[p],i[s.componentId]||(i[s.componentId]={ownComponentData:null,componentClass:s.componentClass,componentId:s.componentId,propertyHash:{},threeLetterType:"icd",generatedForPrototype:e}),0===r&&(i[s.componentId].ownComponentData=s);for(var l=i[s.componentId].propertyHash,c=s.getChildren("prp"),h=null,u=0;u<c.length;++u)h=c[u],l[h.name]=0===r?h:h.clone(!0)}return i}function Y(t,e){return t.componentClass.componentName.localeCompare(e.componentClass.componentName)}function Z(t,e){return void 0===e&&(e=""),cn._propertyTypesByName.name.createProperty({value:e,predefinedId:t+"_n"})}function X(t){var e=new rn("Transform",t+"_t"),n=e.componentClass._propertyTypesByName.position.createProperty({value:new Xt(0,0),predefinedId:t+"_p"});e.addChild(n);var r=e.componentClass._propertyTypesByName.scale.createProperty({value:new Xt(1,1),predefinedId:t+"_s"});e.addChild(r);var i=e.componentClass._propertyTypesByName.angle.createProperty({value:0,predefinedId:t+"_a"});return e.addChild(i),e}function K(t){return t.getGlobalPosition().toArray().map(function(t){return t*mn})}function Q(t){return Xt.fromArray(t).multiplyScalar(vn)}function $(t){return t>.5?(1-t)/.5:t>.2?1:5*t}function tt(t){return t>.5?1:.5+t}function et(t,e,n){void 0===e&&(e=0),void 0===n&&(n={r:255,g:255,b:255,a:1});var r=t+"-"+e+"-"+n.r+"-"+n.g+"-"+n.b+"-"+n.a;if(!wn[r]){var i=document.createElement("canvas");i.width=t,i.height=t;var o=i.getContext("2d"),a=o.createRadialGradient(.5*t,.5*t,.5*t*e,.5*t,.5*t,.5*t);a.addColorStop(0,"rgba("+n.r+", "+n.g+", "+n.b+", "+n.a+")"),a.addColorStop(1,"rgba("+n.r+", "+n.g+", "+n.b+", 0)"),o.fillStyle=a,o.fillRect(0,0,t,t),wn[r]=Se.Texture.fromCanvas(i)}return wn[r]}function nt(t,e){return t>e?e:t<-e?-e:t}function rt(t,e){var n=e-t;return n>Math.PI?e-2*Math.PI:n<-Math.PI?e+2*Math.PI:e}function it(t,e,n,r,i,o){var a=o.type.name;if("float"===a){o.getFlag(Zt.flagDegreesInEditor)&&(e=rt(t,e),n=rt(t,n),r=rt(t,r));var s=1-i;return Math.pow(s,3)*t+3*s*s*i*e+3*s*i*i*n+Math.pow(i,3)*r}return"vector"===a?t.interpolateCubic(r,e,n,i):"color"===a?t.interpolateCubic(r,e,n,i):t}function ot(t,e,n,r,i){var o=1-i;return Math.pow(o,3)*t+3*o*o*i*e+3*o*i*i*n+Math.pow(i,3)*r}function at(t,e,n){return{control1:e+(t-n)/3,control2:e+(n-t)/3}}function st(t){return"sce"===t.reference._rootType}function pt(t){for(var e=window.location.search.substring(1),n=e.split("&"),r=0;r<n.length;r++){var i=n[r].split("=");if(decodeURIComponent(i[0])==t)return decodeURIComponent(i[1])}console.log("Query variable %s not found",t)}function lt(t){Nn.serverToClientEnabled&&t.forEach(function(t){(t=ft(t))&&yt(t)})}function ct(t){if(console.log("receive gameData",t),!t)return console.error("Game data was not received");try{s(function(){Jt.fromJSON(t),xt.dispatch(Pt.GLOBAL_GAME_CREATED,De)}),localStorage.openEditPlayGameId=t.id,history.replaceState({},null,"?gameId="+t.id)}catch(t){console.error("Game is corrupt.",t),g("Game is corrupt.")}}function ht(t,e){if(!On)return console.log("Could not send",t);t?On.emit(t,e):On.emit(e)}function ut(){if(Ft)return void ct({id:"gam_dumb",c:[{id:"prtrQ10Xvlt26lKIsrk",c:[{id:"cdaP5MbwTHjlNTtsbOf",c:[{id:"prp7GBI7ptGoOB0czCf",v:1,n:"rotationalDrag"}],cid:"_Physics",n:"Physics"},{id:"cdalev0lEyN36HMU1yq",cid:"_CharacterController",n:"CharacterController"},{id:"cdatyGx2WHvS86caySN",cid:"cidhFIVThaem3",n:"Shape"},{id:"prp_testPrototypeName",v:"Actor",n:"name"}],si:"M19cq"},{id:"prte2f3KiHuM0sF8fGr",c:[{id:"cdaUTyhrNmhJgbj3hWz",c:[{id:"prptvjNMPCRfYOB18By",v:"static",n:"type"}],cid:"_Physics",n:"Physics"},{id:"cdayHf6lKxMHybf1UDm",cid:"cidAqAv86xu0G",n:"Shape"},{id:"prpQUR3Ei2tKQ10XL40",v:"Static",n:"name"}],si:"XaLeF"},{id:"prtTsDqevlt2okzITrF",c:[{id:"cda9QvRA0RtxAJ2Y73E",cid:"cidPNowJEkdoK",n:"Shape"},{id:"cdaGVd0cK6exGIvPlm8",cid:"_Physics",n:"Physics"},{id:"prpcCUqrxeQMOamqIbc",v:"Dynamic",n:"name"}],si:"OXlXy"},{id:"lvloRefeYW72V69c3Q1",c:[{id:"eprBsqCAnWgyaoVfyiM",si:"GxMPD",c:[{id:"cdaEpszsej3gKpA0ZaQ",cid:"cidW8yFNDGQX9",n:"Shape"},{id:"cdadevJLE9pHC8ITKrc",c:[{id:"prpHBLerc9GTmQe5JBO",v:"static",n:"type"}],cid:"_Physics",n:"Physics"}],n:"Floor",p:{x:-182.1158,y:78.5093},s:{x:4.0126,y:.5846}},{id:"eprCyIXOLETKXtrmRzf",si:"GxMPD",c:[{id:"cdaQXPj6dFUQBtbOREZ",cid:"_CharacterController",n:"CharacterController"},{id:"cdaRpjAVXeYHIAvRPtQ",c:[{id:"prpDPLnUOytA2bb2gXF",v:"circle",n:"type"}],cid:"cidW8yFNDGQX9",n:"Shape"},{id:"cdazw3hJYQKgeidpVbB",c:[{id:"prpwFGr3IBoruOTBIbr",v:"dynamic",n:"type"}],cid:"_Physics",n:"Physics"}],n:"guy",p:{x:-72.9377,y:-12.0532}},{id:"eprTK6vWjNyLCU2lmC3",si:"GxMPD",c:[{id:"cdaFtZvXSTpnde2mCaw",c:[{id:"prpHcFA2HUNovmcJw7D",v:"static",n:"type"}],cid:"_Physics",n:"Physics"},{id:"cdaw8rjFsM9mw8jMbEz",cid:"cidW8yFNDGQX9",n:"Shape"}],n:"Floor",p:{x:-254.0626,y:33.7312},s:{x:4.0126,y:.5846}},{id:"epra8MzE4b0YWUS8bAu",si:"GxMPD",c:[{id:"cdaZr6GMN5zlVAHCl2X",c:[{id:"prpRxYyZV8HU42ht82h",v:"static",n:"type"}],cid:"_Physics",n:"Physics"},{id:"cdarBCjhtof8Sy9pDdt",cid:"cidW8yFNDGQX9",n:"Shape"}],n:"Floor",p:{x:-75.4687,y:42.7656},s:{x:4.0126,y:.5846}},{id:"prpfI8ByaPzgGnGavwE",v:"Level 1",n:"name"}]}]});var t=window.io;if(!t)return console.error("socket.io not defined after window load.");On=new t,On.on("connect",function(){On.onevent=function(t){var e=t.data[0];"string"==typeof e?Dn[e](t.data[1]):lt(e)},On.on("disconnect",function(){console.warn("Disconnected!"),g("Disconnected!"),Nn.serverToClientEnabled=!1,Nn.clientToServerEnabled=!1})})}function dt(e){if(e.packedChange)return e.packedChange;var n={};try{e.parent&&(e.parentId=e.parent.id),e.type===Lt.addSerializableToTree?e.reference?e.value=e.reference.toJSON():t(!1,"invalid change of type addSerializableToTree",e):void 0!==e.value&&(e.value=e.reference.propertyType.type.toJSON(e.value)),Object.keys(Mn).forEach(function(t){if(void 0!==e[t]){if("type"===t&&e[t]===Lt.setPropertyValue)return;n[Mn[t]]=e[t]}})}catch(t){console.log("PACK ERROR",t)}return n}function ft(t){var e={packedChange:t};if(Object.keys(t).forEach(function(n){var r=Rn[n];e[r]=t[n]}),e.type||(e.type=Lt.setPropertyValue),e.type===Lt.addSerializableToTree)e.id=e.value.id;else{if(e.reference=W(e.id),!e.reference)return console.error("received a change with unknown id",e,"packed:",t),null;e.id=e.reference.id}return e.parentId&&(e.parent=W(e.parentId)),e}function yt(t){var e;s(function(){if(t.type===Lt.setPropertyValue)t.reference.value=t.reference.propertyType.type.fromJSON(t.value);else if(t.type===Lt.addSerializableToTree)if(t.parent){var n=Jt.fromJSON(t.value);t.parent.addChild(n),"ent"===n.threeLetterType&&(n.localMaster=!1)}else{var n=Jt.fromJSON(t.value);"sce"===n.threeLetterType&&(e=n)}else t.type===Lt.deleteAllChildren?t.reference.deleteChildren():t.type===Lt.deleteSerializable?t.reference.delete():t.type===Lt.move&&t.reference.move(t.parent)}),e&&e.play()}function mt(){function t(n){if(void 0===n&&(n=!1),e){var r=window.innerWidth,i=window.innerHeight;if(n||r!==kn||i!==Fn){e.style.width=r+"px",e.style.height=i+"px";var o=r*i,a=1;o>Gn&&(a=Math.sqrt(Gn/o));var s=new Xt(r,i),p=s.clone().multiplyScalar(a);Ke.resizeCanvas(p,s),window.scrollTo(0,0),kn=r,Fn=i,xt.dispatch("canvas resize",Ke),setTimeout(function(){return t()},200)}}}if(Ke){var e=document.getElementById("screen");t(!0)}}function vt(t){t.preventDefault();var e=gt(t);zn.forEach(function(n){var r=!!e.find(function(t){return n.contains(t)});n.setState(r,"touchstart"===t.type)})}function gt(t){for(var e=[],n=0;n<t.targetTouches.length;++n){var r=t.targetTouches[n];e.push(new Xt(r.clientX,r.clientY))}return e}function Ct(){if(Ke){var t=!1,e=!1,n=!1;Ke.getComponents("CharacterController").forEach(function(r){"player"===r.type&&(t=!0,"jumper"===r.controlType?0!==r.jumpSpeed&&(e=!0):"top down"===r.controlType&&(n=!0))}),Vn.touchUp.setVisible(n),Vn.touchLeft.setVisible(t),Vn.touchRight.setVisible(t),Vn.touchDown.setVisible(n),Vn.touchJump.setVisible(e),Vn.touchA.setVisible(!0),Vn.touchB.setVisible(!1),Vn.touchUp.visible&&Vn.touchDown.visible?(Vn.touchLeft.setPosition(10,null,60),Vn.touchRight.setPosition(110,null,60),Vn.touchUp.setPosition(60,null,110),Vn.touchDown.setPosition(60,null,10),Vn.touchLeft.setContainsFunction(function(t){var e=_t(t);return e.x<0&&Math.abs(e.x)>Math.abs(e.y)&&e.length()<=jn}),Vn.touchUp.setContainsFunction(function(t){var e=_t(t);return e.y<0&&Math.abs(e.y)>Math.abs(e.x)&&e.length()<=jn}),Vn.touchRight.setContainsFunction(function(t){var e=_t(t);return e.x>0&&Math.abs(e.x)>Math.abs(e.y)&&e.length()<=jn}),Vn.touchDown.setContainsFunction(function(t){var e=_t(t);return e.y>0&&Math.abs(e.y)>Math.abs(e.x)&&e.length()<=jn})):(Vn.touchLeft.setPosition(10,null,20),Vn.touchRight.setPosition(90,null,20),Vn.touchLeft.setContainsFunction(function(t){var e=_t(t);return e.x<=0&&e.y>-jn}),Vn.touchRight.setContainsFunction(function(t){var e=_t(t);return e.x>0&&e.y>-jn&&e.x<jn}));var r=Jn.filter(function(t){return t.visible});r.forEach(function(t,e){var n=r.length-1-e;t.setPosition(null,10+20*n,20+70*e),0===e?t.setContainsFunction(function(e){var n=t.getPosition();return e.x>=n.x-Bn/2-15&&e.y>=n.y-Bn/2}):t.setContainsFunction(function(e){var n=t.getPosition();return e.y>=n.y-Bn/2&&e.y<=n.y+Bn/2&&e.x>=n.x-Bn/2-15})})}}function Tt(){var t=Vn.touchLeft.getPosition(),e=Vn.touchRight.getPosition();return t.add(e).divideScalar(2)}function _t(t){var e=Tt();return t.clone().subtract(e)}var wt={get:function(){return null}},Et=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},bt=function(){function e(){this.currentType=null,this.chain=[],this.timeout=null}return e.prototype.enter=function(e,n){var r=this;if(void 0===n&&(n=null),this.chain.push({type:e,data:n,stack:null}),e!==this.currentType){if(this.chain.find(function(t,n){return t.type===e&&n!==r.chain.length-1})){console.warn("Change event circular dependency"),console.log("################################");for(var i=0,o=this.chain;i<o.length;i++){var a=o[i];if(console.warn("%c"+a.type,"font-weight: bold; font-size: 16px"),a.data&&"object"==typeof a.data)for(var s in a.data)null!=a.data[s]&&console.warn(s+":",a.data[s]);else console.warn(a.data);console.warn(a.stack||"Turn SAVE_STACK_TRACE on to see stack traces. It will slow down the engine."),console.log("--------------------------------------")}t(!1,"Change event circular dependency")}this.currentType=e,this.timeout||(this.timeout=setTimeout(function(){return r.reset()},0))}},e.prototype.leave=function(t){this.chain.length>0&&this.chain[this.chain.length-1].type===t&&(this.chain.pop(),this.currentType=this.chain.length>0?this.chain[this.chain.length-1].type:null)},e.prototype.reset=function(){this.currentType=null,this.chain.length=0,this.timeout=null},e}();!function(){var t=new bt;t.enter("a"),t.enter("a"),t.enter("b"),t.enter("b"),t.leave("b"),t.leave("b"),t.enter("a")}();var Pt;!function(t){t.SCENE_START="scene start",t.SCENE_PLAY="scene play",t.SCENE_PAUSE="scene pause",t.SCENE_RESET="scene reset",t.SCENE_DRAW="scene draw",t.SCENE_ZOOM_CHANGED="zoom changed",t.GAME_LEVEL_COMPLETED="game level completed",t.PROPERTY_VALUE_CHANGE="property change",t.GLOBAL_CHANGE_OCCURED="change",t.GLOBAL_SCENE_CREATED="scene created",t.GLOBAL_GAME_CREATED="game created",t.GLOBAL_ENTITY_CLICKED="global entity clicked",t.ENTITY_CLICKED="entity clicked"}(Pt||(Pt={}));var St={eventDispatchedCallback:null},It=new bt,Nt=function(){function t(){this._listeners={}}return t.prototype.listen=function(t,e,r){var i=this;void 0===r&&(r=0),e.priority=r+Ot++/Dt,this._listeners.hasOwnProperty(t)||(this._listeners[t]=[]);var o=n(this._listeners[t],e);return this._listeners[t].splice(o,0,e),function(){var n=i._listeners[t];if(n){var r=n.indexOf(e);r>=0&&n.splice(r,1)}}},t.prototype.dispatch=function(t,e,n,r){var i=this,o=this._listeners[t];if(o){var a=e&&e.reference?t+e.reference.id:t;It.enter(a,{this:this,a:e,b:n,c:r}),St.eventDispatchedCallback&&St.eventDispatchedCallback(t,o.length);for(var s=0;s<o.length;s++)try{o[s](e,n,r)}catch(e){console.error("Event "+t+" listener crashed.",i._listeners[t][s],e)}It.leave(a)}},t.prototype.dispatchWithResults=function(t,e,n,r){var i=this,o=this._listeners[t];if(!o)return Promise.all([]);var a=[];St.eventDispatchedCallback&&St.eventDispatchedCallback(t,o.length);for(var s=0;s<o.length;s++)try{a.push(o[s](e,n,r))}catch(e){console.error("Event "+t+" listener crashed.",i._listeners[t][s],e)}var p=a.map(function(t){return t instanceof Promise?t:Promise.resolve(t)});return Promise.all(p)},t.prototype.delete=function(){this._listeners={}},t}(),xt=new Nt;xt.globalEventDispatcher=!0;var At,Ot=0,Dt=1e10,Lt={addSerializableToTree:"a",setPropertyValue:"s",deleteSerializable:"d",move:"m",deleteAllChildren:"c"},Mt=new bt;wt.get=i;var Rt=!1,kt="undefined"!=typeof window,Ft="undefined"!=typeof module,Gt={addSerializable:function(t){},removeSerializable:function(t){}},Bt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",Ut=Bt.length,jt=Math.random,Vt=new Map,Jt=function(n){function r(e,r){void 0===e&&(e=""),void 0===r&&(r=!1);var i=n.call(this)||this;return i._children=new Map,t(i.threeLetterType,"Forgot to Serializable.registerSerializable your class?"),i._rootType=i.isRoot?i.threeLetterType:null,r?i:(i.id=e||l(i.threeLetterType),Gt.addSerializable(i),i)}return e(r,n),r.prototype.makeUpAName=function(){return"Serializable"},r.prototype.delete=function(){return n.prototype.delete.call(this),this._parent?(this._parent.deleteChild(this),!1):(this.deleteChildren(),this._alive=!1,this._rootType=null,Gt.removeSerializable(this.id),this._state|=r.STATE_DESTROY,!0)},r.prototype.deleteChildren=function(){this._children.size&&(this._children.forEach(function(t){t.forEach(function(t){t._parent=null,t.delete()})}),this._children.clear(),this._parent&&a(Lt.deleteAllChildren,this))},r.prototype.initWithChildren=function(e){return void 0===e&&(e=[]),t(!(this._state&r.STATE_INIT),"init already done"),this._state|=r.STATE_INIT,e.length>0&&this.addChildren(e),this},r.prototype.addChildren=function(t){for(var e=this,n=0;n<t.length;n++)e.addChild(t[n]);return this},r.prototype.addChild=function(t){return this._addChild(t),this._state|=r.STATE_ADDCHILD,this._rootType&&a(Lt.addSerializableToTree,t),this},r.prototype._addChild=function(e){t(null===e._parent);var n=this._children.get(e.threeLetterType);return void 0===n&&(n=[],this._children.set(e.threeLetterType,n)),n.push(e),e._parent=this,e._state|=r.STATE_ADDPARENT,e._rootType!==this._rootType&&e.setRootType(this._rootType),this},r.prototype.findChild=function(t,e,n){void 0===n&&(n=!1);var r=this._children.get(t);if(!r)return null;if(e){var i=r.find(e);if(i)return i;if(n)for(var o=0;o<r.length;++o){var a=r[o],s=a.findChild(t,e,!0);if(s)return s}return null}return r[0]},r.prototype.findParent=function(t,e){void 0===e&&(e=null);for(var n=this;n;){if(n.threeLetterType===t&&(!e||e(n)))return n;n=n._parent}return null},r.prototype.getRoot=function(){for(var t=this;t._parent;)t=t._parent;return t},r.prototype.deleteChild=function(t,e){return a(Lt.deleteSerializable,t),this._detachChild(t,e),t.delete(),this},r.prototype._detachChild=function(e,n){void 0===n&&(n=0);var r=this._children.get(e.threeLetterType);return t(r,"child not found"),r[n]!==e&&(n=r.indexOf(e)),t(n>=0,"child not found"),r.splice(n,1),0===r.length&&this._children.delete(e.threeLetterType),e._parent=null,e.setRootType(null),this},r.prototype.forEachChild=function(t,e,n){function r(r){r.forEach(function(r){e(r),n&&r.forEachChild(t,e,!0)})}return void 0===t&&(t=null),void 0===n&&(n=!1),t?r(this._children.get(t)||[]):this._children.forEach(r),this},r.prototype.move=function(t){return t._addChild(this._detach()),a(Lt.move,this),this},r.prototype._detach=function(){return this._parent&&this._parent._detachChild(this),this},r.prototype.getParent=function(){return this._parent||null},r.prototype.getChildren=function(t){return this._children.get(t)||[]},r.prototype.toJSON=function(){var t=this,e={id:this.id};if(this._children.size>0){var n=[];Array.from(this._children.keys()).sort(function(t,e){return"prt"===t?-1:1}).forEach(function(e){return n.push(t._children.get(e))}),e.c=[].concat.apply([],n).map(function(t){return t.toJSON()})}return e},r.prototype.toString=function(){return JSON.stringify(this.toJSON(),null,4)},r.prototype.clone=function(){var t=new this.constructor,e=[];return this.forEachChild(null,function(t){e.push(t.clone())}),t.initWithChildren(e),this._state|=r.STATE_CLONE,t},r.prototype.hasDescendant=function(t){var e=this;if(!t)return!1;for(var n=t._parent;n;){if(n===e)return!0;n=n._parent}return!1},r.prototype.setRootType=function(t){if(this._rootType!==t){this._rootType=t;var e;this._children.forEach(function(n){for(e=0;e<n.length;++e)n[e].setRootType(t)})}},r.prototype.isInTree=function(){return!!this._rootType},r.fromJSON=function(e){t("string"==typeof e.id&&e.id.length>5,"Invalid id.");var n=Vt.get(e.id.substring(0,3));t(n);var i;try{i=n(e)}catch(t){if(kt){if(console.error(t),window.force,!window.force)throw new Error}else console.log("Error fromJSON",t);return null}var o=e.c?e.c.map(function(t){return r.fromJSON(t)}).filter(Boolean):[];return i._state&r.STATE_INIT?i.addChildren(o):i.initWithChildren(o),i._state|=r.STATE_FROMJSON,i},r.registerSerializable=function(e,n,r){void 0===r&&(r=null),e.prototype.threeLetterType=n,t("string"==typeof n&&3===n.length),r||(r=function(t){return new e(t.id)}),Vt.set(n,r)},r.STATE_INIT=2,r.STATE_ADDCHILD=4,r.STATE_ADDPARENT=8,r.STATE_CLONE=16,r.STATE_DESTROY=32,r.STATE_FROMJSON=64,r}(Nt);Jt.prototype._parent=null,Jt.prototype._alive=!0,Jt.prototype._state=0,Jt.prototype._rootType=null,Jt.prototype.isRoot=!1,Object.defineProperty(Jt.prototype,"debug",{get:function(){var t=this,e=this.threeLetterType;"cda"===this.threeLetterType&&(e+="|"+this.name),this._children.forEach(function(n,r){e+="|",e+="prp"===r?t.getChildren("prp").map(function(t){return t.name+"="+t._value}).join(", "):r+"("+n.length+")"}),e+="|state: ";var n=[],r=function(e,r){t._state&e&&n.push(r)};return r(Jt.STATE_INIT,"init"),r(Jt.STATE_ADDCHILD,"add child"),r(Jt.STATE_ADDPARENT,"add parent"),r(Jt.STATE_CLONE,"clone"),r(Jt.STATE_DESTROY,"destroy"),r(Jt.STATE_FROMJSON,"from json"),e+=n.join(", ")}}),Object.defineProperty(Jt.prototype,"debugChildren",{get:function(){function t(t){return new function(){}}var e=[];this._children.forEach(function(t,n){e=e.concat(t)});var n=[];return e.forEach(function(e){var r=t(e.threeLetterType);r.debug=e.debug,r.ref=e,r.debugChildren=e.debugChildren;var i=e.debugChildArray;i&&i.length>0&&(r.children=i),n.push(r)}),n}});var zt=!0,Wt=!1,Ht=null,qt=function(n){function r(e){var r=e.value,i=e.predefinedId,o=void 0===i?"":i,a=e.name,s=e.propertyType,p=void 0===s?null:s,l=e.skipSerializableRegistering,c=void 0!==l&&l,h=n.call(this,o,c)||this;return h._initialValueIsJSON=!1,t(a,"Property without a name can not exist"),h._initialValue=r,p?h.setPropertyType(p):(h.name=a,h._initialValueIsJSON=!0),h}return e(r,n),r.prototype.makeUpAName=function(){return this.name},r.prototype.setPropertyType=function(t){this.propertyType=t;try{void 0!==this._initialValue?this.value=this._initialValueIsJSON?t.type.fromJSON(this._initialValue):this._initialValue:this.value=t.initialValue}catch(e){console.log("Invalid value",e,t,this),this.value=t.initialValue}this.name=t.name},r.prototype.clone=function(t){return void 0===t&&(t=!1),new r({value:this.propertyType.type.clone(this.value),name:this.name,propertyType:this.propertyType,skipSerializableRegistering:t})},r.prototype.toJSON=function(){return Object.assign(n.prototype.toJSON.call(this),{v:this.type.toJSON(this.value),n:this.propertyType.name})},r.prototype.valueEquals=function(t){return this.propertyType.type.equal(this._value,t)},Object.defineProperty(r.prototype,"type",{get:function(){return this.propertyType.type},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"value",{get:function(){return this._value},set:function(t){var e=this._value;this._value=this.propertyType.validator.validate(t),this.dispatch(Pt.PROPERTY_VALUE_CHANGE,this._value,e),"gam"===this._rootType?zt&&a(Lt.setPropertyValue,this):!Wt||Ht&&!Ht(this)||a(Lt.setPropertyValue,this)},enumerable:!0,configurable:!0}),r}(Jt);qt.prototype.propertyType=null,Jt.registerSerializable(qt,"prp",function(t){return new qt({value:t.v,predefinedId:t.id,name:t.n})}),Object.defineProperty(qt.prototype,"debug",{get:function(){return"prp "+this.name+"="+this.value}});var Yt=function(){function e(e,n,r,i,o,a,s){void 0===a&&(a=[]);var p=this;this.name=e,this.type=n,this.validator=r,this.initialValue=i,this.description=o,this.visibleIf=s,t(e[0]>="a"&&e[0]<="z","Name of a property must start with lower case letter."),t(n&&"string"==typeof n.name),t(r&&"function"==typeof r.validate),this.name=e,this.type=n,this.validator=r,this.initialValue=i,this.description=o,this.visibleIf=s,this.flags={},a.forEach(function(t){return p.flags[t.type]=t})}return e.prototype.getFlag=function(t){return this.flags[t.type]},e.prototype.createProperty=function(t){var e=void 0===t?{}:t,n=e.value,r=e.predefinedId,i=e.skipSerializableRegistering,o=void 0!==i&&i;return new qt({propertyType:this,value:n,predefinedId:r,name:this.name,skipSerializableRegistering:o})},e}(),Zt=function(e,n,r){for(var i=arguments,o=[],a=3;a<arguments.length;a++)o[a-3]=i[a];var s=r(),p=s.validators.default(),l="",c=[],h=null;return o.forEach(function(e,n){"string"==typeof e?l=e:e&&e.validate?p=e:e&&e.isFlag?c.push(e):e&&e.visibleIf?h=e:t(!1,"invalid parameter "+e+" idx "+n)}),new Yt(e,s,p,n,l,c,h)};Zt.visibleIf=function(e,n){return t("string"==typeof e&&e.length),t(void 0!==n),{visibleIf:!0,propertyName:e,values:Array.isArray(n)?n:[n]}},Zt.flagDegreesInEditor=function(t,e){return void 0===e&&(e={}),e.isFlag=!0,e.type=t,e}("degreesInEditor");var Xt=function(){function t(t,e){this.x=t||0,this.y=e||0}return t.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},t.prototype.addScalars=function(t,e){return this.x+=t,this.y+=e,this},t.prototype.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},t.prototype.subtractScalars=function(t,e){return this.x-=t,this.y-=e,this},t.prototype.multiply=function(t){return this.x*=t.x,this.y*=t.y,this},t.prototype.multiplyScalar=function(t){return this.x*=t,this.y*=t,this},t.prototype.divide=function(t){return this.x/=t.x,this.y/=t.y,this},t.prototype.divideScalar=function(t){return this.x/=t,this.y/=t,this},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.prototype.lengthSq=function(){return this.x*this.x+this.y*this.y},t.prototype.setLength=function(t){var e=this.length();return 0===e?(this.x=t,this.y=0):this.multiplyScalar(t/e),this},t.prototype.getProjectionOn=function(t){var e=t.length();return 0===e?this.clone():t.clone().multiplyScalar(this.dot(t)/(e*e))},t.prototype.distance=function(t){var e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)},t.prototype.distanceSq=function(t){var e=this.x-t.x,n=this.y-t.y;return e*e+n*n},t.prototype.angleTo=function(t){var e=this.length()*t.length();return e>0?Math.acos(this.dot(t)/e):0},t.prototype.closestAngleTo=function(t){var e=Math.abs(this.angleTo(t));return e>.5*Math.PI?Math.abs(Math.PI-e):e},t.prototype.normalize=function(){return this.setLength(1)},t.prototype.horizontalAngle=function(){return Math.atan2(this.y,this.x)},t.prototype.verticalAngle=function(){return Math.atan2(this.x,this.y)},t.prototype.rotate=function(t){var e=this.x*Math.cos(t)-this.y*Math.sin(t);return this.y=this.x*Math.sin(t)+this.y*Math.cos(t),this.x=e,this},t.prototype.rotateTo=function(t){return this.rotate(t-this.verticalAngle())},t.prototype.isEqualTo=function(t){return this.x===t.x&&this.y===t.y},t.prototype.isZero=function(){return!this.x&&!this.y},t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.set=function(t){return this.x=t.x,this.y=t.y,this},t.prototype.setScalars=function(t,e){return this.x=t,this.y=e,this},t.prototype.toString=function(){return"["+this.x+", "+this.y+"]"},t.prototype.toArray=function(){return[this.x,this.y]},t.prototype.interpolateLinear=function(e,n){return new t(this.x+(e.x-this.x)*n,this.y+(e.y-this.y)*n)},t.prototype.interpolateCubic=function(e,n,r,i){var o=1-i;return new t(Math.pow(o,3)*this.x+3*o*o*i*n.x+3*o*i*i*r.x+Math.pow(i,3)*e.x,Math.pow(o,3)*this.y+3*o*o*i*n.y+3*o*i*i*r.y+Math.pow(i,3)*e.y)},t.fromObject=function(e){return new t(e.x,e.y)},t.fromArray=function(e){return new t(e[0],e[1])},t}(),Kt=function(){function e(n,r,i){if(n instanceof e)this.r=n.r,this.g=n.g,this.b=n.b;else if("number"==typeof n)this.r=Math.round(n),this.g=Math.round(r),this.b=Math.round(i);else if("string"==typeof n){var o=u(n);this.r=o.r,this.g=o.g,this.b=o.b}else t(!1,"Invalid Color parameters")}return e.prototype.toHexString=function(){return f(this.r,this.g,this.b)},e.prototype.toHexNumber=function(){return 256*this.r*256+256*this.g+this.b},e.prototype.toString=function(){return"["+this.r+","+this.g+","+this.b+"]"},
e.prototype.interpolateLinear=function(t,n){return new e(this.r+(t.r-this.r)*n,this.g+(t.g-this.g)*n,this.b+(t.b-this.b)*n)},e.prototype.interpolateCubic=function(t,n,r,i){var o=1-i;return new e(Math.pow(o,3)*this.r+3*o*o*i*n.r+3*o*i*i*r.r+Math.pow(i,3)*t.r,Math.pow(o,3)*this.g+3*o*o*i*n.g+3*o*i*i*r.g+Math.pow(i,3)*t.g,Math.pow(o,3)*this.b+3*o*o*i*n.b+3*o*i*i*r.b+Math.pow(i,3)*t.b)},e.prototype.isEqualTo=function(t){return this.r===t.r&&this.g===t.g&&this.b===t.b},e.fromHexString=function(t){var n=u(t);return new e(n.r,n.g,n.b)},e}(),Qt=Math.pow(10,4);Zt.float=c({name:"float",validators:{default:function(t){return t=parseFloat(t),y(t),t},range:function(t,e,n){return t=Number(t),y(t),Math.min(n,Math.max(e,t))},modulo:function(t,e,n){t=Number(t),y(t);var r=n-e;return t<e?t+=(1+((e-t)/r|0))*r:t>n-1e-7&&(t-=(1+((t-n)/r|0))*r),t}},toJSON:function(t){return Math.round(t*Qt)/Qt},fromJSON:function(t){return t}}),Zt.int=c({name:"int",validators:{default:function(t){return t=parseInt(t),y(t),t},range:function(t,e,n){return t=parseInt(t),y(t),Math.min(n,Math.max(e,t))}},toJSON:function(t){return t},fromJSON:function(t){return t}}),Zt.vector=c({name:"vector",validators:{default:function(t){if(!(t instanceof Xt))throw new Error;return t=t.clone(),t.x=parseFloat(t.x),t.y=parseFloat(t.y),y(t.x),y(t.y),t}},toJSON:function(t){return{x:Math.round(t.x*Qt)/Qt,y:Math.round(t.y*Qt)/Qt}},fromJSON:function(t){return Xt.fromObject(t)},clone:function(t){return t.clone()},equal:function(t,e){return t.isEqualTo(e)}}),Zt.string=c({name:"string",validators:{default:function(t){return t?String(t):""}},toJSON:function(t){return t},fromJSON:function(t){return t}}),Zt.longString=c({name:"longString",validators:{default:function(t){return t?String(t):""}},toJSON:function(t){return t},fromJSON:function(t){return t}}),Zt.bool=c({name:"bool",validators:{default:function(t){if("boolean"!=typeof t)throw new Error;return t}},toJSON:function(t){return t?1:0},fromJSON:function(t){return!!t}}),Zt.enum=c({name:"enum",validators:{default:function(){t(!1,"also specify enum values with Prop.enum.values('value1', 'value2', ...)")},values:function(t){for(var e=arguments,n=[],r=1;r<arguments.length;r++)n[r-1]=e[r];if(!Array.isArray(n))throw new Error;if("string"!=typeof t)throw new Error("val should be string");if(n.indexOf(t)<0)throw new Error("value "+t+" not in enum: ["+n+"]");return t}},toJSON:function(t){return t},fromJSON:function(t){return t}}),Zt.color=c({name:"color",validators:{default:function(e){var n=new Kt(e);return t(n.r>=0&&n.r<256),t(n.g>=0&&n.g<256),t(n.b>=0&&n.b<256),n}},toJSON:function(t){return t.toHexString()},fromJSON:function(t){return new Kt(t)},equal:function(t,e){return t.isEqualTo(e)}});var $t=function(n){function r(e){var r=n.call(this,e)||this;return r._properties={},t(Array.isArray(r._propertyOwnerClass._propertyTypes),"call PropertyOwner.defineProperties after class definition"),r}return e(r,n),r.prototype.makeUpAName=function(){return this.name||"PropertyOwner"},r.prototype.initWithPropertyValues=function(e){var n=this;void 0===e&&(e={});var r=[];return Object.keys(e).forEach(function(i){var o=n._propertyOwnerClass._propertyTypesByName[i];t(o,"Invalid property "+i),r.push(o.createProperty({value:e[i]}))}),this.initWithChildren(r),this},r.prototype.initWithChildren=function(e){var r=this;void 0===e&&(e=[]),t(!(this._state&Jt.STATE_INIT),"init already done"),this._state|=Jt.STATE_INIT;var i=[],o=[];e.forEach(function(t){"prp"===t.threeLetterType?i.push(t):o.push(t)}),n.prototype.addChildren.call(this,o);var a=0,s={};i.filter(function(t){return!t.propertyType}).forEach(function(t){var e=r.constructor._propertyTypesByName[t.name];if(!e)return console.log("Property of that name not defined",r.id,t.name,r),a++,void(s[t.id]=!0);t.setPropertyType(e)}),a&&(i=i.filter(function(t){return!s[t.id]}));var p={};return i.forEach(function(t){return p[t.name]=t}),this._propertyOwnerClass._propertyTypes.forEach(function(t){p[t.name]||i.push(t.createProperty())}),n.prototype.addChildren.call(this,i),this},r.prototype.addChild=function(e){if(t(this._state&Jt.STATE_INIT,this.constructor+" requires that initWithChildren will be called before addChild"),n.prototype.addChild.call(this,e),"prp"===e.threeLetterType){if(!e.propertyType){if(!this._propertyOwnerClass._propertyTypesByName[e.name])return void console.log("Property of that name not defined",this.id,e,this);e.setPropertyType(this._propertyOwnerClass._propertyTypesByName[e.name])}t(void 0===this._properties[e.propertyType.name],"Property already added"),this._properties[e.propertyType.name]=e}return this},r.prototype.createPropertyHash=function(){return this.getChildren("prp").map(function(t){return""+t._value}).join(",")},r.prototype.delete=function(){return!!n.prototype.delete.call(this)&&(this._properties={},!0)},r.prototype.deleteChild=function(e,r){return t("prp"!==e.threeLetterType,"Can not delete just one Property child."),n.prototype.deleteChild.call(this,e,r),this},r.defineProperties=function(e,n){var r;e.prototype._propertyOwnerClass=e;var i=e;i._propertyTypes||(i._propertyTypes=[]),(r=i._propertyTypes).push.apply(r,n),i._propertyTypesByName={},i._propertyTypes.forEach(function(n){var r=n.name;t(!e.prototype.hasOwnProperty(r),"Property name "+r+" clashes"),i._propertyTypesByName[r]=n,Object.defineProperty(e.prototype,r,{get:function(){return this._properties[r],this._properties[r].value},set:function(t){this._properties[r].value=t}})})},r}(Jt),te="#".charCodeAt(0),ee=".".charCodeAt(0),ne=function(t){for(var e=null,n=null,r=null,i=0,o=0,a=0;a<=t.length;a++){var s=t.charCodeAt(a),p=s===te,l=s===ee,c=!s;(p||l||c)&&(0===i?e=0===a?"div":t.substring(o,a):1===i?n=t.substring(o,a):r?r+=" "+t.substring(o,a):r=t.substring(o,a),p?i=1:l&&(i=2),o=a+1)}return{tag:e,id:n,className:r}},re=function(t,e){var n=ne(t),r=n.tag,i=n.id,o=n.className,a=e?document.createElementNS(e,r):document.createElement(r);return i&&(a.id=i),o&&(e?a.setAttribute("class",o):a.className=o),a},ie=function(t,e,n){var r=e.__redom_lifecycle;if(oe(r))return void(e.__redom_mounted=!1);var i=n;for(e.__redom_mounted&&ce(e,"onunmount");i;){var o=i.__redom_lifecycle||{};for(var a in r)o[a]&&(o[a]-=r[a]);oe(o)&&(i.__redom_lifecycle=null),i=i.parentNode}},oe=function(t){if(null==t)return!0;for(var e in t)if(t[e])return!1;return!0},ae=["onmount","onunmount"],se="undefined"!=typeof window&&"ShadowRoot"in window,pe=function(t,e,n){var r=me(t),i=me(e);e===i&&i.__redom_view&&(e=i.__redom_view),e!==i&&(i.__redom_view=e);var o=i.__redom_mounted,a=i.parentNode;return o&&a!==r&&ie(0,i,a),null!=n?r.insertBefore(i,me(n)):r.appendChild(i),le(e,i,r,a),e},le=function(t,e,n,r){for(var i=e.__redom_lifecycle||(e.__redom_lifecycle={}),o=n===r,a=!1,s=0;s<ae.length;s++){var p=ae[s];!o&&t!==e&&p in t&&(i[p]=(i[p]||0)+1),i[p]&&(a=!0)}if(!a)return void(e.__redom_mounted=!0);var l=n,c=!1;if((o||!c&&l&&l.__redom_mounted)&&(ce(e,o?"onremount":"onmount"),c=!0),!o)for(;l;){var h=l.parentNode,u=l.__redom_lifecycle||(l.__redom_lifecycle={});for(var d in i)u[d]=(u[d]||0)+i[d];!c&&(l===document||se&&l instanceof window.ShadowRoot||h&&h.__redom_mounted)&&(ce(l,o?"onremount":"onmount"),c=!0),l=h}},ce=function(t,e){if("onmount"===e?t.__redom_mounted=!0:"onunmount"===e&&(t.__redom_mounted=!1),t.__redom_lifecycle){var n=t.__redom_view;n&&n[e]&&n[e]()}},he=function(t,e,n){var r=me(t);if(void 0!==n)r.style[e]=n;else if(ve(e))r.setAttribute("style",e);else for(var i in e)he(r,i,e[i])},ue="http://www.w3.org/1999/xlink",de=function(t,e,n){var r=me(t),i=r instanceof SVGElement;if(void 0!==n)if("style"===e)he(r,n);else if(i&&Ce(n))r[e]=n;else if("dataset"===e)v(r,n);else if(!i&&(e in r||Ce(n)))r[e]=n;else{if(i&&"xlink"===e)return void m(r,n);r.setAttribute(e,n)}else for(var o in e)de(r,o,e[o])},fe=function(t){return document.createTextNode(null!=t?t:"")},ye=function(t,e){for(var n=0;n<e.length;n++){var r=e[n];(0===r||r)&&("function"==typeof r?r(t):ve(r)||ge(r)?t.appendChild(fe(r)):Te(me(r))?pe(t,r):r.length?ye(t,r):"object"==typeof r&&de(t,r))}},me=function(t){return t.nodeType&&t||!t.el&&t||me(t.el)},ve=function(t){return"string"==typeof t},ge=function(t){return"number"==typeof t},Ce=function(t){return"function"==typeof t},Te=function(t){return t&&t.nodeType},_e={},we=function(t){return _e[t]||(_e[t]=re(t))},Ee=function(t){for(var e=arguments,n=[],r=arguments.length-1;r-- >0;)n[r]=e[r+1];var i;if(ve(t))i=we(t).cloneNode(!1);else if(Te(t))i=t.cloneNode(!1);else{if(!Ce(t))throw new Error("At least one argument required");var o=t;i=new(Function.prototype.bind.apply(o,[null].concat(n)))}return ye(me(i),n),i};Ee.extend=function(t){for(var e=arguments,n=[],r=arguments.length-1;r-- >0;)n[r]=e[r+1];var i=we(t);return Ee.bind.apply(Ee,[this,i].concat(n))};var be=Ee;window.sticky=g;var Pe;kt&&(Pe=window.PIXI,Pe.ticker.shared.stop());var Se=Pe,Ie=null,Ne={},xe=document.createElement("canvas");xe.width=1,xe.height=1;var Ae=xe.getContext("2d");xt.listen("scene load level",function(t){var e=P(),n=new Se.Sprite(Se.Texture.fromCanvas(e));t.backgroundGradient=n,S(t),t.layers.static.addChild(n)}),xt.listen("scene unload level",function(t){delete t.backgroundGradient}),xt.listen("canvas resize",function(t){S(t)}),console.log("%cOpen Edit Play","color: #666; font-size: 16px; text-shadow: 0px 0px 1px #777;");var Oe=[Zt("name","No name",Zt.string)],De=null,Le="undefined"!=typeof window,Me=function(t){function n(e){var n=this;return De&&console.error("Only one game allowed."),n=t.call(this,e)||this,Le&&(De=n),n}return e(n,t),n.prototype.initWithChildren=function(e){void 0===e&&(e=[]);var n=t.prototype.initWithChildren.call(this,e);return a(Lt.addSerializableToTree,this),n},n.prototype.delete=function(){return a(Lt.deleteSerializable,this),!!t.prototype.delete.call(this)&&(De===this&&(De=null),g("Game deleted"),!0)},n}($t);$t.defineProperties(Me,Oe),Me.prototype.isRoot=!0,Jt.registerSerializable(Me,"gam",function(t){return t.c&&t.c.sort(function(t,e){return t.id.startsWith("prt")||t.id.startsWith("pfa")?-1:1}),new Me(t.id)});var Re;Re=kt?window.p2:require("../src/external/p2");var ke=Re,Fe=1/60,Ge={friction:.3,restitution:0,stiffness:1e6,relaxation:4,frictionStiffness:1e6,frictionRelaxation:4,surfaceVelocity:0},Be={left:37,right:39,up:38,down:40,ctrl:17,appleLeft:91,appleRight:93,alt:18,shift:16,space:32,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,backspace:8,enter:13,esc:27,plus:187,minus:189,questionMark:191},Ue=!1;document.addEventListener("mousedown",function(t){return 0===t.button&&(Ue=!0)}),document.addEventListener("mouseup",function(t){return 0===t.button&&(Ue=!1)});var je={},Ve=[],Je=[];"undefined"!=typeof window&&(window.onkeydown=function(t){var e=t.which||t.keyCode;"input"==document.activeElement.nodeName.toLowerCase()&&e!==Be.esc||je[e]||(je[e]=!0,Ve.forEach(function(t){return t(e)}))},window.onkeyup=function(t){var e=t.which||t.keyCode;je[e]=!1,Je.forEach(function(t){return t(e)})});var ze;!function(t){t.EDITOR_CHANGE="editor change",t.EDITOR_REGISTER_MODULES="registerModules",t.EDITOR_SCENE_TOOL_CHANGED="scene tool changed",t.EDITOR_REGISTER_HELP_VARIABLE="define help variable",t.EDITOR_DELETE_CONFIRMATION="delete confirmation",t.EDITOR_PRE_DELETE_SELECTION="pre delete selection",t.EDITOR_LOADED="editor loaded",t.EDITOR_RESET="reset",t.EDITOR_FORCE_UPDATE="editor force update",t.EDITOR_UNFOCUS="editor unfocus",t.EDITOR_PLAY="play",t.EDITOR_PAUSE="pause",t.EDITOR_CLONE="clone",t.EDITOR_DELETE="delete",t.EDITOR_DRAW_NEEDED="draw needed",t.EDITOR_SCENE_MODE_CHANGED="scene mode change"}(ze||(ze={}));var We=function(){function t(){this.dispatcher=new Nt}return t.prototype.listen=function(t,e,n){return void 0===n&&(n=0),this.dispatcher.listen(t,e,n)},t.prototype.dispatch=function(t,e,n,r){this.dispatcher.dispatch(t,e,n,r)},t.prototype.dispatchWithResults=function(t,e,n,r){return this.dispatcher.dispatchWithResults(t,e,n,r)},t.prototype.getEventPromise=function(t){return new Promise(function(e){He.listen(t,e)})},t}(),He=new We;He.dispatcher.editorEventDispatcher=!0;var qe;qe=kt?window.performance:{now:Date.now};var Ye={},Ze={},Xe={};St.eventDispatchedCallback=function(t,e){return U("Event "+t,e)};var Ke=null,Qe={enableSleeping:!0},$e=function(n){function r(t){var e=n.call(this,t)||this;if(e.layers={},e.resetting=!1,e.pixelDensity=new Xt(1,1),Ke)try{Ke.delete()}catch(t){console.warn("Deleting old scene failed",t)}return Ke=e,e.canvas=document.querySelector("canvas.openEditPlayCanvas"),e.renderer=C(e.canvas),e.mouseListeners=[k(e.canvas,function(t){return e.dispatch("onMouseMove",t)}),F(e.canvas,function(t){return e.dispatch("onMouseDown",t)}),G(e.canvas,function(t){return e.dispatch("onMouseUp",t)})],a(Lt.addSerializableToTree,e),xt.dispatch(Pt.GLOBAL_SCENE_CREATED,e),e}return e(r,n),r.prototype.makeUpAName=function(){return this.level?this.level.makeUpAName():"Scene"},r.prototype.loadLevel=function(t){function e(t){void 0===t&&(t=r.stage);var e=new Se.Container;return t.addChild(e),e}var n=this;this.level=t,this.stage=new Se.Container,this.cameraPosition=new Xt(0,0),this.cameraZoom=1;var r=this;this.layers={static:e(),background:e(),move:e(),ui:e()},this.layers.behind=e(this.layers.move),this.layers.main=e(this.layers.move),this.layers.front=e(this.layers.move),this.components=new Map,this.animationFrameId=null,this.playing=!1,this.time=0,this.won=!1,I(this,Qe),xt.dispatch("scene load level before entities",Ke,t),this.level.getChildren("epr").map(function(t){return t.createEntity(n)}),xt.dispatch("scene load level",Ke,t)},r.prototype.unloadLevel=function(){var t=this.level;this.level=null,this.pause(),this.deleteChildren(),this.stage&&this.stage.destroy(),this.stage=null,this.layers={},this.components.clear(),x(this),xt.dispatch("scene unload level",Ke,t)},r.prototype.setCameraPositionToPlayer=function(){var t=new Xt(0,0),e=0;this.getComponents("CharacterController").forEach(function(n){n._rootType&&(t.add(n.Transform.getGlobalPosition()),e++)}),e>0&&this.cameraPosition.set(t.divideScalar(e))},r.prototype.updateCamera=function(){this.playing&&this.setCameraPositionToPlayer(),this.layers.move.pivot.set(this.cameraPosition.x-this.canvas.width/2/this.cameraZoom,this.cameraPosition.y-this.canvas.height/2/this.cameraZoom),this.layers.move.scale.set(this.cameraZoom,this.cameraZoom)},r.prototype.win=function(){this.won=!0},r.prototype.animFrame=function(){if(this.animationFrameId=null,this._alive&&this.playing){var t=performance.now(),e=.001*t,n=e-this._prevUpdate;n>.05&&(n=.05),this._prevUpdate=e,this.time+=n,o(this),j("Component updates"),this.dispatch("onUpdate",n,this.time),V("Component updates"),j("Physics"),N(this,n),V("Physics"),j("Draw"),this.draw(),V("Draw"),this.won&&(this.pause(),this.time=0,De.dispatch(Pt.GAME_LEVEL_COMPLETED),this.reset()),this.requestAnimFrame()}},r.prototype.requestAnimFrame=function(){var t=this,e=function(){return t.animFrame()};window.requestAnimationFrame?this.animationFrameId=window.requestAnimationFrame(e):this.animationFrameId=setTimeout(e,16)},r.prototype.draw=function(){this.updateCamera(),[this.layers.behind,this.layers.main,this.layers.front].forEach(T),this.renderer.render(this.stage,null,!1),this.dispatch(Pt.SCENE_DRAW,Ke),U("Draws")},r.prototype.isInInitialState=function(){return!this.playing&&0===this.time},r.prototype.reset=function(){if(this._alive){this.resetting=!0;var t=this.level;this.unloadLevel(),t&&this.loadLevel(t),delete this.resetting,this.dispatch(Pt.SCENE_RESET)}},r.prototype.pause=function(){this.playing&&(this.playing=!1,this.animationFrameId&&(window.requestAnimationFrame?window.cancelAnimationFrame(this.animationFrameId):clearTimeout(this.animationFrameId)),this.animationFrameId=null,this.dispatch(Pt.SCENE_PAUSE))},r.prototype.play=function(){this.playing||(this._prevUpdate=.001*performance.now(),this.playing=!0,this.requestAnimFrame(),0===this.time&&this.dispatch(Pt.SCENE_START),this.dispatch(Pt.SCENE_PLAY))},r.prototype.delete=function(){return!!n.prototype.delete.call(this)&&(this.unloadLevel(),Ke===this&&(Ke=null),this.mouseListeners&&(this.mouseListeners.forEach(function(t){return t()}),this.mouseListeners=null),this.renderer=null,!0)},r.prototype.addComponent=function(t){var e=this.components.get(t.componentClass.componentName);e||(e=new Set,this.components.set(t.componentClass.componentName,e)),e.add(t)},r.prototype.removeComponent=function(e){var n=this.components.get(e.componentClass.componentName);t(n),t(n.delete(e))},r.prototype.getComponents=function(t){return this.components.get(t)||new Set},r.prototype.mouseToWorld=function(t){return new Xt(this.layers.move.pivot.x+t.x/this.cameraZoom*this.pixelDensity.x,this.layers.move.pivot.y+t.y/this.cameraZoom*this.pixelDensity.y)},r.prototype.worldToMouse=function(t){return new Xt((t.x-this.layers.move.pivot.x)*this.cameraZoom/this.pixelDensity.x,(t.y-this.layers.move.pivot.y)*this.cameraZoom/this.pixelDensity.y)},r.prototype.mouseToPIXI=function(t){return t.clone().multiply(this.pixelDensity)},r.prototype.screenPixelsToWorldPixels=function(t){return t/this.cameraZoom*this.pixelDensity.x},r.prototype.getEntitiesAtScreenPoint=function(t){for(var e=0,n=this.stage.children;e<n.length;e++){n[e]}},r.prototype.setZoom=function(t){t&&(this.cameraZoom=t),this.dispatch(Pt.SCENE_ZOOM_CHANGED,this.cameraZoom)},r.prototype.resizeCanvas=function(t,e){this.renderer.resize(t.x,t.y),e?this.pixelDensity.setScalars(t.x/e.x,t.y/e.y):this.pixelDensity.setScalars(1,1)},r}(Jt);$e.prototype.isRoot=!0,Jt.registerSerializable($e,"sce");var tn=new Map,en={onUpdate:"onUpdate",onStart:Pt.SCENE_START},nn=function(n){function r(t){var e=n.call(this,t)||this;return e._componentId=null,e.scene=Ke,e.game=De,e._listenRemoveFunctions=[],e.entity=null,e}return e(r,n),r.prototype.makeUpAName=function(){return this.componentClass.componentName},r.prototype.clone=function(){var t=n.prototype.clone.call(this);return t._componentId=this._componentId,t},r.prototype.delete=function(){return this._parent=null,this.entity=null,n.prototype.delete.call(this),!0},r.prototype._addEventListener=function(t,e){e||(e=t);var n=this[t],r=this,i="Component: "+this.componentClass.componentName;this._listenRemoveFunctions.push(this.scene.listen(e,function(){j(i),n.apply(r,arguments),V(i)}))},r.prototype._preInit=function(){var e=this,n=this;this.componentClass.requirements.forEach(function(e){n[e]=n.entity.getComponent(e),t(n[e],n.componentClass.componentName+" requires component "+e+" but it is not found")}),this.forEachChild("com",function(t){return t._preInit()});for(var r in en)"function"==typeof e[r]&&e._addEventListener(r,en[r]);"Transform"!==this.componentClass.componentName&&this.scene&&this.scene.addComponent(this);try{"function"==typeof this.preInit&&this.preInit()}catch(t){console.error(this.entity,this.componentClass.componentName,"preInit",t)}},r.prototype._init=function(){this.forEachChild("com",function(t){return t._init()});try{"function"==typeof this.init&&this.init()}catch(t){console.error(this.entity,this.componentClass.componentName,"init",t)}},r.prototype._sleep=function(){try{"function"==typeof this.sleep&&this.sleep()}catch(t){console.error(this.entity,this.componentClass.componentName,"sleep",t)}"Transform"!==this.componentClass.componentName&&this.scene&&this.scene.removeComponent(this),this.forEachChild("com",function(t){return t._sleep()}),this._listenRemoveFunctions.forEach(function(t){return t()}),this._listenRemoveFunctions.length=0},r.prototype.listenProperty=function(e,n,r){t(e,"listenProperty called without a component"),this._listenRemoveFunctions.push(e._properties[n].listen(Pt.PROPERTY_VALUE_CHANGE,r))},r.prototype.removeListenerOnSleep=function(e){t(!this.entity.sleeping,"Cannot call removeListenerOnSleep in sleep mode."),this._listenRemoveFunctions.push(e)},r.prototype.toJSON=function(){return Object.assign(n.prototype.toJSON.call(this),{n:this.componentClass.componentName,cid:this._componentId})},r.create=function(e,n){void 0===n&&(n={});var r=tn.get(e);t(r);var i=new r;return i.initWithPropertyValues(n),i},r.createWithInheritedComponentData=function(t){var e=new t.componentClass;e._componentId=t.componentId;var n=t.properties.map(function(t){return t.clone()});return e.initWithChildren(n),e},r.register=function(n){var i=void 0===n?{}:n,o=i.name,a=void 0===o?"":o,s=i.description,p=void 0===s?"":s,l=i.category,c=void 0===l?"Other":l,h=i.icon,u=void 0===h?"fa-puzzle-piece":h,d=i.color,f=void 0===d?"":d,y=i.properties,m=void 0===y?[]:y,v=i.requirements,g=void 0===v?["Transform"]:v,C=i.children,T=void 0===C?[]:C,_=i.parentClass,w=void 0===_?r:_,E=i.prototype,b=void 0===E?{}:E,P=i.allowMultiple,S=void 0===P||P;i.requiresInitWhenEntityIsEdited;t(a,"Component must have a name."),t(a[0]>="A"&&a[0]<="Z","Component name must start with capital letter."),t(!tn.has(a),"Duplicate component class "+a),Object.keys(b).forEach(function(e){r.reservedPrototypeMembers.has(e)&&t(!1,"Component prototype can not have a reserved member: "+e)}),g.indexOf("Transform")<0&&g.push("Transform");var I=a.split("").reduce(function(t,e){return t+e.charCodeAt(0)},0),N=b.constructor,x=b.delete;delete b.constructor,delete b.delete;var A=function(t){function n(){for(var e=arguments,n=[],r=0;r<arguments.length;r++)n[r]=e[r];var i=t.apply(this,n)||this;return N&&N.call(i),i}return e(n,t),n.prototype.delete=function(){return!!t.prototype.delete.call(this)&&(x&&x.call(this),!0)},n.componentName=a,n.category=c,n.requirements=g,n.children=T,n.description=p,n.allowMultiple=S,n.icon=u,n.color=f||"hsla("+I%360+", 40%, 60%, 1)",n}(w);return m.forEach(function(e){t(!r.reservedPropertyNames.has(e.name),"Can not have property called "+e.name)}),$t.defineProperties(A,m),b._name=a,A.prototype.componentClass=A,Object.assign(A.prototype,b),tn.set(A.componentName,A),A},r.reservedPropertyNames=new Set(["id","constructor","delete","children","entity","env","init","preInit","sleep","toJSON","fromJSON"]),r.reservedPrototypeMembers=new Set(["id","children","entity","env","_preInit","_init","_sleep","_forEachChildComponent","_properties","_componentData","toJSON","fromJSON"]),r}($t);Jt.registerSerializable(nn,"com",function(t){var e=new(tn.get(t.n))(t.id);return e._componentId=t.cid||null,e});var rn=function(n){function r(e,r,i){void 0===i&&(i="");var o=n.call(this,r)||this;return o.name=e,o.componentClass=tn.get(o.name),t(o.componentClass,"Component class not defined: "+e),o.componentClass.allowMultiple||(i="_"+e),o.componentId=i||l("cid",10),o}return e(r,n),r.prototype.makeUpAName=function(){return this.name},r.prototype.addChild=function(t){if("prp"===t.threeLetterType&&!t.propertyType){if(!this.componentClass._propertyTypesByName[t.name])return void(kt?console.log("Property of that name not defined",this.id,t,this):console.log("Property of that name not defined",this.id,this.name,t.name));t.setPropertyType(this.componentClass._propertyTypesByName[t.name])}return n.prototype.addChild.call(this,t),this},r.prototype.clone=function(t){var e=t&&t.cloneComponentId?this.componentId:"",n=new r(this.name,!1,e),i=[];return this.forEachChild(null,function(t){i.push(t.clone())}),n.initWithChildren(i),this._state|=Jt.STATE_CLONE,n},r.prototype.toJSON=function(){return Object.assign(n.prototype.toJSON.call(this),{cid:this.componentId,n:this.name})},r.prototype.getInheritedProperties=function(t){void 0===t&&(t=0);var e={},n=this.getParentComponentData();return n&&n.getInheritedProperties(t+1).forEach(function(t){return e[t.name]=t}),this.getChildren("prp").forEach(function(n){e[n.name]=0===t?n:n.clone(!0)}),0===t?this.componentClass._propertyTypes.map(function(t){return e[t.name]||t.createProperty({skipSerializableRegistering:!0})}):Object.keys(e).map(function(t){return e[t]})},r.prototype.getParentComponentData=function(){var t=this;if(!this._parent)return null;for(var e=this._parent.getParentPrototype();e;){var n=e.findChild("cda",function(e){return e.componentId===t.componentId});if(n)return n;e=e.getParentPrototype()}return null},r.prototype.getPropertyOrCreate=function(t){var e=this.findChild("prp",function(e){return e.name===t});return e||(e=this.componentClass._propertyTypesByName[t].createProperty(),this.addChild(e)),e},r.prototype.getProperty=function(t){return this.findChild("prp",function(e){return e.name===t})},r.prototype.setValue=function(t,e){return this.getPropertyOrCreate(t).value=e,this},r.prototype.getValue=function(t){var e=this.getProperty(t);if(e)return e.value;var n=this.getParentComponentData();return n?n.getValue(t):this.componentClass._propertyTypesByName[t].initialValue},r.prototype.createComponent=function(){var t=this.getInheritedProperties(),e={};t.forEach(function(t){e[t.name]=t.value});var n=nn.create(this.name,e);return n._componentId=this.componentId,n},r}(Jt);Jt.registerSerializable(rn,"cda",function(t){return new rn(t.n,t.id,t.cid)});var on={};Gt.addSerializable=z,Gt.removeSerializable=H;var an="entity is already dead",sn=function(n){function r(t){var e=n.call(this,t)||this;return e.components=new Map,e.sleeping=!1,e.prototype=null,e.localMaster=!0,U("Create object"),e}return e(r,n),r.prototype.makeUpAName=function(){return this.prototype?this.prototype.makeUpAName():"Entity"},r.prototype.getComponent=function(e){t(this._alive,an);var n=this.components.get(e);return void 0!==n?n[0]:null},r.prototype.getComponents=function(e){return t(this._alive,an),this.components.get(e)||[]},r.prototype.getListOfAllComponents=function(){var t=[];return this.components.forEach(function(e,n){t.push.apply(t,e)}),t},r.prototype.clone=function(t){void 0===t&&(t=null);var e=new r;e.prototype=this.prototype.clone(),e.sleeping=this.sleeping;var n=[];this.components.forEach(function(t,e){n.push.apply(n,t.map(function(t){return t.clone()}))}),e.addComponents(n,{fullInit:!1}),t&&t.addChild(e);var i=[];return this.forEachChild("ent",function(t){i.push(t.clone(e))}),e.sleeping||r.initComponents(n),e},r.prototype.addComponents=function(e,n){var i=this,o=(void 0===n?{}:n).fullInit,a=void 0===o||o;t(this._alive,an),t(Array.isArray(e),"Parameter is not an array."),r.ENTITY_CREATION_DEBUGGING&&console.log("add components for",this.makeUpAName());for(var s=0;s<e.length;s++){var p=e[s];(i.components.get(p._name)||i.components.set(p._name,[]).get(p._name)).push(p),p.entity=i,p._parent=i,p.setRootType(i._rootType)}return this.sleeping||(r.preInitComponents(e),a&&r.initComponents(e)),this},r.preInitComponents=function(e){r.ENTITY_CREATION_DEBUGGING&&console.log("preInit components for",e[0].entity.makeUpAName());for(var n=0;n<e.length;n++)t(!e[n].entity.sleeping,"entity can not be sleeping when pre initing components"),e[n]._preInit()},r.initComponents=function(e){r.ENTITY_CREATION_DEBUGGING&&console.log("init "+e.length+" components for",e[0].entity.makeUpAName());for(var n=0;n<e.length;n++)t(!e[n].entity.sleeping,"entity can not be sleeping when initing components"),e[n]._init()},r.makeComponentsSleep=function(t){for(var e=0;e<t.length;e++)t[e]._sleep()},r.deleteComponents=function(t){for(var e=0;e<t.length;e++)t[e].delete()},r.prototype.sleep=function(){return t(this._alive,an),!this.sleeping&&(this.components.forEach(function(t,e){return r.makeComponentsSleep(t)}),this.forEachChild("ent",function(t){return t.sleep()}),this.sleeping=!0,!0)},r.prototype.wakeUp=function(){return t(this._alive,an),!!this.sleeping&&(this.sleeping=!1,this.components.forEach(function(t,e){return r.preInitComponents(t)}),this.components.forEach(function(t,e){return r.initComponents(t)}),this.forEachChild("ent",function(t){return t.wakeUp()}),!0)},r.prototype.resetComponents=function(){var t=this;this.prototype.getInheritedComponentDatas().forEach(function(e){var n=t.getComponents(e.componentClass.componentName).find(function(t){return t._componentId===e.componentId});e.properties.forEach(function(t){n._properties[t.name].valueEquals(t.value)||(n[t.name]=t.value)})}),this.forEachChild("ent",function(t){return t.resetComponents()})},r.prototype.delete=function(){return t(this._alive,an),this.sleep(),!!n.prototype.delete.call(this)&&(this.components.forEach(function(t,e){return r.deleteComponents(t)}),this.components.clear(),U("Destroy object"),!0)},r.prototype.deleteComponent=function(e){var n=this.getComponents(e.constructor.componentName),r=n.indexOf(e);return t(r>=0),this.sleeping||e._sleep(),e.delete(),n.splice(r,1),this},r.prototype.setRootType=function(t){if(this._rootType!==t){r.ENTITY_CREATION_DEBUGGING&&console.log("entity added to tree",this.makeUpAName()),n.prototype.setRootType.call(this,t);var e;this.components.forEach(function(n,r){for(e=0;e<n.length;++e)n[e].setRootType(t)})}},r.prototype.toJSON=function(){t(this._alive,an);var e=[];return this.components.forEach(function(t){t.forEach(function(t){e.push(t.toJSON())})}),Object.assign(n.prototype.toJSON.call(this),{c:e,proto:this.prototype.id})},Object.defineProperty(r.prototype,"position",{get:function(){return this.getComponent("Transform").position},set:function(t){this.getComponent("Transform").position=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"Transform",{get:function(){return this.getComponent("Transform")},enumerable:!0,configurable:!0}),r.ENTITY_CREATION_DEBUGGING=!1,r}(Jt);Jt.registerSerializable(sn,"ent",function(t){sn.ENTITY_CREATION_DEBUGGING&&console.log("creating entity from json",t);var e=new sn(t.id);return e.prototype=W(t.proto),sn.ENTITY_CREATION_DEBUGGING&&console.log("created entity from json",e),t.comp&&e.addComponents((t.c||t.comp).map(Jt.fromJSON)),e});var pn=[Zt("name","No name",Zt.string)],ln=function(n){function r(t,e){var r=n.call(this,t)||this;return r.previouslyCreatedEntity=null,r.siblingId=e||l("",5),r}return e(r,n),r.prototype.makeUpAName=function(){return this.name||"Prototype"},r.prototype.addChild=function(e){return e instanceof rn&&!e.componentClass.allowMultiple&&t(null===this.findChild("cda",function(t){return t.componentId===e.componentId}),"Can't have multiple "+e.name+" components. See Component.allowMultiple"),n.prototype.addChild.call(this,e),this},r.prototype.getParentPrototype=function(){return this._parent&&"prt"===this._parent.threeLetterType?this._parent:null},r.prototype.getPrototypePath=function(t){for(var e="";t&&t!==this;)e=e?t.siblingId+"/"+e:t.siblingId,t=t.getParent();return t===this?e:null},r.prototype.getPrototypeByPath=function(t){if("string"!=typeof t)return null;for(var e=t.split("/").filter(Boolean),n=this,r=this,i=0,o=e;i<o.length;i++){var a=o[i],s=function(t){if(!(n=n.findChild(r.threeLetterType,function(e){return e.siblingId===t})))return{value:null}}(a);if("object"==typeof s)return s.value}return n},r.prototype.getInheritedComponentDatas=function(t){void 0===t&&(t=null);for(var e=q(this,this,t),n=Object.keys(e).map(function(t){return e[t]}),r=null,i=0;i<n.length;++i)r=n[i],r.properties=r.componentClass._propertyTypes.map(function(t){return r.propertyHash[t.name]||t.createProperty({skipSerializableRegistering:!0})}),delete r.propertyHash;return n.sort(Y)},r.prototype.hasComponentData=function(t){if(this.findChild("cda",function(e){return e.name===t}))return!0;var e=this.getParentPrototype();return!!e&&e.hasComponentData(t)},r.prototype.createAndAddPropertyForComponentData=function(e,n,r){var i=e.componentClass._propertyTypesByName[n];t(i,"Invalid propertyName",n,e);var o=this.findChild("cda",function(t){return t.componentId===e.componentId}),a=!1;o||(console.log("no component data. create one",this,e),o=new rn(e.componentClass.componentName,!1,e.componentId),a=!0);var s=o.findChild("prp",function(t){return t.name===n});return s?(s.value=r,s):(s=i.createProperty({value:r}),o.addChild(s),a&&this.addChild(o),s)},r.prototype.findComponentDataByComponentId=function(t,e){void 0===e&&(e=!1);var n=this.findChild("cda",function(e){return e.componentId===t});if(n)return n;if(e){var r=this.getParentPrototype();if(r)return r.findComponentDataByComponentId(t,e)}return null},
r.prototype.getOwnComponentDataOrInherit=function(t){var e=this.findComponentDataByComponentId(t,!1);if(!e){var n=this.findComponentDataByComponentId(t,!0);if(!n)return null;e=new rn(n.name,!1,t),this.addChild(e)}return e},r.prototype.findOwnProperty=function(t,e){var n=this.findComponentDataByComponentId(t);return n?n.getProperty(e):null},r.prototype.createEntity=function(t,e){void 0===e&&(e=!1);var n=new sn,r=this.getInheritedComponentDatas(),i=r.map(nn.createWithInheritedComponentData);return n.addComponents(i,{fullInit:!1}),n.prototype=this,t&&t.addChild(n),sn.ENTITY_CREATION_DEBUGGING&&console.log("create entity",this.makeUpAName()),this.forEachChild("epr",function(t){return t.createEntity(n,!0)}),this.previouslyCreatedEntity=n,sn.initComponents(i),e||xt.dispatch("new entity created",n),n},r.prototype.getValue=function(t,e){var n=this.findComponentDataByComponentId(t,!0);return n?n.getValue(e):void 0},r.prototype.countEntityPrototypes=function(t){var e=this;void 0===t&&(t=!1);var n=0,r=new Set;if("prt"!==this.threeLetterType)return{entityPrototypeCount:n,levelIds:r};for(var i=De.getChildren("lvl"),o=i.length-1;o>=0;o--){for(var a=i[o].getChildren("epr"),s=!1,p=a.length-1;p>=0;p--)a[p].prototype===e&&(n++,s=!0);s&&r.add(i[o].id)}return t&&this.forEachChild("prt",function(t){var e=t.countEntityPrototypes(!0);n+=e.entityPrototypeCount,e.levelIds.forEach(function(t){return r.add(t)})}),{entityPrototypeCount:n,levelIds:r}},r.prototype.getEntityPrototypesThatUseThisPrototype=function(){var t=this,e=[],n=new Set;if("prt"!==this.threeLetterType&&"pfa"!==this.threeLetterType)return{entityPrototypes:e,levels:n};for(var r=De.getChildren("lvl"),i=r.length-1;i>=0;i--)!function(i){var o=!1;r[i].forEachChild("epr",function(n){n.prototype===t&&(e.push(n),o=!0)},!0),o&&n.add(r[i])}(i);return this.forEachChild(this.threeLetterType,function(t){var r=t.getEntityPrototypesThatUseThisPrototype();e.push.apply(e,e),r.levels.forEach(function(t){return n.add(t)})}),{entityPrototypes:e,levels:n}},r.prototype.delete=function(){var t=this,e=this.getRoot();return!!n.prototype.delete.call(this)&&("prt"===this.threeLetterType&&"gam"===e.threeLetterType&&e.forEachChild("lvl",function(e){for(var n=e.getChildren("epr"),r=n.length-1;r>=0;r--)n[r].prototype===t&&e.deleteChild(n[r],r)}),this.previouslyCreatedEntity=null,!0)},r.prototype.clone=function(){var t=n.prototype.clone.call(this);return t.siblingId=this.siblingId,t},r.prototype.toJSON=function(){var t=n.prototype.toJSON.call(this);return t.si=this.siblingId,t},r.create=function(t){return(new r).initWithPropertyValues({name:t})},r}($t);$t.defineProperties(ln,pn),Jt.registerSerializable(ln,"prt",function(t){return new ln(t.id,t.si)});var cn=function(n){function r(t,e){var r=n.call(this,t,e)||this;return r.prototype=null,r}return e(r,n),r.prototype.makeUpAName=function(){var t=this.findChild("prp",function(t){return"name"===t.name});return t&&t.value?t.value:this.prototype?this.prototype.makeUpAName():"EntityPrototype"},r.prototype.getTransform=function(){return this.findChild("cda",function(t){return"Transform"===t.name})},r.prototype.getParentPrototype=function(){return this.prototype||null},r.prototype.clone=function(){var t=new r(null,this.siblingId);t.prototype=this.prototype;var e=t.id,n=[];return this.forEachChild(null,function(t){if("prp"===t.threeLetterType&&"name"===t.name){var r=new qt({value:t.propertyType.type.clone(t.value),name:t.name,propertyType:t.propertyType,predefinedId:e+"_n"});n.push(r)}else if("cda"===t.threeLetterType&&"Transform"===t.name){var i=new rn("Transform",e+"_t"),o=i.componentClass._propertyTypesByName.position.createProperty({value:t.findChild("prp",function(t){return"position"===t.name}).value,predefinedId:e+"_p"});i.addChild(o);var a=t.findChild("prp",function(t){return"scale"===t.name});if(a){var s=i.componentClass._propertyTypesByName.scale.createProperty({value:a.value,predefinedId:e+"_s"});i.addChild(s)}var p=t.findChild("prp",function(t){return"angle"===t.name});if(p){var l=i.componentClass._propertyTypesByName.angle.createProperty({value:p.value,predefinedId:e+"_a"});i.addChild(l)}n.push(i)}else"cda"===t.threeLetterType?n.push(t.clone({cloneComponentId:!0})):n.push(t.clone())}),t.initWithChildren(n),this._state|=Jt.STATE_CLONE,t},r.prototype.toJSON=function(){var t=this,e=this.getTransform(),n={id:this.id,si:this.siblingId};this.prototype&&(n.t=this.prototype.id);var r=[];this._children.forEach(function(t){r.push(t)});var i=[].concat.apply([],r).filter(function(n){return n!==e&&n!==t._properties.name});i.length>0&&(n.c=i.map(function(t){return t.toJSON()}));var o=Zt.float().toJSON,a=function(t){"name"===t.name?t.value&&(n.n=t.value):"position"===t.name?n.p=t.type.toJSON(t.value):"scale"===t.name?t.value.isEqualTo(new Xt(1,1))||(n.s=t.type.toJSON(t.value)):"angle"===t.name&&0!==t.value&&(n.a=o(t.value))};return a(this._properties.name),e.getChildren("prp").forEach(a),n},r.prototype.spawnEntityToScene=function(t,e){return t?(e&&(this.getTransform().getPropertyOrCreate("position").value=e),this.createEntity(t)):null},r.prototype.replaceWithVersionThatIsDetachedFromPrototype=function(){var t=new r,e=this.getInheritedComponentDatas(),n=e.map(function(t){return new rn(t.componentClass.componentName,null,t.componentId).initWithChildren(t.properties.map(function(t){return t.clone()}))});t.initWithChildren(n),t.name=this.makeUpAName();var i=this.getParent();return this.delete(),i&&i.addChild(t),t},r.prototype.replaceWithVersionThatIsAttachedToPrototype=function(t){var e=r.createFromPrototype(t),n=this.getTransform(),i=e.getTransform();i.componentClass._propertyTypes.forEach(function(t){i.setValue(t.name,n.getValue(t.name))}),e.name=this.name;var o=this.getParent();return this.delete(),o&&o.addChild(e),e},r.prototype.setRootType=function(e){if(this._rootType!==e)return t(this.getTransform(),"EntityPrototype must have a Transform"),n.prototype.setRootType.call(this,e),this},r.createFromPrototype=function(e){if("pfa"===e.threeLetterType)return e.createEntityPrototype();console.log("This isn't used anymore because we don't anymore have \"Types\" which are plain Prototypes");var n=new r;n.prototype=e;var i=n.id;e.findChild("cda",function(t){return"Transform"===t.name})&&t(!1,"Prototype (prt) can not have a Transform component");var o=Z(i),a=X(i);return n.initWithChildren([o,a]),t(n.getTransform(),"EntityPrototype must have a Transform"),n},r.create=function(t,e){void 0===t&&(t="Empty"),void 0===e&&(e=new Xt(0,0));var n=new r,i=X(n.id);i.setValue("position",e);var o=Z(n.id,t);return n.initWithChildren([o,i]),n},Object.defineProperty(r.prototype,"position",{get:function(){return this.getTransform().findChild("prp",function(t){return"position"===t.name}).value},set:function(t){this.getTransform().findChild("prp",function(t){return"position"===t.name}).value=t},enumerable:!0,configurable:!0}),r}(ln);Jt.registerSerializable(cn,"epr",function(t){var e=new cn(t.id,t.si);e.prototype=t.t?W(t.t):null,t.t&&!e.prototype&&console.error("EntityPrototype "+t.id+" thought it had a prototype or prefab "+t.t+" but it was not found.");var n=t.id+"_n",r=t.id+"_t",i=t.id+"_p",o=t.id+"_s",a=t.id+"_a",s=ln._propertyTypesByName.name.createProperty({value:void 0===t.n?"":t.n,predefinedId:n}),p=new rn("Transform",r),l=tn.get("Transform"),c=l._propertyTypesByName.position.createProperty({value:Xt.fromObject(t.p),predefinedId:i});p.addChild(c);var h=l._propertyTypesByName.scale.createProperty({value:t.s&&Xt.fromObject(t.s)||new Xt(1,1),predefinedId:o});p.addChild(h);var u=l._propertyTypesByName.angle.createProperty({value:t.a||0,predefinedId:a});return p.addChild(u),e.initWithChildren([s,p]),e});var hn=function(n){function r(t,e){return n.call(this,t,e)||this}return e(r,n),r.prototype.makeUpAName=function(){var t=this.findChild("prp",function(t){return"name"===t.name});return t&&t.value||"Prefab"},r.prototype.createEntity=function(){return this.createEntityPrototype().createEntity()},r.prototype.getParentPrototype=function(){return null},r.createFromPrototype=function(t){var e=t.getInheritedComponentDatas(),n=e.map(function(t){var e=new rn(t.componentClass.componentName,null,t.componentId);return e.initWithChildren(t.properties.map(function(t){return t.clone()})),e});n.push(t._properties.name.clone()),t.forEachChild("epr",function(t){var e=r.createFromPrototype(t);n.push(e)});var i=new r(null,t.siblingId).initWithChildren(n);return i.name=t.name||t.prototype&&t.prototype.makeUpAName()||"Prefab",i},r.prototype.createEntityPrototype=function(){var e=new cn(null,this.siblingId);e.prototype=this;var n=e.id,r=this.findChild("cda",function(t){return"Transform"===t.name});r||t(!1,"Prefab (pfa) must have a Transform component");var i=Z(n),o=X(n);o.setValue("position",r.getValue("position")),o.setValue("scale",r.getValue("scale")),o.setValue("angle",r.getValue("angle"));var a=[i,o];return this.forEachChild("pfa",function(t){var e=t.createEntityPrototype();a.push(e)}),e.initWithChildren(a),t(e.getTransform(),"EntityPrototype must have a Transform"),e},r}(ln);Jt.registerSerializable(hn,"pfa",function(t){return new hn(t.id,t.si)});var un=[Zt("name","No name",Zt.string)],dn=function(t){function n(e){return t.call(this,e)||this}return e(n,t),n.prototype.createScene=function(t){return void 0===t&&(t=null),t||new $e,Ke.loadLevel(this),Ke},n.prototype.isEmpty=function(){return 0===this.getChildren("epr").length},n}($t);$t.defineProperties(dn,un),Jt.registerSerializable(dn,"lvl"),nn.register({name:"Transform",icon:"fa-dot-circle-o",allowMultiple:!1,properties:[Zt("position",new Xt(0,0),Zt.vector),Zt("scale",new Xt(1,1),Zt.vector),Zt("angle",0,Zt.float,Zt.float.modulo(0,2*Math.PI),Zt.flagDegreesInEditor)],prototype:{constructor:function(){this.layer=this.scene.layers.main},preInit:function(){this.container=new Se.Container,this.container._debug=this.entity.makeUpAName()+" "+this.name,this.container.position.set(this.position.x,this.position.y),this.container.scale.set(this.scale.x,this.scale.y),this.container.rotation=this.angle},init:function(){var t=this,e=this.getParentTransform();e?(e.container.addChild(this.container),e.listen("globalTransformChanged",function(){t.dispatch("globalTransformChanged",t)})):this.layer.addChild(this.container);var n=function(){t.dispatch("globalTransformChanged",t)};this.listenProperty(this,"position",function(e){t.container.position.set(e.x,e.y),n()}),this.listenProperty(this,"angle",function(e){t.container.rotation=e,n()}),this.listenProperty(this,"scale",function(e){t.container.scale.set(e.x,e.y),n()})},getParentTransform:function(){if(void 0!==this.parentTransform)return this.parentTransform;var t=this.entity.getParent();return t&&"ent"===t.threeLetterType?this.parentTransform=t.getComponent("Transform"):this.parentTransform=null,this.parentTransform},getGlobalPosition:function(){return Xt.fromObject(this.layer.toLocal(fn,this.container,yn))},setGlobalPosition:function(t){this.position=t.set(this.container.parent.toLocal(t,this.layer,yn))},getLocalPosition:function(t){return Xt.fromObject(this.container.parent.toLocal(t,this.layer,yn))},getGlobalAngle:function(){for(var t=this.angle,e=this.getParentTransform();e;)t+=e.angle,e=e.getParentTransform();return t},setGlobalAngle:function(t){var e=this.getGlobalAngle(),n=t-e;this.angle=(this.angle+n+2*Math.PI)%(2*Math.PI)},getGlobalScale:function(){for(var t=this.scale.clone(),e=this.entity.getParent();e&&"ent"===e.threeLetterType;)t.multiply(e.Transform.scale),e=e.getParent();return t},sleep:function(){this.container.destroy(),this.container=null,delete this.parentTransform}}});var fn=new Se.Point,yn=new Se.Point;nn.register({name:"TransformVariance",category:"Logic",description:"Adds random factor to object's transform/orientation.",icon:"fa-dot-circle-o",allowMultiple:!1,properties:[Zt("positionVariance",new Xt(0,0),Zt.vector),Zt("scaleVariance",new Xt(0,0),Zt.vector),Zt("angleVariance",0,Zt.float,Zt.float.range(0,Math.PI),Zt.flagDegreesInEditor)],prototype:{onStart:function(){this.positionVariance.isZero()||(this.Transform.position=this.Transform.position.add(this.positionVariance.clone().multiplyScalar(2*Math.random()-1))),this.scaleVariance.isZero()||(this.Transform.scale=this.Transform.scale.add(this.scaleVariance.clone().multiplyScalar(Math.random()))),this.angleVariance&&(this.Transform.angle+=this.angleVariance*(2*Math.random()-1))}}}),nn.register({name:"Shape",category:"Graphics",icon:"fa-stop",allowMultiple:!0,description:"Draws shape on the screen.",properties:[Zt("type","rectangle",Zt.enum,Zt.enum.values("rectangle","circle","convex")),Zt("radius",20,Zt.float,Zt.visibleIf("type",["circle","convex"])),Zt("size",new Xt(20,20),Zt.vector,Zt.visibleIf("type","rectangle")),Zt("points",3,Zt.int,Zt.int.range(3,16),Zt.visibleIf("type","convex")),Zt("topPointDistance",.5,Zt.float,Zt.float.range(.001,1),Zt.visibleIf("type","convex"),"Only works with at most 8 points"),Zt("fillColor",new Kt(222,222,222),Zt.color),Zt("borderColor",new Kt(255,255,255),Zt.color),Zt("borderWidth",1,Zt.float,Zt.float.range(0,30))],prototype:{graphicsContainPointFunc:null,init:function(){var t=this;this.initSprite(),this.Transform.listen("globalTransformChanged",function(t){});var e=function(){t.updateTexture()};["type","radius","size","fillColor","borderColor","borderWidth","points","topPointDistance"].forEach(function(n){t.listenProperty(t,n,e)})},containsPoint:function(t){return!!this.graphicsContainPointFunc&&this.graphicsContainPointFunc(t)},initSprite:function(){var t=this,e=this.getTextureAndAnchor();this.sprite=new Se.Sprite(e.texture),this.sprite.anchor.set(e.anchor.x,e.anchor.y),this.graphicsContainPointFunc=e.containsPoint,this.sprite.selectableEntityOfSprite=this.entity,this.sprite.selectableEntityHitTest=function(e,n,r){var i=e.toLocal(n,r);return t.containsPoint(i)},this.Transform.container.addChild(this.sprite)},updateTexture:function(){var t=this.getTextureAndAnchor();this.graphicsContainPointFunc=t.containsPoint,this.sprite.texture=t.texture,this.sprite.anchor.set(t.anchor.x,t.anchor.y)},getTextureAndAnchor:function(){var t=this.createPropertyHash(),e=w(t);if(!e){e=E(this.createGraphics(),t)}return e},createGraphics:function(){var t=new Xt(1,1),e=new Se.Graphics;if("rectangle"===this.type){var n=-this.size.x/2*t.x,r=-this.size.y/2*t.y,i=this.size.x*t.x,o=this.size.y*t.y;e.lineStyle(this.borderWidth,this.borderColor.toHexNumber(),1),e.beginFill(this.fillColor.toHexNumber()),e.drawRect(n,r,i,o),e.endFill()}else if("circle"===this.type){var a=(t.x+t.y)/2;e.lineStyle(this.borderWidth,this.borderColor.toHexNumber(),1),e.beginFill(this.fillColor.toHexNumber()),e.drawCircle(0,0,this.radius*a),e.endFill()}else if("convex"===this.type){var s=this.getConvexPoints(Se.Point,!1);s.push(s[0]),e.lineStyle(this.borderWidth,this.borderColor.toHexNumber(),1),e.beginFill(this.fillColor.toHexNumber()),e.drawPolygon(s),e.endFill()}return e},getConvexPoints:function(t,e){var n=this;void 0===t&&(t=Xt),void 0===e&&(e=!0);var r,i,o=2*Math.PI/this.points,a=.5!==this.topPointDistance&&this.points<=8;if(a){var s=Math.PI-o,p=2*Math.sin(o/2),l=1-p*Math.cos(s/2);3===this.points?(r=.2,i=5):8===this.points?(r=l,i=3):(r=l,i=5)}for(var c=[],h=0,u=0;u<this.points;++u){var d=Math.sin(h)*n.radius,f=Math.cos(h)*n.radius;a&&0===u&&(n.topPointDistance>.5?f*=1+(n.topPointDistance-.5)*(i-1):f*=2*n.topPointDistance*(1-r)+r),c.push(new t(d,-f)),h+=o}if(a){var y=c.reduce(function(t,e){return t+e.y},0)/this.points;c.forEach(function(t){return t.y-=y})}if(e){var m=this.Transform.getGlobalScale();1===m.x&&1===m.y||c.forEach(function(t){t.x*=m.x,t.y*=m.y})}return c},sleep:function(){this.sprite.destroy(),this.sprite=null,this.graphicsContainPointFunc=null}}}),nn.register({name:"Sprite",category:"Graphics",icon:"fa-stop",allowMultiple:!0,description:"Draws a sprite on the screen.",properties:[Zt("resource","character.png",Zt.enum,Zt.enum.values("character.png","profile.png","sprite.png")),Zt("anchor",new Xt(.5,.5),Zt.vector)],prototype:{init:function(){var t=this;this.initSprite(),this.listenProperty(this,"anchor",function(e){t.sprite&&t.sprite.anchor.set(t.anchor.x,t.anchor.y)}),this.listenProperty(this,"resource",function(e){t.initSprite()})},initSprite:function(){this.sprite&&this.sprite.destroy(),this.sprite=Se.Sprite.fromImage("/img/"+this.resource),this.sprite.anchor.set(this.anchor.x,this.anchor.y),this.sprite.selectableEntityOfSprite=this.entity,this.sprite.selectableEntityHitTest=b,this.Transform.container.addChild(this.sprite)},sleep:function(){this.sprite.destroy(),this.sprite=null}}}),nn.register({name:"Spawner",category:"Logic",description:"Spawns types to world.",properties:[Zt("typeName","",Zt.string),Zt("trigger","start",Zt.enum,Zt.enum.values("start","interval")),Zt("interval",10,Zt.float,Zt.float.range(.1,1e6),Zt.visibleIf("trigger","interval"),"Interval in seconds")],prototype:{constructor:function(){this.lastSpawn=0},init:function(){this.lastSpawn=this.scene.time},onStart:function(){"start"===this.trigger&&this.spawn()},onUpdate:function(){this.scene.time>this.lastSpawn+this.interval&&this.spawn()},onDrawHelper:function(t){this.Transform.position.x,this.Transform.scale.x,this.Transform.position.y,this.Transform.scale.y,this.Transform.scale.x,this.Transform.scale.y;t.save(),t.fillStyle="blue",t.strokeStyle="white",t.lineWidth=1,t.font="40px Font Awesome 5 Free",t.textAlign="center",t.fillText("",this.Transform.position.x+2,this.Transform.position.y),t.strokeText("",this.Transform.position.x+2,this.Transform.position.y),t.restore()},spawn:function(){var t=this,e=this.game.findChild("prt",function(e){return e.name===t.typeName},!0);if(e){var n=cn.createFromPrototype(e);n.spawnEntityToScene(this.scene,this.Transform.position),n.delete(),this.lastSpawn=this.scene.time}}}}),nn.register({name:"Trigger",description:"When _ then _.",category:"Logic",allowMultiple:!0,properties:[Zt("trigger","playerComesNear",Zt.enum,Zt.enum.values("playerComesNear")),Zt("radius",40,Zt.float,Zt.float.range(0,1e3),Zt.visibleIf("trigger","playerComesNear")),Zt("action","win",Zt.enum,Zt.enum.values("win"))],prototype:{preInit:function(){this.storeProp="__Trigger_"+this._componentId},onUpdate:function(){var t=this;if("playerComesNear"===this.trigger){var e=this.scene.getComponents("CharacterController"),n=[];e.forEach(function(t){return n.push(t.entity)});for(var r=this.radius*this.radius,i=this.Transform.getGlobalPosition(),o=0;o<n.length;++o)if(n[o].Transform.getGlobalPosition().distanceSq(i)<r){if(!n[o][t.storeProp]&&!1!==t.launchTrigger(n[o]))break;n[o][t.storeProp]=!0}else n[o][t.storeProp]=!1}},launchTrigger:function(t){return"win"===this.action&&(this.scene.win(),!1)}}});var mn=.02,vn=1/mn,gn={dynamic:ke.Body.DYNAMIC,kinematic:ke.Body.KINEMATIC,static:ke.Body.STATIC},Cn=ke.Body.SLEEPING,Tn=ke.Body.STATIC;nn.register({name:"Physics",category:"Dynamics",description:'Forms physical rules for <span style="color: #84ce84;">Shapes</span>.',icon:"fa-stop",allowMultiple:!1,properties:[Zt("type","dynamic",Zt.enum,Zt.enum.values("dynamic","static")),Zt("density",1,Zt.float,Zt.float.range(0,100),Zt.visibleIf("type","dynamic")),Zt("drag",.1,Zt.float,Zt.float.range(0,1),Zt.visibleIf("type","dynamic")),Zt("rotationalDrag",.1,Zt.float,Zt.float.range(0,1),Zt.visibleIf("type","dynamic")),Zt("bounciness",0,Zt.float,Zt.float.range(0,1)),Zt("friction",.1,Zt.float,Zt.float.range(0,1))],requirements:["Shape"],requiresInitWhenEntityIsEdited:!0,prototype:{inited:!1,init:function(){var t=this;this.inited=!0;for(var e=function(e){return function(n){!t.updatingOthers&&t.body&&(e(n),"dynamic"===t.type&&t.body.wakeUp())}},n=this.entity.getComponents("Shape"),r=["type","size","radius","points","topPointDistance"],i=0;i<n.length;++i)!function(i){r.forEach(function(r){t.listenProperty(n[i],r,e(function(){return t.updateShape()}))})}(i);this.listenProperty(this.Transform,"position",e(function(e){t.body.position=K(t.Transform),t.body.updateAABB()})),this.listenProperty(this.Transform,"angle",e(function(e){var n=t.Transform.getGlobalAngle();t.body.angle=n,t.body.updateAABB()})),this.listenProperty(this.Transform,"scale",e(function(e){return t.updateShape()})),this.listenProperty(this,"density",e(function(e){t.body.setDensity(.3*e)})),this.listenProperty(this,"friction",e(function(e){return t.updateMaterial()})),this.listenProperty(this,"drag",e(function(e){return t.body.damping=e})),this.listenProperty(this,"rotationalDrag",e(function(e){t.body.angularDamping=e>.98?1:e,t.body.fixedRotation=1===e,t.body.updateMassProperties()})),this.listenProperty(this,"type",e(function(e){t.body.type=e[t.type],t.entity.sleep(),t.entity.wakeUp()})),this.listenProperty(this,"bounciness",e(function(e){return t.updateMaterial()})),this._rootType&&this.createBody()},onStart:function(){this.body.position=K(this.Transform),this.body.angle=this.Transform.getGlobalAngle(),this.updateShape()},createBody:function(){t(!this.body),this.body=new ke.Body({type:gn[this.type],position:[0,0],angle:0,velocity:[0,0],angularVelocity:0,sleepTimeLimit:.6,sleepSpeedLimit:.3,damping:this.drag,angularDamping:this.rotationalDrag>.98?1:this.rotationalDrag,fixedRotation:1===this.rotationalDrag}),this.body.entity=this.entity,O(this.scene,this.body)},updateShape:function(){var e=this;if(this.body.shapes.length>0){t(!A(this.scene).stepping);for(var n=this.body.shapes,r=0;r<n.length;++r)n[r].body=null;n.length=0}var i=this.entity.getComponents("Shape"),o=this.Transform.getGlobalScale();i.forEach(function(t){var n;if("rectangle"===t.type)n=new ke.Box({width:t.size.x*mn*o.x,height:t.size.y*mn*o.y});else if("circle"===t.type){var r=(o.x+o.y)/2;n=new ke.Circle({radius:t.radius*mn*r})}else"convex"===t.type&&(n=new ke.Convex({vertices:t.getConvexPoints().map(function(t){return[t.x*mn,t.y*mn]})}));n&&e.body.addShape(n)}),this.updateMass(),this.updateMaterial()},updateMaterial:function(){var t=L(this.scene,{friction:this.friction,restitution:this.bounciness});this.body.shapes.forEach(function(e){return e.material=t})},updateMass:function(){"dynamic"===this.type&&this.body.setDensity(.3*this.density)},setRootType:function(t){return t&&this.inited&&this.createBody(),nn.prototype.setRootType.call(this,t)},onUpdate:function(){var t=this.body;if(t&&t.sleepState!==Cn&&t.type!==Tn){this.updatingOthers=!0;var e=Q(t.position);this.Transform.getGlobalPosition().isEqualTo(e)||this.Transform.setGlobalPosition(e),this.Transform.getGlobalAngle()!==t.angle&&this.Transform.setGlobalAngle(t.angle),this.updatingOthers=!1}},sleep:function(){this.body&&(D(this.scene,this.body),this.body=null),this.inited=!1},getMass:function(){return this.body.mass},applyForce:function(t){this.body.applyForce(t.toArray()),this.body.wakeUp()},setAngularForce:function(t){this.body.angularForce=t,this.body.wakeUp()}}}),nn.register({name:"Lifetime",description:"Set the object to be destroyed after a time period.",category:"Logic",icon:"fa-bars",requirements:["Transform"],properties:[Zt("lifetime",3,Zt.float,Zt.float.range(.01,1e3),"Life time seconds")],parentClass:nn,prototype:{onUpdate:function(){this.scene.time-this.startTime>=this.lifetime&&this.entity&&this.entity.delete()},init:function(){this.startTime=this.scene.time}}}),nn.register({name:"Particles",category:"Graphics",description:"Particle engine gives eye candy.",allowMultiple:!0,properties:[Zt("startColor",new Kt("#68c07f"),Zt.color),Zt("endColor",new Kt("#59abc0"),Zt.color),Zt("alpha",1,Zt.float,Zt.float.range(0,1)),Zt("particleSize",10,Zt.float,Zt.float.range(1,100)),Zt("particleCount",30,Zt.int,Zt.int.range(0,1e4)),Zt("particleLifetime",1,Zt.float,Zt.float.range(.1,10),"in seconds"),Zt("particleHardness",.2,Zt.float,Zt.float.range(0,1)),Zt("blendMode","add",Zt.enum,Zt.enum.values("add","normal")),Zt("spawnType","circle",Zt.enum,Zt.enum.values("circle","rectangle")),Zt("spawnRadius",20,Zt.float,Zt.float.range(0,1e3),Zt.visibleIf("spawnType","circle")),Zt("spawnRandom",.5,Zt.float,Zt.float.range(0,1),Zt.visibleIf("spawnType","circle")),Zt("spawnRect",new Xt(50,50),Zt.vector,Zt.visibleIf("spawnType","rectangle")),Zt("speedToOutside",50,Zt.float,Zt.float.range(-1e3,1e3),Zt.visibleIf("spawnType","circle")),Zt("speed",new Xt(0,0),Zt.vector),Zt("speedRandom",0,Zt.float,Zt.float.range(0,1e3),"Max random velocity to random direction"),Zt("acceleration",new Xt(0,0),Zt.vector),Zt("globalCoordinates",!0,Zt.bool),Zt("followObject",.4,Zt.float,Zt.float.range(0,1),Zt.visibleIf("globalCoordinates",!0))],prototype:{init:function(){var t=this,e=this;this.container=new Se.Container,this.updateTexture(),["particleSize","particleHardness","alpha"].forEach(function(t){e.listenProperty(e,t,function(){e.updateTexture()})}),this.listenProperty(this,"blendMode",function(t){e.particles&&e.particles.forEach(function(e){e.sprite&&(e.sprite.blendMode=_n[t])})}),this.initParticles(),["particleLifetime","particleCount"].forEach(function(t){e.listenProperty(e,t,function(){e.initParticles()})}),this.updateGlobalCoordinatesProperty(),this.listenProperty(this,"globalCoordinates",function(){e.updateGlobalCoordinatesProperty()});for(var n=this.entity;n&&"ent"===n.threeLetterType&&!this.Physics;)t.Physics=n.getComponent("Physics"),n=n.getParent()},updateGlobalCoordinatesProperty:function(){var t=this;this.positionListener&&(this.positionListener(),this.positionListener=null),this.globalCoordinates?(this.particles.forEach(function(e){e.sprite&&(e.sprite.x+=t.container.position.x,e.sprite.y+=t.container.position.y)}),this.container.setParent(this.scene.layers.main)):(this.container.setParent(this.Transform.container),this.particles.forEach(function(e){e.sprite&&(e.sprite.x-=t.container.position.x,e.sprite.y-=t.container.position.y)}))},updateTexture:function(){var t=this;this.texture=et(this.particleSize,.9*this.particleHardness,{r:255,g:255,b:255,a:this.alpha}),this.particles&&this.particles.forEach(function(e){e.sprite&&(e.sprite.texture=t.texture)})},initParticles:function(){var t=this;this.particles&&this.particles.forEach(function(t){t.sprite&&t.sprite.destroy()}),this.particles=[];for(var e=this.particleLifetime/this.particleCount,n=this.scene.time+Math.random()*e,r=0;r<this.particleCount;++r)t.particles.push({alive:!1,nextBirth:n+r*e})},resetParticle:function(t){if(t.vx=this.speed.x,t.vy=this.speed.y,this.speedRandom>0){var e=this.speedRandom*Math.random(),n=Math.random()*Math.PI*2;t.vx+=Math.sin(n)*e,t.vy+=Math.cos(n)*e}if("circle"===this.spawnType){var r=this.spawnRadius;this.spawnRandom>0&&(r=this.spawnRandom*Math.random()*r+(1-this.spawnRandom)*r);var i=Math.random()*Math.PI*2;t.sprite.x=Math.cos(i)*r,t.sprite.y=Math.sin(i)*r,0!==this.speedToOutside&&(t.vx+=Math.cos(i)*this.speedToOutside,t.vy+=Math.sin(i)*this.speedToOutside)}else"rectangle"===this.spawnType&&(t.sprite.x=-this.spawnRect.x/2+Math.random()*this.spawnRect.x,t.sprite.y=-this.spawnRect.y/2+Math.random()*this.spawnRect.y);if(t.age=this.scene.time-t.nextBirth,t.nextBirth+=this.particleLifetime,this.globalCoordinates&&(Xt.fromObject(this.container.toLocal(t.sprite.position,this.Transform.container,t.sprite.position)),this.Physics&&this.Physics.body)){var o=this.Physics.body.velocity;t.vx=t.vx+this.followObject*o[0]/mn,t.vy=t.vy+this.followObject*o[1]/mn}},onUpdate:function(t,e){for(var n,r,i,o,a,s=this,p=this.particleLifetime,l=1/p,c=this.particles,h=this.acceleration.x*t,u=this.acceleration.y*t,d=this.startColor,f=this.endColor,y=0;y<this.particleCount;y++){if(a=c[y],!a.alive){if(!(e>=a.nextBirth))continue;a.sprite=new Se.Sprite(s.texture),a.sprite.blendMode=_n[s.blendMode],a.sprite.anchor.set(.5,.5),a.alive=!0,s.resetParticle(a),s.container.addChild(a.sprite)}n=a.sprite,r=n.transform.position,a.age+=t,o=a.age*l,o>=1?(s.resetParticle(a),o=a.age*l):(a.vx+=h,a.vy+=u,r.x+=a.vx*t,r.y+=a.vy*t),n.tint=function(t){var e=1-t;return 65536*(d.r*e+f.r*t|0)+256*(d.g*e+f.g*t|0)+(d.b*e+f.b*t|0)}(o),n.alpha=$(o),i=tt(o),n.scale.set(i,i)}},sleep:function(){this.particles=null,this.container.destroy(),this.container=null,this.positionListener&&(this.positionListener(),this.positionListener=null)}}});var _n={add:kt?Se.BLEND_MODES.ADD:0,normal:kt?Se.BLEND_MODES.NORMAL:0},wn={};nn.register({name:"CharacterController",description:"Lets user control the object.",category:"Dynamics",allowMultiple:!1,properties:[Zt("type","player",Zt.enum,Zt.enum.values("player","AI")),Zt("keyboardControls","arrows or WASD",Zt.enum,Zt.enum.values("arrows","WASD","arrows or WASD")),Zt("controlType","jumper",Zt.enum,Zt.enum.values("jumper","top down")),Zt("jumpSpeed",300,Zt.float,Zt.float.range(0,1e3),Zt.visibleIf("controlType","jumper")),Zt("jumpAddedToVelocity",.4,Zt.float,Zt.float.range(0,1),Zt.visibleIf("controlType","jumper"),"1 means that jump speed is added to y velocity when object has y velocity."),Zt("breakInTheAir",!0,Zt.bool,Zt.visibleIf("controlType","jumper")),Zt("speed",200,Zt.float,Zt.float.range(0,1e3)),Zt("acceleration",2e3,Zt.float,Zt.float.range(0,1e4)),Zt("breaking",2e3,Zt.float,Zt.float.range(0,1e4))],prototype:{init:function(){var e=this;this.Physics=this.entity.getComponent("Physics"),this.lastJumpTime=0,this.keyListener=R(function(n){"jumper"===e.controlType&&e.scene.playing&&("arrows"===e.keyboardControls?n===Be.up&&e.jump():"WASD"===e.keyboardControls?n===Be.w&&e.jump():"arrows or WASD"===e.keyboardControls?n!==Be.up&&n!==Be.w||e.jump():t(!1,"Invalid CharacterController.keyboardControls"))})},sleep:function(){this.keyListener&&(this.keyListener(),this.keyListener=null)},getInput:function(){return"arrows"===this.keyboardControls?{up:M(Be.up),down:M(Be.down),left:M(Be.left),right:M(Be.right)}:"WASD"===this.keyboardControls?{up:M(Be.w),down:M(Be.s),left:M(Be.a),right:M(Be.d)}:"arrows or WASD"===this.keyboardControls?{up:M(Be.up)||M(Be.w),down:M(Be.down)||M(Be.s),left:M(Be.left)||M(Be.a),right:M(Be.right)||M(Be.d)}:void t(!1,"Invalid CharacterController.keyboardControls")},onUpdate:function(t,e){var n=this.getInput(),r=n.up,i=n.down,o=n.left,a=n.right,s=0,p=0;a&&s++,o&&s--,r&&p--,i&&p++,"top down"===this.controlType?this.moveTopDown(s,p,t):"jumper"===this.controlType&&this.moveJumper(s,p,t)},moveTopDown:function(t,e,n){if(this.Physics){if(this.Physics.body){var r=this.Physics.body.velocity;r[0]=nt(this.calculateNewVelocity(r[0]/mn,t,n),this.speed)*mn,r[1]=nt(this.calculateNewVelocity(r[1]/mn,e,n),this.speed)*mn}}else if(0!==t||0!==e){var i=this.Transform,o=i.position,a=this.speed*n;i.position=new Xt(o.x+t*a,o.y+e*a)}},moveJumper:function(t,e,n){if(!this.Physics||!this.Physics.body)return!1;var r=this.Physics.body.velocity;r[0]=this.calculateNewVelocity(r[0]/mn,t,n)*mn},jump:function(){if(this.scene.time>this.lastJumpTime+.1&&this.checkIfCanJump()){this.lastJumpTime=this.scene.time;var t=this.Physics.body.velocity;if(t[1]>0)t[1]=-this.jumpSpeed*mn;else{for(var e=Xt.fromArray(t),n=A(this.scene).narrowphase.contactEquations,r=this.Physics.body,i=n.length-1;i>=0;--i){var o=n[i];if(o.bodyA===r||o.bodyB===r){var a=Xt.fromArray(o.normalA);o.bodyB===r&&a.multiplyScalar(-1);var s=e.dot(a);s<0&&e.subtract(a.multiplyScalar(s))}}t[1]=e.y*this.jumpAddedToVelocity-this.jumpSpeed*mn}}},checkIfCanJump:function(){if(!this.Physics||"jumper"!==this.controlType)return!1;var t=A(this.scene).narrowphase.contactEquations,e=this.Physics.body;if(!e)return!1;if(e.sleepState===ke.Body.SLEEPING)return!0;for(var n=t.length-1;n>=0;--n){var r=t[n];if(r.bodyA===e||r.bodyB===e){var i=r.normalA[1];if(r.bodyB===e&&(i*=-1),i>.5)return!0}}return!1},calculateNewVelocity:function(t,e,n){if(0!==e)t>=this.speed&&e>0||t<=-this.speed&&e<0||(t+=e*this.acceleration*n,e<0&&t<-this.speed&&(t=-this.speed),e>0&&t>this.speed&&(t=this.speed));else if(0!==t&&("jumper"!==this.controlType||this.breakInTheAir||this.checkIfCanJump())){var r=Math.abs(t);r-=this.breaking*n,r<0&&(r=0),t=t>0?r:-r}return t}}});var En;!function(t){function e(t){var e;try{e=JSON.parse(t)}catch(t){e={}}return e.animations=e.animations||[],e}t.DEFAULT_FRAME_COUNT=24,t.DEFAULT_FRAME_RATE=24,t.MAX_FRAME_COUNT=100,t.MAX_FRAME_RATE=100,t.parseAnimationData=e;var n=function(){
function e(t,e,n,r){void 0===e&&(e=[]),void 0===n&&(n=void 0),void 0===r&&(r=void 0),this.name=t,this.tracks=e,this.frames=n,this.fps=r}return e.prototype.saveValue=function(t,e,n,i,o){var a=this.tracks.find(function(r){return r.cId===e&&r.path===t&&r.prpName===n});a||(a=new r(t,e,n),this.tracks.push(a)),a.saveValue(i,o)},e.prototype.getKeyFrames=function(t,e,n){var r=this.tracks.find(function(r){return r.cId===e&&r.path===t&&r.prpName===n});return r?r.keyFrames:null},e.prototype.deleteEmptyTracks=function(){for(var t=this,e=this.tracks.length-1;e>=0;e--)0===Object.keys(t.tracks[e].keyFrames).length&&t.tracks.splice(e,1)},e.prototype.deleteOutOfBoundsKeyFrames=function(){for(var e=this.frames||t.DEFAULT_FRAME_COUNT,n=0,r=this.tracks;n<r.length;n++)for(var i=r[n],o=Object.keys(i.keyFrames),a=0,s=o;a<s.length;a++){var p=s[a];+p>e&&delete i.keyFrames[p]}},e.prototype.getHighestKeyFrame=function(){for(var t=0,e=0,n=this.tracks;e<n.length;e++)for(var r=n[e],i=Object.keys(r.keyFrames),o=0,a=i;o<a.length;o++){var s=a[o];+s>t&&(t=+s)}return t},e.create=function(t){var n=(t.tracks||[]).map(r.create);return new e(t.name,n,t.frames,t.fps)},e}();t.Animation=n;var r=function(){function t(t,e,n,r){void 0===r&&(r={}),this.path=t,this.cId=e,this.prpName=n,this.keyFrames=r}return t.prototype.saveValue=function(t,e){this.keyFrames[t]=e},t.create=function(e){var n=e.keyFrames||{};return new t(e.path,e.cId,e.prpName,n)},t}();t.Track=r}(En||(En={})),nn.register({name:"Animation",description:"Allows animation of children",category:"Graphics",icon:"fa-bars",properties:[Zt("animationData","{}",Zt.longString,"temporary var for development")],allowMultiple:!1,prototype:{animator:null,constructor:function(){},preInit:function(){},init:function(){var t=this;this.listenProperty(this,"animationData",function(){return t.loadAnimation()}),this.loadAnimation()},onUpdate:function(t){this.animator.update(t)},loadAnimation:function(){this.animator&&this.animator.delete(),this.animator=new Pn(En.parseAnimationData(this.animationData),this)},sleep:function(){this.animator.delete(),this.animator=null}}});var bn=.33333,Pn=function(){function t(t,e){this.component=e,this.time=0,this.animations=t.animations.map(function(t){return new Sn(t,e.entity.prototype)}),this.currentAnimation=this.animations[0]}return t.prototype.update=function(t){if(this.currentAnimation){var e=this.currentAnimation.frames/this.currentAnimation.fps;this.time+=t,this.time>=e&&(this.time-=e);var n=this.currentAnimation.frames,r=this.time/e*n+1;this.currentAnimation.setFrame(r)}},t.prototype.setAnimation=function(t){if(!t)return this.time=0,this.currentAnimation=null,void this.component.entity.resetComponents();var e=this.animations.find(function(e){return e.name===t});e&&(this.currentAnimation=e,this.time=0)},t.prototype.delete=function(){delete this.animations,delete this.currentAnimation},t}(),Sn=function(){function e(t,e){var n=this;this.name=t.name,this.frames=t.frames||En.DEFAULT_FRAME_COUNT,this.fps=t.fps||En.DEFAULT_FRAME_RATE,this.tracks=t.tracks.map(function(t){return new In(t,n.frames,e)})}return e.prototype.setFrame=function(e){t(e>=1&&e<this.frames+1,"invalid frame number: "+e);for(var n=0,r=this.tracks;n<r.length;n++){r[n].setFrame(e)}},e}(),In=function(){function e(e,n,r){var i=this;if(this.frames=n,this.currentKeyFrameIndex=0,this.keyFrames=[],this.entityPrototype=r.getPrototypeByPath(e.path),!this.entityPrototype)return void console.warn("Animation path did not match anything:",e.path);var o=this.entityPrototype.findComponentDataByComponentId(e.cId,!0),a=o.componentClass.componentName;this.entity=this.entityPrototype.previouslyCreatedEntity,t(this.entity,"must have entity");var s=this.entity.getComponents(a).find(function(t){return t._componentId===e.cId});t(s,"component must be found"),this.animatedProperty=s._properties[e.prpName];for(var p=Object.keys(e.keyFrames).map(function(t){return~~t}).sort(function(t,e){return t-e}),l=0,c=p;l<c.length;l++){var h=c[l],u=i.animatedProperty.propertyType.type.fromJSON(e.keyFrames[h]);i.keyFrames.push({frame:h,value:u,control1:u,control2:u})}for(var d=this.animatedProperty.propertyType.type.name,f=this.animatedProperty.propertyType,y=function(t){return Math.min(Math.max(t,0),255)},m=0;m<this.keyFrames.length;m++){var v=i.keyFrames[m],g=i.keyFrames[(m+1)%i.keyFrames.length],C=i.keyFrames[(m+2)%i.keyFrames.length];if("float"===d){var T=void 0;T=f.getFlag(Zt.flagDegreesInEditor)?at(rt(g.value,v.value),g.value,rt(g.value,C.value)):at(v.value,g.value,C.value),g.control1=T.control1,g.control2=T.control2}else if("vector"===d){var _=v.value,w=g.value,E=C.value,b=w.clone().subtract(_),P=E.clone().subtract(w),S=(Math.PI-b.angleTo(P))/Math.PI;S*=2,S>1&&(S=1);var I=bn*S*.5*(b.length()+P.length()),N=g.frame-v.frame;N<=0&&(N+=i.frames);var x=C.frame-g.frame;x<=0&&(x+=i.frames);var A=Math.sqrt(N/x),O=I,D=I;A>1?(D/=A,O*=A):(O*=A,D/=A);var L=E.clone().subtract(_).setLength(1);g.control1=w.clone().subtract(L.clone().multiplyScalar(O)),g.control2=w.clone().add(L.multiplyScalar(D))}else if("color"===d){var M=at(v.value.r,g.value.r,C.value.r),R=at(v.value.g,g.value.g,C.value.g),k=at(v.value.b,g.value.b,C.value.b);g.control1=new Kt(y(M.control1),y(R.control1),y(k.control1)),g.control2=new Kt(y(M.control2),y(R.control2),y(k.control2))}}}return e.prototype.setFrame=function(t){var e=this.keyFrames;if(0!==e.length){for(var n,r,i=0;i<e.length;i++)if(e[i].frame>t){r=e[i],n=e[(i-1+e.length)%e.length];break}n||(n=e[e.length-1],r=e[0]);var o;if(n===r)o=n.value;else{var a=n.frame;a>t&&(a-=this.frames);var s=r.frame;s<t&&(s+=this.frames);var p=(t-a)/(s-a);o=it(n.value,n.control2,r.control1,r.value,p,this.animatedProperty.propertyType)}return this.animatedProperty.value!==o&&(this.animatedProperty.value=o),o}},e}();window.bezier=ot;var Nn={context:null,serverToClientEnabled:!0,clientToServerEnabled:!1},xn=[],An={};xt.listen(Pt.GLOBAL_CHANGE_OCCURED,function(t){if(!t.external&&Nn.clientToServerEnabled&&!st(t)){if(t.type===Lt.setPropertyValue){var e=An[t.id];e&&xn.splice(xn.indexOf(e),1),An[t.id]=t}xn.push(t),Ln&&Ln()}});var On,Dn={data:function(t){var e=t.profile,n=t.gameData,r=t.editAccess;localStorage.openEditPlayUserId=e.id,localStorage.openEditPlayUserToken=e.userToken,r||xt.dispatch("noEditAccess"),delete e.userToken,window.user=e,ct(n)},identifyYourself:function(){if(De)return location.reload();var t=pt("gameId")||localStorage.openEditPlayGameId;ht("identify",{userId:localStorage.openEditPlayUserId,userToken:localStorage.openEditPlayUserToken,gameId:t,context:Nn.context})},errorMessage:function(t){var e=t.message,n=t.isFatal,r=t.data;console.error("Server sent "+(n?"FATAL ERROR":"error")+":",e,r),n&&g(e)}},Ln=function(t,e,n){function r(){a=Date.now(),o=null,n()}function i(t){o=setTimeout(r,t)}if(void 0===e&&(e="soon"),!["instant","soon","next"].includes(e))throw new Error("Invalid callbackLimitMode");var o=null,a=0;return function(n){if(!o){var s=a+t-Date.now();if(s>0)i(s);else{var p=n||e;"instant"===p?r():"soon"===p?i(0):"next"===p&&i(t)}}}}(200,"soon",function(){if(On&&0!==xn.length&&Nn.clientToServerEnabled){var t=xn.map(dt);xn.length=0,An={},console.log("send change",t),ht("",t)}});window.addEventListener("load",ut);var Mn={id:"i",type:"t",value:"v",parentId:"p"},Rn={};Object.keys(Mn).forEach(function(t){Rn[Mn[t]]=t});var kn=null,Fn=null;window.addEventListener("resize",mt),J(mt);var Gn=48e4,Bn=70,Un=function(){function t(t,e,n){void 0===n&&(n=!1),this.elementId=t,this.keyBinding=e,this.requireTouchStart=n,this.element=null,this.state=!1,this.visible=!1,this.containsFunc=null}return t.prototype.initElement=function(){this.element||(this.element=document.getElementById(this.elementId))},t.prototype.setPosition=function(t,e,n){t?this.element.style.left=t+"px":this.element.style.right=e+"px",this.element.style.bottom=n+"px"},t.prototype.getPosition=function(){var t=document.getElementById("screen"),e=parseInt(t.style.width),n=parseInt(t.style.height),r=parseInt(this.element.style.left),i=parseInt(this.element.style.right),o=parseInt(this.element.style.bottom),a=isNaN(r)?e-i-this.element.offsetWidth/2:r+this.element.offsetWidth/2,s=n-o-this.element.offsetHeight/2;return new Xt(a,s)},t.prototype.contains=function(t){return!!this.visible&&(this.containsFunc?this.containsFunc.call(this,t):this.getPosition().distance(t)<=Bn/2)},t.prototype.setContainsFunction=function(t){this.containsFunc=t},t.prototype.setVisible=function(t){this.visible!==t&&(this.visible=t,this.element.style.display=t?"inline-block":"none")},t.prototype.setState=function(t,e){var n=this.state;!this.requireTouchStart||this.state||e?this.state=!!t:this.state=!1,this.state!==n&&(this.state?(this.element.classList.add("pressed"),B("keydown",this.keyBinding)):(this.element.classList.remove("pressed"),B("keyup",this.keyBinding)))},t}(),jn=110,Vn={touchUp:new Un("touchUp",Be.up),touchDown:new Un("touchDown",Be.down),touchLeft:new Un("touchLeft",Be.left),touchRight:new Un("touchRight",Be.right),touchJump:new Un("touchJump",Be.up,!0),touchA:new Un("touchA",Be.space,!0),touchB:new Un("touchB",Be.b,!0)},Jn=[Vn.touchJump,Vn.touchA,Vn.touchB],zn=Object.keys(Vn).map(function(t){return Vn[t]});window.addEventListener("load",function(){document.addEventListener("touchmove",vt,{passive:!1}),document.addEventListener("touchstart",vt,{passive:!1}),document.addEventListener("touchend",vt,{passive:!1}),document.addEventListener("scroll",function(t){return t.preventDefault()},{passive:!1}),window.IS_TOUCH_DEVICE="ontouchstart"in window||navigator.maxTouchPoints,window.IS_TOUCH_DEVICE&&document.body.classList.add("touch"),window.navigator.standalone&&document.body.classList.add("nativeFullscreen"),zn.forEach(function(t){return t.initElement()})}),J(function(){Ke.listen(Pt.SCENE_START,function(){return Ct()})}),function(t,e){zt=t,Wt=!!e,Ht="function"==typeof e?e:null}(!1,!1),function(t){Nn=Object.assign(Nn,t)}({serverToClientEnabled:!0,clientToServerEnabled:!1,context:"play"}),function(t){xt.listen(Pt.GLOBAL_GAME_CREATED,t),De&&t(De)}(function(t){function e(){var e=t.getChildren("lvl");n>=e.length&&(n=0),e[n].createScene().play()}var n=0;e(),window.introLogo&&(window.introLogo.style.display="none"),t.listen(Pt.GAME_LEVEL_COMPLETED,function(){n++,e()})}),R(function(t){t===Be.space&&Ke&&Ke.win()})});
//# sourceMappingURL=openeditplay.min.js.map
