{"version":3,"file":"openeditplay.min.js","sources":["../src/util/assert.ts","../src/core/eventDispatcher.ts","../src/core/change.ts","../src/core/serializable.ts","../src/core/propertyType.ts","../src/util/color.ts","../src/core/dataTypes.ts","../node_modules/redom/dist/redom.es.js","../src/util/popup.ts","../src/features/graphics.ts","../src/modules/backgroundGradient.ts","../src/features/physics.ts","../src/util/input.ts","../src/util/performance.ts","../src/core/scene.ts","../src/core/serializableManager.ts","../src/core/prototype.ts","../src/core/entityPrototype.ts","../src/components/Particles.ts","../src/util/algorithm.ts","../src/core/net.ts","../src/player/canvasResize.ts","../src/player/touchControlManager.ts","../src/util/environment.ts","../src/core/property.ts","../src/util/vector.ts","../src/core/propertyOwner.ts","../src/core/game.ts","../src/editor/editorEventDispatcher.ts","../src/core/component.ts","../src/core/componentData.ts","../src/core/entity.ts","../src/core/prefab.ts","../src/core/level.ts","../src/components/Transform.ts","../src/components/TransformVariance.ts","../src/components/Shape.ts","../src/components/Sprite.ts","../src/components/Spawner.ts","../src/components/Trigger.ts","../src/components/Physics.ts","../src/components/Lifetime.ts","../src/components/CharacterController.ts","../src/util/callLimiter.ts","../src/player/TouchControl.ts","../src/player/main.ts"],"sourcesContent":["// @ifndef OPTIMIZE\nexport const changeGetter = {\n\tget: () => null // override this\n};\n// @endif\n\nexport default function assert(condition, ...messages) {\n\t// @ifndef OPTIMIZE\n\tif (!condition) {\n\t\tconsole.log('Assert', ...messages, new Error().stack, '\\norigin', changeGetter.get());\n\t\tdebugger;\n\t\tif (!window['force'])\n\t\t\tthrow new Error(messages.join('; '));\n\t}\n\t// @endif\n}\n","export enum GameEvent {\n    SCENE_START = 'scene start',\n    SCENE_PLAY = 'scene play',\n    SCENE_PAUSE = 'scene pause',\n    SCENE_RESET = 'scene reset',\n    SCENE_DRAW = 'scene draw', // parameters(scene: Scene)\n    SCENE_ZOOM_CHANGED = 'zoom changed',\n    GAME_LEVEL_COMPLETED = 'game level completed',\n    PROPERTY_VALUE_CHANGE = 'property change',\n    GLOBAL_CHANGE_OCCURED = 'change',\n    GLOBAL_SCENE_CREATED = 'scene created',\n    GLOBAL_GAME_CREATED = 'game created',\n}\n\nexport type ListenerFunction = Function & { priority?: number };\n\nexport let eventDispatcherCallbacks = {\n    eventDispatchedCallback: null // (eventName, listenerCount) => void\n};\n\nexport default class EventDispatcher {\n    _listeners: { [event in GameEvent]?: Array<ListenerFunction> } = {};\n\n    // priority should be a whole number between -100000 and 100000. a smaller priority number means that it will be executed first.\n    listen(event: GameEvent, callback: ListenerFunction, priority = 0) {\n        (callback as any).priority = priority + (listenerCounter++ / NUMBER_BIGGER_THAN_LISTENER_COUNT);\n        if (!this._listeners.hasOwnProperty(event)) {\n            this._listeners[event] = [];\n        }\n        let index = decideIndexOfListener(this._listeners[event], callback);\n        this._listeners[event].splice(index, 0, callback);\n        return () => {\n            let eventListeners = this._listeners[event];\n            if (!eventListeners) return; // listeners probably already deleted\n\n            let index = eventListeners.indexOf(callback);\n            if (index >= 0)\n                eventListeners.splice(index, 1);\n        };\n    }\n    dispatch(event: GameEvent, a?, b?, c?) {\n        let listeners = this._listeners[event];\n        if (!listeners)\n            return;\n\n        if (eventDispatcherCallbacks.eventDispatchedCallback)\n            eventDispatcherCallbacks.eventDispatchedCallback(event, listeners.length);\n\n        for (let i = 0; i < listeners.length; i++) {\n            // @ifndef OPTIMIZE\n            try {\n                // @endif\n\n                listeners[i](a, b, c);\n\n                // @ifndef OPTIMIZE\n            } catch (e) {\n                console.error(`Event ${event} listener crashed.`, this._listeners[event][i], e);\n            }\n            // @endif\n        }\n    }\n\n    /**\n     * This is separate function for optimization.\n     * Returns promise that has value array, containing all results from listeners.\n     * Promise can reject.\n     *\n     * Handler of this kind of events should return either a value or a Promise.\n     */\n    dispatchWithResults(event: GameEvent, a?, b?, c?) {\n        let listeners = this._listeners[event];\n        if (!listeners)\n            return Promise.all([]);\n\n        let results = [];\n\n        if (eventDispatcherCallbacks.eventDispatchedCallback)\n            eventDispatcherCallbacks.eventDispatchedCallback(event, listeners.length);\n\n        for (let i = 0; i < listeners.length; i++) {\n            // @ifndef OPTIMIZE\n            try {\n                // @endif\n\n                results.push(listeners[i](a, b, c));\n\n                // @ifndef OPTIMIZE\n            } catch (e) {\n                console.error(`Event ${event} listener crashed.`, this._listeners[event][i], e);\n            }\n            // @endif\n        }\n\n        let promises = results.map(res => res instanceof Promise ? res : Promise.resolve(res));\n        return Promise.all(promises);\n    }\n\n    delete() {\n        this._listeners = {};\n    }\n}\n\nexport let globalEventDispatcher = new EventDispatcher();\n\nlet listenerCounter = 0;\nconst NUMBER_BIGGER_THAN_LISTENER_COUNT = 10000000000;\n\nfunction decideIndexOfListener(array, callback) {\n    let low = 0,\n        high = array.length,\n        priority = callback.priority;\n\n    while (low < high) {\n        let mid = low + high >>> 1;\n        if (array[mid].priority < priority) low = mid + 1;\n        else high = mid;\n    }\n    return low;\n}\n","import assert, { changeGetter as assertChangeGetter } from '../util/assert';\nimport Serializable, { serializableCallbacks } from './serializable';\nimport Property from './property';\nimport EventDispatcher, { GameEvent, globalEventDispatcher } from './eventDispatcher';\n\nlet DEBUG_CHANGES = 0;\nlet CHECK_FOR_INVALID_ORIGINS = 0;\n\nexport type Change = {\n\ttype: string;\n\treference: Serializable;\n\tid: string;\n\texternal: boolean; // caused by network\n\torigin?: any; // exists in editor, but not in optimized release\n\tvalue?: any;\n\tparent?: Serializable;\n}\n\n// reference parameters are not sent over net. they are helpers in local game instance\nexport let changeType = {\n\taddSerializableToTree: 'a', // parentId, reference\n\tsetPropertyValue: 's', // id, value\n\tdeleteSerializable: 'd', // id\n\tmove: 'm', // id, parentId\n\tdeleteAllChildren: 'c', // id\n};\n\nlet origin;\n\n// @ifndef OPTIMIZE\nlet previousVisualOrigin;\nfunction resetOrigin() {\n\torigin = null;\n}\nexport function getChangeOrigin() {\n\treturn origin;\n}\nassertChangeGetter.get = getChangeOrigin;\n// @endif\nexport function setChangeOrigin(_origin) {\n\t// @ifndef OPTIMIZE\n\tif (_origin !== origin) {\n\t\torigin = _origin;\n\t\tif (DEBUG_CHANGES && _origin && _origin !== previousVisualOrigin) {\n\t\t\tconsole.log('origin', previousVisualOrigin);\n\t\t\tpreviousVisualOrigin = _origin;\n\t\t}\n\n\t\tif (CHECK_FOR_INVALID_ORIGINS)\n\t\t\tsetTimeout(resetOrigin, 0);\n\t}\n\t// @endif\n}\n\nlet externalChange = false;\n\n// addChange needs to be called if editor, server or net game needs to share changes\nexport function addChange(type: string, reference: Serializable) {\n\t// @ifndef OPTIMIZE\n\tassert(origin, 'Change without origin!');\n\t// @endif\n\n\tif (!reference.id) return;\n\n\tlet change: Change = {\n\t\ttype,\n\t\treference,\n\t\tid: reference.id,\n\t\texternal: externalChange,\n\t\torigin // exists in editor, but not in optimized release\n\t};\n\tif (type === changeType.setPropertyValue) {\n\t\tchange.value = (reference as Property)._value;\n\t} else if (type === changeType.move) {\n\t\tchange.parent = reference._parent;\n\t} else if (type === changeType.addSerializableToTree) {\n\t\tchange.parent = reference._parent;\n\t\tdelete change.id;\n\t}\n\n\t// @ifndef OPTIMIZE\n\tif (DEBUG_CHANGES)\n\t\tconsole.log('change', change);\n\n\tlet previousOrigin = origin;\n\t// @endif\n\n\tglobalEventDispatcher.dispatch(GameEvent.GLOBAL_CHANGE_OCCURED, change);\n\n\t// @ifndef OPTIMIZE\n\tif (origin !== previousOrigin) {\n\t\tif (DEBUG_CHANGES)\n\t\t\tconsole.log('origin changed from', previousOrigin, 'to', origin && origin.constructor || origin);\n\t\torigin = previousOrigin;\n\t}\n\t// @endif\n}\n\nexport function executeExternal(callback) {\n\tsetChangeOrigin('external');\n\tif (externalChange) return callback();\n\texternalChange = true;\n\tcallback();\n\texternalChange = false;\n}\n","import assert from '../util/assert';\nimport { changeType, addChange } from './change';\nimport { isClient } from '../util/environment';\nimport EventDispatcher from './eventDispatcher';\n\nexport const serializableCallbacks = {\n\taddSerializable: (serializable: Serializable) => { },\n\tremoveSerializable: (serializableId: string) => { },\n};\n\nconst CHARACTERS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'; // 62 chars\nconst CHAR_COUNT = CHARACTERS.length;\n\nconst random = Math.random;\nexport function createStringId(threeLetterPrefix = '???', characters = 16) {\n\tlet id = threeLetterPrefix;\n\tfor (let i = characters - 1; i >= 0; --i)\n\t\tid += CHARACTERS[random() * CHAR_COUNT | 0];\n\treturn id;\n}\n\nlet serializableClasses = new Map();\n\nexport default class Serializable extends EventDispatcher {\n\tid: string;\n\tthreeLetterType: string;\n\tisRoot: boolean;\n\t_children: Map<string, Array<Serializable>> = new Map();\n\t_rootType: string;\n\t_parent: Serializable;\n\t_alive: boolean;\n\t_state: number;\n\n\tconstructor(predefinedId: string = '', skipSerializableRegistering = false) {\n\t\tsuper();\n\t\t// @ifndef OPTIMIZE\n\t\tassert(this.threeLetterType, 'Forgot to Serializable.registerSerializable your class?');\n\t\t// @endif\n\t\tthis._rootType = this.isRoot ? this.threeLetterType : null;\n\t\tif (skipSerializableRegistering)\n\t\t\treturn;\n\t\tif (predefinedId) {\n\t\t\tthis.id = predefinedId;\n\t\t} else {\n\t\t\tthis.id = createStringId(this.threeLetterType);\n\t\t}\n\t\t/*\n\t\tif (this.id.startsWith('?'))\n\t\t\tthrow new Error('?');\n\t\t\t*/\n\t\tserializableCallbacks.addSerializable(this);\n\t}\n\tmakeUpAName() {\n\t\treturn 'Serializable';\n\t}\n\tdelete() {\n\t\tsuper.delete();\n\t\tif (this._parent) {\n\t\t\tthis._parent.deleteChild(this);\n\t\t\treturn false;\n\t\t}\n\t\tthis.deleteChildren();\n\t\tthis._alive = false;\n\t\tthis._rootType = null;\n\t\tserializableCallbacks.removeSerializable(this.id);\n\t\tthis._state |= Serializable.STATE_DESTROY;\n\t\treturn true;\n\t}\n\tdeleteChildren() {\n\t\tif (this._children.size) {\n\t\t\tthis._children.forEach(array => {\n\t\t\t\tarray.forEach(child => {\n\t\t\t\t\tchild._parent = null;\n\t\t\t\t\tchild.delete();\n\t\t\t\t});\n\t\t\t});\n\t\t\tthis._children.clear();\n\n\t\t\tif (this._parent) {\n\t\t\t\taddChange(changeType.deleteAllChildren, this);\n\t\t\t}\n\t\t}\n\t}\n\t// this is called right after constructor\n\tinitWithChildren(children: Array<Serializable> = []) {\n\t\tassert(!(this._state & Serializable.STATE_INIT), 'init already done');\n\t\tthis._state |= Serializable.STATE_INIT;\n\t\tif (children.length > 0)\n\t\t\tthis.addChildren(children);\n\t\treturn this;\n\t}\n\taddChildren(children) {\n\t\tfor (let i = 0; i < children.length; i++)\n\t\t\tthis.addChild(children[i]);\n\t\treturn this;\n\t}\n\taddChild(child: Serializable): Serializable {\n\t\tthis._addChild(child);\n\n\t\tthis._state |= Serializable.STATE_ADDCHILD;\n\n\t\tif (this._rootType)\n\t\t\taddChange(changeType.addSerializableToTree, child);\n\t\treturn this;\n\t}\n\t_addChild(child: Serializable) {\n\t\tassert(child._parent === null);\n\n\t\tlet array = this._children.get(child.threeLetterType);\n\t\tif (array === undefined) {\n\t\t\tarray = [];\n\t\t\tthis._children.set(child.threeLetterType, array);\n\t\t}\n\t\tarray.push(child);\n\t\tchild._parent = this;\n\t\tchild._state |= Serializable.STATE_ADDPARENT;\n\n\t\tif (child._rootType !== this._rootType) // tiny optimization\n\t\t\tchild.setRootType(this._rootType);\n\n\t\treturn this;\n\t}\n\tfindChild(threeLetterType: string, filterFunction: (s: Serializable) => boolean, deep: boolean = false) {\n\t\tlet array = this._children.get(threeLetterType);\n\t\tif (!array) return null;\n\t\tif (filterFunction) {\n\t\t\tlet foundChild = array.find(filterFunction);\n\t\t\tif (foundChild) {\n\t\t\t\treturn foundChild;\n\t\t\t} else if (deep) {\n\t\t\t\tfor (let i = 0; i < array.length; ++i) {\n\t\t\t\t\tlet child = array[i];\n\t\t\t\t\tlet foundChild = child.findChild(threeLetterType, filterFunction, true);\n\t\t\t\t\tif (foundChild)\n\t\t\t\t\t\treturn foundChild;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn null;\n\t\t} else {\n\t\t\treturn array[0];\n\t\t}\n\t}\n\tfindParent(threeLetterType: string, filterFunction: (Serializable) => boolean = null) {\n\t\tlet serializable: Serializable = this;\n\t\twhile (serializable) {\n\t\t\tif (serializable.threeLetterType === threeLetterType && (!filterFunction || filterFunction(serializable)))\n\t\t\t\treturn serializable;\n\t\t\tserializable = serializable._parent;\n\t\t}\n\t\treturn null;\n\t}\n\tgetRoot() {\n\t\tlet serializable: Serializable = this;\n\t\twhile (serializable._parent) {\n\t\t\tserializable = serializable._parent;\n\t\t}\n\t\treturn serializable;\n\t}\n\t// idx is optional\n\tdeleteChild(child: Serializable, idx?: number) {\n\t\taddChange(changeType.deleteSerializable, child);\n\t\tthis._detachChild(child, idx);\n\t\tchild.delete();\n\t\treturn this;\n\t}\n\t// idx is optional\n\t_detachChild(child: Serializable, idx:number = 0) {\n\t\tlet array = this._children.get(child.threeLetterType);\n\t\tassert(array, 'child not found');\n\t\tif (array[idx] !== child)\n\t\t\tidx = array.indexOf(child);\n\t\tassert(idx >= 0, 'child not found');\n\t\tarray.splice(idx, 1);\n\t\tif (array.length === 0)\n\t\t\tthis._children.delete(child.threeLetterType);\n\t\tchild._parent = null;\n\t\tchild.setRootType(null);\n\n\t\treturn this;\n\t}\n\tforEachChild(threeLetterType: string = null, callback: (s: Serializable) => void, deep: boolean = false) {\n\t\tfunction processArray(array) {\n\t\t\tarray.forEach(child => {\n\t\t\t\tcallback(child);\n\t\t\t\tdeep && child.forEachChild(threeLetterType, callback, true);\n\t\t\t});\n\t\t}\n\t\tif (threeLetterType) {\n\t\t\tprocessArray(this._children.get(threeLetterType) || []);\n\t\t} else {\n\t\t\tthis._children.forEach(processArray);\n\t\t}\n\t\treturn this;\n\t}\n\tmove(newParent: Serializable) {\n\n\t\tnewParent._addChild(this._detach());\n\t\taddChange(changeType.move, this);\n\n\t\treturn this;\n\t}\n\t_detach() {\n\t\tthis._parent && this._parent._detachChild(this);\n\t\treturn this;\n\t}\n\tgetParent() {\n\t\treturn this._parent || null;\n\t}\n\tgetChildren(threeLetterType: string) {\n\t\treturn this._children.get(threeLetterType) || [];\n\t}\n\ttoJSON() {\n\t\tlet json: any = {\n\t\t\tid: this.id\n\t\t};\n\t\tif (this._children.size > 0) {\n\t\t\tlet arrays = [];\n\t\t\t// prototypes must come before a level\n\t\t\tArray.from(this._children.keys()).sort((a, b) => a === 'prt' ? -1 : 1)\n\t\t\t\t.forEach(key => arrays.push(this._children.get(key)));\n\t\t\tjson.c = [].concat(...arrays).map(child => child.toJSON());\n\t\t}\n\t\treturn json;\n\t}\n\ttoString() {\n\t\treturn JSON.stringify(this.toJSON(), null, 4);\n\t}\n\tclone() {\n\t\tlet obj: Serializable = new (this.constructor as any)();\n\t\tlet children = [];\n\t\tthis.forEachChild(null, child => {\n\t\t\tchildren.push(child.clone());\n\t\t});\n\t\tobj.initWithChildren(children);\n\t\tthis._state |= Serializable.STATE_CLONE;\n\t\treturn obj;\n\t}\n\thasDescendant(child: Serializable) {\n\t\tif (!child) return false;\n\t\tlet parent = child._parent;\n\t\twhile (parent) {\n\t\t\tif (parent === this) return true;\n\t\t\tparent = parent._parent;\n\t\t}\n\t\treturn false;\n\t}\n\tsetRootType(rootType: string) {\n\t\tif (this._rootType === rootType)\n\t\t\treturn;\n\t\tthis._rootType = rootType;\n\n\t\t// Optimized\n\t\tlet i;\n\t\tthis._children.forEach(childArray => {\n\t\t\tfor (i = 0; i < childArray.length; ++i) {\n\t\t\t\tchildArray[i].setRootType(rootType);\n\t\t\t}\n\t\t});\n\t}\n\tisInTree() {\n\t\treturn !!this._rootType;\n\t}\n\tstatic fromJSON(json: any) {\n\t\tassert(typeof json.id === 'string' && json.id.length > 5, 'Invalid id.');\n\t\tlet fromJSON = serializableClasses.get(json.id.substring(0, 3));\n\t\tassert(fromJSON);\n\t\tlet obj;\n\t\ttry {\n\t\t\tobj = fromJSON(json);\n\t\t} catch (e) {\n\t\t\tif (isClient) {\n\t\t\t\tconsole.error(e);\n\t\t\t\tif (!window['force'])\n\t\t\t\t\tdebugger; // Type 'force = true' in console to ignore failed imports.\n\n\t\t\t\tif (!window['force'])\n\t\t\t\t\tthrow new Error();\n\t\t\t} else {\n\t\t\t\tconsole.log('Error fromJSON', e);\n\t\t\t}\n\t\t\treturn null;\n\t\t}\n\t\tlet children = json.c ? json.c.map(child => Serializable.fromJSON(child)).filter(Boolean) : [];\n\t\tif (obj._state & Serializable.STATE_INIT)\n\t\t\tobj.addChildren(children);\n\t\telse\n\t\t\tobj.initWithChildren(children);\n\t\tobj._state |= Serializable.STATE_FROMJSON;\n\t\treturn obj;\n\t}\n\tstatic registerSerializable(Class: { new(...args): Serializable}, threeLetterType: string, fromJSON: (string) => void = null) {\n\t\tClass.prototype.threeLetterType = threeLetterType;\n\t\tassert(typeof threeLetterType === 'string' && threeLetterType.length === 3);\n\t\tif (!fromJSON)\n\t\t\tfromJSON = json => new Class(json.id);\n\t\tserializableClasses.set(threeLetterType, fromJSON);\n\t}\n\n\tstatic STATE_INIT: number = 2;\n\tstatic STATE_ADDCHILD: number = 4;\n\tstatic STATE_ADDPARENT: number = 8;\n\tstatic STATE_CLONE: number = 16;\n\tstatic STATE_DESTROY: number = 32;\n\tstatic STATE_FROMJSON: number = 64;\n}\n\nSerializable.prototype._parent = null;\nSerializable.prototype._alive = true;\nSerializable.prototype._state = 0;\nSerializable.prototype._rootType = null;\n\nSerializable.prototype.isRoot = false; // If this should be a root node\nObject.defineProperty(Serializable.prototype, 'debug', {\n\tget() {\n\t\tlet info = this.threeLetterType;\n\n\t\tif (this.threeLetterType === 'cda')\n\t\t\tinfo += '|' + this.name;\n\n\t\tthis._children.forEach((value, key) => {\n\t\t\tinfo += '|';\n\t\t\tif (key === 'prp')\n\t\t\t\tinfo += this.getChildren('prp').map(p => `${p.name}=${p._value}`).join(', ');\n\t\t\telse\n\t\t\t\tinfo += `${key}(${value.length})`;\n\t\t});\n\n\t\tinfo += '|state: ';\n\n\t\tlet states = [];\n\t\tlet logState = (state, stateString) => {\n\t\t\tif (this._state & state)\n\t\t\t\tstates.push(stateString);\n\t\t};\n\n\t\tlogState(Serializable.STATE_INIT, 'init');\n\t\tlogState(Serializable.STATE_ADDCHILD, 'add child');\n\t\tlogState(Serializable.STATE_ADDPARENT, 'add parent');\n\t\tlogState(Serializable.STATE_CLONE, 'clone');\n\t\tlogState(Serializable.STATE_DESTROY, 'destroy');\n\t\tlogState(Serializable.STATE_FROMJSON, 'from json');\n\n\t\tinfo += states.join(', ');\n\n\t\treturn info;\n\t}\n});\nObject.defineProperty(Serializable.prototype, 'debugChildren', {\n\tget() {\n\t\tlet c = [];\n\t\tthis._children.forEach((value, key) => {\n\t\t\tc = c.concat(value);\n\t\t});\n\n\t\tlet children = [];\n\n\t\tfunction createDebugObject(type) {\n\t\t\tif (type === 'gam') return new function Game() { };\n\t\t\tif (type === 'sce') return new function Scene() { };\n\t\t\tif (type === 'prt') return new function Prototype() { };\n\t\t\tif (type === 'prp') return new function Property() { };\n\t\t\tif (type === 'cda') return new function ComponentData() { };\n\t\t\tif (type === 'com') return new function Component() { };\n\t\t\tif (type === 'epr') return new function EntityPrototype() { };\n\t\t\tif (type === 'ent') return new function Entity() { };\n\t\t\tif (type === 'lvl') return new function Level() { };\n\t\t\tif (type === 'pfa') return new function Prefab() { };\n\t\t\treturn new function Other() { };\n\t\t}\n\n\t\tc.forEach(child => {\n\t\t\tlet obj = createDebugObject(child.threeLetterType);\n\n\t\t\tobj.debug = child.debug;\n\t\t\tobj.ref = child;\n\t\t\tobj.debugChildren = child.debugChildren;\n\t\t\tlet c = child.debugChildArray;\n\t\t\tif (c && c.length > 0)\n\t\t\t\tobj.children = c;\n\t\t\tchildren.push(obj);\n\t\t});\n\n\t\treturn children;\n\t}\n});\n\n/**\n * If a serializable is a ancestor of another serializable, it is filtered out from the list\n */\nexport function filterChildren(serializables: Array<Serializable>) {\n\tlet idSet = new Set(serializables.map(s => s.id));\n\treturn serializables.filter(serializable => {\n\t\tlet parent = serializable.getParent();\n\t\twhile (parent) {\n\t\t\tif (idSet.has(parent.id))\n\t\t\t\treturn false;\n\t\t\tparent = parent.getParent();\n\t\t}\n\t\treturn true;\n\t});\n}\n","import assert from '../util/assert';\nimport Property from './property';\nimport { DataTypeContainer } from './dataTypes';\n// info about type, validator, validatorParameters, initialValue\n\nexport class PropertyType {\n\tflags: any;\n\tconstructor(\n\t\tpublic name: string,\n\t\tpublic type: DataType,\n\t\tpublic validator,\n\t\tpublic initialValue,\n\t\tpublic description: string,\n\t\tflags: Array<any> = [],\n\t\tpublic visibleIf\n\t) {\n\t\tassert(name[0] >= 'a' && name[0] <= 'z', 'Name of a property must start with lower case letter.');\n\t\tassert(type && typeof type.name === 'string');\n\t\tassert(validator && typeof validator.validate === 'function');\n\n\t\tthis.name = name;\n\t\tthis.type = type;\n\t\tthis.validator = validator;\n\t\tthis.initialValue = initialValue;\n\t\tthis.description = description;\n\t\tthis.visibleIf = visibleIf;\n\t\tthis.flags = {};\n\t\tflags.forEach(f => this.flags[f.type] = f);\n\t}\n\tgetFlag(flag: Flag) {\n\t\treturn this.flags[flag.type];\n\t}\n\tcreateProperty({\n\t\tvalue,\n\t\tpredefinedId,\n\t\tskipSerializableRegistering = false\n\t}: CreatePropertyParameters = {}) {\n\t\treturn new Property({\n\t\t\tpropertyType: this,\n\t\t\tvalue,\n\t\t\tpredefinedId,\n\t\t\tname: this.name,\n\t\t\tskipSerializableRegistering\n\t\t});\n\t}\n}\n\ntype CreatePropertyParameters = {\n\tvalue?: any;\n\tpredefinedId?: string;\n\tskipSerializableRegistering?: boolean;\n}\n\nexport interface PropType extends Function, DataTypeContainer {\n\tvisibleIf?: (propertyName: string, value: any) => any;\n}\n\n/*\n\tBeautiful way of creating property types\n\n\toptionalParameters:\n\t\tdescription: 'Example',\n\t\tvalidator: PropertyType.\n */\nconst Prop: PropType = function Prop(propertyName: string, defaultValue: any, type: DataTypeDefinition, ...optionalParameters) {\n\tlet dataType = type();\n\tlet validator = dataType.validators.default();\n\tlet description = '';\n\tlet flags = [];\n\tlet visibleIf = null;\n\toptionalParameters.forEach((p, idx) => {\n\t\tif (typeof p === 'string')\n\t\t\tdescription = p;\n\t\telse if (p && p.validate)\n\t\t\tvalidator = p;\n\t\telse if (p && p.isFlag)\n\t\t\tflags.push(p);\n\t\telse if (p && p.visibleIf)\n\t\t\tvisibleIf = p;\n\t\telse\n\t\t\tassert(false, 'invalid parameter ' + p + ' idx ' + idx);\n\t});\n\treturn new PropertyType(propertyName, dataType, validator, defaultValue, description, flags, visibleIf);\n};\n\nexport default Prop;\n\n// if value is string, property must be value\n// if value is an array, property must be one of the values\nProp.visibleIf = function (propertyName: string, value: any) {\n\tassert(typeof propertyName === 'string' && propertyName.length);\n\tassert(typeof value !== 'undefined');\n\treturn {\n\t\tvisibleIf: true,\n\t\tpropertyName,\n\t\tvalues: Array.isArray(value) ? value : [value]\n\t};\n};\n\ntype Flag = {\n\ttype: string;\n\tisFlag: boolean;\n};\nfunction createFlag(type: string, func: any = {}): Flag {\n\tfunc.isFlag = true;\n\tfunc.type = type;\n\treturn func;\n}\n\nexport interface PropType {\n\tflagDegreesInEditor?: Flag;\n}\nProp.flagDegreesInEditor = createFlag('degreesInEditor');\n\ntype DataType = {\n\tname: string;\n\tvalidators?: { [s: string]: Function };\n\ttoJSON?: Function;\n\tfromJSON?: Function;\n\tclone?: Function;\n};\nexport type DataTypeDefinition = Function;\n\nexport function createDataType({\n\tname = '',\n\tvalidators = { default: x => x }, // default must exist. if value is a reference(object), validator should copy the value.\n\ttoJSON = x => x,\n\tfromJSON = x => x,\n\tclone = x => x\n}: DataType): DataTypeDefinition {\n\tassert(name, 'name missing from property type');\n\tassert(typeof validators.default === 'function', 'default validator missing from property type: ' + name);\n\tassert(typeof toJSON === 'function', 'invalid toJSON for property type: ' + name);\n\tassert(typeof fromJSON === 'function', 'invalid fromJSON for property type: ' + name);\n\n\tlet type: DataType = {\n\t\tname,\n\t\tvalidators,\n\t\ttoJSON,\n\t\tfromJSON,\n\t\tclone\n\t};\n\tlet createType = () => type;\n\n\tObject.keys(validators).forEach(validatorName => {\n\t\tcreateType[validatorName] = createValidator(validatorName, validators[validatorName]);\n\t\tvalidators[validatorName] = createType[validatorName];\n\t});\n\treturn createType;\n}\n\ntype Validator = {\n\tvalidate?: Function,\n\tvalidatorName?: string,\n\tparameters?: Array<any>\n};\n\nfunction createValidator(name: string, validatorFunction: Function): Validator {\n\tlet validator: any = function (...args): Validator {\n\t\tlet parameters = args;\n\t\tlet validatorArgs = [null, ...args];\n\t\treturn {\n\t\t\tvalidatorName: name,\n\t\t\tvalidate: function (x) {\n\t\t\t\tvalidatorArgs[0] = x;\n\t\t\t\treturn validatorFunction.apply(null, validatorArgs);\n\t\t\t},\n\t\t\tparameters\n\t\t};\n\t};\n\tvalidator.validatorName = name;\n\tvalidator.validate = validatorFunction;\n\treturn validator;\n}\n","import assert from './assert'\n\nfunction isColor(color) {\n\n}\n\nexport class Color {\n\tr: number;\n\tg: number;\n\tb: number;\n\tconstructor(r: number | Color | string, g?: number, b?: number) {\n\t\tif (r instanceof Color) {\n\t\t\tthis.r = r.r;\n\t\t\tthis.g = r.g;\n\t\t\tthis.b = r.b;\n\t\t} else if (typeof r === 'number') {\n\t\t\tthis.r = r;\n\t\t\tthis.g = g;\n\t\t\tthis.b = b;\n\t\t} else if (typeof r === 'string') {\n\t\t\tlet rgb = hexToRgb(r);\n\t\t\tthis.r = rgb.r;\n\t\t\tthis.g = rgb.g;\n\t\t\tthis.b = rgb.b;\n\t\t} else {\n\t\t\tassert(false, 'Invalid Color parameters');\n\t\t}\n\t}\n\ttoHexString() {\n\t\treturn rgbToHex(this.r, this.g, this.b);\n\t}\n\ttoHexNumber() {\n\t\treturn this.r * 256 * 256 + this.g * 256 + this.b;\n\t}\n\ttoString() {\n\t\treturn `[${this.r},${this.g},${this.b}]`;\n\t}\n}\n\nexport function hexToRgb(hex) {\n\tvar result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\n\treturn result ? {\n\t\tr: parseInt(result[1], 16),\n\t\tg: parseInt(result[2], 16),\n\t\tb: parseInt(result[3], 16)\n\t} : null;\n}\n\nexport function componentToHex(c: number) {\n\tvar hex = c.toString(16);\n\treturn hex.length == 1 ? \"0\" + hex : hex;\n}\n\nexport function rgbToHex(r: number, g: number, b: number) {\n\treturn \"#\" + componentToHex(r) + componentToHex(g) + componentToHex(b);\n}\n\nexport function isHexString(hex: string) {\n\treturn hex && hex.match(/^#[0-9a-f]{6}$/i) ? true : false;\n}\n","import assert from '../util/assert';\nimport Prop, { createDataType, PropType, DataTypeDefinition } from './propertyType';\nimport Vector from '../util/vector';\nimport { isHexString, Color } from '../util/color';\n\nfunction validateFloat(val) {\n\tif (isNaN(val) || val === Infinity || val === -Infinity)\n\t\tthrow new Error('Invalid float: ' + val);\n}\n\nconst FLOAT_JSON_PRECISION = 4;\nconst FLOAT_JSON_PRECISION_MULTIPLIER = Math.pow(10, FLOAT_JSON_PRECISION);\nconst FLOAT_DELTA = 0.0000001;\n\nexport interface DataTypeContainer {\n\tfloat?: Function & {\n\t\trange?: (min: number, max: number) => number,\n\t\tmodulo?: (min: number, max: number) => number\n\t};\n}\nProp.float = createDataType({\n\tname: 'float',\n\tvalidators: {\n\t\tdefault(x) {\n\t\t\tx = parseFloat(x);\n\t\t\t// @ifndef OPTIMIZE\n\t\t\tvalidateFloat(x);\n\t\t\t// @endif\n\t\t\treturn x;\n\t\t},\n\t\t// PropertyType.float.range(min, max)\n\t\trange(x: number, min: number, max: number): number {\n\t\t\tx = Number(x);\n\t\t\tvalidateFloat(x);\n\t\t\treturn Math.min(max, Math.max(min, x));\n\t\t},\n\t\tmodulo(x, min, max) {\n\t\t\tx = Number(x);\n\t\t\tvalidateFloat(x);\n\n\t\t\tlet range = max - min;\n\n\t\t\tif (x < min) {\n\t\t\t\tx += (((min - x) / range | 0) + 1) * range;\n\t\t\t} else if (x > max - FLOAT_DELTA) {\n\t\t\t\tx -= (((x - max) / range | 0) + 1) * range;\n\t\t\t}\n\n\t\t\treturn x;\n\t\t}\n\t},\n\ttoJSON: x => Math.round(x * FLOAT_JSON_PRECISION_MULTIPLIER) / FLOAT_JSON_PRECISION_MULTIPLIER,\n\tfromJSON: x => x\n});\n\nexport interface DataTypeContainer {\n\tint?: Function & {\n\t\trange?: (min: number, max: number) => number\n\t};\n}\nProp.int = createDataType({\n\tname: 'int',\n\tvalidators: {\n\t\tdefault(x) {\n\t\t\tx = parseInt(x);\n\t\t\t// @ifndef OPTIMIZE\n\t\t\tvalidateFloat(x);\n\t\t\t// @endif\n\t\t\treturn x;\n\t\t},\n\t\t// PropertyType.float.range(min, max)\n\t\trange(x, min, max) {\n\t\t\tx = parseInt(x);\n\t\t\tvalidateFloat(x);\n\t\t\treturn Math.min(max, Math.max(min, x));\n\t\t}\n\t},\n\ttoJSON: x => x,\n\tfromJSON: x => x\n});\n\nexport interface DataTypeContainer { vector?: DataTypeDefinition; }\nProp.vector = createDataType({\n\tname: 'vector',\n\tvalidators: {\n\t\tdefault(vec) {\n\t\t\t// @ifndef OPTIMIZE\n\t\t\tif (!(vec instanceof Vector))\n\t\t\t\tthrow new Error();\n\t\t\t// @endif\n\t\t\tvec = vec.clone();\n\t\t\t// @ifndef OPTIMIZE\n\t\t\tvec.x = parseFloat(vec.x);\n\t\t\tvec.y = parseFloat(vec.y);\n\t\t\tvalidateFloat(vec.x);\n\t\t\tvalidateFloat(vec.y);\n\t\t\t// @endif\n\t\t\treturn vec;\n\t\t}\n\t},\n\ttoJSON: vec => ({\n\t\tx: Math.round(vec.x * FLOAT_JSON_PRECISION_MULTIPLIER) / FLOAT_JSON_PRECISION_MULTIPLIER,\n\t\ty: Math.round(vec.y * FLOAT_JSON_PRECISION_MULTIPLIER) / FLOAT_JSON_PRECISION_MULTIPLIER\n\t}),\n\tfromJSON: vec => Vector.fromObject(vec),\n\tclone: vec => vec.clone()\n});\n\nexport interface DataTypeContainer { string?: DataTypeDefinition; }\nProp.string = createDataType({\n\tname: 'string',\n\tvalidators: {\n\t\tdefault: x => x ? String(x) : ''\n\t},\n\ttoJSON: x => x,\n\tfromJSON: x => x\n});\n\nexport interface DataTypeContainer { bool?: DataTypeDefinition; }\nProp.bool = createDataType({\n\tname: 'bool',\n\tvalidators: {\n\t\tdefault(x) {\n\t\t\tif (typeof x !== 'boolean')\n\t\t\t\tthrow new Error();\n\t\t\treturn x;\n\t\t}\n\t},\n\ttoJSON: x => x ? 1 : 0,\n\tfromJSON: x => !!x\n});\n\nexport interface DataTypeContainer {\n\tenum?: Function & {\n\t\tvalues?: (...values: Array<string>) => string\n\t};\n}\nProp.enum = createDataType({\n\tname: 'enum',\n\tvalidators: {\n\t\tdefault() {\n\t\t\tassert(false, `also specify enum values with Prop.enum.values('value1', 'value2', ...)`);\n\t\t},\n\t\tvalues(x, ...values) {\n\t\t\tif (!Array.isArray(values))\n\t\t\t\tthrow new Error();\n\t\t\tif (typeof x !== 'string')\n\t\t\t\tthrow new Error('val should be string');\n\t\t\tif (values.indexOf(x) < 0)\n\t\t\t\tthrow new Error(`value ${x} not in enum: [${values}]`);\n\t\t\treturn x;\n\t\t}\n\t},\n\ttoJSON: x => x,\n\tfromJSON: x => x\n});\n\nexport interface DataTypeContainer { color?: DataTypeDefinition; }\nProp.color = createDataType({\n\tname: 'color',\n\tvalidators: {\n\t\tdefault(color) {\n\t\t\tlet newColor = new Color(color);\n\t\t\t// @ifndef OPTIMIZE\n\t\t\tassert(newColor.r >= 0 && newColor.r < 256);\n\t\t\tassert(newColor.g >= 0 && newColor.g < 256);\n\t\t\tassert(newColor.b >= 0 && newColor.b < 256);\n\t\t\t// @endif\n\t\t\treturn newColor;\n\t\t}\n\t},\n\ttoJSON: x => x.toHexString(),\n\tfromJSON: x => new Color(x)\n});\n","var HASH = '#'.charCodeAt(0);\nvar DOT = '.'.charCodeAt(0);\n\nvar TAG_NAME = 0;\nvar ID = 1;\nvar CLASS_NAME = 2;\n\nvar parseQuery = function (query) {\n  var tag = null;\n  var id = null;\n  var className = null;\n  var mode = TAG_NAME;\n  var offset = 0;\n\n  for (var i = 0; i <= query.length; i++) {\n    var char = query.charCodeAt(i);\n    var isHash = char === HASH;\n    var isDot = char === DOT;\n    var isEnd = !char;\n\n    if (isHash || isDot || isEnd) {\n      if (mode === TAG_NAME) {\n        if (i === 0) {\n          tag = 'div';\n        } else {\n          tag = query.substring(offset, i);\n        }\n      } else if (mode === ID) {\n        id = query.substring(offset, i);\n      } else {\n        if (className) {\n          className += ' ' + query.substring(offset, i);\n        } else {\n          className = query.substring(offset, i);\n        }\n      }\n\n      if (isHash) {\n        mode = ID;\n      } else if (isDot) {\n        mode = CLASS_NAME;\n      }\n\n      offset = i + 1;\n    }\n  }\n\n  return { tag: tag, id: id, className: className };\n};\n\nvar createElement = function (query, ns) {\n  var ref = parseQuery(query);\n  var tag = ref.tag;\n  var id = ref.id;\n  var className = ref.className;\n  var element = ns ? document.createElementNS(ns, tag) : document.createElement(tag);\n\n  if (id) {\n    element.id = id;\n  }\n\n  if (className) {\n    if (ns) {\n      element.setAttribute('class', className);\n    } else {\n      element.className = className;\n    }\n  }\n\n  return element;\n};\n\nvar unmount = function (parent, child) {\n  var parentEl = getEl(parent);\n  var childEl = getEl(child);\n\n  if (child === childEl && childEl.__redom_view) {\n    // try to look up the view if not provided\n    child = childEl.__redom_view;\n  }\n\n  if (childEl.parentNode) {\n    doUnmount(child, childEl, parentEl);\n\n    parentEl.removeChild(childEl);\n  }\n\n  return child;\n};\n\nvar doUnmount = function (child, childEl, parentEl) {\n  var hooks = childEl.__redom_lifecycle;\n\n  if (hooksAreEmpty(hooks)) {\n    childEl.__redom_mounted = false;\n    return;\n  }\n\n  var traverse = parentEl;\n\n  if (childEl.__redom_mounted) {\n    trigger(childEl, 'onunmount');\n  }\n\n  while (traverse) {\n    var parentHooks = traverse.__redom_lifecycle || {};\n\n    for (var hook in hooks) {\n      if (parentHooks[hook]) {\n        parentHooks[hook] -= hooks[hook];\n      }\n    }\n\n    if (hooksAreEmpty(parentHooks)) {\n      traverse.__redom_lifecycle = null;\n    }\n\n    traverse = traverse.parentNode;\n  }\n};\n\nvar hooksAreEmpty = function (hooks) {\n  if (hooks == null) {\n    return true;\n  }\n  for (var key in hooks) {\n    if (hooks[key]) {\n      return false;\n    }\n  }\n  return true;\n};\n\nvar hookNames = ['onmount', 'onunmount'];\nvar shadowRootAvailable = typeof window !== 'undefined' && 'ShadowRoot' in window;\n\nvar mount = function (parent, child, before) {\n  var parentEl = getEl(parent);\n  var childEl = getEl(child);\n\n  if (child === childEl && childEl.__redom_view) {\n    // try to look up the view if not provided\n    child = childEl.__redom_view;\n  }\n\n  if (child !== childEl) {\n    childEl.__redom_view = child;\n  }\n\n  var wasMounted = childEl.__redom_mounted;\n  var oldParent = childEl.parentNode;\n\n  if (wasMounted && (oldParent !== parentEl)) {\n    doUnmount(child, childEl, oldParent);\n  }\n\n  if (before != null) {\n    parentEl.insertBefore(childEl, getEl(before));\n  } else {\n    parentEl.appendChild(childEl);\n  }\n\n  doMount(child, childEl, parentEl, oldParent);\n\n  return child;\n};\n\nvar doMount = function (child, childEl, parentEl, oldParent) {\n  var hooks = childEl.__redom_lifecycle || (childEl.__redom_lifecycle = {});\n  var remount = (parentEl === oldParent);\n  var hooksFound = false;\n\n  for (var i = 0; i < hookNames.length; i++) {\n    var hookName = hookNames[i];\n\n    if (!remount && (child !== childEl) && (hookName in child)) {\n      hooks[hookName] = (hooks[hookName] || 0) + 1;\n    }\n    if (hooks[hookName]) {\n      hooksFound = true;\n    }\n  }\n\n  if (!hooksFound) {\n    childEl.__redom_mounted = true;\n    return;\n  }\n\n  var traverse = parentEl;\n  var triggered = false;\n\n  if (remount || (!triggered && (traverse && traverse.__redom_mounted))) {\n    trigger(childEl, remount ? 'onremount' : 'onmount');\n    triggered = true;\n  }\n\n  if (remount) {\n    return;\n  }\n\n  while (traverse) {\n    var parent = traverse.parentNode;\n    var parentHooks = traverse.__redom_lifecycle || (traverse.__redom_lifecycle = {});\n\n    for (var hook in hooks) {\n      parentHooks[hook] = (parentHooks[hook] || 0) + hooks[hook];\n    }\n\n    if (!triggered && (traverse === document || (shadowRootAvailable && (traverse instanceof window.ShadowRoot)) || (parent && parent.__redom_mounted))) {\n      trigger(traverse, remount ? 'onremount' : 'onmount');\n      triggered = true;\n    }\n\n    traverse = parent;\n  }\n};\n\nvar trigger = function (el, eventName) {\n  if (eventName === 'onmount') {\n    el.__redom_mounted = true;\n  } else if (eventName === 'onunmount') {\n    el.__redom_mounted = false;\n  }\n\n  var hooks = el.__redom_lifecycle;\n\n  if (!hooks) {\n    return;\n  }\n\n  var view = el.__redom_view;\n  var hookCount = 0;\n\n  view && view[eventName] && view[eventName]();\n\n  for (var hook in hooks) {\n    if (hook) {\n      hookCount++;\n    }\n  }\n\n  if (hookCount) {\n    var traverse = el.firstChild;\n\n    while (traverse) {\n      var next = traverse.nextSibling;\n\n      trigger(traverse, eventName);\n\n      traverse = next;\n    }\n  }\n};\n\nvar setStyle = function (view, arg1, arg2) {\n  var el = getEl(view);\n\n  if (arg2 !== undefined) {\n    el.style[arg1] = arg2;\n  } else if (isString(arg1)) {\n    el.setAttribute('style', arg1);\n  } else {\n    for (var key in arg1) {\n      setStyle(el, key, arg1[key]);\n    }\n  }\n};\n\n/* global SVGElement */\n\nvar xlinkns = 'http://www.w3.org/1999/xlink';\n\nvar setAttr = function (view, arg1, arg2) {\n  var el = getEl(view);\n  var isSVG = el instanceof SVGElement;\n\n  if (arg2 !== undefined) {\n    if (arg1 === 'style') {\n      setStyle(el, arg2);\n    } else if (isSVG && isFunction(arg2)) {\n      el[arg1] = arg2;\n    } else if (arg1 === 'dataset') {\n      setData(el, arg2);\n    } else if (!isSVG && (arg1 in el || isFunction(arg2))) {\n      el[arg1] = arg2;\n    } else {\n      if (isSVG && (arg1 === 'xlink')) {\n        setXlink(el, arg2);\n        return;\n      }\n      el.setAttribute(arg1, arg2);\n    }\n  } else {\n    for (var key in arg1) {\n      setAttr(el, key, arg1[key]);\n    }\n  }\n};\n\nfunction setXlink (el, obj) {\n  for (var key in obj) {\n    el.setAttributeNS(xlinkns, key, obj[key]);\n  }\n}\n\nfunction setData (el, obj) {\n  for (var key in obj) {\n    el.dataset[key] = obj[key];\n  }\n}\n\nvar text = function (str) { return document.createTextNode((str != null) ? str : ''); };\n\nvar parseArguments = function (element, args) {\n  for (var i = 0; i < args.length; i++) {\n    var arg = args[i];\n\n    if (arg !== 0 && !arg) {\n      continue;\n    }\n\n    // support middleware\n    if (typeof arg === 'function') {\n      arg(element);\n    } else if (isString(arg) || isNumber(arg)) {\n      element.appendChild(text(arg));\n    } else if (isNode(getEl(arg))) {\n      mount(element, arg);\n    } else if (arg.length) {\n      parseArguments(element, arg);\n    } else if (typeof arg === 'object') {\n      setAttr(element, arg);\n    }\n  }\n};\n\nvar ensureEl = function (parent) { return isString(parent) ? html(parent) : getEl(parent); };\nvar getEl = function (parent) { return (parent.nodeType && parent) || (!parent.el && parent) || getEl(parent.el); };\n\nvar isString = function (a) { return typeof a === 'string'; };\nvar isNumber = function (a) { return typeof a === 'number'; };\nvar isFunction = function (a) { return typeof a === 'function'; };\n\nvar isNode = function (a) { return a && a.nodeType; };\n\nvar htmlCache = {};\n\nvar memoizeHTML = function (query) { return htmlCache[query] || (htmlCache[query] = createElement(query)); };\n\nvar html = function (query) {\n  var args = [], len = arguments.length - 1;\n  while ( len-- > 0 ) args[ len ] = arguments[ len + 1 ];\n\n  var element;\n\n  if (isString(query)) {\n    element = memoizeHTML(query).cloneNode(false);\n  } else if (isNode(query)) {\n    element = query.cloneNode(false);\n  } else {\n    throw new Error('At least one argument required');\n  }\n\n  parseArguments(element, args);\n\n  return element;\n};\n\nhtml.extend = function (query) {\n  var args = [], len = arguments.length - 1;\n  while ( len-- > 0 ) args[ len ] = arguments[ len + 1 ];\n\n  var clone = memoizeHTML(query);\n\n  return html.bind.apply(html, [ this, clone ].concat( args ));\n};\n\nvar el = html;\nvar h = html;\n\nvar setChildren = function (parent) {\n  var children = [], len = arguments.length - 1;\n  while ( len-- > 0 ) children[ len ] = arguments[ len + 1 ];\n\n  var parentEl = getEl(parent);\n  var current = traverse(parent, children, parentEl.firstChild);\n\n  while (current) {\n    var next = current.nextSibling;\n\n    unmount(parent, current);\n\n    current = next;\n  }\n};\n\nfunction traverse (parent, children, _current) {\n  var current = _current;\n\n  for (var i = 0; i < children.length; i++) {\n    var child = children[i];\n\n    if (!child) {\n      continue;\n    }\n\n    var childEl = getEl(child);\n\n    if (childEl === current) {\n      current = current.nextSibling;\n      continue;\n    }\n\n    if (isNode(childEl)) {\n      mount(parent, child, current);\n      continue;\n    }\n\n    if (child.length != null) {\n      current = traverse(parent, child, current);\n    }\n  }\n\n  return current;\n}\n\nvar propKey = function (key) { return function (item) { return item[key]; }; };\n\nvar listPool = function (View, key, initData) {\n  return new ListPool(View, key, initData);\n};\n\nvar ListPool = function ListPool (View, key, initData) {\n  this.View = View;\n  this.initData = initData;\n  this.oldLookup = {};\n  this.lookup = {};\n  this.oldViews = [];\n  this.views = [];\n\n  if (key != null) {\n    this.lookup = {};\n    this.key = isFunction(key) ? key : propKey(key);\n  }\n};\nListPool.prototype.update = function update (data, context) {\n  var ref = this;\n    var View = ref.View;\n    var key = ref.key;\n    var initData = ref.initData;\n  var keySet = key != null;\n\n  var oldLookup = this.lookup;\n  var newLookup = {};\n\n  var newViews = new Array(data.length);\n  var oldViews = this.views;\n\n  for (var i = 0; i < data.length; i++) {\n    var item = data[i];\n    var view = (void 0);\n\n    if (keySet) {\n      var id = key(item);\n      view = oldLookup[id] || new View(initData, item, i, data);\n      newLookup[id] = view;\n      view.__redom_id = id;\n    } else {\n      view = oldViews[i] || new View(initData, item, i, data);\n    }\n    view.update && view.update(item, i, data, context);\n\n    var el = getEl(view.el);\n    el.__redom_view = view;\n    newViews[i] = view;\n  }\n\n  this.oldViews = oldViews;\n  this.views = newViews;\n\n  this.oldLookup = oldLookup;\n  this.lookup = newLookup;\n};\n\nvar list = function (parent, View, key, initData) {\n  return new List(parent, View, key, initData);\n};\n\nvar List = function List (parent, View, key, initData) {\n  this.__redom_list = true;\n  this.View = View;\n  this.initData = initData;\n  this.views = [];\n  this.pool = new ListPool(View, key, initData);\n  this.el = ensureEl(parent);\n  this.keySet = key != null;\n};\nList.prototype.update = function update (data, context) {\n    var this$1 = this;\n    if ( data === void 0 ) data = [];\n\n  var ref = this;\n    var keySet = ref.keySet;\n  var oldViews = this.views;\n  var oldLookup = keySet && this.lookup;\n\n  this.pool.update(data, context);\n  var ref$1 = this.pool;\n    var views = ref$1.views;\n    var lookup = ref$1.lookup;\n\n  if (keySet) {\n    for (var i = 0; i < oldViews.length; i++) {\n      var id = oldViews[i].__redom_id;\n      if (!(id in lookup)) {\n        unmount(this$1, oldLookup[id]);\n      }\n    }\n  }\n\n  setChildren(this, views);\n\n  if (keySet) {\n    this.lookup = lookup;\n  }\n  this.views = views;\n};\n\nList.extend = function (parent, View, key, initData) {\n  return List.bind(List, parent, View, key, initData);\n};\n\nlist.extend = List.extend;\n\n/* global Node */\n\nvar place = function (View, initData) {\n  return new Place(View, initData);\n};\n\nvar Place = function Place (View, initData) {\n  this.el = text('');\n  this.visible = false;\n  this.view = null;\n  this._placeholder = this.el;\n  if (View instanceof Node) {\n    this._el = View;\n  } else {\n    this._View = View;\n  }\n  this._initData = initData;\n};\nPlace.prototype.update = function update (visible, data) {\n  var placeholder = this._placeholder;\n  var parentNode = this.el.parentNode;\n\n  if (visible) {\n    if (!this.visible) {\n      if (this._el) {\n        mount(parentNode, this._el, placeholder);\n        unmount(parentNode, placeholder);\n        this.el = this._el;\n        this.visible = visible;\n        return;\n      }\n      var View = this._View;\n      var view = new View(this._initData);\n\n      this.el = getEl(view);\n      this.view = view;\n\n      mount(parentNode, view, placeholder);\n      unmount(parentNode, placeholder);\n    }\n    this.view && this.view.update && this.view.update(data);\n  } else {\n    if (this.visible) {\n      if (this._el) {\n        mount(parentNode, placeholder, this._el);\n        unmount(parentNode, this._el);\n        this.el = placeholder;\n        this.visible = visible;\n        return;\n      }\n      mount(parentNode, placeholder, this.view);\n      unmount(parentNode, this.view);\n\n      this.el = placeholder;\n      this.view = null;\n    }\n  }\n  this.visible = visible;\n};\n\nvar router = function (parent, Views, initData) {\n  return new Router(parent, Views, initData);\n};\n\nvar Router = function Router (parent, Views, initData) {\n  this.el = ensureEl(parent);\n  this.Views = Views;\n  this.initData = initData;\n};\nRouter.prototype.update = function update (route, data) {\n  if (route !== this.route) {\n    var Views = this.Views;\n    var View = Views[route];\n\n    this.route = route;\n    this.view = View && new View(this.initData, data);\n\n    setChildren(this.el, [ this.view ]);\n  }\n  this.view && this.view.update && this.view.update(data, route);\n};\n\nvar ns = 'http://www.w3.org/2000/svg';\n\nvar svgCache = {};\n\nvar memoizeSVG = function (query) { return svgCache[query] || (svgCache[query] = createElement(query, ns)); };\n\nvar svg = function (query) {\n  var args = [], len = arguments.length - 1;\n  while ( len-- > 0 ) args[ len ] = arguments[ len + 1 ];\n\n  var element;\n\n  if (isString(query)) {\n    element = memoizeSVG(query).cloneNode(false);\n  } else if (isNode(query)) {\n    element = query.cloneNode(false);\n  } else {\n    throw new Error('At least one argument required');\n  }\n\n  parseArguments(element, args);\n\n  return element;\n};\n\nsvg.extend = function (query) {\n  var clone = memoizeSVG(query);\n\n  return svg.bind(this, clone);\n};\n\nsvg.ns = ns;\n\nvar s = svg;\n\nexport { el, h, html, list, List, listPool, ListPool, mount, unmount, place, Place, router, Router, setAttr, setStyle, setChildren, s, svg, text };\n","import {el, mount} from 'redom';\n\nexport function stickyNonModalErrorPopup(text) {\n\tdocument.body.style.filter = 'contrast(70%) brightness(130%) saturate(200%) sepia(40%) hue-rotate(300deg)';\n\n\tlet popup = el('div', text, {\n\t\tstyle: {\n\t\t\t'position': 'fixed',\n\t\t\t'display': 'inline-block',\n\t\t\t'max-width': '600%',\n\t\t\t'top': '20%',\n\t\t\t'width': '100%',\n\t\t\t'padding': '40px 10%',\n\t\t\t'font-size': '20px',\n\t\t\t'z-index': '100000',\n\t\t\t'color': 'white',\n\t\t\t'background': '#0c0c0c',\n\t\t\t'text-align': 'center',\n\t\t\t'user-select': 'auto !important',\n\t\t\t'box-sizing': 'border-box'\n\t\t}\n\t});\n\n\tmount(document.body, popup);\n}\n\nwindow.sticky = stickyNonModalErrorPopup;\n","import { isClient } from '../util/environment';\n\nlet PIXI;\n\nif (isClient) {\n\tPIXI = window['PIXI'];\n\tPIXI.ticker.shared.stop();\n}\n\nexport default PIXI;\n\nlet renderer: PIXI.WebGLRenderer | PIXI.CanvasRenderer = null; // Only one PIXI renderer supported for now\n\nexport function getRenderer(canvas: HTMLCanvasElement) {\n\t/*\n\treturn {\n\t\trender: () => {},\n\t\tresize: () => {}\n\t};\n\t*/\n\n\tif (!renderer) {\n\t\trenderer = PIXI.autoDetectRenderer({\n\t\t\tview: canvas,\n\t\t\tautoResize: true,\n\t\t\tantialias: true\n\t\t});\n\n\t\t// Interaction plugin uses ticker that runs in the background. Destroy it to save CPU.\n\t\tif (renderer.plugins.interaction) // if interaction is left out from pixi build, interaction is no defined\n\t\t\trenderer.plugins.interaction.destroy();\n\t}\n\n\treturn renderer;\n}\n\nexport function sortDisplayObjects(container) {\n\tcontainer.children.sort(sortFunc);\n}\nfunction sortFunc(a, b) {\n\tif (a.y < b.y)\n\t\treturn -1;\n\telse if (a.y > b.y)\n\t\treturn 1;\n\telse\n\t\treturn 0;\n}\n\nlet texturesAndAnchors: { [hash: string]: { texture: any, anchor: any } } = {};\nexport function resetTexturesAndAnchors() {\n\tfor (let i in texturesAndAnchors) {\n\t\ttexturesAndAnchors[i].texture.destroy();\n\t}\n\ttexturesAndAnchors = {};\n}\nexport function getHashedTextureAndAnchor(hash) {\n\treturn texturesAndAnchors[hash];\n}\nexport function generateTextureAndAnchor(graphicsObject, hash) {\n\tif (!texturesAndAnchors[hash]) {\n\t\tlet bounds = graphicsObject.getLocalBounds();\n\t\tlet anchor = {\n\t\t\tx: -bounds.x / bounds.width,\n\t\t\ty: -bounds.y / bounds.height\n\t\t};\n\t\ttexturesAndAnchors[hash] = {\n\t\t\ttexture: renderer.generateTexture(graphicsObject, PIXI.SCALE_MODES.LINEAR, 2),\n\t\t\tanchor\n\t\t};\n\t}\n\treturn texturesAndAnchors[hash];\n}\n","import PIXI from '../features/graphics';\nimport Scene from '../core/scene';\nimport { globalEventDispatcher } from '../core/eventDispatcher';\n\nfunction createCanvas() {\n\tconst RESOLUTION = 10;\n\tvar canvas = document.createElement('canvas');\n\tcanvas.width  = 1;\n\tcanvas.height = RESOLUTION;\n\tvar ctx = canvas.getContext('2d');\n\tvar gradient = ctx.createLinearGradient(0, 0, 0, RESOLUTION * 0.8);\n\t// gradient.addColorStop(0, \"#5886c8\");\n\t// gradient.addColorStop(1, \"#9eb6d5\");\n\tgradient.addColorStop(0, \"#5c77ff\");\n\tgradient.addColorStop(1, \"#90c9f6\");\n\tctx.fillStyle = gradient;\n\tctx.fillRect(0, 0, 1, RESOLUTION);\n\treturn canvas;\n}\n\nglobalEventDispatcher.listen('scene load level', (scene: Scene) => {\n\tlet gradientCanvas = createCanvas();\n\tlet sprite = new PIXI.Sprite(PIXI.Texture.fromCanvas(gradientCanvas));\n\tscene['backgroundGradient'] = sprite;\n\tupdateSceneBackgroundGradient(scene);\n\tscene.layers.static.addChild(sprite);\n});\n\nglobalEventDispatcher.listen('scene unload level', (scene: Scene) => {\n\tdelete scene['backgroundGradient'];\n});\n\nglobalEventDispatcher.listen('canvas resize', (scene: Scene) => {\n\tupdateSceneBackgroundGradient(scene);\n});\n\nfunction updateSceneBackgroundGradient(scene: Scene) {\n\tif (!scene.canvas || !scene['backgroundGradient'])\n\t\treturn;\n\n\tscene['backgroundGradient'].width = scene.canvas.width;\n\tscene['backgroundGradient'].height = scene.canvas.height;\n};\n","import assert from '../util/assert';\nimport { isClient } from '../util/environment';\n\nlet p2;\nif (isClient)\n\tp2 = window.p2;\nelse\n\tp2 = require('../src/external/p2');\n\nexport default p2;\n\nexport function createWorld(owner, options) {\n\tassert(!owner._p2World);\n\towner._p2World = new p2.World({\n\t\tgravity: [0, 9.81]\n\t\t// gravity: [0, 0]\n\t});\n\n\t// Stress test says that Body sleeping performs better than Island sleeping when idling.\n\towner._p2World.sleepMode = p2.World.BODY_SLEEPING;\n}\n// const MAX_PHYSICS_DT = 0.2;\nconst PHYSICS_DT = 1 / 60;\nexport function updateWorld(owner, dt) {\n\towner._p2World.step(PHYSICS_DT, dt, 5);\n\t// owner._p2World.step(dt, dt, 10);\n}\nexport function deleteWorld(owner) {\n\tif (owner._p2World)\n\t\towner._p2World.clear()\n\tdelete owner._p2World;\n\tdelete owner._p2Materials;\n}\nexport function getWorld(owner) {\n\treturn owner._p2World;\n}\nexport function addBody(owner, body) {\n\towner._p2World.addBody(body);\n}\nexport function deleteBody(owner, body) {\n\towner._p2World.removeBody(body);\n}\n\n// export function addContactMaterial(owner, A, B, options) {\n// \towner._p2World.addContactMaterial(new p2.ContactMaterial(A, B, options));\n// }\n\nconst defaultMaterialOptions = {\n\tfriction: 0.3,\n\trestitution: 0,\n\tstiffness: 1e6, // Hardness of the contact. Less stiffness will make the objects penetrate more, and will make the contact act more like a spring than a contact force.\n\trelaxation: 4, // Original: 3. Small number makes bounce. Big number makes object stay inside another object.\n\tfrictionStiffness: 1e6, // Stiffness of the resulting friction force. For most cases, the value of this property should be a large number. I cannot think of any case where you would want less frictionStiffness.\n\tfrictionRelaxation: 4, // Relaxation of the resulting friction force. The default value should be good for most simulations.\n\tsurfaceVelocity: 0 // Will add surface velocity to this material. If bodyA rests on top if bodyB, and the surface velocity is positive, bodyA will slide to the right.\n};\n\nexport function createMaterial(owner, options) {\n\tif (!owner._p2Materials)\n\t\towner._p2Materials = {};\n\tlet materials = owner._p2Materials;\n\toptions = Object.assign({}, defaultMaterialOptions, options);\n\tlet hash = [\n\t\toptions.friction,\n\t\toptions.restitution,\n\t\toptions.stiffness,\n\t\toptions.relaxation,\n\t\toptions.frictionStiffness,\n\t\toptions.frictionRelaxation,\n\t\toptions.surfaceVelocity\n\t].join(';');\n\n\tif (materials[hash])\n\t\treturn materials[hash];\n\n\tlet material = new p2.Material();\n\tmaterial.options = options;\n\tmaterials[hash] = material;\n\n\t// TODO: When physics entities are edited, new materials are created.\n\t// Should somehow remove old unused materials and contact materials.\n\n\tfor (var h in materials) {\n\t\tlet m = materials[h];\n\t\tlet o1 = material.options;\n\t\tlet o2 = m.options;\n\t\tlet contactMaterial = new p2.ContactMaterial(material, m, {\n\t\t\tfriction:\t\t\t\tMath.min(o1.friction, o2.friction),\n\t\t\trestitution:\t\t\tMath.max(o1.restitution, o2.restitution), // If one is bouncy and other is not, collision is bouncy.\n\t\t\tstiffness:\t\t\t\tMath.min(o1.stiffness, o2.stiffness),\n\t\t\trelaxation:\t\t\t\t(o1.relaxation + o2.relaxation) / 2,\n\t\t\tfrictionStiffness:\t\tMath.min(o1.frictionStiffness, o2.frictionStiffness),\n\t\t\tfrictionRelaxation:\t\t(o1.frictionRelaxation + o2.frictionRelaxation) / 2,\n\t\t\tsurfaceVelocity:\t\tMath.max(o1.surfaceVelocity, o2.surfaceVelocity)\n\t\t});\n\t\towner._p2World.addContactMaterial(contactMaterial);\n\t}\n\n\treturn material;\n}\n","import Vector from './vector';\n\nexport function keyPressed(key) {\n\treturn keys[key] || false;\n}\n\nexport function listenKeyDown(handler) {\n\tkeyDownListeners.push(handler);\n\treturn () => keyDownListeners.splice(keyDownListeners.indexOf(handler), 1);\n}\nexport function listenKeyUp(handler) {\n\tkeyUpListeners.push(handler);\n\treturn () => keyUpListeners.splice(keyUpListeners.indexOf(handler), 1);\n}\n\nexport const key = {\n\tleft: 37,\n\tright: 39,\n\tup: 38,\n\tdown: 40,\n\tctrl: 17,\n\tappleLeft: 91,\n\tappleRight: 93,\n\talt: 18,\n\tshift: 16,\n\tspace: 32,\n\ta: 65,\n\tb: 66,\n\tc: 67,\n\td: 68,\n\te: 69,\n\tf: 70,\n\tg: 71,\n\th: 72,\n\ti: 73,\n\tj: 74,\n\tk: 75,\n\tl: 76,\n\tm: 77,\n\tn: 78,\n\to: 79,\n\tp: 80,\n\tq: 81,\n\tr: 82,\n\ts: 83,\n\tt: 84,\n\tu: 85,\n\tv: 86,\n\tw: 87,\n\tx: 88,\n\ty: 89,\n\tz: 90,\n\t'0': 48,\n\t'1': 49,\n\t'2': 50,\n\t'3': 51,\n\t'4': 52,\n\t'5': 53,\n\t'6': 54,\n\t'7': 55,\n\t'8': 56,\n\t'9': 57,\n\tbackspace: 8,\n\tenter: 13,\n\tesc: 27,\n\tplus: 187,\n\tminus: 189,\n\tquestionMark: 191\n};\n\nexport function listenMouseMove(element: HTMLElement, handler: (vec: Vector) => void): () => void {\n\tlet domHandler = event => {\n\t\tlet x = event.pageX;\n\t\tlet y = event.pageY;\n\t\tlet el = element;\n\t\twhile (el != null) {\n\t\t\tx -= el.offsetLeft;\n\t\t\ty -= el.offsetTop;\n\t\t\tel = <HTMLElement>el.offsetParent;\n\t\t}\n\n\t\telement['_mx'] = x;\n\t\telement['_my'] = y;\n\n\t\thandler && handler(new Vector(x, y));\n\t};\n\telement.addEventListener('mousemove', domHandler);\n\treturn () => element.removeEventListener('mousemove', domHandler);\n}\n// Requires listenMouseMove on the same element to get the mouse position\nexport function listenMouseDown(element: HTMLElement, handler: (vec?: Vector) => void) {\n\tlet domHandler = event => {\n\t\tif (typeof element['_mx'] === 'number')\n\t\t\thandler(new Vector(element['_mx'], element['_my']));\n\t\telse\n\t\t\thandler();\n\t};\n\telement.addEventListener('mousedown', domHandler);\n\treturn () => element.removeEventListener('mousedown', domHandler);\n}\n// Requires listenMouseMove on the same element to get the mouse position\nexport function listenMouseUp(element: HTMLElement, handler: (vec?: Vector) => void) {\n\t// listen document body because many times mouse is accidentally dragged outside of element\n\tlet domHandler = event => {\n\t\tif (typeof element['_mx'] === 'number')\n\t\t\thandler(new Vector(element['_mx'], element['_my']));\n\t\telse\n\t\t\thandler();\n\t};\n\tdocument.body.addEventListener('mouseup', domHandler);\n\treturn () => element.removeEventListener('mouseup', domHandler);\n}\n\n////////////////////////////////////\n\n\nlet keys = {};\nlet keyDownListeners = [];\nlet keyUpListeners = [];\n\n\nif (typeof window !== 'undefined') {\n\n\twindow.onkeydown = event => {\n\t\tlet keyCode = event.which || event.keyCode;\n\n\t\tif (document.activeElement.nodeName.toLowerCase() == \"input\" && keyCode !== key.esc)\n\t\t\treturn;\n\n\t\tif (!keys[keyCode]) {\n\t\t\tkeys[keyCode] = true;\n\t\t\tkeyDownListeners.forEach(l => l(keyCode));\n\t\t}\n\n\t\t// console.log(keyCode);\n\t};\n\twindow.onkeyup = event => {\n\t\tlet key = event.which || event.keyCode;\n\t\tkeys[key] = false;\n\t\tkeyUpListeners.forEach(l => l(key));\n\t};\n}\n\nexport function simulateKeyEvent(eventName: 'keydown' | 'keyup', keyCode: number) {\n\tif (eventName === 'keydown') {\n\t\twindow.onkeydown({\n\t\t\tkeyCode\n\t\t} as any);\n\t} else if (eventName === 'keyup') {\n\t\twindow.onkeyup({\n\t\t\tkeyCode\n\t\t} as any);\n\t}\n}\n","import { isClient } from './environment';\nimport { editorEventDispacher } from \"../editor/editorEventDispatcher\";\nimport { eventDispatcherCallbacks } from '../core/eventDispatcher';\n\nconst UPDATE_INTERVAL = 1000; //ms\n\nlet performance;\nperformance = isClient ? window.performance : { now: Date.now };\n\nlet snapshotPerformance = []; // is static data for UPDATE_INTERVAL. then it changes.\nlet cumulativePerformance = {}; // will be reseted every UPDATE_INTERVAL\nlet currentPerformanceMeters = {}; // very short term\n\nlet perSecondSnapshot = [];\nlet currentPerSecondMeters = {};\nexport function eventHappened(name, count = 1) {\n\t// @ifndef OPTIMIZE\n\tcurrentPerSecondMeters[name] = (currentPerSecondMeters[name] || 0) + count;\n\t// @endif\n}\neventDispatcherCallbacks.eventDispatchedCallback = (eventName, count) => eventHappened(`Event ${eventName}`, count);\n\nexport function start(name) {\n\t// @ifndef OPTIMIZE\n\tcurrentPerformanceMeters[name] = performance.now();\n\t// @endif\n}\n\nexport function stop(name) {\n\t// @ifndef OPTIMIZE\n\tlet millis = performance.now() - currentPerformanceMeters[name];\n\tif (cumulativePerformance[name])\n\t\tcumulativePerformance[name] += millis;\n\telse\n\t\tcumulativePerformance[name] = millis;\n\t// @endif\n}\n\nlet performanceInterval = null;\nexport function startPerformanceUpdates() {\n\tperformanceInterval = setInterval(() => {\n\t\tprintPrivatePerformance(cumulativePerformance);\n\n\t\tsnapshotPerformance = performanceObjectToPublicArray(cumulativePerformance);\n\t\tcumulativePerformance = {};\n\t\teditorEventDispacher.dispatch('performance snapshot', snapshotPerformance);\n\n\t\tperSecondSnapshot = perSecondObjectToPublicArray(currentPerSecondMeters);\n\t\tcurrentPerSecondMeters = {};\n\t\teditorEventDispacher.dispatch('perSecond snapshot', perSecondSnapshot);\n\t}, UPDATE_INTERVAL);\n}\n\nfunction printPrivatePerformance(object) {\n\tlet msg = '';\n\tObject.keys(object).filter(key => key.startsWith('#')).map(key => ({\n\t\tname: key,\n\t\tvalue: object[key] / UPDATE_INTERVAL\n\t})).sort((a, b) => {\n\t\treturn a.value < b.value ? 1 : -1;\n\t}).forEach(perf => {\n\t\tmsg += `\\n   ${perf.name.substring(1)}: ${perf.value * 100}`;\n\t});\n\tif (msg)\n\t\tconsole.log('#Performance:' + msg);\n}\n\nfunction performanceObjectToPublicArray(object) {\n\treturn Object.keys(object).filter(key => !key.startsWith('#')).map(key => ({\n\t\tname: key,\n\t\tvalue: object[key] / UPDATE_INTERVAL\n\t})).sort((a, b) => {\n\t\treturn a.value < b.value ? 1 : -1;\n\t});\n}\nfunction perSecondObjectToPublicArray(object) {\n\treturn Object.keys(object).map(key => ({\n\t\tname: key,\n\t\tcount: object[key]\n\t})).sort((a, b) => a.name.localeCompare(b.name));\n}\n\nexport let FRAME_MEMORY_LENGTH = 60 * 8;\nlet frameTimes = [];\nfor (let i = 0; i < FRAME_MEMORY_LENGTH; ++i) {\n\tframeTimes.push(0);\n}\nexport function setFrameTime(seconds) {\n\t// @ifndef OPTIMIZE\n\tframeTimes.shift();\n\tframeTimes.push(seconds);\n\t// @endif\n}\nexport function getFrameTimes() {\n\treturn frameTimes;\n}\n","import Serializable from './serializable';\nimport assert from '../util/assert';\nimport { game } from './game';\nimport { addChange, changeType, setChangeOrigin } from './change';\nimport { createWorld, deleteWorld, updateWorld } from '../features/physics';\nimport { listenMouseMove, listenMouseDown, listenMouseUp, listenKeyDown, key, keyPressed } from '../util/input';\nimport { default as PIXI, getRenderer, sortDisplayObjects } from '../features/graphics';\nimport * as performanceTool from '../util/performance';\nimport Vector from '../util/vector';\n\nimport Level from './level';\nimport { Component } from './component';\nimport EntityPrototype from './entityPrototype';\nimport { GameEvent, globalEventDispatcher } from './eventDispatcher';\n\nlet scene: Scene = null;\nexport { scene };\n\nconst physicsOptions = {\n\tenableSleeping: true\n};\n\nexport default class Scene extends Serializable {\n\tcanvas: HTMLCanvasElement;\n\trenderer: any;\n\tmouseListeners: Array<() => void>;\n\tlevel: Level;\n\tstage: PIXI.Container;\n\tcameraPosition: Vector;\n\tcameraZoom: number;\n\tlayers: { [s: string]: PIXI.Container } = {};\n\tcomponents: Map<string, Set<Component>>;\n\tanimationFrameId: any;\n\tplaying: boolean;\n\ttime: number;\n\twon: boolean;\n\t_prevUpdate: number;\n\tresetting: boolean = false;\n\tpixelDensity: Vector = new Vector(1, 1);\n\n\tconstructor(predefinedId?) {\n\t\tsuper(predefinedId);\n\n\t\tif (scene) {\n\t\t\ttry {\n\t\t\t\tscene.delete();\n\t\t\t} catch (e) {\n\t\t\t\tconsole.warn('Deleting old scene failed', e);\n\t\t\t}\n\t\t}\n\t\tscene = this;\n\t\twindow['scene'] = this;\n\n\t\tthis.canvas = document.querySelector('canvas.openEditPlayCanvas');\n\t\tthis.renderer = getRenderer(this.canvas);\n\n\t\tthis.mouseListeners = [\n\t\t\tlistenMouseMove(this.canvas, mousePosition => this.dispatch('onMouseMove', mousePosition)),\n\t\t\tlistenMouseDown(this.canvas, mousePosition => this.dispatch('onMouseDown', mousePosition)),\n\t\t\tlistenMouseUp(this.canvas, mousePosition => this.dispatch('onMouseUp', mousePosition))\n\t\t];\n\n\t\taddChange(changeType.addSerializableToTree, this);\n\n\t\tglobalEventDispatcher.dispatch(GameEvent.GLOBAL_SCENE_CREATED, this);\n\t}\n\tmakeUpAName() {\n\t\tif (this.level)\n\t\t\treturn this.level.makeUpAName();\n\t\telse\n\t\t\treturn 'Scene';\n\t}\n\n\tloadLevel(level: Level) {\n\t\tthis.level = level;\n\n\t\tthis.stage = new PIXI.Container();\n\t\tthis.cameraPosition = new Vector(0, 0);\n\t\tthis.cameraZoom = 1;\n\n\t\tlet self = this;\n\t\tfunction createLayer(parent = self.stage): PIXI.Container {\n\t\t\tlet layer = new PIXI.Container();\n\t\t\tparent.addChild(layer);\n\t\t\treturn layer;\n\t\t}\n\t\tthis.layers = {\n\t\t\tstatic: createLayer(), // doesn't move when camera does\n\t\t\tbackground: createLayer(), // moves a little when camera does\n\t\t\tmove: createLayer(), // moves with camera\n\t\t\tui: createLayer() // doesn't move, is on front\n\t\t};\n\t\tthis.layers.behind = createLayer(this.layers.move);\n\t\tthis.layers.main = createLayer(this.layers.move);\n\t\tthis.layers.front = createLayer(this.layers.move);\n\n\t\t// this.bloom = new PIXI.filters.AdvancedBloomFilter();\n\t\t// this.layers.move.filters = [this.bloom];\n\n\t\t// To make component based entity search fast:\n\t\tthis.components = new Map(); // componentName -> Set of components\n\n\t\tthis.animationFrameId = null;\n\t\tthis.playing = false;\n\t\tthis.time = 0;\n\t\tthis.won = false;\n\n\t\tcreateWorld(this, physicsOptions);\n\n\t\tglobalEventDispatcher.dispatch('scene load level before entities', scene, level);\n\n\t\tthis.level.getChildren('epr').map((epr: EntityPrototype) => epr.createEntity(this));\n\n\t\tglobalEventDispatcher.dispatch('scene load level', scene, level);\n\n\t\t// this.draw();\n\t}\n\tunloadLevel() {\n\t\tlet level = this.level;\n\t\tthis.level = null;\n\n\t\tthis.pause();\n\n\t\tthis.deleteChildren();\n\n\t\tif (this.stage)\n\t\t\tthis.stage.destroy();\n\t\tthis.stage = null;\n\n\t\tthis.layers = {};\n\n\t\tthis.components.clear();\n\n\t\tdeleteWorld(this);\n\n\t\tglobalEventDispatcher.dispatch('scene unload level', scene, level);\n\t}\n\n\tsetCameraPositionToPlayer() {\n\t\tlet pos = new Vector(0, 0);\n\t\tlet count = 0;\n\t\tthis.getComponents('CharacterController').forEach(characterController => {\n\t\t\tif (characterController._rootType) {\n\t\t\t\tpos.add(characterController.Transform.position);\n\t\t\t\tcount++;\n\t\t\t}\n\t\t});\n\t\tif (count > 0) {\n\t\t\tthis.cameraPosition.set(pos.divideScalar(count));\n\t\t}\n\t}\n\n\tupdateCamera() {\n\t\tif (this.playing) {\n\t\t\tthis.setCameraPositionToPlayer();\n\t\t}\n\t\t// pivot is camera top left corner position\n\t\tthis.layers.move.pivot.set(this.cameraPosition.x - this.canvas.width / 2 / this.cameraZoom, this.cameraPosition.y - this.canvas.height / 2 / this.cameraZoom);\n\t\tthis.layers.move.scale.set(this.cameraZoom, this.cameraZoom);\n\t}\n\n\twin() {\n\t\tthis.won = true;\n\t}\n\n\tanimFrame() {\n\t\tthis.animationFrameId = null;\n\t\tif (!this._alive || !this.playing) return;\n\n\t\tlet timeInMilliseconds = performance.now();\n\t\tlet t = 0.001 * timeInMilliseconds;\n\t\tlet dt = t - this._prevUpdate;\n\n\t\tperformanceTool.setFrameTime(dt);\n\n\t\tif (dt > 0.05)\n\t\t\tdt = 0.05;\n\t\tthis._prevUpdate = t;\n\t\tthis.time += dt;\n\n\t\tsetChangeOrigin(this);\n\n\t\t// Update logic\n\t\tperformanceTool.start('Component updates');\n\t\tthis.dispatch('onUpdate', dt, this.time);\n\t\tperformanceTool.stop('Component updates');\n\n\t\t// Update physics\n\t\tperformanceTool.start('Physics');\n\t\tupdateWorld(this, dt);\n\t\tperformanceTool.stop('Physics');\n\n\t\t// // Update logic\n\t\t// performanceTool.start('Component post updates');\n\t\t// this.dispatch('onPostPhysicsUpdate', dt, this.time);\n\t\t// performanceTool.stop('Component post updates');\n\n\t\t// Update graphics\n\t\tperformanceTool.start('Draw');\n\t\tthis.draw();\n\t\tperformanceTool.stop('Draw');\n\n\t\tif (this.won) {\n\t\t\tthis.pause();\n\t\t\tthis.time = 0;\n\t\t\tgame.dispatch(GameEvent.GAME_LEVEL_COMPLETED);\n\t\t\tthis.reset();\n\t\t}\n\n\t\tthis.requestAnimFrame();\n\t}\n\n\trequestAnimFrame() {\n\t\tlet callback = () => this.animFrame();\n\t\tif (window.requestAnimationFrame)\n\t\t\tthis.animationFrameId = window.requestAnimationFrame(callback);\n\t\telse\n\t\t\tthis.animationFrameId = setTimeout(callback, 16);\n\t}\n\n\tdraw() {\n\t\tthis.updateCamera();\n\n\t\t[this.layers.behind, this.layers.main, this.layers.front].forEach(sortDisplayObjects);\n\n\t\tthis.renderer.render(this.stage, null, false);\n\n\t\tthis.dispatch(GameEvent.SCENE_DRAW, scene);\n\t\tperformanceTool.eventHappened('Draws');\n\t}\n\n\tisInInitialState() {\n\t\treturn !this.playing && this.time === 0;\n\t}\n\n\treset() {\n\t\tif (!this._alive)\n\t\t\treturn; // scene has been replaced by another one\n\n\t\tthis.resetting = true;\n\n\t\tlet level = this.level;\n\t\tthis.unloadLevel();\n\n\t\tif (level)\n\t\t\tthis.loadLevel(level);\n\n\t\t// this.draw(); // we might be doing ok even without draw.\n\t\t// player mode starts mainloop and editor may want to control the drawing more.\n\n\t\tdelete this.resetting;\n\n\t\tthis.dispatch(GameEvent.SCENE_RESET);\n\t}\n\n\tpause() {\n\t\tif (!this.playing) return;\n\n\t\tthis.playing = false;\n\t\tif (this.animationFrameId) {\n\t\t\tif (window.requestAnimationFrame)\n\t\t\t\twindow.cancelAnimationFrame(this.animationFrameId);\n\t\t\telse\n\t\t\t\tclearTimeout(this.animationFrameId);\n\t\t}\n\t\tthis.animationFrameId = null;\n\n\t\tthis.dispatch(GameEvent.SCENE_PAUSE);\n\t}\n\n\tplay() {\n\t\tif (this.playing) return;\n\n\t\tthis._prevUpdate = 0.001 * performance.now();\n\t\tthis.playing = true;\n\n\t\tthis.requestAnimFrame();\n\n\t\tif (this.time === 0)\n\t\t\tthis.dispatch(GameEvent.SCENE_START);\n\n\t\tthis.dispatch(GameEvent.SCENE_PLAY);\n\t}\n\n\tdelete() {\n\t\tif (!super.delete()) return false;\n\n\t\tthis.unloadLevel();\n\n\t\tif (scene === this)\n\t\t\tscene = null;\n\n\t\tif (this.mouseListeners) {\n\t\t\tthis.mouseListeners.forEach(listener => listener());\n\t\t\tthis.mouseListeners = null;\n\t\t}\n\n\t\tthis.renderer = null; // Do not call renderer.destroy(). Same renderer is used by all scenes for now.\n\n\t\treturn true;\n\t}\n\n\t// To make component based entity search fast:\n\taddComponent(component: Component) {\n\t\tlet set = this.components.get(component.componentClass.componentName);\n\t\tif (!set) {\n\t\t\tset = new Set();\n\t\t\tthis.components.set(component.componentClass.componentName, set);\n\t\t}\n\t\tset.add(component);\n\t}\n\n\tremoveComponent(component: Component) {\n\t\tlet set = this.components.get(component.componentClass.componentName);\n\t\tassert(set);\n\t\tassert(set.delete(component));\n\t}\n\n\tgetComponents(componentName) {\n\t\treturn this.components.get(componentName) || new Set;\n\t}\n\n\tmouseToWorld(mousePosition: Vector) {\n\t\treturn new Vector(\n\t\t\tthis.layers.move.pivot.x + mousePosition.x / this.cameraZoom * this.pixelDensity.x,\n\t\t\tthis.layers.move.pivot.y + mousePosition.y / this.cameraZoom * this.pixelDensity.y\n\t\t);\n\t}\n\tscreenPixelsToWorldPixels(screenPixels: number) {\n\t\treturn screenPixels / this.cameraZoom * this.pixelDensity.x;\n\t}\n\n\tsetZoom(zoomLevel) {\n\t\tif (zoomLevel)\n\t\t\tthis.cameraZoom = zoomLevel;\n\t\tthis.dispatch(GameEvent.SCENE_ZOOM_CHANGED, this.cameraZoom);\n\t}\n\n\tresizeCanvas(gameResolution: Vector, screenResolution?: Vector) {\n\t\tthis.renderer.resize(gameResolution.x, gameResolution.y);\n\n\t\tif (screenResolution) {\n\t\t\tthis.pixelDensity.setScalars(gameResolution.x / screenResolution.x, gameResolution.y / screenResolution.y);\n\t\t} else {\n\t\t\tthis.pixelDensity.setScalars(1, 1);\n\t\t}\n\t}\n}\nScene.prototype.isRoot = true;\n\nSerializable.registerSerializable(Scene, 'sce');\n\nexport function forEachScene(listener) {\n\tglobalEventDispatcher.listen(GameEvent.GLOBAL_SCENE_CREATED, listener);\n\n\tif (scene)\n\t\tlistener(scene);\n}\n","import assert, { changeGetter as assertChangeGetter } from '../util/assert';\nimport Serializable, { serializableCallbacks } from './serializable';\n\nexport let serializables = {};\n\nexport function addSerializable(serializable: Serializable) {\n// @ifndef OPTIMIZE\n\tif (serializables[serializable.id] !== undefined)\n\t\tassert(false, (\"Serializable id clash \" + (serializable.id)));\n// @endif\n\tserializables[serializable.id] = serializable;\n}\nserializableCallbacks.addSerializable = addSerializable;\n\nexport function getSerializable(id: string) {\n\treturn serializables[id] || null;\n}\n\nexport function hasSerializable(id: string) {\n\treturn Boolean(serializables[id]);\n}\n\nexport function removeSerializable(id: string) {\n\t/* When deleting a scene, this function is called a lot of times\n\tif (!serializables[id])\n\t\tthrow new Error('Serializable not found!');\n\t*/\n\tdelete serializables[id];\n}\nserializableCallbacks.removeSerializable = removeSerializable;\n","import Serializable from './serializable';\nimport assert from '../util/assert';\nimport { getSerializable } from './serializableManager';\nimport Prop, { PropertyType } from './propertyType';\nimport PropertyOwner from './propertyOwner';\nimport ComponentData from './componentData';\nimport Entity from './entity';\nimport { game } from './game';\nimport { Component } from './component';\nimport EntityPrototype from './entityPrototype';\nimport Level from './level';\nimport { globalEventDispatcher } from './eventDispatcher';\n\nlet propertyTypes = [\n\tProp('name', 'No name', Prop.string)\n];\n\nexport default class Prototype extends PropertyOwner {\n\tpreviouslyCreatedEntity: Entity;\n\tname: string; // Hack to reveal PropertyOwner property\n\n\tstatic _propertyTypes: Array<PropertyType>;\n\tstatic _propertyTypesByName: { [s: string]: PropertyType };\n\n\tconstructor(predefinedId?: string) {\n\t\tsuper(predefinedId);\n\n\t\tthis.previouslyCreatedEntity = null;\n\t}\n\n\tmakeUpAName() {\n\t\treturn this.name || 'Prototype';\n\t}\n\n\taddChild(child: Serializable): Prototype {\n\t\t// if (child.threeLetterType === 'cda' && !child.componentClass.allowMultiple)\n\t\tif (child instanceof ComponentData && !(child as ComponentData).componentClass.allowMultiple)\n\t\t\tassert(this.findChild('cda', (cda: ComponentData) => cda.componentId === child.componentId) === null, `Can't have multiple ${child.name} components. See Component.allowMultiple`);\n\t\tsuper.addChild(child);\n\t\treturn this;\n\t}\n\tgetParentPrototype(): Prototype {\n\t\treturn this._parent && this._parent.threeLetterType === 'prt' ? this._parent as Prototype : null;\n\t}\n\n\t/*\n\tfilter filters component datas\n\n\tReturns JSON:\n\t[\n\t\t{\n\t\t\townComponent: false, // component of a parent prototype\n\t\t\tcomponentClass: [object Object],\n\t\t\tcomponentId: <componentId>,\n\t\t\tthreeLetterType: 'icd',\n\t \t\tgeneratedForPrototype: <this>,\n\t\t\tproperties: [\n\t\t\t\t{ id missing }\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t ownComponentData: <ComponentData> || null, // null if this prototype has 0 properties defined\n\t\t\t componentClass: [object Object],\n\t\t\t componentId: <componentId>,\n\t\t\t threeLetterType: 'icd',\n\t\t\t generatedForPrototype: <this>,\n\t\t\t properties: [\n\t\t\t \t{ id found if own property } // some properties might be from parent prototypes and thus missing id\n\t\t\t ]\n\t\t }\n\t]\n\t */\n\tgetInheritedComponentDatas(filter = null) {\n\t\tlet data = getDataFromPrototype(this, this, filter);\n\t\tlet array = Object.keys(data).map(key => data[key]);\n\t\tlet inheritedComponentData;\n\t\tfor (let i = 0; i < array.length; ++i) {\n\t\t\tinheritedComponentData = array[i];\n\t\t\tinheritedComponentData.properties = inheritedComponentData.componentClass._propertyTypes.map(propertyType => {\n\t\t\t\treturn inheritedComponentData.propertyHash[propertyType.name]\n\t\t\t\t\t|| propertyType.createProperty({ skipSerializableRegistering: true });\n\t\t\t});\n\t\t\tdelete inheritedComponentData.propertyHash;\n\t\t}\n\n\t\treturn array.sort(sortInheritedComponentDatas);\n\t}\n\n\tcreateAndAddPropertyForComponentData(inheritedComponentData, propertyName, propertyValue) {\n\t\tlet propertyType = inheritedComponentData.componentClass._propertyTypesByName[propertyName] as PropertyType;\n\t\tassert(propertyType, 'Invalid propertyName', propertyName, inheritedComponentData);\n\t\tlet componentData = this.findChild('cda', (componentData: ComponentData) => componentData.componentId === inheritedComponentData.componentId);\n\t\tlet componentDataIsNew = false;\n\t\tif (!componentData) {\n\t\t\tconsole.log('no component data. create one', this, inheritedComponentData);\n\t\t\tcomponentData = new ComponentData(inheritedComponentData.componentClass.componentName, false, inheritedComponentData.componentId);\n\t\t\tcomponentDataIsNew = true;\n\t\t}\n\t\tlet property = componentData.findChild('prp', property => property.name === propertyName);\n\t\tif (property) {\n\t\t\tproperty.value = propertyValue;\n\t\t\treturn property;\n\t\t}\n\n\t\tproperty = propertyType.createProperty({\n\t\t\tvalue: propertyValue,\n\t\t});\n\t\tcomponentData.addChild(property);\n\n\t\tif (componentDataIsNew)\n\t\t\tthis.addChild(componentData);\n\n\t\treturn property;\n\t}\n\n\tfindComponentDataByComponentId(componentId, alsoFindFromParents = false) {\n\t\tlet child = this.findChild('cda', (componentData: ComponentData) => componentData.componentId === componentId);\n\t\tif (child)\n\t\t\treturn child;\n\t\tif (alsoFindFromParents) {\n\t\t\tlet parent = this.getParentPrototype();\n\t\t\tif (parent)\n\t\t\t\treturn parent.findComponentDataByComponentId(componentId, alsoFindFromParents);\n\t\t}\n\t\treturn null;\n\t}\n\n\tgetOwnComponentDataOrInherit(componentId) {\n\t\tlet componentData = this.findComponentDataByComponentId(componentId, false);\n\t\tif (!componentData) {\n\t\t\tlet inheritedComponentData = this.findComponentDataByComponentId(componentId, true);\n\t\t\tif (!inheritedComponentData)\n\t\t\t\treturn null;\n\n\t\t\tcomponentData = new ComponentData(inheritedComponentData.name, false, componentId);\n\t\t\tthis.addChild(componentData);\n\t\t}\n\t\treturn componentData\n\t}\n\n\tfindOwnProperty(componentId, propertyName) {\n\t\tlet componentData = this.findComponentDataByComponentId(componentId);\n\t\tif (componentData) {\n\t\t\treturn componentData.getProperty(propertyName);\n\t\t}\n\t\treturn null;\n\t}\n\n\t// Parent is needed so that we can init children knowing who is the parent\n\tcreateEntity(parent?: Serializable, _skipNewEntityEvent = false) {\n\t\tlet entity = new Entity();\n\n\t\tlet inheritedComponentDatas = this.getInheritedComponentDatas();\n\t\tlet components = inheritedComponentDatas.map(Component.createWithInheritedComponentData);\n\t\tentity.addComponents(components, { fullInit: false }); // Only do preInit\n\n\t\tentity.prototype = this;\n\n\t\tif (parent)\n\t\t\tparent.addChild(entity);\n\n\t\tif (Entity.ENTITY_CREATION_DEBUGGING) console.log('create entity', this.makeUpAName());\n\n\t\tthis.forEachChild('epr', (epr: EntityPrototype) => epr.createEntity(entity, true));\n\t\t// let childEntityPrototypes = this.getChildren('epr');\n\t\t// childEntityPrototypes.forEach(epr => epr.createEntity(entity));\n\n\t\t// Components have only been preinited. Lets call the init now.\n\t\tEntity.initComponents(components);\n\n\t\tthis.previouslyCreatedEntity = entity;\n\n\t\tif (!_skipNewEntityEvent)\n\t\t\tglobalEventDispatcher.dispatch('new entity created', entity);\n\n\t\treturn entity;\n\t}\n\n\tgetValue(componentId, propertyName) {\n\t\tlet componentData = this.findComponentDataByComponentId(componentId, true);\n\t\tif (componentData)\n\t\t\treturn componentData.getValue(propertyName);\n\t\telse\n\t\t\treturn undefined;\n\t}\n\n\tcountEntityPrototypes(findChildren = false) {\n\t\tlet entityPrototypeCount = 0;\n\t\tlet levelIds = new Set();\n\n\t\tif (this.threeLetterType !== 'prt') {\n\t\t\treturn {\n\t\t\t\tentityPrototypeCount,\n\t\t\t\tlevelIds\n\t\t\t};\n\t\t}\n\n\t\tlet levels = game.getChildren('lvl');\n\t\tfor (let i = levels.length - 1; i >= 0; i--) {\n\t\t\tlet entityPrototypes = levels[i].getChildren('epr') as Array<EntityPrototype>;\n\t\t\tlet foundInThisLevel = false;\n\t\t\tfor (let j = entityPrototypes.length - 1; j >= 0; j--) {\n\t\t\t\tif (entityPrototypes[j].prototype === this) {\n\t\t\t\t\tentityPrototypeCount++;\n\t\t\t\t\tfoundInThisLevel = true;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (foundInThisLevel) {\n\t\t\t\tlevelIds.add(levels[i].id);\n\t\t\t}\n\t\t}\n\n\t\tif (findChildren)\n\t\t\tthis.forEachChild('prt', (prt: Prototype) => {\n\t\t\t\tlet results = prt.countEntityPrototypes(true);\n\t\t\t\tentityPrototypeCount += results.entityPrototypeCount;\n\t\t\t\tresults.levelIds.forEach(levelId => levelIds.add(levelId));\n\t\t\t});\n\n\t\treturn {\n\t\t\tentityPrototypeCount,\n\t\t\tlevelIds\n\t\t};\n\t}\n\n\t/**\n\t * Only works for Prefabs and Prototypes. Not for EntityPrototypes.\n\t */\n\tgetEntityPrototypesThatUseThisPrototype() {\n\t\tlet entityPrototypes: EntityPrototype[] = [];\n\t\tlet levels: Set<Level> = new Set();\n\n\t\tif (this.threeLetterType !== 'prt' && this.threeLetterType !== 'pfa') {\n\t\t\treturn {\n\t\t\t\tentityPrototypes,\n\t\t\t\tlevels\n\t\t\t};\n\t\t}\n\n\t\tlet levelArray = game.getChildren('lvl') as Level[];\n\t\tfor (let i = levelArray.length - 1; i >= 0; i--) {\n\t\t\tlet levelEntityPrototypes = levelArray[i].getChildren('epr') as Array<EntityPrototype>;\n\t\t\tlet foundInThisLevel = false;\n\t\t\tfor (let j = levelEntityPrototypes.length - 1; j >= 0; j--) {\n\t\t\t\tif (levelEntityPrototypes[j].prototype === this) {\n\t\t\t\t\tentityPrototypes.push(levelEntityPrototypes[j]);\n\t\t\t\t\tfoundInThisLevel = true;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (foundInThisLevel) {\n\t\t\t\tlevels.add(levelArray[i]);\n\t\t\t}\n\t\t}\n\n\t\tthis.forEachChild(this.threeLetterType, (prt: Prototype) => {\n\t\t\tlet results = prt.getEntityPrototypesThatUseThisPrototype();\n\t\t\tentityPrototypes.push(...entityPrototypes);\n\t\t\tresults.levels.forEach((level: Level) => levels.add(level));\n\t\t});\n\n\t\treturn {\n\t\t\tentityPrototypes,\n\t\t\tlevels\n\t\t};\n\t}\n\n\tdelete() {\n\t\tlet _gameRoot = this.getRoot();\n\t\tif (!super.delete()) return false;\n\t\tif (this.threeLetterType === 'prt' && _gameRoot.threeLetterType === 'gam') {\n\t\t\t_gameRoot.forEachChild('lvl', (lvl: Level) => {\n\t\t\t\tlet items = lvl.getChildren('epr') as Array<EntityPrototype>;\n\t\t\t\tfor (let i = items.length - 1; i >= 0; i--) {\n\t\t\t\t\tif (items[i].prototype === this) {\n\t\t\t\t\t\tlvl.deleteChild(items[i], i);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tthis.previouslyCreatedEntity = null;\n\t\treturn true;\n\t}\n\tstatic create(name: string) {\n\t\treturn new Prototype().initWithPropertyValues({ name });\n\t};\n}\nPropertyOwner.defineProperties(Prototype, propertyTypes);\n\nSerializable.registerSerializable(Prototype, 'prt');\n\nfunction getDataFromPrototype(prototype: Prototype, originalPrototype: Prototype, filter?: (cda: ComponentData) => boolean, _depth = 0) {\n\tlet data;\n\n\tlet parentPrototype = prototype.getParentPrototype() as Prototype;\n\tif (parentPrototype)\n\t\tdata = getDataFromPrototype(parentPrototype, originalPrototype, filter, _depth + 1);\n\telse\n\t\tdata = {}; // Top level\n\n\tlet componentDatas = prototype.getChildren('cda') as any as Array<ComponentData>;\n\tif (filter)\n\t\tcomponentDatas = componentDatas.filter(filter);\n\tlet componentData;\n\tfor (let i = 0; i < componentDatas.length; ++i) {\n\t\tcomponentData = componentDatas[i];\n\n\t\tif (!data[componentData.componentId]) {\n\t\t\t// Most parent version of this componentId\n\t\t\tdata[componentData.componentId] = {\n\t\t\t\t// ownComponent = true if the original prototype is the first one introducing this componentId\n\t\t\t\townComponentData: null, // will be given value if the original prototype has this componentId\n\t\t\t\tcomponentClass: componentData.componentClass,\n\t\t\t\tcomponentId: componentData.componentId,\n\t\t\t\tpropertyHash: {},\n\t\t\t\tthreeLetterType: 'icd',\n\t\t\t\tgeneratedForPrototype: originalPrototype,\n\t\t\t};\n\t\t}\n\n\t\tif (_depth === 0) {\n\t\t\tdata[componentData.componentId].ownComponentData = componentData;\n\t\t}\n\n\t\tlet propertyHash = data[componentData.componentId].propertyHash;\n\n\t\tlet properties = componentData.getChildren('prp');\n\t\tlet property;\n\t\tfor (let j = 0; j < properties.length; ++j) {\n\t\t\tproperty = properties[j];\n\t\t\t// Newest version of a property always overrides old property\n\t\t\tpropertyHash[property.name] = _depth === 0 ? property : property.clone(true);\n\t\t}\n\t};\n\n\treturn data;\n}\n\nfunction sortInheritedComponentDatas(a, b) {\n\treturn a.componentClass.componentName.localeCompare(b.componentClass.componentName);\n}\n","import Prototype from './prototype';\nimport Property from './property';\nimport Serializable from './serializable';\nimport { getSerializable } from './serializableManager';\nimport { Prop, componentClasses } from './component';\nimport ComponentData from './componentData';\nimport assert from '../util/assert';\nimport Vector from '../util/vector';\nimport Prefab from './prefab';\n\n// EntityPrototype is a prototype that always has one Transform ComponentData and optionally other ComponentDatas also.\n// Entities are created based on EntityPrototypes\nexport default class EntityPrototype extends Prototype {\n\tprototype: Prototype = null;\n\tconstructor(predefinedId?) {\n\t\tsuper(predefinedId);\n\t\t// this._parent is level, not prototype. We need a link to parent-prototype.\n\t}\n\n\tmakeUpAName() {\n\t\tlet nameProperty = this.findChild('prp', (property: Property) => property.name === 'name');\n\t\tif (nameProperty && nameProperty.value)\n\t\t\treturn nameProperty.value;\n\t\telse if (this.prototype)\n\t\t\treturn this.prototype.makeUpAName();\n\t\telse\n\t\t\treturn 'EntityPrototype';\n\t}\n\n\tgetTransform() {\n\t\treturn this.findChild('cda', (cda: ComponentData) => cda.name === 'Transform');\n\t}\n\tgetParentPrototype() {\n\t\treturn this.prototype || null;\n\t}\n\tclone() {\n\t\tlet obj = new EntityPrototype();\n\t\tobj.prototype = this.prototype;\n\t\tlet id = obj.id;\n\t\tlet children = [];\n\t\tthis.forEachChild(null, child => {\n\t\t\tif (child.threeLetterType === 'prp' && (child as Property).name === 'name') {\n\t\t\t\tlet property = new Property({\n\t\t\t\t\tvalue: (child as Property).propertyType.type.clone((child as Property).value),\n\t\t\t\t\tname: (child as Property).name,\n\t\t\t\t\tpropertyType: (child as Property).propertyType,\n\t\t\t\t\tpredefinedId: id + '_n'\n\t\t\t\t});\n\t\t\t\tchildren.push(property);\n\t\t\t} else if (child.threeLetterType === 'cda' && (child as ComponentData).name === 'Transform') {\n\t\t\t\tlet transform = new ComponentData('Transform', id + '_t');\n\n\t\t\t\t// Transform component data always has a position\n\t\t\t\tlet position = transform.componentClass._propertyTypesByName.position.createProperty({\n\t\t\t\t\tvalue: child.findChild('prp', (prp: Property) => prp.name === 'position').value,\n\t\t\t\t\tpredefinedId: id + '_p'\n\t\t\t\t});\n\t\t\t\ttransform.addChild(position);\n\n\t\t\t\tlet oldScaleProperty = child.findChild('prp', (prp: Property) => prp.name === 'scale');\n\t\t\t\tif (oldScaleProperty) {\n\t\t\t\t\tlet scale = transform.componentClass._propertyTypesByName.scale.createProperty({\n\t\t\t\t\t\tvalue: oldScaleProperty.value,\n\t\t\t\t\t\tpredefinedId: id + '_s'\n\t\t\t\t\t});\n\t\t\t\t\ttransform.addChild(scale);\n\t\t\t\t}\n\n\t\t\t\tlet oldAngleProperty = child.findChild('prp', (prp: Property) => prp.name === 'angle');\n\t\t\t\tif (oldAngleProperty) {\n\t\t\t\t\tlet angle = transform.componentClass._propertyTypesByName.angle.createProperty({\n\t\t\t\t\t\tvalue: oldAngleProperty.value,\n\t\t\t\t\t\tpredefinedId: id + '_a'\n\t\t\t\t\t});\n\t\t\t\t\ttransform.addChild(angle);\n\t\t\t\t}\n\n\t\t\t\tchildren.push(transform);\n\t\t\t} else if (child.threeLetterType === 'cda') {\n\t\t\t\tchildren.push((child as ComponentData).clone({ cloneComponentId: true }));\n\t\t\t} else {\n\t\t\t\tchildren.push(child.clone());\n\t\t\t}\n\t\t});\n\t\tobj.initWithChildren(children);\n\t\tthis._state |= Serializable.STATE_CLONE;\n\t\treturn obj;\n\t}\n\n\ttoJSON() {\n\t\t/*\n\t\tlet json = super.toJSON();\n\t\tjson.t = this.prototype.id;\n\t\treturn json;\n\t\t*/\n\n\t\t// Below optimization reduces size 88%. child id's have to be generated based on this.id\n\n\t\tlet Transform = this.getTransform();\n\t\tlet json: any = {\n\t\t\tid: this.id\n\t\t};\n\t\tif (this.prototype)\n\t\t\tjson.t = this.prototype.id; // might be prototype or prefab or may not exist. .t as in type\n\n\t\tlet childArrays = [];\n\t\tthis._children.forEach(child => {\n\t\t\tchildArrays.push(child);\n\t\t});\n\t\tlet children = [].concat(...childArrays).filter(child => {\n\t\t\treturn child !== Transform && child !== this._properties.name;\n\t\t});\n\t\tif (children.length > 0)\n\t\t\tjson.c = children.map(child => child.toJSON());\n\n\t\tlet floatToJSON = Prop.float().toJSON;\n\t\tlet handleProperty = prp => {\n\t\t\tif (prp.name === 'name') {\n\t\t\t\tif (prp.value)\n\t\t\t\t\tjson.n = prp.value;\n\t\t\t} else if (prp.name === 'position') {\n\t\t\t\tjson.p = prp.type.toJSON(prp.value);\n\t\t\t} else if (prp.name === 'scale') {\n\t\t\t\tif (!prp.value.isEqualTo(new Vector(1, 1))) {\n\t\t\t\t\tjson.s = prp.type.toJSON(prp.value);\n\t\t\t\t}\n\t\t\t} else if (prp.name === 'angle') {\n\t\t\t\tif (prp.value !== 0)\n\t\t\t\t\tjson.a = floatToJSON(prp.value);\n\t\t\t}\n\t\t};\n\t\thandleProperty(this._properties.name);\n\n\t\tTransform.getChildren('prp').forEach(handleProperty);\n\t\treturn json;\n\t}\n\tspawnEntityToScene(scene, position) {\n\t\tif (!scene)\n\t\t\treturn;\n\n\t\tif (position) {\n\t\t\tthis.getTransform().getPropertyOrCreate('position').value = position;\n\t\t}\n\n\t\tthis.createEntity(scene);\n\t}\n\n\tdetachFromPrototype() {\n\t\tthis.name = this.makeUpAName();\n\n\t\tlet inheritedComponentDatas = this.getInheritedComponentDatas((cda: ComponentData) => {\n\t\t\treturn cda.name !== 'Transform';\n\t\t});\n\t\tlet children: Array<Serializable> = inheritedComponentDatas.map(icd => {\n\t\t\treturn new ComponentData(icd.componentClass.componentName, null, icd.componentId)\n\t\t\t\t.initWithChildren(icd.properties.map(prp => prp.clone()));\n\t\t}) as any as Array<Serializable>;\n\n\t\tlet componentDatas = this.getChildren('cda') as ComponentData[];\n\t\tcomponentDatas.forEach(cda => {\n\t\t\tif (cda.name !== 'Transform')\n\t\t\t\tcda.delete();\n\t\t});\n\t\tdebugger;\n\t\t// TODO: For some reason all non-Transform components have not been removed yet...\n\t\tthis.addChildren(children);\n\n\t\tthis.prototype = null;\n\t}\n\n\t// Optimize this away\n\tsetRootType(rootType) {\n\t\tif (this._rootType === rootType)\n\t\t\treturn;\n\t\tassert(this.getTransform(), 'EntityPrototype must have a Transform');\n\t\tsuper.setRootType(rootType);\n\t}\n\t/**\n\t * If Transform or Transform.position is missing, they are added.\n\t * prototype can also be Prefab which extends Prototype.\n\t */\n\tstatic createFromPrototype(prototype: Prototype) {\n\t\tif (prototype.threeLetterType === 'pfa') {\n\t\t\treturn (prototype as Prefab).createEntityPrototype();\n\t\t}\n\n\t\tlet entityPrototype = new EntityPrototype();\n\t\tentityPrototype.prototype = prototype;\n\t\tlet id = entityPrototype.id;\n\n\t\tlet prototypeTransform = prototype.findChild('cda', cda => cda.name === 'Transform');\n\n\t\tif (prototypeTransform)\n\t\t\tassert(false, 'Prototype (prt) can not have a Transform component');\n\n\t\tlet name = createEntityPrototypeNameProperty(id);\n\t\tlet transform = createEntityPrototypeTransform(id);\n\n\t\tentityPrototype.initWithChildren([name, transform]);\n\n\t\t// @ifndef OPTIMIZE\n\t\tassert(entityPrototype.getTransform(), 'EntityPrototype must have a Transform');\n\t\t// @endif\n\n\t\treturn entityPrototype;\n\t}\n}\nObject.defineProperty(EntityPrototype.prototype, 'position', {\n\tget() {\n\t\treturn this.getTransform().findChild('prp', prp => prp.name === 'position').value;\n\t},\n\tset(position) {\n\t\treturn this.getTransform().findChild('prp', prp => prp.name === 'position').value = position;\n\t}\n});\n\nexport function createEntityPrototypeNameProperty(entityPrototypeId, name = '') {\n\treturn EntityPrototype._propertyTypesByName.name.createProperty({\n\t\tvalue: name,\n\t\tpredefinedId: entityPrototypeId + '_n'\n\t});\n}\n\nexport function createEntityPrototypeTransform(entityPrototypeId) {\n\tlet transform = new ComponentData('Transform', entityPrototypeId + '_t');\n\n\tlet position = transform.componentClass._propertyTypesByName.position.createProperty({\n\t\tvalue: new Vector(0, 0),\n\t\tpredefinedId: entityPrototypeId + '_p'\n\t});\n\ttransform.addChild(position);\n\n\tlet scale = transform.componentClass._propertyTypesByName.scale.createProperty({\n\t\tvalue: new Vector(1, 1),\n\t\tpredefinedId: entityPrototypeId + '_s'\n\t});\n\ttransform.addChild(scale);\n\n\tlet angle = transform.componentClass._propertyTypesByName.angle.createProperty({\n\t\tvalue: 0,\n\t\tpredefinedId: entityPrototypeId + '_a'\n\t});\n\ttransform.addChild(angle);\n\n\treturn transform;\n}\n\nEntityPrototype.create = function (name = 'Empty', position = new Vector(0, 0)) {\n\tlet entityPrototype = new EntityPrototype();\n\tlet transform = createEntityPrototypeTransform(entityPrototype.id);\n\ttransform.setValue('position', position);\n\n\tlet nameProperty = createEntityPrototypeNameProperty(entityPrototype.id, name);\n\n\tentityPrototype.initWithChildren([nameProperty, transform]);\n\treturn entityPrototype;\n}\n\nSerializable.registerSerializable(EntityPrototype, 'epr', json => {\n\tlet entityPrototype = new EntityPrototype(json.id);\n\tentityPrototype.prototype = json.t ? getSerializable(json.t) : null;\n\n\t// assert(!json.t || entityPrototype.prototype, `Prototype or Prefab ${json.t} not found`); // .t as in type\n\tif (json.t && !entityPrototype.prototype)\n\t\tconsole.warn(`EntityPrototype thougt it had a prototype or prefab ${json.t} but it was not found.`);\n\n\tlet nameId = json.id + '_n';\n\tlet transformId = json.id + '_t';\n\tlet positionId = json.id + '_p';\n\tlet scaleId = json.id + '_s';\n\tlet angleId = json.id + '_a';\n\n\tlet name = Prototype._propertyTypesByName.name.createProperty({\n\t\tvalue: json.n === undefined ? '' : json.n,\n\t\tpredefinedId: nameId\n\t});\n\n\tlet transformData = new ComponentData('Transform', transformId);\n\tlet transformClass = componentClasses.get('Transform');\n\n\tlet position = transformClass._propertyTypesByName.position.createProperty({\n\t\tvalue: Vector.fromObject(json.p), // in the future, everything will be using p instead of x and y.\n\t\tpredefinedId: positionId\n\t});\n\ttransformData.addChild(position);\n\n\tlet scale = transformClass._propertyTypesByName.scale.createProperty({\n\t\tvalue: json.s && Vector.fromObject(json.s) || new Vector(1, 1),\n\t\tpredefinedId: scaleId\n\t});\n\ttransformData.addChild(scale);\n\n\tlet angle = transformClass._propertyTypesByName.angle.createProperty({\n\t\tvalue: json.a || 0,\n\t\tpredefinedId: angleId\n\t});\n\ttransformData.addChild(angle);\n\n\tentityPrototype.initWithChildren([name, transformData]);\n\n\treturn entityPrototype;\n});\n","import { Component, Prop } from '../core/component';\nimport Vector from '../util/vector';\nimport { Color } from '../util/color';\nimport { default as PIXI, generateTextureAndAnchor, getHashedTextureAndAnchor } from '../features/graphics';\nimport { isClient } from '../util/environment';\n\nimport { PHYSICS_SCALE } from './Physics';\nimport { GameEvent } from '../core/eventDispatcher';\n\nComponent.register({\n\tname: 'Particles',\n\tcategory: 'Graphics',\n\tdescription: 'Particle engine gives eye candy.',\n\tallowMultiple: true,\n\tproperties: [\n\t\tProp('startColor', new Color('#68c07f'), Prop.color),\n\t\tProp('endColor', new Color('#59abc0'), Prop.color),\n\t\tProp('alpha', 1, Prop.float, Prop.float.range(0, 1)),\n\t\tProp('particleSize', 10, Prop.float, Prop.float.range(1, 100)),\n\t\tProp('particleCount', 30, Prop.int, Prop.int.range(0, 10000)),\n\t\tProp('particleLifetime', 1, Prop.float, Prop.float.range(0.1, 10), 'in seconds'),\n\t\tProp('particleHardness', 0.2, Prop.float, Prop.float.range(0, 1)),\n\t\tProp('blendMode', 'add', Prop.enum, Prop.enum.values('add', 'normal')),\n\t\tProp('spawnType', 'circle', Prop.enum, Prop.enum.values('circle', 'rectangle')),\n\t\tProp('spawnRadius', 20, Prop.float, Prop.float.range(0, 1000), Prop.visibleIf('spawnType', 'circle')),\n\t\tProp('spawnRandom', 0.5, Prop.float, Prop.float.range(0, 1), Prop.visibleIf('spawnType', 'circle')),\n\t\tProp('spawnRect', new Vector(50, 50), Prop.vector, Prop.visibleIf('spawnType', 'rectangle')),\n\t\tProp('speedToOutside', 50, Prop.float, Prop.float.range(-1000, 1000), Prop.visibleIf('spawnType', 'circle')),\n\t\tProp('speed', new Vector(0, 0), Prop.vector),\n\t\tProp('speedRandom', 0, Prop.float, Prop.float.range(0, 1000), 'Max random velocity to random direction'),\n\t\tProp('acceleration', new Vector(0, 0), Prop.vector),\n\t\tProp('globalCoordinates', true, Prop.bool),\n\t\tProp('followObject', 0.4, Prop.float, Prop.float.range(0, 1), Prop.visibleIf('globalCoordinates', true))\n\t],\n\tprototype: {\n\t\tinit() {\n\t\t\t//ParticleContainer does not work properly!\n\n\t\t\t// maxSize < 40 will crash\n\t\t\t// With many Particle-components with few particles, this is deadly-expensive.\n\t\t\t// And also crashes now and then with low maxValue.\n\t\t\t// this.container = new PIXI.particles.ParticleContainer(5000, {\n\t\t\t// \tposition: true,\n\t\t\t// \talpha: true,\n\t\t\t// \tscale: false,\n\t\t\t// \trotation: false,\n\t\t\t// \tuvs: false\n\t\t\t// });\n\n\n\t\t\t// Use normal container instead\n\t\t\tthis.container = new PIXI.Container();\n\n\t\t\t// Texture\n\t\t\tthis.updateTexture();\n\t\t\t['particleSize', 'particleHardness', 'alpha'].forEach(propertyName => {\n\t\t\t\tthis.listenProperty(this, propertyName, () => {\n\t\t\t\t\tthis.updateTexture();\n\t\t\t\t});\n\t\t\t});\n\n\t\t\t// Blend mode\n\t\t\tthis.listenProperty(this, 'blendMode', blendMode => {\n\t\t\t\tif (!this.particles)\n\t\t\t\t\treturn;\n\n\t\t\t\tthis.particles.forEach(p => {\n\t\t\t\t\tif (p.sprite)\n\t\t\t\t\t\tp.sprite.blendMode = blendModes[blendMode];\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.scene.layers.main.addChild(this.container);\n\n\t\t\tthis.initParticles();\n\t\t\t['particleLifetime', 'particleCount'].forEach(propertyName => {\n\t\t\t\tthis.listenProperty(this, propertyName, () => {\n\t\t\t\t\tthis.initParticles();\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.updateGlobalCoordinatesProperty();\n\t\t\tthis.listenProperty(this, 'globalCoordinates', () => {\n\t\t\t\tthis.updateGlobalCoordinatesProperty();\n\t\t\t});\n\n\t\t\tthis.Physics = this.entity.getComponent('Physics');\n\t\t},\n\n\t\tupdateGlobalCoordinatesProperty() {\n\t\t\tif (this.positionListener) {\n\t\t\t\tthis.positionListener();\n\t\t\t\tthis.positionListener = null;\n\t\t\t}\n\t\t\tif (this.globalCoordinates) {\n\t\t\t\tthis.particles.forEach(p => {\n\t\t\t\t\tif (p.sprite) {\n\t\t\t\t\t\tp.sprite.x += this.container.position.x;\n\t\t\t\t\t\tp.sprite.y += this.container.position.y;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tthis.container.position.set(0, 0);\n\t\t\t} else {\n\t\t\t\tthis.positionListener = this.Transform.listen('globalTransformChanged', Transform => {\n\t\t\t\t\tlet position = Transform.getGlobalPosition();\n\t\t\t\t\tthis.container.position.set(position.x, position.y);\n\t\t\t\t});\n\t\t\t\tthis.container.position.set(this.Transform.position.x, this.Transform.position.y);\n\n\t\t\t\tthis.particles.forEach(p => {\n\t\t\t\t\tif (p.sprite) {\n\t\t\t\t\t\tp.sprite.x -= this.container.position.x;\n\t\t\t\t\t\tp.sprite.y -= this.container.position.y;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\n\t\tupdateTexture() {\n\t\t\tthis.texture = getParticleTexture(this.particleSize, this.particleHardness * 0.9, { r: 255, g: 255, b: 255, a: this.alpha });\n\t\t\t// this.container.baseTexture = this.texture;\n\t\t\tif (this.particles) {\n\t\t\t\tthis.particles.forEach(p => {\n\t\t\t\t\tif (p.sprite)\n\t\t\t\t\t\tp.sprite.texture = this.texture;\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\n\t\tinitParticles() {\n\t\t\tif (this.particles) {\n\t\t\t\tthis.particles.forEach(p => {\n\t\t\t\t\tif (p.sprite)\n\t\t\t\t\t\tp.sprite.destroy();\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis.particles = [];\n\t\t\tlet interval = this.particleLifetime / this.particleCount;\n\t\t\tlet firstBirth = this.scene.time + Math.random() * interval;\n\t\t\tfor (let i = 0; i < this.particleCount; ++i) {\n\t\t\t\tthis.particles.push({\n\t\t\t\t\talive: false,\n\t\t\t\t\tnextBirth: firstBirth + i * interval\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\n\t\tresetParticle(p) {\n\n\t\t\tp.vx = this.speed.x;\n\t\t\tp.vy = this.speed.y;\n\t\t\tif (this.speedRandom > 0) {\n\t\t\t\tlet randomSpeed = this.speedRandom * Math.random();\n\t\t\t\tlet randomAngle = Math.random() * Math.PI * 2;\n\t\t\t\tp.vx += Math.sin(randomAngle) * randomSpeed;\n\t\t\t\tp.vy += Math.cos(randomAngle) * randomSpeed;\n\t\t\t}\n\n\t\t\t// Calculate starting position\n\t\t\tif (this.spawnType === 'circle') {\n\t\t\t\tlet r = this.spawnRadius;\n\t\t\t\tif (this.spawnRandom > 0) {\n\t\t\t\t\tr = this.spawnRandom * Math.random() * r + (1 - this.spawnRandom) * r;\n\t\t\t\t}\n\t\t\t\tlet angle = Math.random() * Math.PI * 2;\n\t\t\t\tp.sprite.x = Math.cos(angle) * r;\n\t\t\t\tp.sprite.y = Math.sin(angle) * r;\n\t\t\t\tif (this.speedToOutside !== 0) {\n\t\t\t\t\tp.vx += Math.cos(angle) * this.speedToOutside;\n\t\t\t\t\tp.vy += Math.sin(angle) * this.speedToOutside;\n\t\t\t\t}\n\t\t\t} else if (this.spawnType === 'rectangle') {\n\t\t\t\t// Rectangle\n\t\t\t\tp.sprite.x = -this.spawnRect.x / 2 + Math.random() * this.spawnRect.x;\n\t\t\t\tp.sprite.y = -this.spawnRect.y / 2 + Math.random() * this.spawnRect.y;\n\t\t\t}\n\n\t\t\tp.age = this.scene.time - p.nextBirth;\n\t\t\tp.nextBirth += this.particleLifetime;\n\n\t\t\tif (this.globalCoordinates) {\n\t\t\t\tlet pos = Vector.fromObject(this.container.toLocal(zeroPoint, this.Transform.container, tempPoint));\n\t\t\t\tp.sprite.x += pos.x;\n\t\t\t\tp.sprite.y += pos.y;\n\n\t\t\t\tif (this.Physics && this.Physics.body) {\n\t\t\t\t\tlet vel = this.Physics.body.velocity;\n\t\t\t\t\tp.vx = p.vx + this.followObject * vel[0] / PHYSICS_SCALE;\n\t\t\t\t\tp.vy = p.vy + this.followObject * vel[1] / PHYSICS_SCALE;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\tonUpdate(dt, t) {\n\t\t\tconst particleLifetime = this.particleLifetime;\n\t\t\tconst invParticleLifetime = 1 / particleLifetime;\n\t\t\tconst particles = this.particles;\n\t\t\tconst accelerationX = this.acceleration.x * dt;\n\t\t\tconst accelerationY = this.acceleration.y * dt;\n\n\t\t\t// Fast color interpolation\n\t\t\tconst startColor = this.startColor;\n\t\t\tconst endColor = this.endColor;\n\t\t\tfunction colorLerp(lerp) {\n\t\t\t\tlet startMultiplier = 1 - lerp;\n\t\t\t\tlet r = (startColor.r * startMultiplier + endColor.r * lerp) | 0; // to int\n\t\t\t\tlet g = (startColor.g * startMultiplier + endColor.g * lerp) | 0;\n\t\t\t\tlet b = (startColor.b * startMultiplier + endColor.b * lerp) | 0;\n\t\t\t\treturn 65536 * r + 256 * g + b;\n\t\t\t}\n\n\t\t\tlet sprite,\n\t\t\t\tspritePos,\n\t\t\t\tscale,\n\t\t\t\tlerp,\n\t\t\t\tp\n\t\t\t\t;\n\n\t\t\tfor (let i = 0; i < this.particleCount; i++) {\n\t\t\t\tp = particles[i];\n\n\t\t\t\tif (!p.alive) {\n\t\t\t\t\t// Not alive\n\t\t\t\t\tif (t >= p.nextBirth) {\n\t\t\t\t\t\t// The birth!\n\t\t\t\t\t\tp.sprite = new PIXI.Sprite(this.texture);\n\t\t\t\t\t\tp.sprite.blendMode = blendModes[this.blendMode];\n\t\t\t\t\t\tp.sprite.anchor.set(0.5, 0.5);\n\t\t\t\t\t\tp.alive = true;\n\t\t\t\t\t\tthis.resetParticle(p);\n\t\t\t\t\t\tthis.container.addChild(p.sprite);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Is alive\n\n\t\t\t\tsprite = p.sprite;\n\t\t\t\tspritePos = sprite.transform.position;\n\n\t\t\t\tp.age += dt;\n\t\t\t\tlerp = p.age * invParticleLifetime;\n\t\t\t\tif (lerp >= 1) {\n\t\t\t\t\tthis.resetParticle(p);\n\t\t\t\t\tlerp = p.age * invParticleLifetime;\n\t\t\t\t} else {\n\t\t\t\t\tp.vx += accelerationX;\n\t\t\t\t\tp.vy += accelerationY;\n\t\t\t\t\tspritePos.x += p.vx * dt;\n\t\t\t\t\tspritePos.y += p.vy * dt;\n\t\t\t\t}\n\n\t\t\t\tsprite.tint = colorLerp(lerp);\n\n\t\t\t\tsprite.alpha = alphaLerp(lerp);\n\n\t\t\t\tscale = scaleLerp(lerp);\n\t\t\t\tsprite.scale.set(scale, scale);\n\n\t\t\t}\n\t\t},\n\n\t\tsleep() {\n\t\t\tthis.particles = null;\n\n\t\t\tthis.container.destroy();\n\t\t\tthis.container = null;\n\n\t\t\tif (this.positionListener) {\n\t\t\t\tthis.positionListener();\n\t\t\t\tthis.positionListener = null;\n\t\t\t}\n\n\t\t\t// do not destroy textures. we can reuse them.\n\t\t}\n\t}\n});\n\nfunction alphaLerp(lerp) {\n\tif (lerp > 0.5) {\n\t\treturn (1 - lerp) / 0.5;\n\t} else if (lerp > 0.2) {\n\t\treturn 1;\n\t} else {\n\t\treturn lerp * 5;\n\t}\n}\n\nfunction scaleLerp(lerp) {\n\tif (lerp > 0.5) {\n\t\treturn 1;\n\t} else {\n\t\treturn 0.5 + lerp;\n\t}\n}\n\nconst blendModes = {\n\tadd: isClient ? PIXI.BLEND_MODES.ADD : 0,\n\tnormal: isClient ? PIXI.BLEND_MODES.NORMAL : 0\n};\n\nlet textureCache = {};\n\n// size: pixels\n// gradientHardness: 0..1\nfunction getParticleTexture(size, gradientHardness = 0, rgb = { r: 255, g: 255, b: 255, a: 1 }) {\n\tlet hash = `${size}-${gradientHardness}-${rgb.r}-${rgb.g}-${rgb.b}-${rgb.a}`;\n\tif (!textureCache[hash]) {\n\t\tlet canvas = document.createElement('canvas');\n\t\tcanvas.width = size;\n\t\tcanvas.height = size;\n\t\tlet context = canvas.getContext('2d');\n\t\tvar gradient = context.createRadialGradient(\n\t\t\tsize * 0.5,\n\t\t\tsize * 0.5,\n\t\t\tsize * 0.5 * (gradientHardness), // inner r\n\t\t\tsize * 0.5,\n\t\t\tsize * 0.5,\n\t\t\tsize * 0.5 // outer r\n\t\t);\n\t\tgradient.addColorStop(0, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${rgb.a})`);\n\t\tgradient.addColorStop(1, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0)`);\n\t\tcontext.fillStyle = gradient;\n\t\tcontext.fillRect(0, 0, size, size);\n\t\ttextureCache[hash] = PIXI.Texture.fromCanvas(canvas);\n\t}\n\treturn textureCache[hash];\n}\n\nlet zeroPoint = new PIXI.Point();\nlet tempPoint = new PIXI.Point();\n","export function removeTheDeadFromArray(array) {\n\tfor (let i = array.length - 1; i >= 0; --i) {\n\t\tif (array[i]._alive === false)\n\t\t\tarray.splice(i, 1);\n\t}\n}\n\nexport function absLimit(value, absMax) {\n\tif (value > absMax)\n\t\treturn absMax;\n\telse if (value < -absMax)\n\t\treturn -absMax;\n\telse\n\t\treturn value;\n}\n","import {\n\texecuteExternal,\n\tchangeType,\n\tChange\n} from './change'\nimport Serializable from './serializable';\nimport {game} from './game';\nimport {limit} from '../util/callLimiter';\nimport {stickyNonModalErrorPopup} from \"../util/popup\";\nimport assert from '../util/assert';\nimport { getSerializable } from './serializableManager';\nimport Property from './property';\nimport { GameEvent, globalEventDispatcher } from './eventDispatcher';\n\nlet options = {\n\tcontext: null, // 'play' or 'edit'. This is communicated to server. Doesn't affect client.\n\tserverToClientEnabled: true,\n\tclientToServerEnabled: false\n};\n\nexport function configureNetSync(_options) {\n\toptions = Object.assign(options, _options);\n}\n\nlet changes = [];\nlet valueChanges = {}; // id => change\n\nfunction isInSceneTree(change) {\n\treturn change.reference._rootType === 'sce';\n}\n\nfunction getQueryVariable(variable) {\n\tvar query = window.location.search.substring(1);\n\tvar vars = query.split('&');\n\tfor (var i = 0; i < vars.length; i++) {\n\t\tvar pair = vars[i].split('=');\n\t\tif (decodeURIComponent(pair[0]) == variable) {\n\t\t\treturn decodeURIComponent(pair[1]);\n\t\t}\n\t}\n\tconsole.log('Query variable %s not found', variable);\n}\n\nfunction changeReceivedOverNet(packedChanges) {\n\tif (!options.serverToClientEnabled)\n\t\treturn;\n\tpackedChanges.forEach(change => {\n\t\tchange = unpackChange(change);\n\t\tif (change) {\n\t\t\texecuteChange(change);\n\t\t}\n\t});\n}\nfunction gameReceivedOverNet(gameData){\n\tconsole.log('receive gameData', gameData);\n\tif (!gameData)\n\t\treturn console.error('Game data was not received');\n\ttry {\n\t\texecuteExternal(() => {\n\t\t\tSerializable.fromJSON(gameData);\n\t\t});\n\t\tlocalStorage.openEditPlayGameId = gameData.id;\n\t\t// location.replace(`${location.origin}${location.pathname}?gameId=${gameData.id}`);\n\t\thistory.replaceState({}, null, `?gameId=${gameData.id}`);\n\t} catch(e) {\n\t\tconsole.error('Game is corrupt.', e);\n\t\tstickyNonModalErrorPopup('Game is corrupt.');\n\t}\n}\n\nglobalEventDispatcher.listen(GameEvent.GLOBAL_CHANGE_OCCURED, change => {\n\tif (change.external || !options.clientToServerEnabled)\n\t\treturn; // Don't send a change that you have received.\n\n\tif (isInSceneTree(change)) // Don't sync scene\n\t\treturn;\n\n\tif (change.type === changeType.setPropertyValue) {\n\t\tlet duplicateChange = valueChanges[change.id];\n\t\tif (duplicateChange) {\n\t\t\tchanges.splice(changes.indexOf(duplicateChange), 1);\n\t\t}\n\t\tvalueChanges[change.id] = change;\n\t}\n\tchanges.push(change);\n\n\tif (sendChanges)\n\t\tsendChanges();\n});\n\nfunction parseSocketMessage(message) {\n\tlet type = message.split(' ')[0];\n\tlet body = message.substring(type.length + 1);\n\tif (body.length > 0)\n\t\tbody = JSON.parse(body);\n\n\tconsole.log('parseSocketMessage', type, body);\n\n\treturn {\n\t\ttype,\n\t\tbody\n\t};\n}\n\nfunction sendSocketMessage(eventName, data) {\n\tif (!socket)\n\t\treturn console.log('Could not send', eventName);\n\n\tif (eventName)\n\t\tsocket.emit(eventName, data);\n\telse\n\t\tsocket.emit(data);\n}\n\nlet listeners = {\n\tdata(result) {\n\t\tlet {profile, gameData, editAccess} = result;\n\t\tlocalStorage.openEditPlayUserId = profile.id;\n\t\tlocalStorage.openEditPlayUserToken = profile.userToken;\n\n\t\tif (!editAccess) {\n\t\t\tglobalEventDispatcher.dispatch('noEditAccess');\n\t\t}\n\n\t\tdelete profile.userToken;\n\t\twindow.user = profile;\n\n\t\tgameReceivedOverNet(gameData);\n\t},\n\tidentifyYourself() {\n\t\tif (game)\n\t\t\treturn location.reload();\n\n\t\tlet gameId = getQueryVariable('gameId') || localStorage.openEditPlayGameId;\n\t\tlet userId = localStorage.openEditPlayUserId; // if doesn't exist, server will create one\n\t\tlet userToken = localStorage.openEditPlayUserToken; // if doesn't exist, server will create one\n\t\tlet context = options.context;\n\t\tsendSocketMessage('identify', {userId, userToken, gameId, context});\n\t},\n\terrorMessage(result) {\n\t\tlet {message, isFatal, data} = result;\n\t\tconsole.error(`Server sent ${isFatal ? 'FATAL ERROR' : 'error'}:`, message, data);\n\t\tif (isFatal) {\n\t\t\tstickyNonModalErrorPopup(message);\n\t\t\t// document.body.textContent = message;\n\t\t}\n\t}\n};\n\nlet sendChanges = limit(200, 'soon', () => {\n\tif (!socket || changes.length === 0 || !options.clientToServerEnabled)\n\t\treturn;\n\n\tlet packedChanges = changes.map(packChange);\n\tchanges.length = 0;\n\tvalueChanges = {};\n\tconsole.log('send change', packedChanges);\n\tsendSocketMessage('', packedChanges);\n});\n\nlet socket;\nfunction connect() {\n\tlet io = window['io'];\n\tif (!io) {\n\t\treturn console.error('socket.io not defined after window load.');\n\t}\n\n\tsocket = new io();\n\tsocket.on('connect', () => {\n\t\tsocket.onevent = packet => {\n\t\t\tlet param1 = packet.data[0];\n\t\t\tif (typeof param1 === 'string') {\n\t\t\t\tlisteners[param1](packet.data[1]);\n\t\t\t} else {\n\t\t\t\t// Optimized change-event\n\t\t\t\tchangeReceivedOverNet(param1);\n\t\t\t}\n\t\t};\n\t\tsocket.on('disconnect', () => {\n\t\t\tconsole.warn('Disconnected!');\n\t\t\tstickyNonModalErrorPopup('Disconnected!');\n\t\t\toptions.serverToClientEnabled = false;\n\t\t\toptions.clientToServerEnabled = false;\n\t\t});\n\t});\n}\nwindow.addEventListener('load', connect);\n\nlet keyToShortKey = {\n\tid: 'i', // obj.id\n\ttype: 't', // changeType.*\n\tvalue: 'v', // value after toJSON\n\tparentId: 'p' // obj._parent.id\n};\nlet shortKeyToKey = {};\nObject.keys(keyToShortKey).forEach(k => {\n\tshortKeyToKey[keyToShortKey[k]] = k;\n});\n\nfunction packChange(change) {\n\tif (change.packedChange)\n\t\treturn change.packedChange; // optimization\n\n\tlet packed = {};\n\ttry {\n\t\tif (change.parent)\n\t\t\tchange.parentId = change.parent.id;\n\n\t\tif (change.type === changeType.addSerializableToTree) {\n\t\t\tif (change.reference) {\n\t\t\t\tchange.value = change.reference.toJSON();\n\t\t\t} else {\n\t\t\t\tassert(false, 'invalid change of type addSerializableToTree', change);\n\t\t\t}\n\t\t} else if (change.value !== undefined) {\n\t\t\tchange.value = change.reference.propertyType.type.toJSON(change.value);\n\t\t}\n\n\t\tObject.keys(keyToShortKey).forEach(key => {\n\t\t\tif (change[key] !== undefined) {\n\t\t\t\tif (key === 'type' && change[key] === changeType.setPropertyValue) return; // optimize most common type\n\t\t\t\tpacked[keyToShortKey[key]] = change[key];\n\t\t\t}\n\t\t});\n\t} catch (e) {\n\t\tconsole.log('PACK ERROR', e);\n\t}\n\treturn packed;\n}\n\nfunction unpackChange(packedChange): Change {\n\tlet change: any = {\n\t\tpackedChange // optimization\n\t};\n\tObject.keys(packedChange).forEach(shortKey => {\n\t\tlet key = shortKeyToKey[shortKey];\n\t\tchange[key] = packedChange[shortKey];\n\t});\n\tif (!change.type)\n\t\tchange.type = changeType.setPropertyValue;\n\n\tif (change.type === changeType.addSerializableToTree) {\n\t\t// reference does not exist because it has not been created yet\n\t\tchange.id = change.value.id;\n\t} else {\n\t\tchange.reference = getSerializable(change.id);\n\t\tif (change.reference) {\n\t\t\tchange.id = change.reference.id;\n\t\t} else {\n\t\t\tconsole.error('received a change with unknown id', change, 'packed:', packedChange);\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tif (change.parentId)\n\t\tchange.parent = getSerializable(change.parentId);\n\treturn change as Change;\n}\n\nfunction executeChange(change: Change) {\n\tlet newScene;\n\n\texecuteExternal(() => {\n\t\tif (change.type === changeType.setPropertyValue) {\n\t\t\t(change.reference as Property).value = (change.reference as Property).propertyType.type.fromJSON(change.value);\n\t\t} else if (change.type === changeType.addSerializableToTree) {\n\t\t\tif (change.parent) {\n\t\t\t\tlet obj = Serializable.fromJSON(change.value);\n\t\t\t\tchange.parent.addChild(obj);\n\t\t\t\tif (obj.threeLetterType === 'ent') {\n\t\t\t\t\tobj.localMaster = false;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tlet obj = Serializable.fromJSON(change.value); // Scene does not need a parent\n\t\t\t\tif (obj.threeLetterType === 'sce')\n\t\t\t\t\tnewScene = obj;\n\t\t\t}\n\t\t} else if (change.type === changeType.deleteAllChildren) {\n\t\t\tchange.reference.deleteChildren();\n\t\t} else if (change.type === changeType.deleteSerializable) {\n\t\t\tchange.reference.delete();\n\t\t} else if (change.type === changeType.move) {\n\t\t\tchange.reference.move(change.parent);\n\t\t}\n\t});\n\n\tif (newScene)\n\t\tnewScene.play();\n}\n","import { scene, forEachScene } from '../core/scene';\nimport debug from './debug'\n\nimport Vector from '../util/vector';\nimport { globalEventDispatcher } from '../core/eventDispatcher';\n\nlet previousWidth = null;\nlet previousHeight = null;\nfunction resizeCanvas() {\n\tif (!scene)\n\t\treturn;\n\n\tlet screen = document.getElementById('screen');\n\n\tfunction setSize(force: boolean = false) {\n\t\tif (!screen)\n\t\t\treturn;\n\n\t\tlet width = window.innerWidth;\n\t\tlet height = window.innerHeight;\n\n\t\tif (!force && width === previousWidth && height === previousHeight)\n\t\t\treturn;\n\n\t\tscreen.style.width = width + 'px';\n\t\tscreen.style.height = height + 'px';\n\n\t\t// Here you can change the resolution of the canvas\n\t\tlet pixels = width * height;\n\t\tlet quality = 1;\n\t\tif (pixels > MAX_PIXELS) {\n\t\t\tquality = Math.sqrt(MAX_PIXELS / pixels);\n\t\t}\n\n\t\tlet screenResolution = new Vector(width, height);\n\t\tlet gameResolution = screenResolution.clone().multiplyScalar(quality);\n\n\t\tscene.resizeCanvas(gameResolution, screenResolution);\n\t\t// scene.renderer.resize(width * quality, height * quality);\n\n\t\twindow.scrollTo(0, 0);\n\n\t\tpreviousWidth = width;\n\t\tpreviousHeight = height;\n\n\t\tglobalEventDispatcher.dispatch('canvas resize', scene);\n\n\t\t// Lets see if it has changed after 200ms.\n\t\tsetTimeout(() => setSize(), 200);\n\t}\n\n\tsetSize(true);\n\n\t// setTimeout(setSize, 50);\n\t// setTimeout(setSize, 400);\n\t// setTimeout(setSize, 1000);\n}\n\nwindow.addEventListener('resize', resizeCanvas);\nforEachScene(resizeCanvas);\n\nconst MAX_PIXELS = 800 * 600;\n","import {keyPressed, key, listenKeyDown, simulateKeyEvent} from '../util/input'\nimport {forEachScene, scene} from '../core/scene';\nimport Vector from '../util/vector';\nimport { default as TouchControl, CONTROL_SIZE } from './TouchControl';\nimport debug from './debug'\nimport { GameEvent } from '../core/eventDispatcher';\n\nconst ARROW_HITBOX_RADIUS = 110;\n\nconst controls: { [s: string]: TouchControl; } = {\n\ttouchUp:\tnew TouchControl('touchUp',\t\tkey.up),\n\ttouchDown:\tnew TouchControl('touchDown',\tkey.down),\n\ttouchLeft:\tnew TouchControl('touchLeft',\tkey.left),\n\ttouchRight:\tnew TouchControl('touchRight',\tkey.right),\n\ttouchJump:\tnew TouchControl('touchJump',\tkey.up, true),\n\ttouchA:\t\tnew TouchControl('touchA',\t\tkey.space, true),\n\ttouchB:\t\tnew TouchControl('touchB',\t\tkey.b, true)\n};\nconst rightHandControlArray = [controls.touchJump, controls.touchA, controls.touchB];\nconst controlArray = Object.keys(controls).map(key => controls[key]);\n\nwindow.addEventListener('load', () => {\n\tdocument.addEventListener(\"touchmove\", touchChange, {passive: false});\n\tdocument.addEventListener(\"touchstart\", touchChange, {passive: false});\n\tdocument.addEventListener(\"touchend\", touchChange, {passive: false});\n\tdocument.addEventListener(\"scroll\", event => event.preventDefault(), {passive: false});\n\n\twindow.IS_TOUCH_DEVICE = 'ontouchstart' in window || navigator.maxTouchPoints;\n\tif (window.IS_TOUCH_DEVICE)\n\t\tdocument.body.classList.add('touch');\n\n\tif (window.navigator.standalone)\n\t\tdocument.body.classList.add('nativeFullscreen');\n\n\tcontrolArray.forEach(control => control.initElement());\n});\n\nfunction touchChange(event) {\n\tevent.preventDefault();\n\n\tlet touchCoordinates = getTouchCoordinates(event);\n\tcontrolArray.forEach(control => {\n\t\tlet isPressed = !!touchCoordinates.find(coord => control.contains(coord));\n\t\tcontrol.setState(isPressed, event.type === 'touchstart');\n\t});\n}\n\nfunction getTouchCoordinates(touchEvent) {\n\tlet touchCoordinates = [];\n\tfor (let i = 0; i < touchEvent.targetTouches.length; ++i) {\n\t\tlet touch = touchEvent.targetTouches[i];\n\t\ttouchCoordinates.push(new Vector(touch.clientX,touch.clientY));\n\t}\n\treturn touchCoordinates;\n}\n\nforEachScene(() => {\n\tscene.listen(GameEvent.SCENE_START, () => positionControls());\n});\n\nfunction positionControls() {\n\tif (!scene)\n\t\treturn;\n\n\tlet\n\t\tplayerFound = false,\n\t\tjumperFound = false,\n\t\tjumpSpeedFound = false,\n\t\ttopDownFound = false,\n\t\tnextLevelButton = true // Press A to reset. Temp solution.\n\t;\n\n\tlet characterControllers = scene.getComponents('CharacterController');\n\tcharacterControllers.forEach(characterController => {\n\t\tif (characterController.type === 'player') {\n\t\t\tplayerFound = true;\n\t\t\tif (characterController.controlType === 'jumper') {\n\t\t\t\tjumperFound = true;\n\t\t\t\tif (characterController.jumpSpeed !== 0) {\n\t\t\t\t\tjumpSpeedFound = true;\n\t\t\t\t}\n\t\t\t} else if (characterController.controlType === 'top down') {\n\t\t\t\ttopDownFound = true;\n\t\t\t}\n\t\t}\n\t});\n\n\tcontrols.touchUp.setVisible(topDownFound);\n\tcontrols.touchLeft.setVisible(playerFound);\n\tcontrols.touchRight.setVisible(playerFound);\n\tcontrols.touchDown.setVisible(topDownFound);\n\tcontrols.touchJump.setVisible(jumpSpeedFound);\n\tcontrols.touchA.setVisible(nextLevelButton); // Temp solution.\n\tcontrols.touchB.setVisible(false);\n\n\tif (controls.touchUp.visible && controls.touchDown.visible) {\n\t\tcontrols.touchLeft.setPosition(10, null, 60);\n\t\tcontrols.touchRight.setPosition(110, null, 60);\n\t\tcontrols.touchUp.setPosition(60, null, 110);\n\t\tcontrols.touchDown.setPosition(60, null, 10);\n\n\t\tcontrols.touchLeft.setContainsFunction(point => {\n\t\t\tlet rel = getRelativePositionToArrowCenter(point);\n\t\t\treturn rel.x < 0 && Math.abs(rel.x) > Math.abs(rel.y) && rel.length() <= ARROW_HITBOX_RADIUS;\n\t\t});\n\n\t\tcontrols.touchUp.setContainsFunction(point => {\n\t\t\tlet rel = getRelativePositionToArrowCenter(point);\n\t\t\treturn rel.y < 0 && Math.abs(rel.y) > Math.abs(rel.x) && rel.length() <= ARROW_HITBOX_RADIUS;\n\t\t});\n\n\t\tcontrols.touchRight.setContainsFunction(point => {\n\t\t\tlet rel = getRelativePositionToArrowCenter(point);\n\t\t\treturn rel.x > 0 && Math.abs(rel.x) > Math.abs(rel.y) && rel.length() <= ARROW_HITBOX_RADIUS;\n\t\t});\n\n\t\tcontrols.touchDown.setContainsFunction(point => {\n\t\t\tlet rel = getRelativePositionToArrowCenter(point);\n\t\t\treturn rel.y > 0 && Math.abs(rel.y) > Math.abs(rel.x) && rel.length() <= ARROW_HITBOX_RADIUS;\n\t\t});\n\t} else {\n\t\tcontrols.touchLeft.setPosition(10, null, 20);\n\t\tcontrols.touchRight.setPosition(90, null, 20);\n\n\t\tcontrols.touchLeft.setContainsFunction(point => {\n\t\t\tlet rel = getRelativePositionToArrowCenter(point);\n\t\t\treturn rel.x <= 0 && rel.y > -ARROW_HITBOX_RADIUS;\n\t\t});\n\t\tcontrols.touchRight.setContainsFunction(point => {\n\t\t\tlet rel = getRelativePositionToArrowCenter(point);\n\t\t\treturn rel.x > 0 && rel.y > -ARROW_HITBOX_RADIUS && rel.x < ARROW_HITBOX_RADIUS;\n\t\t});\n\t}\n\n\tconst SIDE_BUTTON_EXTRA_LEFT_HITBOX = 15; // pixels\n\tlet visibleRightHandControls = rightHandControlArray.filter(control => control.visible);\n\tvisibleRightHandControls.forEach((control, idx) => {\n\t\tlet idxFromRightWall = visibleRightHandControls.length - 1 - idx;\n\t\tcontrol.setPosition(null, 10 + idxFromRightWall * 20, 20 + idx * 70);\n\n\t\tif (idx === 0) {\n\t\t\t// Bottom right corner control\n\t\t\tcontrol.setContainsFunction(point => {\n\t\t\t\tlet pos = control.getPosition();\n\t\t\t\treturn point.x >= pos.x - CONTROL_SIZE / 2 - SIDE_BUTTON_EXTRA_LEFT_HITBOX && point.y >= pos.y - CONTROL_SIZE / 2;\n\t\t\t});\n\t\t} else {\n\t\t\tcontrol.setContainsFunction(point => {\n\t\t\t\tlet pos = control.getPosition();\n\t\t\t\treturn point.y >= pos.y - CONTROL_SIZE / 2 && point.y <= pos.y + CONTROL_SIZE / 2 && point.x >= pos.x - CONTROL_SIZE / 2 - SIDE_BUTTON_EXTRA_LEFT_HITBOX;\n\t\t\t});\n\t\t}\n\t});\n}\n\nfunction getArrowCenter() {\n\tlet leftPos = controls.touchLeft.getPosition();\n\tlet rightPos = controls.touchRight.getPosition();\n\tlet center = leftPos.add(rightPos).divideScalar(2);\n\treturn center;\n}\nfunction getRelativePositionToArrowCenter(point) {\n\tlet center = getArrowCenter();\n\treturn point.clone().subtract(center);\n}\n","let isClient = typeof window !== 'undefined';\nlet isServer = typeof module !== 'undefined';\n\nif (isClient && isServer)\n\tthrow new Error('Can not be client and server at the same time.');\n\nexport { isClient, isServer };\n","import Serializable from './serializable';\nimport { addChange, changeType, setChangeOrigin } from './change';\nimport assert from '../util/assert';\nimport * as performanceTool from '../util/performance';\nimport { PropertyType } from './propertyType';\nimport { GameEvent } from './eventDispatcher';\n\nlet changesEnabled = true;\nlet scenePropertyFilter = null;\n// true / false to enable / disable property value change sharing.\n// if object is passed, changes are only sent\nexport function filterSceneChanges(_scenePropertyFilter) {\n\tscenePropertyFilter = _scenePropertyFilter;\n\tchangesEnabled = true;\n}\n\nexport function disableAllChanges() {\n\tchangesEnabled = false;\n}\n\nexport function enableAllChanges() {\n\tchangesEnabled = true;\n}\n\n// Object of a property\nexport default class Property extends Serializable {\n\t_value: any;\n\t_initialValue: any;\n\tname: any;\n\tpropertyType: PropertyType;\n\t_initialValueIsJSON: boolean = false;\n\n\t// set skipSerializableRegistering=true if you are not planning to add this property to the hierarchy\n\t// if you give propertyType, value in real value form\n\t// if you don't give propertyType (give it later), value as JSON form\n\tconstructor({ value, predefinedId = '', name, propertyType = null, skipSerializableRegistering = false }) {\n\t\tsuper(predefinedId, skipSerializableRegistering);\n\t\tassert(name, 'Property without a name can not exist');\n\t\tthis._initialValue = value;\n\t\tif (propertyType)\n\t\t\tthis.setPropertyType(propertyType);\n\t\telse {\n\t\t\tthis.name = name;\n\t\t\tthis._initialValueIsJSON = true;\n\t\t}\n\t}\n\tmakeUpAName() {\n\t\treturn this.name;\n\t}\n\tsetPropertyType(propertyType) {\n\t\tthis.propertyType = propertyType;\n\t\ttry {\n\t\t\tif (this._initialValue !== undefined)\n\t\t\t\tthis.value = this._initialValueIsJSON ? propertyType.type.fromJSON(this._initialValue) : this._initialValue;\n\t\t\telse\n\t\t\t\tthis.value = propertyType.initialValue;\n\t\t} catch(e) {\n\t\t\tconsole.log('Invalid value', e, propertyType, this);\n\t\t\tthis.value = propertyType.initialValue;\n\t\t}\n\t\tthis.name = propertyType.name;\n\t}\n\tclone(skipSerializableRegistering = false) {\n\t\treturn new Property({\n\t\t\tvalue: this.propertyType.type.clone(this.value),\n\t\t\tname: this.name,\n\t\t\tpropertyType: this.propertyType,\n\t\t\tskipSerializableRegistering\n\t\t});\n\t}\n\ttoJSON() {\n\t\treturn Object.assign(super.toJSON(), {\n\t\t\tv: this.type.toJSON(this.value),\n\t\t\tn: this.propertyType.name\n\t\t});\n\t}\n\n\tget type() {\n\t\treturn this.propertyType.type;\n\t}\n\n\tset value(newValue) {\n\t\tlet oldValue = this._value;\n\t\tthis._value = this.propertyType.validator.validate(newValue);\n\n\t\tthis.dispatch(GameEvent.PROPERTY_VALUE_CHANGE, this._value, oldValue);\n\t\tif (changesEnabled && this._rootType) { // not scene or empty\n\t\t\tif (scenePropertyFilter === null\n\t\t\t\t|| this._rootType !== 'sce'\n\t\t\t\t|| scenePropertyFilter(this)\n\t\t\t) {\n\t\t\t\taddChange(changeType.setPropertyValue, this);\n\t\t\t}\n\t\t}\n\t}\n\tget value() {\n\t\treturn this._value;\n\t}\n}\nProperty.prototype.propertyType = null;\n\nSerializable.registerSerializable(Property, 'prp', json => {\n\treturn new Property({\n\t\tvalue: json.v,\n\t\tpredefinedId: json.id,\n\t\tname: json.n\n\t});\n});\n\nObject.defineProperty(Property.prototype, 'debug', {\n\tget() {\n\t\treturn `prp ${this.name}=${this.value}`;\n\t}\n});\n","export default class Vector {\n\tx: number;\n\ty: number;\n\tconstructor(x: number, y: number) {\n\t\tthis.x = x || 0;\n\t\tthis.y = y || 0;\n\t}\n\tadd(vec: Vector) {\n\t\tthis.x += vec.x;\n\t\tthis.y += vec.y;\n\t\treturn this;\n\t}\n\taddScalars(x: number, y: number) {\n\t\tthis.x += x;\n\t\tthis.y += y;\n\t\treturn this;\n\t}\n\tsubtract(vec: Vector) {\n\t\tthis.x -= vec.x;\n\t\tthis.y -= vec.y;\n\t\treturn this;\n\t}\n\tsubtractScalars(x: number, y: number) {\n\t\tthis.x -= x;\n\t\tthis.y -= y;\n\t\treturn this;\n\t}\n\tmultiply(vec: Vector) {\n\t\tthis.x *= vec.x;\n\t\tthis.y *= vec.y;\n\t\treturn this;\n\t}\n\tmultiplyScalar(scalar: number) {\n\t\tthis.x *= scalar;\n\t\tthis.y *= scalar;\n\t\treturn this;\n\t}\n\tdivide(vec: Vector) {\n\t\tthis.x /= vec.x;\n\t\tthis.y /= vec.y;\n\t\treturn this;\n\t}\n\tdivideScalar(scalar: number) {\n\t\tthis.x /= scalar;\n\t\tthis.y /= scalar;\n\t\treturn this;\n\t}\n\tdot(vec: Vector) {\n\t\treturn this.x * vec.x + this.y * vec.y;\n\t}\n\tlength(): number {\n\t\treturn Math.sqrt(this.x * this.x + this.y * this.y);\n\t}\n\tlengthSq(): number {\n\t\treturn this.x * this.x + this.y * this.y;\n\t}\n\tsetLength(newLength: number) {\n\t\tlet oldLength = this.length();\n\n\t\tif (oldLength === 0) {\n\t\t\tthis.x = newLength;\n\t\t\tthis.y = 0;\n\t\t} else {\n\t\t\tthis.multiplyScalar(newLength / oldLength);\n\t\t}\n\t\treturn this;\n\t}\n\tgetProjectionOn(vec: Vector) {\n\t\tlet length = vec.length();\n\t\tif (length === 0)\n\t\t\treturn this.clone();\n\t\telse\n\t\t\treturn vec.clone().multiplyScalar(this.dot(vec) / (length * length));\n\t}\n\tdistance(vec: Vector) {\n\t\tlet dx = this.x - vec.x,\n\t\t\tdy = this.y - vec.y;\n\t\treturn Math.sqrt(dx * dx + dy * dy);\n\t}\n\tdistanceSq(vec: Vector) {\n\t\tlet dx = this.x - vec.x,\n\t\t\tdy = this.y - vec.y;\n\t\treturn dx * dx + dy * dy;\n\t}\n\tnormalize() {\n\t\treturn this.setLength(1);\n\t}\n\thorizontalAngle() {\n\t\treturn Math.atan2(this.y, this.x);\n\t}\n\tverticalAngle() {\n\t\treturn Math.atan2(this.x, this.y);\n\t}\n\trotate(angle: number) {\n\t\tlet x = this.x * Math.cos(angle) - this.y * Math.sin(angle);\n\t\tthis.y = this.x * Math.sin(angle) + this.y * Math.cos(angle);\n\t\tthis.x = x;\n\n\t\treturn this;\n\t}\n\trotateTo(angle: number) {\n\t\treturn this.rotate(angle - this.verticalAngle());\n\t}\n\tisEqualTo(vec: Vector) {\n\t\treturn this.x === vec.x && this.y === vec.y;\n\t}\n\tisZero(): boolean {\n\t\treturn !this.x && !this.y;\n\t}\n\tclone(): Vector {\n\t\treturn new Vector(this.x, this.y);\n\t}\n\tset(vec: Vector) {\n\t\tthis.x = vec.x;\n\t\tthis.y = vec.y;\n\t\treturn this;\n\t}\n\tsetScalars(x: number, y: number) {\n\t\tthis.x = x;\n\t\tthis.y = y;\n\t\treturn this;\n\t}\n\ttoString(): string {\n\t\treturn `[${this.x}, ${this.y}]`;\n\t}\n\ttoArray(): Array<number> {\n\t\treturn [this.x, this.y];\n\t}\n\n\tstatic fromObject(obj: { x: number, y: number }) {\n\t\treturn new Vector(obj.x, obj.y);\n\t};\n\tstatic fromArray(obj) {\n\t\treturn new Vector(obj[0], obj[1]);\n\t};\n}\n","import Serializable from './serializable';\nimport assert from '../util/assert';\nimport { getSerializable } from './serializableManager';\nimport { PropertyType } from './propertyType';\nexport { default as Prop } from './propertyType';\nimport Property from './property';\n\nexport interface PropertyOwnerClass {\n\t_propertyTypes: Array<PropertyType>;\n\t_propertyTypesByName: { [s: string]: PropertyType };\n}\n\nexport default class PropertyOwner extends Serializable {\n\t_properties: { [name: string]: Property } = {};\n\t_propertyOwnerClass: PropertyOwnerClass; // use prototype's value\n\n\tconstructor(predefinedId?: string) {\n\t\tsuper(predefinedId);\n\t\tassert(Array.isArray(this._propertyOwnerClass._propertyTypes), 'call PropertyOwner.defineProperties after class definition');\n\t}\n\tmakeUpAName() {\n\t\treturn (this as any).name || 'PropertyOwner';\n\t}\n\t// Just a helper\n\tinitWithPropertyValues(values: {[key: string]: any} = {}) {\n\t\tlet children = [];\n\n\t\tObject.keys(values).forEach(propName => {\n\t\t\tlet propertyType = this._propertyOwnerClass._propertyTypesByName[propName];\n\t\t\tassert(propertyType, 'Invalid property ' + propName);\n\t\t\tchildren.push(propertyType.createProperty({\n\t\t\t\tvalue: values[propName]\n\t\t\t}));\n\t\t});\n\t\tthis.initWithChildren(children);\n\t\treturn this;\n\t}\n\tinitWithChildren(children: Array<Serializable> = []) {\n\t\tassert(!(this._state & Serializable.STATE_INIT), 'init already done');\n\t\tthis._state |= Serializable.STATE_INIT;\n\n\t\tlet propChildren: Array<Property> = [];\n\t\tlet otherChildren: Array<Serializable> = [];\n\t\t// Separate Property children and other children\n\t\tchildren.forEach(child => {\n\t\t\tif (child.threeLetterType === 'prp') {\n\t\t\t\tpropChildren.push(child as Property);\n\t\t\t} else {\n\t\t\t\totherChildren.push(child);\n\t\t\t}\n\t\t});\n\t\tsuper.addChildren(otherChildren);\n\n\t\tlet invalidPropertiesCount = 0;\n\n\t\tlet propertyIdToInvalid = {};\n\n\t\t// Make sure Properties have a PropertyType. They don't work without it.\n\t\tpropChildren.filter(prop => !prop.propertyType).forEach(prop => {\n\t\t\tlet propertyType = (this.constructor as any as PropertyOwnerClass)._propertyTypesByName[prop.name];\n\t\t\tif (!propertyType) {\n\t\t\t\tconsole.log('Property of that name not defined', this.id, prop.name, this);\n\t\t\t\tinvalidPropertiesCount++;\n\t\t\t\tpropertyIdToInvalid[prop.id] = true;\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tprop.setPropertyType(propertyType);\n\t\t});\n\t\tif (invalidPropertiesCount)\n\t\t\tpropChildren = propChildren.filter(p => !propertyIdToInvalid[p.id]);\n\n\t\t// Make sure all PropertyTypes have a matching Property\n\t\tlet nameToProp = {};\n\t\tpropChildren.forEach(c => nameToProp[c.name] = c);\n\t\tthis._propertyOwnerClass._propertyTypes.forEach(propertyType => {\n\t\t\tif (!nameToProp[propertyType.name])\n\t\t\t\tpropChildren.push(propertyType.createProperty());\n\t\t});\n\n\t\tsuper.addChildren(propChildren);\n\t\treturn this;\n\t}\n\taddChild(child: Serializable): PropertyOwner {\n\t\tassert(this._state & Serializable.STATE_INIT, this.constructor + ' requires that initWithChildren will be called before addChild');\n\t\tsuper.addChild(child);\n\t\tif (child.threeLetterType === 'prp') {\n\t\t\tif (!(child as Property).propertyType) {\n\t\t\t\tif (!this._propertyOwnerClass._propertyTypesByName[(child as Property).name]) {\n\t\t\t\t\tconsole.log('Property of that name not defined', this.id, child, this);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t(child as Property).setPropertyType(this._propertyOwnerClass._propertyTypesByName[(child as Property).name]);\n\t\t\t}\n\t\t\tassert(this._properties[(child as Property).propertyType.name] === undefined, 'Property already added');\n\t\t\tthis._properties[(child as Property).propertyType.name] = (child as Property);\n\t\t}\n\t\treturn this;\n\t}\n\tcreatePropertyHash() {\n\t\treturn this.getChildren('prp').map(property => '' + (property as Property)._value).join(',');\n\t}\n\tdelete() {\n\t\tif (!super.delete()) return false;\n\t\tthis._properties = {};\n\t\treturn true;\n\t}\n\t// idx is optional\n\tdeleteChild(child: Serializable, idx?: number) {\n\t\tassert(child.threeLetterType !== 'prp', 'Can not delete just one Property child.');\n\t\tsuper.deleteChild(child, idx);\n\t\treturn this;\n\t}\n\n\tstatic defineProperties(Class: { new(...args): Serializable }, propertyTypes: Array<PropertyType>) {\n\t\tClass.prototype._propertyOwnerClass = Class;\n\t\tlet ClassAsTypeHolder = Class as any as PropertyOwnerClass;\n\t\tClassAsTypeHolder._propertyTypes = propertyTypes;\n\t\tClassAsTypeHolder._propertyTypesByName = {};\n\t\tpropertyTypes.forEach(propertyType => {\n\t\t\tconst propertyTypeName = propertyType.name;\n\t\t\tassert(Class.prototype[propertyTypeName] === undefined, 'Property name ' + propertyTypeName + ' clashes');\n\t\t\tClassAsTypeHolder._propertyTypesByName[propertyTypeName] = propertyType;\n\t\t\tObject.defineProperty(Class.prototype, propertyTypeName, {\n\t\t\t\tget() {\n\t\t\t\t\tif  (!this._properties[propertyTypeName])\n\t\t\t\t\tdebugger;\n\t\t\t\t\treturn this._properties[propertyTypeName].value;\n\t\t\t\t},\n\t\t\t\tset(value) {\n\t\t\t\t\tthis._properties[propertyTypeName].value = value;\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t};\n}\n","// @flow\n\nimport Serializable from './serializable'\nimport { addChange, changeType, setChangeOrigin } from './change';\nimport Prototype from './prototype'\nimport assert from '../util/assert'\nimport PropertyOwner, { Prop, PropertyOwnerClass } from './propertyOwner';\nimport {stickyNonModalErrorPopup} from '../util/popup'\nimport '../modules';\nimport { globalEventDispatcher, GameEvent } from './eventDispatcher';\n\nlet propertyTypes = [\n\tProp('name', 'No name', Prop.string)\n];\n\nlet game: Game = null; // only one game at the time\nexport { game };\n\nlet isClient = typeof window !== 'undefined';\n\nexport default class Game extends PropertyOwner {\n\tconstructor(predefinedId?: string) {\n\t\tif (game)\n\t\t\tconsole.error('Only one game allowed.');\n\n\t\t/*\n\t\tif (isClient) {\n\t\t\tif (game) {\n\t\t\t\ttry {\n\t\t\t\t\tgame.delete();\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.warn('Deleting old game failed', e);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t*/\n\n\t\tsuper(predefinedId);\n\n\t\tif (isClient) {\n\t\t\tgame = this;\n\t\t}\n\n\t\tsetTimeout(() => {\n\t\t\tglobalEventDispatcher.dispatch(GameEvent.GLOBAL_GAME_CREATED, this);\n\t\t}, 1);\n\t}\n\tinitWithChildren(children: Array<Serializable> = []) {\n\t\tlet val = super.initWithChildren(children);\n\t\taddChange(changeType.addSerializableToTree, this);\n\t\treturn val;\n\t}\n\tdelete() {\n\t\taddChange(changeType.deleteSerializable, this);\n\t\tif (!super.delete()) return false;\n\n\t\tif (game === this)\n\t\t\tgame = null;\n\n\t\tstickyNonModalErrorPopup('Game deleted');\n\n\t\treturn true;\n\t}\n}\nPropertyOwner.defineProperties(Game, propertyTypes);\n\nGame.prototype.isRoot = true;\n\n\n\nSerializable.registerSerializable(Game, 'gam', json => {\n\tif (json.c) {\n\t\tjson.c.sort((a, b) => {\n\t\t\tif (a.id.startsWith('prt') || a.id.startsWith('pfa'))\n\t\t\t\treturn -1;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t});\n\t}\n\treturn new Game(json.id);\n});\n\nlet gameCreateListeners = [];\nexport function forEachGame(listener: (game: Game) => void) {\n\tglobalEventDispatcher.listen(GameEvent.GLOBAL_GAME_CREATED, listener);\n\n\tif (game)\n\t\tlistener(game);\n}\n","import EventDispatcher, { GameEvent, ListenerFunction } from \"../core/eventDispatcher\";\n\nexport enum EditorEvent {\n    EDITOR_CHANGE = 'editor change',\n    EDITOR_REGISTER_MODULES = 'registerModules', // parameters(editor)\n    EDITOR_SCENE_TOOL_CHANGED = 'scene tool changed', // parameters(editor)\n    EDITOR_REGISTER_HELP_VARIABLE = 'define help variable', // parameters(name, value)\n    EDITOR_DELETE_CONFIRMATION = 'delete confirmation', // handlerCallback return true|false|Promise wether deletion should succeed.\n    EDITOR_PRE_DELETE_SELECTION = 'pre delete selection',\n    EDITOR_LOADED = 'editor loaded'\n};\n\n// Wrapper that takes only EditorEvents\nclass EditorEventDispatcher {\n    dispatcher: EventDispatcher = new EventDispatcher();\n\n    // priority should be a whole number between -100000 and 100000. a smaller priority number means that it will be executed first.\n    listen(event: EditorEvent | string, callback: ListenerFunction, priority = 0) {\n        return this.dispatcher.listen(event as any as GameEvent, callback, priority);\n    }\n    dispatch(event: EditorEvent | string, a?, b?, c?) {\n        this.dispatcher.dispatch(event as any as GameEvent, a, b, c);\n    }\n    dispatchWithResults(event: EditorEvent | string, a?, b?, c?) {\n        return this.dispatcher.dispatchWithResults(event as any as GameEvent, a, b, c);\n    }\n    getEventPromise(event: EditorEvent | string) {\n\t\treturn new Promise(function(res) {\n\t\t\teditorEventDispacher.listen(event, res);\n\t\t});\n\t}\n}\n\nexport let editorEventDispacher = new EditorEventDispatcher();\n","import Serializable from './serializable';\nimport Entity from './entity';\nimport assert from '../util/assert';\nimport PropertyOwner from './propertyOwner';\nimport Scene, { scene } from './scene';\nimport Game, { game } from './game';\nexport { default as Prop } from './propertyType';\nexport let componentClasses: Map<string, typeof Component> = new Map();\nimport * as performance from '../util/performance';\nimport { PropertyType } from './propertyType';\nimport { GameEvent } from './eventDispatcher';\n\nconst automaticSceneEventListeners = [\n\t'onUpdate',\n\t'onStart'\n];\n\n// Object of a component, see _componentExample.js\nexport class Component extends PropertyOwner {\n\t_componentId: string;\n\tscene: Scene;\n\tgame: Game;\n\t_listenRemoveFunctions: Array<() => void>;\n\tentity: Entity;\n\tcomponentClass: typeof Component;\n\tcomponentName: string;\n\tTransform: Component;\n\t[s: string]: any; // Suppress all errors. Components will have many custom parameters.\n\n\tstatic componentName: string;\n\tstatic category: string;\n\tstatic requirements: Array<string>;\n\tstatic children: Array<any>;\n\tstatic description: string;\n\tstatic allowMultiple: boolean;\n\tstatic icon: string;\n\tstatic color: string;\n\n\tstatic _propertyTypes: Array<PropertyType>;\n\tstatic _propertyTypesByName: { [s: string]: PropertyType };\n\n\tconstructor(predefinedId?: string) {\n\t\tsuper(predefinedId);\n\t\tthis._componentId = null; // Creator will fill this\n\t\tthis.scene = scene;\n\t\tthis.game = game;\n\t\tthis._listenRemoveFunctions = [];\n\t\tthis.entity = null;\n\t}\n\tmakeUpAName() {\n\t\treturn this.componentClass.componentName;\n\t}\n\tdelete() {\n\t\t// Component.delete never returns false because entity doesn't have components as children\n\t\tthis._parent = null;\n\t\tthis.entity = null;\n\t\tsuper.delete();\n\t\treturn true;\n\t}\n\t_addEventListener(functionName: string) {\n\t\tlet func = this[functionName];\n\t\tlet self = this;\n\t\tlet performanceName = 'Component: ' + this.componentClass.componentName;\n\t\tthis._listenRemoveFunctions.push(this.scene.listen(functionName, function () {\n\t\t\t// @ifndef OPTIMIZE\n\t\t\tperformance.start(performanceName);\n\t\t\t// @endif\n\n\t\t\tfunc.apply(self, arguments);\n\n\t\t\t// @ifndef OPTIMIZE\n\t\t\tperformance.stop(performanceName);\n\t\t\t// @endif\n\t\t}));\n\t}\n\t// In preInit you can init the component with stuff that other components might want to use in init function\n\t// In preInit you can not trust that other components have been inited in any way\n\t_preInit() {\n\t\tthis.componentClass.requirements.forEach(r => {\n\t\t\tthis[r] = this.entity.getComponent(r);\n\t\t\tassert(this[r], `${this.componentClass.componentName} requires component ${r} but it is not found`);\n\t\t});\n\n\t\tthis.forEachChild('com', (c: Component) => c._preInit());\n\n\t\tfor (let i = 0; i < automaticSceneEventListeners.length; ++i) {\n\t\t\tif (typeof this[automaticSceneEventListeners[i]] === 'function')\n\t\t\t\tthis._addEventListener(automaticSceneEventListeners[i]);\n\t\t}\n\n\t\tif (this.componentClass.componentName !== 'Transform' && this.scene)\n\t\t\tthis.scene.addComponent(this);\n\n\t\ttry {\n\t\t\tif (typeof (this as ComponentRegisterPrototype).preInit === 'function')\n\t\t\t\t(this as ComponentRegisterPrototype).preInit();\n\t\t} catch (e) {\n\t\t\tconsole.error(this.entity, this.componentClass.componentName, 'preInit', e);\n\t\t}\n\t}\n\t// In preInit you can access other components and know that their preInit is done.\n\t_init() {\n\t\tthis.forEachChild('com', (c: Component) => c._init());\n\t\ttry {\n\t\t\tif (typeof (this as ComponentRegisterPrototype).init === 'function')\n\t\t\t(this as ComponentRegisterPrototype).init();\n\t\t} catch (e) {\n\t\t\tconsole.error(this.entity, this.componentClass.componentName, 'init', e);\n\t\t}\n\t}\n\t_sleep() {\n\t\ttry {\n\t\t\tif (typeof (this as ComponentRegisterPrototype).sleep === 'function')\n\t\t\t(this as ComponentRegisterPrototype).sleep();\n\t\t} catch (e) {\n\t\t\tconsole.error(this.entity, this.componentClass.componentName, 'sleep', e);\n\t\t}\n\n\t\tif (this.componentClass.componentName !== 'Transform' && this.scene)\n\t\t\tthis.scene.removeComponent(this);\n\n\t\tthis.forEachChild('com', (c: Component) => c._sleep());\n\n\t\tthis._listenRemoveFunctions.forEach(f => f());\n\t\tthis._listenRemoveFunctions.length = 0;\n\t}\n\tlistenProperty(component: Component, propertyName: string, callback: Function) {\n\t\tthis._listenRemoveFunctions.push(component._properties[propertyName].listen(GameEvent.PROPERTY_VALUE_CHANGE, callback));\n\t}\n\ttoJSON() {\n\t\treturn Object.assign(super.toJSON(), {\n\t\t\tn: this.componentClass.componentName,\n\t\t\tcid: this._componentId\n\t\t});\n\t}\n\n\tstatic create(name: string, values = {}) {\n\t\tlet componentClass = componentClasses.get(name);\n\t\tassert(componentClass);\n\t\tlet component = new componentClass();\n\t\tcomponent.initWithPropertyValues(values);\n\t\treturn component;\n\t};\n\tstatic createWithInheritedComponentData(inheritedComponentData) {\n\t\tlet component = new inheritedComponentData.componentClass;\n\t\tcomponent._componentId = inheritedComponentData.componentId;\n\t\tlet properties = inheritedComponentData.properties.map(p => p.clone());\n\t\tcomponent.initWithChildren(properties);\n\t\treturn component;\n\t};\n\n\tstatic reservedPropertyNames = new Set(['id', 'constructor', 'delete', 'children', 'entity', 'env', 'init', 'preInit', 'sleep', 'toJSON', 'fromJSON']);\n\tstatic reservedPrototypeMembers = new Set(['id', 'children', 'entity', 'env', '_preInit', '_init', '_sleep', '_forEachChildComponent', '_properties', '_componentData', 'toJSON', 'fromJSON']);\n\tstatic register({\n\t\tname = '', // required\n\t\tdescription = '',\n\t\tcategory = 'Other',\n\t\ticon = 'fa-puzzle-piece', // in editor\n\t\tcolor = '', // in editor\n\t\tproperties = [],\n\t\trequirements = ['Transform'],\n\t\tchildren = [],\n\t\tparentClass = Component,\n\t\tprototype = {},\n\t\tallowMultiple = true,\n\t\trequiresInitWhenEntityIsEdited = false\n\t}: ComponentRegisterOptions = {}) {\n\t\tassert(name, 'Component must have a name.');\n\t\tassert(name[0] >= 'A' && name[0] <= 'Z', 'Component name must start with capital letter.');\n\t\tassert(!componentClasses.has(name), 'Duplicate component class ' + name);\n\t\tObject.keys(prototype).forEach(k => {\n\t\t\tif (Component.reservedPrototypeMembers.has(k))\n\t\t\t\tassert(false, 'Component prototype can not have a reserved member: ' + k);\n\t\t});\n\n\t\tif (requirements.indexOf('Transform') < 0) requirements.push('Transform');\n\t\tlet colorNum = name.split('').reduce((prev, curr) => prev + curr.charCodeAt(0), 0);\n\n\t\tlet constructorFunction = prototype.constructor;\n\t\tlet deleteFunction = prototype.delete;\n\t\tdelete prototype.constructor;\n\t\tdelete prototype.delete;\n\t\tclass Com extends parentClass {\n\t\t\tconstructor(...args) {\n\t\t\t\tsuper(...args);\n\t\t\t\tif (constructorFunction)\n\t\t\t\t\tconstructorFunction.call(this);\n\t\t\t}\n\t\t\tdelete() {\n\t\t\t\tif (!super.delete()) return false;\n\n\t\t\t\tif (deleteFunction)\n\t\t\t\t\tdeleteFunction.call(this);\n\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tstatic componentName = name;\n\t\t\tstatic category = category;\n\t\t\tstatic requirements = requirements;\n\t\t\tstatic children = children;\n\t\t\tstatic description = description;\n\t\t\tstatic allowMultiple = allowMultiple;\n\t\t\tstatic icon = icon;\n\t\t\tstatic color = color || `hsla(${colorNum % 360}, 40%, 60%, 1)`;\n\t\t\tcomponentClass: typeof Component;\n\t\t}\n\t\tproperties.forEach(p => {\n\t\t\tassert(!Component.reservedPropertyNames.has(p.name), 'Can not have property called ' + p.name);\n\t\t});\n\t\tPropertyOwner.defineProperties(Com, properties); // properties means propertyTypes here\n\n\t\tprototype._name = name;\n\t\tCom.prototype.componentClass = Com;\n\t\tObject.assign(Com.prototype, prototype);\n\t\tcomponentClasses.set(Com.componentName, Com);\n\t\treturn Com;\n\t};\n}\n\ninterface ComponentRegisterPrototype {\n\tconstructor?: Function,\n\tdelete?: () => void,\n\t_name?: string,\n\tpreInit?: () => void,\n\tinit?: () => void,\n\tsleep?: () => void,\n\t[others: string]: any\n};\n\ntype ComponentRegisterOptions = {\n\tname?: string,\n\tdescription?: string,\n\tcategory?: string,\n\ticon?: string,\n\tcolor?: string,\n\tproperties?: Array<any>,\n\trequirements?: Array<string>,\n\tchildren?: Array<any>,\n\tparentClass?: typeof Component,\n\tprototype?: ComponentRegisterPrototype,\n\tallowMultiple?: boolean,\n\trequiresInitWhenEntityIsEdited?: boolean\n};\n\nSerializable.registerSerializable(Component, 'com', json => {\n\tlet component = <Component> new (componentClasses.get(json.n))(json.id);\n\tcomponent._componentId = json.cid || null;\n\treturn component;\n});\n","import Serializable, { createStringId } from './serializable';\nimport assert from '../util/assert';\nimport { componentClasses, Component } from './component';\nimport { isClient } from '../util/environment';\nimport Property from './property';\nimport { PropertyOwnerClass } from './propertyOwner';\nimport Prototype from './prototype';\n\nexport default class ComponentData extends Serializable {\n\tname: string;\n\tcomponentClass: typeof Component & PropertyOwnerClass;\n\tcomponentId: string;\n\n\tconstructor(componentClassName, predefinedId?, predefinedComponentId: string = '') {\n\t\tsuper(predefinedId);\n\t\tthis.name = componentClassName;\n\t\tthis.componentClass = componentClasses.get(this.name);\n\t\tassert(this.componentClass, 'Component class not defined: ' + componentClassName);\n\t\tif (!this.componentClass.allowMultiple)\n\t\t\tpredefinedComponentId = '_' + componentClassName;\n\t\tthis.componentId = predefinedComponentId || createStringId('cid', 10); // what will be the id of component created from this componentData\n\t}\n\tmakeUpAName() {\n\t\treturn this.name;\n\t}\n\taddChild(child) {\n\t\tif (child.threeLetterType === 'prp') {\n\t\t\tif (!child.propertyType) {\n\t\t\t\tif (!this.componentClass._propertyTypesByName[child.name]) {\n\t\t\t\t\tif (isClient)\n\t\t\t\t\t\tconsole.log('Property of that name not defined', this.id, child, this);\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.log('Property of that name not defined', this.id, this.name, child.name);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tchild.setPropertyType(this.componentClass._propertyTypesByName[child.name]);\n\t\t\t}\n\t\t}\n\t\tsuper.addChild(child);\n\t\treturn this as Serializable;\n\t}\n\tclone(options?) {\n\t\tlet newComponentId = (options && options.cloneComponentId) ? this.componentId : '';\n\t\tlet obj = new ComponentData(this.name, false, newComponentId);\n\t\tlet children = [];\n\t\tthis.forEachChild(null, child => {\n\t\t\tchildren.push(child.clone());\n\t\t});\n\t\tobj.initWithChildren(children);\n\t\tthis._state |= Serializable.STATE_CLONE;\n\t\treturn obj as Serializable;\n\t}\n\ttoJSON() {\n\t\treturn Object.assign(super.toJSON(), {\n\t\t\tcid: this.componentId,\n\t\t\tn: this.name\n\t\t});\n\t}\n\t/*\n\tReturns a list of Properties.\n\tThose which don't have an id are temporary properties generated from parents.\n\tDon't set _depth.\n\t */\n\tgetInheritedProperties(_depth = 0) {\n\t\tlet properties = {};\n\n\t\t// properties from parent\n\t\tlet parentComponentData = this.getParentComponentData();\n\t\tif (parentComponentData)\n\t\t\tparentComponentData.getInheritedProperties(_depth + 1).forEach(prop => properties[prop.name] = prop);\n\n\t\t// properties from this. override properties of parents\n\t\tthis.getChildren('prp').forEach((prop: Property) => {\n\t\t\tif (_depth === 0)\n\t\t\t\tproperties[prop.name] = prop;\n\t\t\telse\n\t\t\t\tproperties[prop.name] = prop.clone(true);\n\t\t});\n\n\t\t// fill from propertyType\n\t\tif (_depth === 0) {\n\t\t\treturn this.componentClass._propertyTypes.map(propertyType => {\n\t\t\t\treturn properties[propertyType.name] || propertyType.createProperty({\n\t\t\t\t\tskipSerializableRegistering: true\n\t\t\t\t});\n\t\t\t});\n\t\t} else {\n\t\t\treturn Object.keys(properties).map(key => properties[key]);\n\t\t}\n\t}\n\tgetParentComponentData() {\n\t\tif (!this._parent) return null;\n\t\tlet parentPrototype = (this._parent as Prototype).getParentPrototype() as Prototype;\n\t\twhile (parentPrototype) {\n\t\t\tlet parentComponentData = parentPrototype.findChild('cda', (componentData: ComponentData) => componentData.componentId === this.componentId);\n\t\t\tif (parentComponentData)\n\t\t\t\treturn parentComponentData;\n\t\t\telse\n\t\t\t\tparentPrototype = parentPrototype.getParentPrototype() as Prototype;\n\t\t}\n\t\treturn null;\n\t}\n\tgetPropertyOrCreate(name) {\n\t\tlet property = this.findChild('prp', (prp: Property) => prp.name === name);\n\t\tif (!property) {\n\t\t\tproperty = this.componentClass._propertyTypesByName[name].createProperty();\n\t\t\tthis.addChild(property);\n\t\t}\n\t\treturn property;\n\t}\n\tgetProperty(name) {\n\t\treturn this.findChild('prp', prp => (prp as Property).name === name);\n\t}\n\tsetValue(propertyName, value) {\n\t\tthis.getPropertyOrCreate(propertyName).value = value;\n\t\treturn this;\n\t}\n\tgetValue(name) {\n\t\tlet property = this.getProperty(name);\n\t\tif (property)\n\t\t\treturn property.value;\n\t\tlet parent = this.getParentComponentData();\n\n\t\tif (parent)\n\t\t\treturn parent.getValue(name);\n\n\t\treturn this.componentClass._propertyTypesByName[name].initialValue;\n\t}\n\tcreateComponent() {\n\t\tlet properties = this.getInheritedProperties();\n\t\tlet values = {};\n\t\tproperties.forEach(prop => {\n\t\t\tvalues[prop.name] = prop.value;\n\t\t});\n\t\tlet component = Component.create(this.name, values);\n\t\tcomponent._componentId = this.componentId;\n\t\treturn component;\n\t}\n}\nSerializable.registerSerializable(ComponentData, 'cda', json => {\n\treturn new ComponentData(json.n, json.id, json.cid);\n});\n\n\n/*\n\nFrom Component? Is this needed?\n\n\tcreateComponentData() {\n\t\tlet componentName = this.componentClass.componentName;\n\t\tlet propertyTypes = this.class._propertyTypes;\n\t\tlet componentData = new ComponentData(componentName);\n\t\tlet children = [];\n\t\tpropertyTypes.forEach(pt => {\n\t\t\tchildren.push(pt.createProperty({\n\t\t\t\tvalue: this[pt.name]\n\t\t\t}));\n\t\t});\n\t\tcomponentData.initWithChildren(children);\n\t\treturn componentData;\n\t}\n\n*/\n","import Serializable from './serializable';\nimport assert from '../util/assert';\nimport * as performanceTool from '../util/performance';\nimport Prototype from './prototype';\nimport { Component } from './component';\nimport { getSerializable } from './serializableManager';\n\nconst ALIVE_ERROR = 'entity is already dead';\n\nexport default class Entity extends Serializable {\n\tcomponents: Map<string, Array<Component>>;\n\tsleeping: boolean;\n\tprototype: Prototype;\n\tlocalMaster: boolean;\n\n\tstatic ENTITY_CREATION_DEBUGGING = false;\n\n\tconstructor(predefinedId?) {\n\t\tsuper(predefinedId);\n\t\tthis.components = new Map(); // name -> array\n\t\tthis.sleeping = false;\n\t\tthis.prototype = null; // should be set immediately after constructor\n\t\tthis.localMaster = true; // set false if entity is controlled over the net\n\n\t\tperformanceTool.eventHappened('Create object');\n\t}\n\n\tmakeUpAName() {\n\t\tif (this.prototype) {\n\t\t\treturn this.prototype.makeUpAName();\n\t\t} else {\n\t\t\treturn 'Entity';\n\t\t}\n\t}\n\n\t// Get the first component of given name\n\tgetComponent(name) {\n\t\tassert(this._alive, ALIVE_ERROR);\n\t\tlet components = this.components.get(name);\n\t\tif (components !== undefined)\n\t\t\treturn components[0];\n\t\telse\n\t\t\treturn null;\n\t}\n\n\t// Get all components with given name\n\tgetComponents(name) {\n\t\tassert(this._alive, ALIVE_ERROR);\n\t\treturn this.components.get(name) || [];\n\t}\n\n\tgetListOfAllComponents() {\n\t\tlet components = [];\n\t\tthis.components.forEach((value, key) => {\n\t\t\tcomponents.push(...value);\n\t\t});\n\t\treturn components;\n\t}\n\n\tclone() {\n\t\tlet entity = new Entity();\n\t\tentity.prototype = this.prototype.clone() as Prototype;\n\t\tentity.sleeping = this.sleeping;\n\t\tlet components = [];\n\t\tthis.components.forEach((value, key) => {\n\t\t\tcomponents.push(...value.map(c => c.clone()));\n\t\t});\n\t\tentity.addComponents(components);\n\t\treturn entity;\n\t}\n\n\t/*\n\tAdds multiple components as an array to this Entity.\n\tInitializes components after all components are added.\n\t*/\n\taddComponents(components, { fullInit = true } = {}) {\n\t\tassert(this._alive, ALIVE_ERROR);\n\t\tassert(Array.isArray(components), 'Parameter is not an array.');\n\n\t\tif (Entity.ENTITY_CREATION_DEBUGGING) console.log('add components for', this.makeUpAName());\n\n\t\tfor (let i = 0; i < components.length; i++) {\n\t\t\tlet component = components[i];\n\t\t\tlet componentList = this.components.get(component._name) || this.components.set(component._name, []).get(component._name);\n\t\t\tcomponentList.push(component);\n\t\t\tcomponent.entity = this;\n\t\t\tcomponent._parent = this;\n\t\t\tcomponent.setRootType(this._rootType);\n\t\t}\n\n\t\tif (!this.sleeping) {\n\t\t\tEntity.preInitComponents(components);\n\t\t\tif (fullInit)\n\t\t\t\tEntity.initComponents(components);\n\t\t}\n\t\treturn this;\n\t}\n\n\tstatic preInitComponents(components) {\n\t\tif (Entity.ENTITY_CREATION_DEBUGGING) console.log('preInit components for', components[0].entity.makeUpAName());\n\t\tfor (let i = 0; i < components.length; i++)\n\t\t\tcomponents[i]._preInit();\n\t}\n\n\tstatic initComponents(components) {\n\t\tif (Entity.ENTITY_CREATION_DEBUGGING) console.log(`init ${components.length} components for`, components[0].entity.makeUpAName());\n\t\tfor (let i = 0; i < components.length; i++)\n\t\t\tcomponents[i]._init();\n\t}\n\n\tstatic makeComponentsSleep(components) {\n\t\tfor (let i = 0; i < components.length; i++)\n\t\t\tcomponents[i]._sleep();\n\t}\n\n\tstatic deleteComponents(components) {\n\t\tfor (let i = 0; i < components.length; i++)\n\t\t\tcomponents[i].delete();\n\t}\n\n\tsleep() {\n\t\tassert(this._alive, ALIVE_ERROR);\n\t\tif (this.sleeping) return false;\n\n\t\tthis.components.forEach((value, key) => Entity.makeComponentsSleep(value));\n\n\t\tthis.sleeping = true;\n\t\treturn true;\n\t}\n\n\twakeUp() {\n\t\tassert(this._alive, ALIVE_ERROR);\n\t\tif (!this.sleeping) return false;\n\n\t\tthis.components.forEach((value, key) => Entity.preInitComponents(value));\n\t\tthis.components.forEach((value, key) => Entity.initComponents(value));\n\n\t\tthis.sleeping = false;\n\t\treturn true;\n\t}\n\n\tdelete() {\n\t\tassert(this._alive, ALIVE_ERROR);\n\t\tthis.sleep();\n\t\tif (!super.delete()) return false;\n\n\t\tthis.components.forEach((value, key) => Entity.deleteComponents(value));\n\t\tthis.components.clear();\n\n\t\tperformanceTool.eventHappened('Destroy object');\n\n\t\treturn true;\n\t}\n\n\tdeleteComponent(component) {\n\t\tlet array = this.getComponents(component.constructor.componentName);\n\t\tlet idx = array.indexOf(component);\n\t\tassert(idx >= 0);\n\t\tif (!this.sleeping)\n\t\t\tcomponent._sleep();\n\t\tcomponent.delete();\n\t\tarray.splice(idx, 1);\n\t\treturn this;\n\t}\n\n\tsetRootType(rootType) {\n\t\tif (this._rootType === rootType)\n\t\t\treturn;\n\n\t\tif (Entity.ENTITY_CREATION_DEBUGGING) console.log('entity added to tree', this.makeUpAName());\n\n\t\tsuper.setRootType(rootType);\n\n\t\tlet i;\n\t\tthis.components.forEach((value, key) => {\n\t\t\tfor (i = 0; i < value.length; ++i) {\n\t\t\t\tvalue[i].setRootType(rootType);\n\t\t\t}\n\t\t});\n\t}\n\n\ttoJSON() {\n\t\tassert(this._alive, ALIVE_ERROR);\n\n\t\tlet components = [];\n\t\tthis.components.forEach(compArray => {\n\t\t\tcompArray.forEach(comp => {\n\t\t\t\tcomponents.push(comp.toJSON());\n\t\t\t});\n\t\t});\n\n\t\treturn Object.assign(super.toJSON(), {\n\t\t\tc: components, // overwrite children. earlier this was named 'comp'\n\t\t\tproto: this.prototype.id\n\t\t});\n\t}\n\tget position() {\n\t\treturn this.getComponent('Transform').position;\n\t}\n\tset position(position) {\n\t\tthis.getComponent('Transform').position = position;\n\t}\n\tget Transform() {\n\t\treturn this.getComponent('Transform');\n\t}\n}\n\nSerializable.registerSerializable(Entity, 'ent', json => {\n\tif (Entity.ENTITY_CREATION_DEBUGGING) console.log('creating entity from json', json);\n\tlet entity = new Entity(json.id);\n\tentity.prototype = getSerializable(json.proto);\n\tif (Entity.ENTITY_CREATION_DEBUGGING) console.log('created entity from json', entity);\n\tif (json.comp) {\n\t\tentity.addComponents((json.c || json.comp).map(Serializable.fromJSON));\n\t}\n\treturn entity;\n});\n\n","import Prototype from './prototype';\nimport Property from './property';\nimport Serializable from './serializable';\nimport { getSerializable } from './serializableManager';\nimport { Prop, componentClasses } from './component';\nimport ComponentData from './componentData';\nimport assert from '../util/assert';\nimport Vector from '../util/vector';\nimport EntityPrototype, { createEntityPrototypeNameProperty, createEntityPrototypeTransform } from \"./entityPrototype\";\n\n// Prefab is an EntityPrototype that has been saved to a prefab.\nexport default class Prefab extends Prototype {\n\tconstructor(predefinedId?: string) {\n\t\tsuper(predefinedId);\n\t}\n\n\tmakeUpAName() {\n\t\tlet nameProperty = this.findChild('prp', (property: Property) => property.name === 'name');\n\t\treturn nameProperty && nameProperty.value || 'Prefab';\n\t}\n\n\tcreateEntity() {\n\t\treturn this.createEntityPrototype().createEntity();\n\t}\n\n\tgetParentPrototype() {\n\t\treturn null;\n\t}\n\t// Meant for entityPrototypes, but works theoretically for prototypes\n\tstatic createFromPrototype(prototype: Prototype) {\n\t\tlet inheritedComponentDatas = prototype.getInheritedComponentDatas();\n\t\tlet children: Array<Serializable> = inheritedComponentDatas.map(icd => {\n\t\t\treturn new ComponentData(icd.componentClass.componentName, null, icd.componentId)\n\t\t\t\t.initWithChildren(icd.properties.map(prp => prp.clone()));\n\t\t}) as any as Array<Serializable>;\n\n\t\tchildren.push(prototype._properties.name.clone());\n\n\t\tprototype.forEachChild('epr', (childEntityPrototype: EntityPrototype) => {\n\t\t\tlet prefab = Prefab.createFromPrototype(childEntityPrototype);\n\t\t\tchildren.push(prefab);\n\t\t});\n\n\t\tlet prefab = new Prefab().initWithChildren(children);\n\n\t\t// Don't just prototype.makeUpAName() because it might give you \"Prototype\" or \"EntityPrototype\". Checking them would be a hack.\n\t\tprefab.name = prototype.name || prototype.prototype && prototype.prototype.makeUpAName() || 'Prefab';\n\n\t\treturn prefab;\n\t}\n\n\tcreateEntityPrototype() {\n\t\tlet entityPrototype = new EntityPrototype();\n\t\tentityPrototype.prototype = this;\n\t\tlet id = entityPrototype.id;\n\n\t\tlet prototypeTransform = this.findChild('cda', (cda: ComponentData) => cda.name === 'Transform');\n\n\t\tif (!prototypeTransform)\n\t\t\tassert(false, 'Prefab (pfa) must have a Transform component');\n\n\t\tlet name = createEntityPrototypeNameProperty(id);\n\t\tlet transform = createEntityPrototypeTransform(id);\n\n\t\ttransform.setValue('position', prototypeTransform.getValue('position'));\n\t\ttransform.setValue('scale', prototypeTransform.getValue('scale'));\n\t\ttransform.setValue('angle', prototypeTransform.getValue('angle'));\n\n\t\tlet children: Serializable[] = [name, transform];\n\n\t\tthis.forEachChild('pfa', (pfa: Prefab) => {\n\t\t\tlet childEntityPrototype = pfa.createEntityPrototype();\n\t\t\tchildren.push(childEntityPrototype);\n\t\t});\n\n\t\tentityPrototype.initWithChildren(children);\n\n\t\t/*\n\t\t\t\tlet inheritedComponentDatas = this.getInheritedComponentDatas();\n\t\t\t\tlet children: Array<Serializable> = inheritedComponentDatas.map(icd => {\n\t\t\t\t\treturn new ComponentData(icd.componentClass.componentName, null, icd.componentId)\n\t\t\t\t\t\t.initWithChildren(icd.properties.map(prp => prp.clone()));\n\t\t\t\t}) as any as Array<Serializable>;\n\t\t\t\tchildren.push(this._properties.name.clone());\n\n\t\t\t\tentityPrototype.initWithChildren(children);\n\t\t\t\t*/\n\n\t\t// @ifndef OPTIMIZE\n\t\tassert(entityPrototype.getTransform(), 'EntityPrototype must have a Transform');\n\t\t// @endif\n\n\t\treturn entityPrototype;\n\t}\n\n\t// Do not use EntityPrototype optimization\n\t// This is only needed if Prefab would extend EntityPrototype instead of Prototype\n\t// toJSON() {\n\t// \treturn Serializable.prototype.toJSON.apply(this, arguments);\n\t// }\n\n\t// This is only needed if Prefab would extend EntityPrototype instead of Prototype\n\t// clone() {\n\t// \treturn Serializable.prototype.clone.apply(this, arguments);\n\t// }\n}\n\n/*\nfilter filters component datas\n\nReturns JSON:\n[\n\t{\n\t\townComponent: false, // component of a parent prototype\n\t\tcomponentClass: [object Object],\n\t\tcomponentId: <componentId>,\n\t\tthreeLetterType: 'icd',\n\t\t generatedForPrototype: <this>,\n\t\tproperties: [\n\t\t\t{ id missing }\n\t\t]\n\t},\n\t{\n\t\t ownComponentData: <ComponentData> || null, // null if this prototype has 0 properties defined\n\t\t componentClass: [object Object],\n\t\t componentId: <componentId>,\n\t\t threeLetterType: 'icd',\n\t\t generatedForPrototype: <this>,\n\t\t properties: [\n\t\t\t { id found if own property } // some properties might be from parent prototypes and thus missing id\n\t\t ]\n\t }\n]\n */\n\nSerializable.registerSerializable(Prefab, 'pfa');\n","import Serializable from './serializable';\nimport PropertyOwner, { Prop } from './propertyOwner';\nimport Scene, { scene } from './scene';\n\nlet propertyTypes = [\n\tProp('name', 'No name', Prop.string)\n];\n\nexport default class Level extends PropertyOwner {\n\tname: string;\n\n\tconstructor(predefinedId?) {\n\t\tsuper(predefinedId);\n\t}\n\tcreateScene(predefinedSceneObject: Scene = null) {\n\t\tif (!predefinedSceneObject)\n\t\t\tnew Scene();\n\n\t\tscene.loadLevel(this);\n\n\t\treturn scene;\n\t}\n\tisEmpty() {\n\t\treturn this.getChildren('epr').length === 0;\n\t}\n\n\t/*\n\tOPTIMIZATION DOES NOT WORK, YET\n\ttoJSON() {\n\t\tlet json = super.toJSON();\n\t\tconsole.log('before', json);\n\t\tif (json.c) {\n\t\t\tlet prototypeIds = new Set();\n\t\t\tjson.c.forEach(child => {\n\t\t\t\tconsole.log('child', child);\n\t\t\t\tprototypeIds.add(child.p);\n\t\t\t});\n\n\t\t\tlet prototypeIdToNum = {};\n\t\t\tlet prototypeIdArray = [];\n\t\t\tlet num = 0;\n\t\t\tprototypeIds.forEach(key => {\n\t\t\t\tprototypeIdArray[num] = key;\n\t\t\t\tprototypeIdToNum[key] = num++;\n\t\t\t});\n\n\t\t\tjson.c.forEach(child => {\n\t\t\t\tchild.p = prototypeIdToNum[child.p] || child.p;\n\t\t\t});\n\n\t\t\tjson.p = prototypeIdArray;\n\n\t\t\tconsole.log(json, prototypeIds, prototypeIdToNum, prototypeIdArray);\n\t\t}\n\t\treturn json;\n\t}\n\t*/\n}\nPropertyOwner.defineProperties(Level, propertyTypes);\n\nSerializable.registerSerializable(Level, 'lvl');\n","import { Component, Prop } from '../core/component';\nimport Vector from '../util/vector';\nimport {default as PIXI} from '../features/graphics';\n\nComponent.register({\n\tname: 'Transform',\n\ticon: 'fa-dot-circle-o',\n\tallowMultiple: false,\n\tproperties: [\n\t\tProp('position', new Vector(0, 0), Prop.vector),\n\t\tProp('scale', new Vector(1, 1), Prop.vector),\n\t\tProp('angle', 0, Prop.float, Prop.float.modulo(0, Math.PI * 2), Prop.flagDegreesInEditor)\n\t],\n\tprototype: {\n\t\tconstructor() {\n\t\t\tthis.layer = this.scene.layers.main;\n\t\t},\n\t\tpreInit() {\n\t\t\tthis.container = new PIXI.Container();\n\t\t\tthis.container._debug = this.entity.makeUpAName() + ' ' + this.name;\n\t\t\tthis.container.position.set(this.position.x, this.position.y);\n\t\t\tthis.container.scale.set(this.scale.x, this.scale.y);\n\t\t\tthis.container.rotation = this.angle;\n\t\t},\n\t\tinit() {\n\t\t\tlet parentTransform = this.getParentTransform();\n\t\t\tif (parentTransform) {\n\t\t\t\tparentTransform.container.addChild(this.container);\n\t\t\t\tparentTransform.listen('globalTransformChanged', () => {\n\t\t\t\t\tthis.dispatch('globalTransformChanged', this);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tthis.layer.addChild(this.container);\n\t\t\t}\n\n\t\t\t// Optimize this. Shouldn't be called multiple times per frame.\n\t\t\tlet change = () => {\n\t\t\t\tthis.dispatch('globalTransformChanged', this);\n\t\t\t};\n\n\t\t\tthis.listenProperty(this, 'position', position => {\n\t\t\t\tthis.container.position.set(position.x, position.y);\n\t\t\t\tchange();\n\t\t\t});\n\t\t\tthis.listenProperty(this, 'angle', angle => {\n\t\t\t\tthis.container.rotation = angle;\n\t\t\t\tchange();\n\t\t\t});\n\t\t\tthis.listenProperty(this, 'scale', scale => {\n\t\t\t\tthis.container.scale.set(scale.x, scale.y);\n\t\t\t\tchange();\n\t\t\t});\n\t\t\t// change();\n\t\t},\n\t\tgetParentTransform() {\n\t\t\tif (this.parentTransform !== undefined)\n\t\t\t\treturn this.parentTransform;\n\n\t\t\tlet parentEntity = this.entity.getParent();\n\t\t\tif (parentEntity && parentEntity.threeLetterType === 'ent')\n\t\t\t\tthis.parentTransform = parentEntity.getComponent('Transform');\n\t\t\telse\n\t\t\t\tthis.parentTransform = null;\n\n\t\t\treturn this.parentTransform;\n\t\t},\n\t\tgetGlobalPosition() {\n\t\t\treturn Vector.fromObject(this.layer.toLocal(zeroPoint, this.container, tempPoint));\n\t\t},\n\t\tgetGlobalAngle() {\n\t\t\tlet angle = this.angle;\n\t\t\tlet parent = this.getParentTransform();\n\t\t\twhile (parent) {\n\t\t\t\tangle += parent.angle;\n\t\t\t\tparent = parent.getParentTransform();\n\t\t\t}\n\t\t\treturn angle;\n\t\t},\n\t\tsetGlobalPosition(position: Vector) {\n\t\t\tthis.position = position.set(this.container.parent.toLocal(position, this.layer, tempPoint));\n\t\t},\n\t\tsleep() {\n\t\t\tthis.container.destroy();\n\t\t\tthis.container = null;\n\n\t\t\tdelete this.parentTransform;\n\t\t}\n\n\t}\n});\n\nlet zeroPoint = new PIXI.Point();\nlet tempPoint = new PIXI.Point();\n","import { Component, Prop } from '../core/component';\nimport Vector from '../util/vector';\n\nComponent.register({\n\tname: 'TransformVariance',\n\tcategory: 'Logic',\n\tdescription: `Adds random factor to object's transform/orientation.`,\n\ticon: 'fa-dot-circle-o',\n\tallowMultiple: false,\n\tproperties: [\n\t\tProp('positionVariance', new Vector(0, 0), Prop.vector),\n\t\tProp('scaleVariance', new Vector(0, 0), Prop.vector),\n\t\tProp('angleVariance', 0, Prop.float, Prop.float.range(0, Math.PI), Prop.flagDegreesInEditor)\n\t],\n\tprototype: {\n\t\tonStart() {\n\t\t\tif (!this.positionVariance.isZero())\n\t\t\t\tthis.Transform.position = this.Transform.position.add(this.positionVariance.clone().multiplyScalar(-1 + 2 * Math.random()));\n\n\t\t\tif (!this.scaleVariance.isZero())\n\t\t\t\tthis.Transform.scale = this.Transform.scale.add(this.scaleVariance.clone().multiplyScalar(Math.random()));\n\t\t\t\n\t\t\tif (this.angleVariance)\n\t\t\t\tthis.Transform.angle += this.angleVariance * (-1 + 2 * Math.random());\n\t\t}\n\t}\n});\n","import {Component, Prop} from '../core/component';\nimport Vector from '../util/vector';\nimport {Color} from '../util/color';\nimport {default as PIXI, generateTextureAndAnchor, getHashedTextureAndAnchor} from '../features/graphics';\n\nComponent.register({\n\tname: 'Shape',\n\tcategory: 'Graphics',\n\ticon: 'fa-stop',\n\tallowMultiple: true,\n\tdescription: 'Draws shape on the screen.',\n\tproperties: [\n\t\tProp('type', 'rectangle', Prop.enum, Prop.enum.values('rectangle', 'circle', 'convex')),\n\t\tProp('radius', 20, Prop.float, Prop.visibleIf('type', ['circle', 'convex'])),\n\t\tProp('size', new Vector(20, 20), Prop.vector, Prop.visibleIf('type', 'rectangle')),\n\t\tProp('points', 3, Prop.int, Prop.int.range(3, 16), Prop.visibleIf('type', 'convex')),\n\t\tProp('topPointDistance', 0.5, Prop.float, Prop.float.range(0.001, 1), Prop.visibleIf('type', 'convex'), 'Only works with at most 8 points'), // Value 0\n\t\tProp('fillColor', new Color(222, 222, 222), Prop.color),\n\t\tProp('borderColor', new Color(255, 255, 255), Prop.color),\n\t\tProp('borderWidth', 1, Prop.float, Prop.float.range(0, 30))\n\t],\n\tprototype: {\n\t\tinit() {\n\t\t\tthis.initSprite();\n\t\t\tthis.Transform.listen('globalTransformChanged', transform => {\n\t\t\t\t/*\n\t\t\t\tthis.sprite.x = transform.globalPosition.x;\n\t\t\t\tthis.sprite.y = transform.globalPosition.y;\n\n\t\t\t\t// rotation setter function has a function call. lets optimize.\n\t\t\t\tif (this.sprite.rotation !== transform.globalAngle)\n\t\t\t\t\tthis.sprite.rotation = transform.globalAngle;\n\n\t\t\t\tthis.sprite.scale.set(transform.globalScale.x, transform.globalScale.y);\n\t\t\t\t*/\n\t\t\t});\n\n\t\t\t/*\n\t\t\tthis.listenProperty(this.Transform, 'position', position => {\n\t\t\t\tthis.sprite.x = position.x;\n\t\t\t\tthis.sprite.y = position.y;\n\t\t\t});\n\n\t\t\tthis.listenProperty(this.Transform, 'angle', angle => {\n\t\t\t\tthis.sprite.rotation = angle;\n\t\t\t});\n\t\t\t*/\n\n\t\t\tlet redrawGraphics = () => {\n\t\t\t\tthis.updateTexture();\n\t\t\t};\n\n\t\t\t// this.listenProperty(this.Transform, 'scale', redrawGraphics);\n\n\t\t\tlet propertiesThatRequireRedraw = [\n\t\t\t\t'type',\n\t\t\t\t'radius',\n\t\t\t\t'size',\n\t\t\t\t'fillColor',\n\t\t\t\t'borderColor',\n\t\t\t\t'borderWidth',\n\t\t\t\t'points',\n\t\t\t\t'topPointDistance'\n\t\t\t];\n\n\t\t\tpropertiesThatRequireRedraw.forEach(propName => {\n\t\t\t\tthis.listenProperty(this, propName, redrawGraphics);\n\t\t\t});\n\t\t},\n\t\tinitSprite() {\n\t\t\tlet textureAndAnchor = this.getTextureAndAnchor();\n\t\t\tthis.sprite = new PIXI.Sprite(textureAndAnchor.texture);\n\t\t\tthis.sprite.anchor.set(textureAndAnchor.anchor.x, textureAndAnchor.anchor.y);\n\n\t\t\tthis.Transform.container.addChild(this.sprite);\n\t\t},\n\t\tupdateTexture() {\n\t\t\tlet textureAndAnchor = this.getTextureAndAnchor();\n\t\t\tthis.sprite.texture = textureAndAnchor.texture;\n\t\t\tthis.sprite.anchor.set(textureAndAnchor.anchor.x, textureAndAnchor.anchor.y);\n\t\t},\n\t\tgetTextureAndAnchor() {\n\t\t\tlet hash = this.createPropertyHash();// + this.Transform.scale;\n\t\t\tlet textureAndAnchor = getHashedTextureAndAnchor(hash);\n\n\t\t\tif (!textureAndAnchor) {\n\t\t\t\tlet graphics = this.createGraphics();\n\t\t\t\ttextureAndAnchor = generateTextureAndAnchor(graphics, hash);\n\t\t\t\tgraphics.destroy();\n\t\t\t}\n\t\t\treturn textureAndAnchor;\n\t\t},\n\t\tcreateGraphics() {\n\t\t\tlet scale = new Vector(1, 1);// this.Transform.scale;\n\t\t\tlet graphics = new PIXI.Graphics();\n\n\t\t\tif (this.type === 'rectangle') {\n\t\t\t\tlet\n\t\t\t\t\tx = -this.size.x / 2 * scale.x,\n\t\t\t\t\ty = -this.size.y / 2 * scale.y,\n\t\t\t\t\tw = this.size.x * scale.x,\n\t\t\t\t\th = this.size.y * scale.y;\n\n\t\t\t\tgraphics.lineStyle(this.borderWidth, this.borderColor.toHexNumber(), 1);\n\t\t\t\tgraphics.beginFill(this.fillColor.toHexNumber());\n\t\t\t\tgraphics.drawRect(x, y, w, h);\n\t\t\t\tgraphics.endFill();\n\t\t\t} else if (this.type === 'circle') {\n\t\t\t\tlet averageScale = (scale.x + scale.y) / 2;\n\n\t\t\t\tgraphics.lineStyle(this.borderWidth, this.borderColor.toHexNumber(), 1);\n\t\t\t\tgraphics.beginFill(this.fillColor.toHexNumber());\n\t\t\t\tgraphics.drawCircle(0, 0, this.radius * averageScale);\n\t\t\t\tgraphics.endFill();\n\t\t\t} else if (this.type === 'convex') {\n\t\t\t\tlet path = this.getConvexPoints(PIXI.Point, false);\n\t\t\t\tpath.push(path[0]); // Close the path\n\n\t\t\t\tgraphics.lineStyle(this.borderWidth, this.borderColor.toHexNumber(), 1);\n\t\t\t\tgraphics.beginFill(this.fillColor.toHexNumber());\n\t\t\t\tgraphics.drawPolygon(path);\n\t\t\t\tgraphics.endFill();\n\t\t\t}\n\n\t\t\treturn graphics;\n\t\t},\n\t\tgetConvexPoints(vectorClass = Vector, takeScaleIntoAccount = true) {\n\t\t\tconst centerAngle = Math.PI * 2 / this.points;\n\t\t\tconst isNotEventPolygon = this.topPointDistance !== 0.5 && this.points <= 8;\n\n\t\t\tlet minDistanceMultiplier;\n\t\t\tlet maxDistanceMultiplier;\n\t\t\tif (isNotEventPolygon) {\n\t\t\t\tconst segmentAngle = Math.PI - centerAngle;\n\t\t\t\tconst unitSegmentLength = 2 * Math.sin(centerAngle / 2);\n\t\t\t\tconst defaultMinDistanceMultiplier = 1 - unitSegmentLength * Math.cos(segmentAngle / 2);\n\n\t\t\t\tif (this.points === 3) {\n\t\t\t\t\tminDistanceMultiplier = 0.2;\n\t\t\t\t\tmaxDistanceMultiplier = 5;\n\t\t\t\t} else if (this.points === 8) {\n\t\t\t\t\tminDistanceMultiplier = defaultMinDistanceMultiplier;\n\t\t\t\t\tmaxDistanceMultiplier = 3;\n\t\t\t\t} else {\n\t\t\t\t\tminDistanceMultiplier = defaultMinDistanceMultiplier;\n\t\t\t\t\tmaxDistanceMultiplier = 5;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlet path = [];\n\n\t\t\tlet currentAngle = 0;\n\t\t\tfor (let i = 0; i < this.points; ++i) {\n\t\t\t\tlet x = Math.sin(currentAngle) * this.radius;\n\t\t\t\tlet y = Math.cos(currentAngle) * this.radius;\n\n\t\t\t\tif (isNotEventPolygon && i === 0) {\n\t\t\t\t\tif (this.topPointDistance > 0.5) {\n\t\t\t\t\t\ty *= 1 + (this.topPointDistance - 0.5) * (maxDistanceMultiplier - 1);\n\t\t\t\t\t} else {\n\t\t\t\t\t\ty *= 2 * this.topPointDistance * (1 - minDistanceMultiplier) + minDistanceMultiplier;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tpath.push(new vectorClass(x, -y));\n\t\t\t\tcurrentAngle += centerAngle;\n\t\t\t}\n\t\t\tif (isNotEventPolygon) {\n\t\t\t\t// put weight to center\n\t\t\t\tlet averageY = path.reduce((prev, curr) => prev + curr.y, 0) / this.points;\n\t\t\t\tpath.forEach(p => p.y -= averageY);\n\t\t\t}\n\n\t\t\tif (takeScaleIntoAccount) {\n\t\t\t\tconst scale = this.Transform.scale;\n\t\t\t\tif (scale.x !== 1 || scale.y !== 1) {\n\t\t\t\t\tpath.forEach(p => {\n\t\t\t\t\t\tp.x *= scale.x;\n\t\t\t\t\t\tp.y *= scale.y;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn path;\n\t\t},\n\t\tsleep() {\n\t\t\tthis.sprite.destroy();\n\t\t\tthis.sprite = null;\n\t\t}\n\t}\n});\n","import {Component, Prop} from '../core/component';\nimport Vector from '../util/vector';\nimport {Color} from '../util/color';\nimport {default as PIXI, generateTextureAndAnchor, getHashedTextureAndAnchor} from '../features/graphics';\n\nComponent.register({\n\tname: 'Sprite',\n\tcategory: 'Graphics',\n\ticon: 'fa-stop',\n\tallowMultiple: true,\n\tdescription: 'Draws a sprite on the screen.',\n\tproperties: [\n\t\tProp('resource', 'character.png', Prop.enum, Prop.enum.values('character.png', 'profile.png', 'sprite.png')),\n\t\tProp('anchor', new Vector(0.5, 0.5), Prop.vector)\n\t],\n\tprototype: {\n\t\tinit() {\n\t\t\tthis.initSprite();\n\n\t\t\tthis.listenProperty(this, 'anchor', anchor => {\n\t\t\t\tif (!this.sprite) return;\n\t\t\t\telse this.sprite.anchor.set(this.anchor.x, this.anchor.y);\n\t\t\t});\n\n\t\t\tthis.listenProperty(this, 'resource', resource => {\n\t\t\t\tthis.initSprite();\n\t\t\t});\n\t\t},\n\t\tinitSprite() {\n\t\t\tif (this.sprite) {\n\t\t\t\tthis.sprite.destroy();\n\t\t\t}\n\n\t\t\tthis.sprite = PIXI.Sprite.fromImage('/img/' + this.resource);\n\t\t\tthis.sprite.anchor.set(this.anchor.x, this.anchor.y);\n\n\t\t\tthis.Transform.container.addChild(this.sprite);\n\t\t},\n\t\tsleep() {\n\t\t\tthis.sprite.destroy();\n\t\t\tthis.sprite = null;\n\t\t}\n\t}\n});\n","import { Component, Prop } from '../core/component';\nimport EntityPrototype from '../core/entityPrototype';\n\nComponent.register({\n\tname: 'Spawner',\n\tcategory: 'Logic',\n\tdescription: 'Spawns types to world.',\n\tproperties: [\n\t\tProp('typeName', '', Prop.string),\n\t\tProp('trigger', 'start', Prop.enum, Prop.enum.values('start', 'interval')),\n\t\tProp('interval', 10, Prop.float, Prop.float.range(0.1, 1000000), Prop.visibleIf('trigger', 'interval'), 'Interval in seconds')\n\t],\n\tprototype: {\n\t\tconstructor() {\n\t\t\tthis.lastSpawn = 0;\n\t\t},\n\t\tinit() {\n\t\t\tthis.lastSpawn = this.scene.time;\n\t\t},\n\t\tonStart() {\n\t\t\tif (this.trigger === 'start')\n\t\t\t\tthis.spawn();\n\t\t},\n\t\tonUpdate() {\n\t\t\tif (this.scene.time > this.lastSpawn + this.interval)\n\t\t\t\tthis.spawn();\n\t\t},\n\t\tonDrawHelper(context) {\n\t\t\tlet size = 30;\n\t\t\tlet\n\t\t\t\tx = this.Transform.position.x - size * this.Transform.scale.x/2,\n\t\t\t\ty = this.Transform.position.y - size * this.Transform.scale.y/2,\n\t\t\t\tw = size * this.Transform.scale.x,\n\t\t\t\th = size * this.Transform.scale.y;\n\t\t\tcontext.save();\n\t\t\tcontext.fillStyle = 'blue';\n\t\t\tcontext.strokeStyle = 'white';\n\t\t\tcontext.lineWidth = 1;\n\t\t\tcontext.font = '40px FontAwesome';\n\t\t\tcontext.textAlign = 'center';\n\t\t\tcontext.fillText('\\uF21D', this.Transform.position.x + 2, this.Transform.position.y);\n\t\t\tcontext.strokeText('\\uf21d', this.Transform.position.x + 2, this.Transform.position.y);\n\n\t\t\tcontext.restore();\n\t\t},\n\t\tspawn() {\n\t\t\tlet prototype = this.game.findChild('prt', prt => prt.name === this.typeName, true);\n\t\t\tif (!prototype)\n\t\t\t\treturn;\n\n\t\t\tlet entityPrototype = EntityPrototype.createFromPrototype(prototype);\n\t\t\tentityPrototype.spawnEntityToScene(this.scene, this.Transform.position);\n\t\t\tentityPrototype.delete();\n\t\t\tthis.lastSpawn = this.scene.time;\n\t\t}\n\t}\n});\n","import { Component, Prop } from '../core/component';\nimport Vector from '../util/vector';\n\nComponent.register({\n\tname: 'Trigger',\n\tdescription: 'When _ then _.',\n\tcategory: 'Logic',\n\tallowMultiple: true,\n\tproperties: [\n\t\tProp('trigger', 'playerComesNear', Prop.enum, Prop.enum.values('playerComesNear')),\n\t\tProp('radius', 40, Prop.float, Prop.float.range(0, 1000), Prop.visibleIf('trigger', 'playerComesNear')),\n\t\tProp('action', 'win', Prop.enum, Prop.enum.values('win'))\n\t],\n\tprototype: {\n\t\tpreInit() {\n\t\t\tthis.storeProp = `__Trigger_${this._componentId}`;\n\t\t},\n\t\tonUpdate() {\n\t\t\tif (this.trigger === 'playerComesNear') {\n\t\t\t\tlet componentSet = this.scene.getComponents('CharacterController');\n\t\t\t\tlet entities = [];\n\t\t\t\tcomponentSet.forEach(c => entities.push(c.entity));\n\t\t\t\tlet distSq = this.radius * this.radius;\n\t\t\t\tlet pos = this.Transform.getGlobalPosition();\n\t\t\t\tfor (let i = 0; i < entities.length; ++i) {\n\t\t\t\t\tif (entities[i].Transform.getGlobalPosition().distanceSq(pos) < distSq) {\n\t\t\t\t\t\tif (!entities[i][this.storeProp] && this.launchTrigger(entities[i]) !== false)\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tentities[i][this.storeProp] = true;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tentities[i][this.storeProp] = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\t// Return false if other triggers should not be checked\n\t\t// Note: check this return false logic. Looks weird.\n\t\tlaunchTrigger(entity) {\n\t\t\tif (this.action === 'win') {\n\t\t\t\tthis.scene.win();\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\t}\n});\n","import { Component, Prop } from '../core/component';\nimport Vector from '../util/vector';\nimport p2, { addBody, deleteBody, createMaterial, getWorld } from '../features/physics';\nimport assert from '../util/assert';\n\nconst PHYSICS_SCALE = 1/50;\nexport { PHYSICS_SCALE };\nconst PHYSICS_SCALE_INV = 1/PHYSICS_SCALE;\n\nconst DENSITY_SCALE = 3/10;\n\nconst type = {\n\tdynamic: p2.Body.DYNAMIC,\n\tkinematic: p2.Body.KINEMATIC,\n\tstatic: p2.Body.STATIC\n};\n\nconst SLEEPING = p2.Body.SLEEPING;\nconst STATIC = p2.Body.STATIC;\n\nComponent.register({\n\tname: 'Physics',\n\tcategory: 'Dynamics',\n\tdescription: 'Forms physical rules for <span style=\"color: #84ce84;\">Shapes</span>.',\n\ticon: 'fa-stop',\n\tallowMultiple: false,\n\tproperties: [\n\t\tProp('type', 'dynamic', Prop.enum, Prop.enum.values('dynamic', 'static')),\n\t\tProp('density', 1, Prop.float, Prop.float.range(0, 100), Prop.visibleIf('type', 'dynamic')),\n\t\tProp('drag', 0.1, Prop.float, Prop.float.range(0, 1), Prop.visibleIf('type', 'dynamic')),\n\t\tProp('rotationalDrag', 0.1, Prop.float, Prop.float.range(0, 1), Prop.visibleIf('type', 'dynamic')),\n\t\tProp('bounciness', 0, Prop.float, Prop.float.range(0, 1)),\n\t\tProp('friction', 0.1, Prop.float, Prop.float.range(0, 1))\n\t],\n\trequirements: [\n\t\t'Shape'\n\t],\n\trequiresInitWhenEntityIsEdited: true,\n\tprototype: {\n\t\tinited: false,\n\t\tinit() {\n\t\t\tthis.inited = true;\n\t\t\tlet update = callback => {\n\t\t\t\treturn value => {\n\t\t\t\t\tif (!this.updatingOthers && this.body) {\n\t\t\t\t\t\tcallback(value);\n\t\t\t\t\t\tif (this.type === 'dynamic')\n\t\t\t\t\t\t\tthis.body.wakeUp();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tlet Shapes = this.entity.getComponents('Shape');\n\t\t\tconst shapePropertiesThatShouldUpdateShape = [\n\t\t\t\t'type',\n\t\t\t\t'size',\n\t\t\t\t'radius',\n\t\t\t\t'points',\n\t\t\t\t'topPointDistance'\n\t\t\t];\n\t\t\tfor (let i = 0; i < Shapes.length; ++i) {\n\t\t\t\tshapePropertiesThatShouldUpdateShape.forEach(property => {\n\t\t\t\t\tthis.listenProperty(Shapes[i], property, update(() => this.updateShape()));\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis.listenProperty(this.Transform, 'position', update(position => {\n\t\t\t\tthis.body.position = position.toArray().map(x => x * PHYSICS_SCALE);\n\t\t\t\tthis.body.updateAABB();\n\t\t\t}));\n\t\t\tthis.listenProperty(this.Transform, 'angle', update(angle => {\n\t\t\t\tthis.body.angle = angle;\n\t\t\t\tthis.body.updateAABB();\n\t\t\t}));\n\t\t\tthis.listenProperty(this.Transform, 'scale', update(scale => this.updateShape()));\n\t\t\tthis.listenProperty(this, 'density', update(density => {\n\t\t\t\tthis.body.setDensity(density * DENSITY_SCALE);\n\t\t\t}));\n\t\t\tthis.listenProperty(this, 'friction', update(friction => this.updateMaterial()));\n\t\t\tthis.listenProperty(this, 'drag', update(drag => this.body.damping = drag));\n\t\t\tthis.listenProperty(this, 'rotationalDrag', update(rotationalDrag => {\n\t\t\t\tthis.body.angularDamping = rotationalDrag > 0.98 ? 1 : rotationalDrag;\n\t\t\t\tthis.body.fixedRotation = rotationalDrag === 1;\n\t\t\t\tthis.body.updateMassProperties();\n\t\t\t}));\n\t\t\tthis.listenProperty(this, 'type', update(type => {\n\t\t\t\tthis.body.type = type[this.type];\n\t\t\t\tthis.entity.sleep();\n\t\t\t\tthis.entity.wakeUp();\n\t\t\t}));\n\t\t\tthis.listenProperty(this, 'bounciness', update(bounciness => this.updateMaterial()));\n\n\t\t\tif (this._rootType)\n\t\t\t\tthis.createBody();\n\t\t},\n\t\tcreateBody() {\n\t\t\tassert(!this.body);\n\n\t\t\tthis.body = new p2.Body({\n\t\t\t\ttype: type[this.type],\n\t\t\t\tposition: [this.Transform.position.x * PHYSICS_SCALE, this.Transform.position.y * PHYSICS_SCALE],\n\t\t\t\tangle: this.Transform.angle,\n\t\t\t\tvelocity: [0, 0],\n\t\t\t\tangularVelocity: 0,\n\t\t\t\tsleepTimeLimit: 0.6,\n\t\t\t\tsleepSpeedLimit: 0.3,\n\t\t\t\tdamping: this.drag,\n\t\t\t\tangularDamping: this.rotationalDrag > 0.98 ? 1 : this.rotationalDrag,\n\t\t\t\tfixedRotation: this.rotationalDrag === 1\n\t\t\t});\n\t\t\tthis.updateShape();\n\n\t\t\tthis.body.entity = this.entity;\n\n\t\t\taddBody(this.scene, this.body);\n\t\t},\n\t\tupdateShape() {\n\t\t\tif (this.body.shapes.length > 0) {\n\t\t\t\t// We update instead of create.\n\t\t\t\t// Should remove existing shapes\n\n\t\t\t\t// The library does not support updating shapes during the step.\n\t\t\t\tlet world = getWorld(this.scene);\n\t\t\t\tassert(!world.stepping);\n\n\t\t\t\tlet shapes = this.body.shapes;\n\t\t\t\tfor (let i = 0; i < shapes.length; ++i) {\n\t\t\t\t\tshapes[i].body = null;\n\t\t\t\t}\n\t\t\t\tshapes.length = 0;\n\t\t\t}\n\n\t\t\tlet Shapes = this.entity.getComponents('Shape');\n\t\t\tlet scale = this.Transform.scale;\n\n\t\t\tShapes.forEach(Shape => {\n\t\t\t\tlet shape;\n\n\t\t\t\tif (Shape.type === 'rectangle') {\n\t\t\t\t\tshape = new p2.Box({\n\t\t\t\t\t\twidth: Shape.size.x * PHYSICS_SCALE * scale.x,\n\t\t\t\t\t\theight: Shape.size.y * PHYSICS_SCALE * scale.y\n\t\t\t\t\t});\n\t\t\t\t} else if (Shape.type === 'circle') {\n\t\t\t\t\tlet averageScale = (scale.x + scale.y) / 2;\n\n\t\t\t\t\tshape = new p2.Circle({\n\t\t\t\t\t\tradius: Shape.radius * PHYSICS_SCALE * averageScale\n\t\t\t\t\t});\n\t\t\t\t} else if (Shape.type === 'convex') {\n\t\t\t\t\tshape = new p2.Convex({\n\t\t\t\t\t\tvertices: Shape.getConvexPoints().map(p => ([p.x * PHYSICS_SCALE, p.y * PHYSICS_SCALE]))\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (shape)\n\t\t\t\t\tthis.body.addShape(shape);\n\t\t\t});\n\n\t\t\tthis.updateMass();\n\t\t\tthis.updateMaterial();\n\t\t},\n\t\tupdateMaterial(){\n\t\t\tlet material = createMaterial(this.scene, {\n\t\t\t\tfriction: this.friction,\n\t\t\t\trestitution: this.bounciness,\n\t\t\t\t// stiffness: 1e6,\n\t\t\t\t// relaxation: 4,\n\t\t\t\t// frictionStiffness: 1e6,\n\t\t\t\t// frictionRelaxation: 4,\n\t\t\t\t// surfaceVelocity: 0\n\t\t\t});\n\t\t\tthis.body.shapes.forEach(s => s.material = material);\n\t\t},\n\t\tupdateMass() {\n\t\t\tif (this.type === 'dynamic')\n\t\t\t\tthis.body.setDensity(this.density * DENSITY_SCALE);\n\t\t},\n\t\tsetRootType(rootType) {\n\t\t\tif (rootType) {\n\t\t\t\tif (this.inited)\n\t\t\t\t\tthis.createBody();\n\t\t\t}\n\t\t\treturn Component.prototype.setRootType.call(this, rootType);\n\t\t},\n\t\tonUpdate() {\n\t\t\tlet b = this.body;\n\t\t\tif (!b || b.sleepState === SLEEPING || b.type === STATIC)\n\t\t\t\treturn;\n\n\t\t\tthis.updatingOthers = true;\n\n\t\t\tlet newPos = new Vector(b.position[0] * PHYSICS_SCALE_INV, b.position[1] * PHYSICS_SCALE_INV);\n\t\t\tif (!this.Transform.position.isEqualTo(newPos))\n\t\t\t\tthis.Transform.position = newPos;\n\n\t\t\tif (this.Transform.angle !== b.angle)\n\t\t\t\tthis.Transform.angle = b.angle;\n\n\t\t\tthis.updatingOthers = false;\n\t\t},\n\t\tsleep() {\n\t\t\tif (this.body) {\n\t\t\t\tdeleteBody(this.scene, this.body);\n\t\t\t\tthis.body = null;\n\t\t\t}\n\t\t\tthis.inited = false;\n\t\t},\n\t\tgetMass() {\n\t\t\treturn this.body.mass;\n\t\t},\n\t\tapplyForce(forceVector) {\n\t\t\tthis.body.applyForce(forceVector.toArray());\n\t\t\tthis.body.wakeUp();\n\t\t},\n\t\tsetAngularForce(force) {\n\t\t\tthis.body.angularForce = force;\n\t\t\tthis.body.wakeUp();\n\t\t}\n\t}\n});\n","import { Component, Prop } from '../core/component';\n\n// Export so that other components can have this component as parent\nexport default Component.register({\n\tname: 'Lifetime',\n\tdescription: 'Set the object to be destroyed after a time period.',\n\tcategory: 'Logic', // You can also make up new categories.\n\ticon: 'fa-bars', // Font Awesome id\n\trequirements: ['Transform'], // These shared components are autofilled. Error if component is not found.\n\tproperties: [\n\t\tProp('lifetime', 3, Prop.float, Prop.float.range(0.01, 1000), 'Life time seconds')\n\t],\n\tparentClass: Component,\n\tprototype: {\n\t\tonUpdate() {\n\t\t\tlet lifetime = this.scene.time - this.startTime;\n\t\t\tif (lifetime >= this.lifetime) {\n\t\t\t\tif (this.entity)\n\t\t\t\t\tthis.entity.delete();\n\t\t\t}\n\t\t},\n\t\tinit() {\n\t\t\tthis.startTime = this.scene.time;\n\t\t}\n\t}\n});\n","import { Component, Prop } from '../core/component';\nimport { key, keyPressed, listenKeyDown } from '../util/input';\nimport assert from '../util/assert'\nimport Vector from '../util/vector';\nimport { getWorld, default as p2 } from '../features/physics';\nimport {PHYSICS_SCALE} from './Physics'\nimport { absLimit } from '../util/algorithm';\n\nconst JUMP_SAFE_DELAY = 0.1; // seconds\n\nComponent.register({\n\tname: 'CharacterController',\n\tdescription: 'Lets user control the object.',\n\tcategory: 'Dynamics',\n\tallowMultiple: false,\n\tproperties: [\n\t\tProp('type', 'player', Prop.enum, Prop.enum.values('player', 'AI')),\n\t\tProp('keyboardControls', 'arrows or WASD', Prop.enum, Prop.enum.values('arrows', 'WASD', 'arrows or WASD')),\n\t\tProp('controlType', 'jumper', Prop.enum, Prop.enum.values('jumper', 'top down'/*, 'space ship'*/)),\n\t\tProp('jumpSpeed', 300, Prop.float, Prop.float.range(0, 1000), Prop.visibleIf('controlType', 'jumper')),\n\t\tProp('jumpAddedToVelocity', 0.4, Prop.float, Prop.float.range(0, 1), Prop.visibleIf('controlType', 'jumper'), '1 means that jump speed is added to y velocity when object has y velocity.'),\n\t\tProp('breakInTheAir', true, Prop.bool, Prop.visibleIf('controlType', 'jumper')),\n\t\tProp('speed', 200, Prop.float, Prop.float.range(0, 1000)),\n\t\tProp('acceleration', 2000, Prop.float, Prop.float.range(0, 10000)),\n\t\tProp('breaking', 2000, Prop.float, Prop.float.range(0, 10000))\n\t],\n\tprototype: {\n\t\tinit() {\n\t\t\tthis.Physics = this.entity.getComponent('Physics');\n\n\t\t\tthis.lastJumpTime = 0;\n\n\t\t\tthis.keyListener = listenKeyDown(keyCode => {\n\t\t\t\tif (this.controlType !== 'jumper' || !this.scene.playing)\n\t\t\t\t\treturn;\n\n\t\t\t\tif (this.keyboardControls === 'arrows') {\n\t\t\t\t\tif (keyCode === key.up)\n\t\t\t\t\t\tthis.jump();\n\t\t\t\t} else if (this.keyboardControls === 'WASD') {\n\t\t\t\t\tif (keyCode === key.w)\n\t\t\t\t\t\tthis.jump();\n\t\t\t\t} else if (this.keyboardControls === 'arrows or WASD') {\n\t\t\t\t\tif (keyCode === key.up || keyCode === key.w)\n\t\t\t\t\t\tthis.jump();\n\t\t\t\t} else {\n\t\t\t\t\tassert(false, 'Invalid CharacterController.keyboardControls');\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tsleep() {\n\t\t\tif (this.keyListener) {\n\t\t\t\tthis.keyListener();\n\t\t\t\tthis.keyListener = null;\n\t\t\t}\n\t\t},\n\t\tgetInput() {\n\t\t\tif (this.keyboardControls === 'arrows') {\n\t\t\t\treturn {\n\t\t\t\t\tup: keyPressed(key.up),\n\t\t\t\t\tdown: keyPressed(key.down),\n\t\t\t\t\tleft: keyPressed(key.left),\n\t\t\t\t\tright: keyPressed(key.right)\n\t\t\t\t};\n\t\t\t} else if (this.keyboardControls === 'WASD') {\n\t\t\t\treturn {\n\t\t\t\t\tup: keyPressed(key.w),\n\t\t\t\t\tdown: keyPressed(key.s),\n\t\t\t\t\tleft: keyPressed(key.a),\n\t\t\t\t\tright: keyPressed(key.d)\n\t\t\t\t};\n\t\t\t} else if (this.keyboardControls === 'arrows or WASD') {\n\t\t\t\treturn {\n\t\t\t\t\tup: keyPressed(key.up) || keyPressed(key.w),\n\t\t\t\t\tdown: keyPressed(key.down) || keyPressed(key.s),\n\t\t\t\t\tleft: keyPressed(key.left) || keyPressed(key.a),\n\t\t\t\t\tright: keyPressed(key.right) || keyPressed(key.d)\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\tassert(false, 'Invalid CharacterController.keyboardControls');\n\t\t\t}\n\t\t},\n\t\tonUpdate(dt, t) {\n\t\t\tlet { up, down, left, right } = this.getInput();\n\n\t\t\tlet dx = 0,\n\t\t\t\tdy = 0;\n\n\t\t\tif (right) dx++;\n\t\t\tif (left) dx--;\n\t\t\tif (up) dy--;\n\t\t\tif (down) dy++;\n\n\t\t\tif (this.controlType === 'top down') {\n\t\t\t\tthis.moveTopDown(dx, dy, dt);\n\t\t\t} else if (this.controlType === 'jumper') {\n\t\t\t\tthis.moveJumper(dx, dy, dt);\n\t\t\t}\n\t\t},\n\t\t// dx and dy between [-1, 1]\n\t\tmoveTopDown(dx, dy, dt) {\n\t\t\tif (!this.Physics) {\n\t\t\t\tif (dx !== 0 || dy !== 0) {\n\t\t\t\t\tlet Transform = this.Transform;\n\t\t\t\t\tlet p = Transform.position;\n\t\t\t\t\tlet delta = this.speed * dt;\n\t\t\t\t\tTransform.position = new Vector(p.x + dx * delta, p.y + dy * delta);\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!this.Physics.body)\n\t\t\t\treturn;\n\n\t\t\t// Physics based\n\t\t\t// #############\n\n\t\t\tlet bodyVelocity = this.Physics.body.velocity;\n\n\t\t\tbodyVelocity[0] = absLimit(this.calculateNewVelocity(bodyVelocity[0] / PHYSICS_SCALE, dx, dt), this.speed) * PHYSICS_SCALE;\n\t\t\tbodyVelocity[1] = absLimit(this.calculateNewVelocity(bodyVelocity[1] / PHYSICS_SCALE, dy, dt), this.speed) * PHYSICS_SCALE;\n\t\t},\n\t\tmoveJumper(dx, dy, dt) {\n\t\t\tif (!this.Physics || !this.Physics.body)\n\t\t\t\treturn false;\n\n\t\t\tlet bodyVelocity = this.Physics.body.velocity;\n\n\t\t\tbodyVelocity[0] = this.calculateNewVelocity(bodyVelocity[0] / PHYSICS_SCALE, dx, dt) * PHYSICS_SCALE;\n\t\t},\n\t\tjump() {\n\t\t\tif (this.scene.time > this.lastJumpTime + JUMP_SAFE_DELAY && this.checkIfCanJump()) {\n\t\t\t\tthis.lastJumpTime = this.scene.time;\n\n\t\t\t\tlet bodyVelocity = this.Physics.body.velocity;\n\t\t\t\tif (bodyVelocity[1] > 0) {\n\t\t\t\t\t// going down\n\t\t\t\t\tbodyVelocity[1] = -this.jumpSpeed * PHYSICS_SCALE;\n\t\t\t\t} else {\n\t\t\t\t\t// going up\n\t\t\t\t\tlet velocityVector = Vector.fromArray(bodyVelocity);\n\n\t\t\t\t\tlet contactEquations = getWorld(this.scene).narrowphase.contactEquations;\n\t\t\t\t\tlet body = this.Physics.body;\n\n\t\t\t\t\tfor (let i = contactEquations.length - 1; i >= 0; --i) {\n\t\t\t\t\t\tlet contact = contactEquations[i];\n\t\t\t\t\t\tif (contact.bodyA === body || contact.bodyB === body) {\n\t\t\t\t\t\t\tlet normal = Vector.fromArray(contact.normalA);\n\t\t\t\t\t\t\tif (contact.bodyB === body)\n\t\t\t\t\t\t\t\tnormal.multiplyScalar(-1);\n\t\t\t\t\t\t\tlet dotProduct = velocityVector.dot(normal);\n\t\t\t\t\t\t\tif (dotProduct < 0) {\n\t\t\t\t\t\t\t\t// character is moving away from the contact. could be caused by physics engine.\n\t\t\t\t\t\t\t\tvelocityVector.subtract(normal.multiplyScalar(dotProduct));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tbodyVelocity[1] = velocityVector.y * this.jumpAddedToVelocity - this.jumpSpeed * PHYSICS_SCALE;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tcheckIfCanJump() {\n\t\t\tif (!this.Physics || this.controlType !== 'jumper')\n\t\t\t\treturn false;\n\n\t\t\tlet contactEquations = getWorld(this.scene).narrowphase.contactEquations;\n\t\t\tlet body = this.Physics.body;\n\n\t\t\tif (!body)\n\t\t\t\treturn false;\n\n\t\t\tif (body.sleepState === p2.Body.SLEEPING)\n\t\t\t\treturn true;\n\n\t\t\tfor (let i = contactEquations.length - 1; i >= 0; --i) {\n\t\t\t\tlet contact = contactEquations[i];\n\t\t\t\tif (contact.bodyA === body || contact.bodyB === body) {\n\t\t\t\t\tlet normalY = contact.normalA[1];\n\t\t\t\t\tif (contact.bodyB === body)\n\t\t\t\t\t\tnormalY *= -1;\n\t\t\t\t\tif (normalY > 0.5)\n\t\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\t\tcalculateNewVelocity(velocity, input, dt) {\n\t\t\tif (input !== 0) {\n\t\t\t\tif (velocity >= this.speed && input > 0) {\n\t\t\t\t\t// don't do anything\n\t\t\t\t} else if (velocity <= -this.speed && input < 0) {\n\t\t\t\t\t// don't do anything\n\t\t\t\t} else {\n\t\t\t\t\t// do something\n\t\t\t\t\tvelocity += input * this.acceleration * dt;\n\n\t\t\t\t\tif (input < 0 && velocity < -this.speed)\n\t\t\t\t\t\tvelocity = -this.speed;\n\n\t\t\t\t\tif (input > 0 && velocity > this.speed)\n\t\t\t\t\t\tvelocity = this.speed;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (velocity !== 0 && (this.controlType !== 'jumper' || this.breakInTheAir || this.checkIfCanJump())) {\n\t\t\t\t\tlet absVel = Math.abs(velocity);\n\t\t\t\t\tabsVel -= this.breaking * dt;\n\t\t\t\t\tif (absVel < 0)\n\t\t\t\t\t\tabsVel = 0;\n\n\t\t\t\t\tif (velocity > 0)\n\t\t\t\t\t\tvelocity = absVel;\n\t\t\t\t\telse\n\t\t\t\t\t\tvelocity = -absVel;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn velocity;\n\t\t}\n\t}\n});\n","/*\n milliseconds: how often callback can be called\n callbackLimitMode:\n \t- instant: if it has been quiet, call callback() instantly\n \t- soon: if it has been quiet, call callback() instantly after current code loop\n \t- next: if it has been quiet, call callback() after waiting milliseconds.\n\n When calling the callback, limitMode can be overridden: func(callLimitMode);\n */\nexport function limit(milliseconds, callbackLimitMode = 'soon', callback) {\n\tif (!['instant', 'soon', 'next'].includes(callbackLimitMode))\n\t\tthrow new Error('Invalid callbackLimitMode');\n\n\tlet queueTimeout = null; // non-null when call is in queue\n\tlet lastCall = 0; // last time when callback was called\n\n\tfunction callCallback() {\n\t\tlastCall = Date.now();\n\t\tqueueTimeout = null;\n\t\tcallback();\n\t}\n\tfunction callCallbackWithDelay(delayMilliseconds) {\n\t\tqueueTimeout = setTimeout(callCallback, delayMilliseconds);\n\t}\n\n\treturn function(callLimitMode?) {\n\t\tif (queueTimeout)\n\t\t\treturn;\n\n\t\tlet timeToNextPossibleCall = lastCall + milliseconds - Date.now();\n\t\tif (timeToNextPossibleCall > 0) {\n\t\t\tcallCallbackWithDelay(timeToNextPossibleCall);\n\t\t} else {\n\t\t\tlet mode = callLimitMode || callbackLimitMode;\n\t\t\tif (mode === 'instant')\n\t\t\t\tcallCallback();\n\t\t\telse if (mode === 'soon')\n\t\t\t\tcallCallbackWithDelay(0)\n\t\t\telse if (mode === 'next')\n\t\t\t\tcallCallbackWithDelay(milliseconds)\n\t\t}\n\t}\n}\n","import { keyPressed, key, listenKeyDown, simulateKeyEvent } from '../util/input'\nimport Vector from '../util/vector';\nimport debug from './debug'\n\nexport const CONTROL_SIZE = 70; // pixels\n\nexport default class TouchControl {\n\telement: HTMLElement = null; // document not loaded yet.\n\tstate: boolean = false; // is key binding simulated?\n\tvisible: boolean = false;\n\tcontainsFunc: (point: Vector) => boolean = null;\n\n\tconstructor(public elementId: string, public keyBinding: number, public requireTouchStart = false) {\n\t}\n\n\tinitElement() {\n\t\tif (!this.element)\n\t\t\tthis.element = document.getElementById(this.elementId);\n\t}\n\n\tsetPosition(left: number, right: number, bottom: number) {\n\t\tif (left)\n\t\t\tthis.element.style.left = left + 'px';\n\t\telse\n\t\t\tthis.element.style.right = right + 'px';\n\t\tthis.element.style.bottom = bottom + 'px';\n\t}\n\n\tgetPosition() {\n\t\tlet screen = document.getElementById('screen');\n\t\tlet screenWidth = parseInt(screen.style.width);\n\t\tlet screenHeight = parseInt(screen.style.height);\n\n\t\tlet left = parseInt(this.element.style.left);\n\t\tlet right = parseInt(this.element.style.right);\n\t\tlet bottom = parseInt(this.element.style.bottom);\n\n\t\tlet x = !isNaN(left) ? (left + this.element.offsetWidth / 2) : (screenWidth - right - this.element.offsetWidth / 2);\n\t\tlet y = screenHeight - bottom - this.element.offsetHeight / 2;\n\n\t\treturn new Vector(x, y);\n\t}\n\n\tcontains(point: Vector) {\n\t\tif (!this.visible)\n\t\t\treturn false;\n\n\t\tif (this.containsFunc)\n\t\t\treturn this.containsFunc.call(this, point);\n\n\t\tlet position = this.getPosition();\n\t\treturn position.distance(point) <= CONTROL_SIZE / 2;\n\t}\n\t// function(point) {...}\n\tsetContainsFunction(func: (point: Vector) => boolean) {\n\t\tthis.containsFunc = func;\n\t}\n\n\tsetVisible(visible: boolean) {\n\t\tif (this.visible === visible)\n\t\t\treturn;\n\n\t\tthis.visible = visible;\n\t\tif (visible)\n\t\t\tthis.element.style.display = 'inline-block';\n\t\telse\n\t\t\tthis.element.style.display = 'none';\n\t}\n\n\tsetState(controlContainsATouch: boolean, isTouchStartEvent: boolean) {\n\t\tlet oldState = this.state;\n\n\t\tif (this.requireTouchStart && !this.state && !isTouchStartEvent)\n\t\t\tthis.state = false;\n\t\telse\n\t\t\tthis.state = !!controlContainsATouch;\n\n\t\tif (this.state === oldState)\n\t\t\treturn;\n\n\t\tif (this.state) {\n\t\t\tthis.element.classList.add('pressed');\n\t\t\tsimulateKeyEvent('keydown', this.keyBinding);\n\t\t} else {\n\t\t\tthis.element.classList.remove('pressed');\n\t\t\tsimulateKeyEvent('keyup', this.keyBinding);\n\t\t}\n\t}\n}\n","import '../core/index'\nimport '../components'\nimport { keyPressed, key, listenKeyDown, simulateKeyEvent } from '../util/input'\nimport { scene, forEachScene } from '../core/scene';\nimport { forEachGame } from '../core/game';\nimport { configureNetSync } from '../core/net'\nimport { disableAllChanges } from '../core/property';\n\nimport './canvasResize'\nimport './touchControlManager'\n\n\nimport * as fullscreen from '../util/fullscreen';\nimport Level from '../core/level';\nimport { GameEvent } from '../core/eventDispatcher';\n\ndisableAllChanges();\n\nconfigureNetSync({\n\tserverToClientEnabled: true,\n\tclientToServerEnabled: false,\n\tcontext: 'play'\n});\n\nforEachGame(game => {\n\tlet levelIndex = 0;\n\n\tfunction play() {\n\t\tlet levels = game.getChildren('lvl') as Array<Level>;\n\t\tif (levelIndex >= levels.length)\n\t\t\tlevelIndex = 0;\n\t\tlevels[levelIndex].createScene().play();\n\t}\n\n\tplay();\n\n\tgame.listen(GameEvent.GAME_LEVEL_COMPLETED, () => {\n\t\tlevelIndex++;\n\t\tplay();\n\t});\n});\n\nlistenKeyDown(keyValue => {\n\tif (keyValue === key.space && scene)\n\t\tscene.win();\n});\n\n\n\n// Fullscreen\n/*\nif (fullscreen.fullscreenSupport()) {\n\twindow.addEventListener('click', () => fullscreen.toggleFullscreen(window.document.body));\n}\nsetTimeout(() => {\n\tdocument.getElementById('fullscreenInfo').classList.add('showSlowly');\n}, 1000);\nsetTimeout(() => {\n\tdocument.getElementById('fullscreenInfo').classList.remove('showSlowly');\n}, 3000);\n*/\n"],"names":["assert","condition","_i","messages","console","log","Error","stack","changeGetter","get","window","join","decideIndexOfListener","array","callback","low","high","length","priority","mid","getChangeOrigin","origin","setChangeOrigin","_origin","addChange","type","reference","id","change","external","externalChange","changeType","setPropertyValue","value","_value","move","parent","_parent","addSerializableToTree","previousOrigin","globalEventDispatcher","dispatch","GameEvent","GLOBAL_CHANGE_OCCURED","executeExternal","createStringId","threeLetterPrefix","characters","i","CHARACTERS","random","CHAR_COUNT","createDataType","_a","_b","name","_c","validators","_d","toJSON","_e","fromJSON","_f","clone","default","createType","Object","keys","forEach","validatorName","createValidator","validatorFunction","validator","args","parameters","validatorArgs","validate","x","apply","hexToRgb","hex","result","exec","r","parseInt","g","b","componentToHex","c","toString","rgbToHex","validateFloat","val","isNaN","Infinity","setXlink","el","obj","key","setAttributeNS","xlinkns","setData","dataset","stickyNonModalErrorPopup","text","document","body","style","filter","popup","position","display","max-width","top","width","padding","font-size","z-index","color","background","text-align","user-select","box-sizing","mount","getRenderer","canvas","renderer","PIXI","autoDetectRenderer","view","autoResize","antialias","plugins","interaction","destroy","sortDisplayObjects","container","children","sort","sortFunc","a","y","getHashedTextureAndAnchor","hash","texturesAndAnchors","generateTextureAndAnchor","graphicsObject","bounds","getLocalBounds","anchor","height","texture","generateTexture","SCALE_MODES","LINEAR","createCanvas","createElement","ctx","getContext","gradient","createLinearGradient","RESOLUTION","addColorStop","fillStyle","fillRect","updateSceneBackgroundGradient","scene","createWorld","owner","options","_p2World","p2","World","gravity","sleepMode","BODY_SLEEPING","updateWorld","dt","step","PHYSICS_DT","deleteWorld","clear","_p2Materials","getWorld","addBody","deleteBody","removeBody","createMaterial","materials","assign","defaultMaterialOptions","friction","restitution","stiffness","relaxation","frictionStiffness","frictionRelaxation","surfaceVelocity","material","Material","h","m","o1","o2","contactMaterial","ContactMaterial","Math","min","max","addContactMaterial","keyPressed","listenKeyDown","handler","keyDownListeners","push","splice","indexOf","listenMouseMove","element","domHandler","event","pageX","pageY","offsetLeft","offsetTop","offsetParent","Vector","addEventListener","removeEventListener","listenMouseDown","listenMouseUp","simulateKeyEvent","eventName","keyCode","onkeydown","onkeyup","eventHappened","count","currentPerSecondMeters","start","currentPerformanceMeters","performance","now","stop","millis","cumulativePerformance","forEachScene","listener","listen","GLOBAL_SCENE_CREATED","addSerializable","serializable","undefined","serializables","getSerializable","removeSerializable","getDataFromPrototype","prototype","originalPrototype","_depth","data","parentPrototype","getParentPrototype","componentDatas","getChildren","componentData","componentId","ownComponentData","componentClass","propertyHash","threeLetterType","generatedForPrototype","properties","property","j","sortInheritedComponentDatas","componentName","localeCompare","createEntityPrototypeNameProperty","entityPrototypeId","EntityPrototype","_propertyTypesByName","createProperty","predefinedId","createEntityPrototypeTransform","transform","ComponentData","addChild","scale","angle","alphaLerp","lerp","scaleLerp","getParticleTexture","size","gradientHardness","rgb","textureCache","context","createRadialGradient","Texture","fromCanvas","absLimit","absMax","isInSceneTree","_rootType","getQueryVariable","variable","query","location","search","substring","vars","split","pair","decodeURIComponent","changeReceivedOverNet","packedChanges","serverToClientEnabled","unpackChange","executeChange","gameReceivedOverNet","gameData","error","Serializable","localStorage","openEditPlayGameId","history","replaceState","e","sendSocketMessage","socket","emit","connect","io","on","onevent","packet","param1","listeners","warn","clientToServerEnabled","packChange","packedChange","packed","parentId","propertyType","keyToShortKey","shortKey","shortKeyToKey","newScene","localMaster","deleteAllChildren","deleteChildren","deleteSerializable","delete","play","resizeCanvas","setSize","force","screen","innerWidth","innerHeight","previousWidth","previousHeight","pixels","quality","MAX_PIXELS","sqrt","screenResolution","gameResolution","multiplyScalar","scrollTo","setTimeout","getElementById","touchChange","preventDefault","touchCoordinates","getTouchCoordinates","controlArray","control","isPressed","find","coord","contains","setState","touchEvent","targetTouches","touch","clientX","clientY","positionControls","playerFound","jumpSpeedFound","topDownFound","getComponents","characterController","controlType","jumpSpeed","controls","touchUp","setVisible","touchLeft","touchRight","touchDown","touchJump","touchA","touchB","visible","setPosition","setContainsFunction","point","rel","getRelativePositionToArrowCenter","abs","ARROW_HITBOX_RADIUS","visibleRightHandControls","rightHandControlArray","idx","idxFromRightWall","pos","getPosition","CONTROL_SIZE","getArrowCenter","leftPos","rightPos","add","divideScalar","center","subtract","eventDispatcherCallbacks","eventDispatchedCallback","this","EventDispatcher","listenerCounter","NUMBER_BIGGER_THAN_LISTENER_COUNT","_listeners","hasOwnProperty","index","eventListeners","_this","Promise","all","results","promises","map","res","resolve","isClient","isServer","module","serializableCallbacks","serializableId","serializableClasses","Map","skipSerializableRegistering","_super","isRoot","tslib_1.__extends","deleteChild","_alive","_state","STATE_DESTROY","_children","child","STATE_INIT","addChildren","_addChild","STATE_ADDCHILD","set","STATE_ADDPARENT","setRootType","filterFunction","deep","foundChild","foundChild_1","findChild","_detachChild","processArray","forEachChild","newParent","_detach","json","arrays_1","Array","from","concat","JSON","stringify","constructor","initWithChildren","STATE_CLONE","rootType","childArray","Boolean","STATE_FROMJSON","Class","defineProperty","info","p","states","logState","state","stateString","createDebugObject","debug","ref","debugChildren","debugChildArray","changesEnabled","scenePropertyFilter","_initialValue","setPropertyType","_initialValueIsJSON","Property","initialValue","v","n","newValue","oldValue","PROPERTY_VALUE_CHANGE","registerSerializable","description","flags","visibleIf","f","PropertyType","flag","Prop","propertyName","defaultValue","optionalParameters","dataType","isFlag","values","isArray","flagDegreesInEditor","func","vec","scalar","newLength","oldLength","dot","dx","dy","setLength","atan2","cos","sin","rotate","verticalAngle","Color","FLOAT_JSON_PRECISION_MULTIPLIER","pow","float","parseFloat","range","Number","modulo","round","int","vector","fromObject","string","String","bool","enum","newColor","toHexString","_propertyOwnerClass","_propertyTypes","PropertyOwner","propName","propChildren","otherChildren","invalidPropertiesCount","propertyIdToInvalid","prop","nameToProp","_properties","propertyTypes","ClassAsTypeHolder","propertyTypeName","HASH","charCodeAt","DOT","parseQuery","tag","className","mode","offset","char","isHash","isDot","isEnd","ns","createElementNS","setAttribute","doUnmount","childEl","parentEl","hooks","__redom_lifecycle","hooksAreEmpty","__redom_mounted","traverse","trigger","parentHooks","hook","parentNode","hookNames","shadowRootAvailable","before","getEl","__redom_view","wasMounted","oldParent","insertBefore","appendChild","doMount","remount","hooksFound","hookName","triggered","ShadowRoot","setStyle","arg1","arg2","isString","setAttr","isSVG","SVGElement","isFunction","str","createTextNode","parseArguments","arg","isNumber","isNode","nodeType","htmlCache","memoizeHTML","html","len","arguments","cloneNode","extend","bind","sticky","ticker","shared","gradientCanvas","sprite","Sprite","layers","static","game","GLOBAL_GAME_CREATED","Game","defineProperties","startsWith","require","left","right","up","down","ctrl","appleLeft","appleRight","alt","shift","space","d","k","l","o","q","s","t","u","w","z","0","1","2","3","4","5","6","7","8","9","backspace","enter","esc","plus","minus","questionMark","keyUpListeners","which","activeElement","nodeName","toLowerCase","EditorEvent","EditorEventDispatcher","dispatcher","dispatchWithResults","editorEventDispacher","Date","physicsOptions","enableSleeping","querySelector","mouseListeners","mousePosition","Scene","level","makeUpAName","createLayer","self","stage","layer","Container","cameraPosition","cameraZoom","ui","behind","main","front","components","animationFrameId","playing","time","won","epr","createEntity","pause","Transform","setCameraPositionToPlayer","pivot","timeInMilliseconds","_prevUpdate","performanceTool.start","performanceTool.stop","draw","GAME_LEVEL_COMPLETED","reset","requestAnimFrame","animFrame","requestAnimationFrame","updateCamera","render","SCENE_DRAW","performanceTool.eventHappened","resetting","unloadLevel","loadLevel","SCENE_RESET","cancelAnimationFrame","clearTimeout","SCENE_PAUSE","SCENE_START","SCENE_PLAY","component","Set","pixelDensity","screenPixels","zoomLevel","SCENE_ZOOM_CHANGED","resize","setScalars","componentClasses","automaticSceneEventListeners","_componentId","_listenRemoveFunctions","entity","Component","functionName","performanceName","performance.start","performance.stop","requirements","getComponent","_preInit","_addEventListener","addComponent","preInit","_init","init","sleep","removeComponent","_sleep","cid","initWithPropertyValues","inheritedComponentData","category","icon","_g","_h","_j","_k","_l","parentClass","_m","_o","allowMultiple","has","reservedPrototypeMembers","colorNum","reduce","prev","curr","constructorFunction","deleteFunction","call","Com","reservedPropertyNames","_name","componentClassName","predefinedComponentId","newComponentId","cloneComponentId","parentComponentData","getParentComponentData","getInheritedProperties","prp","getPropertyOrCreate","getProperty","getValue","create","ALIVE_ERROR","sleeping","Entity","addComponents","fullInit","ENTITY_CREATION_DEBUGGING","preInitComponents","initComponents","makeComponentsSleep","deleteComponents","compArray","comp","proto","previouslyCreatedEntity","Prototype","cda","propertyValue","componentDataIsNew","alsoFindFromParents","parent_1","findComponentDataByComponentId","_skipNewEntityEvent","inheritedComponentDatas","getInheritedComponentDatas","createWithInheritedComponentData","findChildren","entityPrototypeCount","levelIds","levels","entityPrototypes","foundInThisLevel","prt","countEntityPrototypes","levelId","levelArray","levelEntityPrototypes","getEntityPrototypesThatUseThisPrototype","_gameRoot","getRoot","lvl","items","nameProperty","oldScaleProperty","oldAngleProperty","getTransform","childArrays","floatToJSON","handleProperty","isEqualTo","icd","createEntityPrototype","entityPrototype","setValue","nameId","transformId","positionId","scaleId","angleId","transformData","transformClass","Prefab","childEntityPrototype","prefab","createFromPrototype","prototypeTransform","pfa","Level","predefinedSceneObject","register","PI","_debug","rotation","parentTransform","getParentTransform","listenProperty","parentEntity","getParent","getGlobalPosition","toLocal","zeroPoint","tempPoint","getGlobalAngle","setGlobalPosition","Point","onStart","positionVariance","isZero","scaleVariance","angleVariance","initSprite","redrawGraphics","updateTexture","textureAndAnchor","getTextureAndAnchor","createPropertyHash","graphics","createGraphics","Graphics","lineStyle","borderWidth","borderColor","toHexNumber","beginFill","fillColor","drawRect","endFill","averageScale","drawCircle","radius","path","getConvexPoints","drawPolygon","vectorClass","takeScaleIntoAccount","minDistanceMultiplier","maxDistanceMultiplier","centerAngle","points","isNotEventPolygon","topPointDistance","segmentAngle","unitSegmentLength","defaultMinDistanceMultiplier","currentAngle","averageY_1","scale_1","resource","fromImage","lastSpawn","spawn","onUpdate","interval","onDrawHelper","save","strokeStyle","lineWidth","font","textAlign","fillText","strokeText","restore","typeName","spawnEntityToScene","storeProp","componentSet","entities_1","distSq","distanceSq","launchTrigger","action","win","dynamic","Body","DYNAMIC","kinematic","KINEMATIC","STATIC","SLEEPING","requiresInitWhenEntityIsEdited","inited","update","updatingOthers","wakeUp","Shapes","shapePropertiesThatShouldUpdateShape","updateShape","toArray","updateAABB","density","setDensity","updateMaterial","drag","damping","rotationalDrag","angularDamping","fixedRotation","updateMassProperties","bounciness","createBody","velocity","angularVelocity","sleepTimeLimit","sleepSpeedLimit","shapes","stepping","Shape","shape","Box","Circle","Convex","vertices","addShape","updateMass","sleepState","newPos","getMass","mass","applyForce","forceVector","setAngularForce","angularForce","startTime","lifetime","blendMode","particles","blendModes","initParticles","updateGlobalCoordinatesProperty","Physics","positionListener","globalCoordinates","particleSize","particleHardness","alpha","particleLifetime","particleCount","firstBirth","alive","nextBirth","resetParticle","vx","speed","vy","speedRandom","randomSpeed","randomAngle","spawnType","spawnRadius","spawnRandom","speedToOutside","spawnRect","age","vel","followObject","spritePos","invParticleLifetime","accelerationX","acceleration","accelerationY","startColor","endColor","tint","startMultiplier","BLEND_MODES","ADD","normal","NORMAL","lastJumpTime","keyListener","keyboardControls","jump","getInput","moveTopDown","moveJumper","bodyVelocity","calculateNewVelocity","delta","checkIfCanJump","velocityVector","fromArray","contactEquations","narrowphase","contact","bodyA","bodyB","normalA","dotProduct","jumpAddedToVelocity","normalY","input","breakInTheAir","absVel","breaking","changes","valueChanges","duplicateChange","sendChanges","profile","editAccess","openEditPlayUserId","openEditPlayUserToken","userToken","user","identifyYourself","reload","gameId","userId","errorMessage","message","isFatal","milliseconds","callbackLimitMode","callCallback","lastCall","queueTimeout","callCallbackWithDelay","delayMilliseconds","includes","callLimitMode","timeToNextPossibleCall","elementId","keyBinding","requireTouchStart","TouchControl","bottom","screenWidth","screenHeight","offsetWidth","offsetHeight","containsFunc","distance","controlContainsATouch","isTouchStartEvent","oldState","classList","remove","passive","IS_TOUCH_DEVICE","navigator","maxTouchPoints","standalone","initElement","_options","levelIndex","createScene","keyValue"],"mappings":"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"}