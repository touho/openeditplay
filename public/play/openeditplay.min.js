!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(0,function(){"use strict";function t(t,e){}function e(t){ct[t.id]=t}function n(t){return ct[t]||null}function i(t){delete ct[t]}function r(t){}function o(t,e){if(e.id){var n={type:t,reference:e,id:e.id,external:ft,origin:dt};t===lt.setPropertyValue?n.value=e._value:t===lt.move?n.parent=e._parent:t===lt.addSerializableToTree&&(n.parent=e._parent,delete n.id);for(var i=0;i<yt.length;++i)yt[i](n)}}function s(t){if(r("external"),ft)return t();ft=!0,t(),ft=!1}function a(e){if(e.packedChange)return e.packedChange;var n={};try{e.parent&&(e.parentId=e.parent.id),e.type===lt.addSerializableToTree?e.reference?e.value=e.reference.toJSON():t(!1,"invalid change of type addSerializableToTree",e):void 0!==e.value&&(e.value=e.reference.propertyType.type.toJSON(e.value)),Object.keys(ut).forEach(function(t){if(void 0!==e[t]){if("type"===t&&e[t]===lt.setPropertyValue)return;n[ut[t]]=e[t]}})}catch(t){console.log("PACK ERROR",t)}return n}function p(t){var e={packedChange:t};if(Object.keys(t).forEach(function(n){var i=ht[n];e[i]=t[n]}),e.type||(e.type=lt.setPropertyValue),e.type===lt.addSerializableToTree)e.id=e.value.id;else{if(e.reference=n(e.id),!e.reference)return console.error("received a change with unknown id",e,"packed:",t),null;e.id=e.reference.id}return e.parentId&&(e.parent=n(e.parentId)),e}function c(t){var e;s(function(){if(t.type===lt.setPropertyValue)t.reference.value=t.reference.propertyType.type.fromJSON(t.value);else if(t.type===lt.addSerializableToTree)if(t.parent){var n=_t.fromJSON(t.value);t.parent.addChild(n),"ent"===n.threeLetterType&&(n.localMaster=!1)}else{var i=_t.fromJSON(t.value);"sce"===i.threeLetterType&&(e=i)}else t.type===lt.deleteAllChildren?t.reference.deleteChildren():t.type===lt.deleteSerializable?t.reference.delete():t.type===lt.move&&t.reference.move(t.parent)}),e&&e.play()}function l(t,e){void 0===t&&(t="???"),void 0===e&&(e=16);for(var n=t,i=e-1;i>=0;--i)n+=gt[Tt()*wt|0];return n}function u(e,n,i){for(var r=[],o=arguments.length-3;o-- >0;)r[o]=arguments[o+3];i=i();var s=i.validators.default(),a="",p=[],c=null;return r.forEach(function(e,n){"string"==typeof e?a=e:e&&e.validate?s=e:e&&e.isFlag?p.push(e):e&&e.visibleIf?c=e:t(!1,"invalid parameter "+e+" idx "+n)}),new Pt(e,i,s,n,a,p,c)}function h(e){var n=e.name;void 0===n&&(n="");var i=e.validators;void 0===i&&(i={default:function(t){return t}});var r=e.toJSON;void 0===r&&(r=function(t){return t});var o=e.fromJSON;void 0===o&&(o=function(t){return t});var s=e.clone;void 0===s&&(s=function(t){return t}),t(n,"name missing from property type"),t("function"==typeof i.default,"default validator missing from property type: "+n),t("function"==typeof r,"invalid toJSON for property type: "+n),t("function"==typeof o,"invalid fromJSON for property type: "+n);var a={name:n,validators:i,toJSON:r,fromJSON:o,clone:s},p=function(){return a};return Object.keys(i).forEach(function(t){p[t]=d(t,i[t]),i[t]=p[t]}),p}function d(t,e){var n=function(){for(var n=arguments.length,i=Array(n);n--;)i[n]=arguments[n];var r=[].concat(i),o=[null].concat(i);return{validatorName:t,validate:function(t){return o[0]=t,e.apply(null,o)},parameters:r}};return n.validatorName=t,n.validate=e,n}function f(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function y(t){var e=t.toString(16);return 1==e.length?"0"+e:e}function m(t,e,n){return"#"+y(t)+y(e)+y(n)}function v(t){if(isNaN(t)||t===1/0||t===-(1/0))throw new Error("Invalid float: "+t)}function g(t,e,n,i){void 0===i&&(i=0);var r,o=t.getParentPrototype();r=o?g(o,e,n,i+1):{};var s=t.getChildren("cda");n&&(s=s.filter(n));for(var a,p=0;p<s.length;++p){a=s[p],r[a.componentId]||(r[a.componentId]={ownComponentData:null,componentClass:a.componentClass,componentId:a.componentId,propertyHash:{},threeLetterType:"icd",generatedForPrototype:e}),0===i&&(r[a.componentId].ownComponentData=a);for(var c=r[a.componentId].propertyHash,l=a.getChildren("prp"),u=void 0,h=0;h<l.length;++h)u=l[h],c[u.name]=0===i?u:u.clone(!0)}return r}function w(t,e){return t.componentClass.componentName.localeCompare(e.componentClass.componentName)}function T(t,e,n){var i=t.el||t,r=e.el||e;return zt(r)&&(r=r.el),e===r&&r.__redom_view&&(e=r.__redom_view),e!==r&&(r.__redom_view=e),e.isMounted?e.remount&&e.remount():e.mount&&e.mount(),n?i.insertBefore(r,n.el||n):i.appendChild(r),e.isMounted?e.remounted&&e.remounted():(e.isMounted=!0,e.mounted&&e.mounted()),e}function C(t,e){var n=t.el||t,i=e.el||e;return e===i&&i.__redom_view&&(e=i.__redom_view),e.unmount&&e.unmount(),n.removeChild(i),e.isMounted=!1,e.unmounted&&e.unmounted(),e}function _(t,e,n){var i=t.el||t;if(arguments.length>2)i.style[e]=n;else if(Jt(e))i.setAttribute("style",e);else for(var r in e)_(i,r,e[r])}function b(t,e,n){var i=t.el||t,r=i instanceof window.SVGElement;if(arguments.length>2)"style"===e?_(i,n):r&&Ft(n)?i[e]=n:!r&&(e in i||Ft(n))?i[e]=n:i.setAttribute(e,n);else for(var o in e)b(i,o,e[o])}function S(t,e){for(var n=0;n<e.length;n++){var i=e[n];i&&("function"==typeof i?i(t):Jt(i)||Bt(i)?t.appendChild(jt(i)):Vt(i)||Vt(i.el)||zt(i.el)?T(t,i):i.length?S(t,i):"object"==typeof i&&b(t,i))}}function x(t,e){for(var n,i,r,o=0,s=0,a=0;a<=t.length;a++){var p=t.charCodeAt(a);if(p===Ut||p===qt||!p){if(0===o)n=0===a?"div":p?t.substring(s,a):t;else{var c=t.substring(s,a);1===o?i=c:r?r+=" "+c:r=c}s=a+1,o=p===Ut?1:2}}var l=e?Wt.createElementNS(e,n):Wt.createElement(n);return i&&(l.id=i),r&&(e?l.setAttribute("class",r):l.className=r),l}function P(t){for(var e=arguments,n=[],i=arguments.length-1;i-- >0;)n[i]=e[i+1];var r;if(Jt(t))r=Gt(t).cloneNode(!1);else{if(!Vt(t))throw new Error("At least one argument required");r=t.cloneNode(!1)}return S(r,n),r}function E(t,e){if(void 0===e.length)return E(t,[e]);for(var n=t.el||t,i=n.firstChild,r=0;r<e.length;r++){var o=e[r];if(o){var s=o.el||o;zt(s)&&(s=s.el),s!==i?T(t,o,i):i=i.nextSibling}}for(;i;){var a=i.nextSibling;C(t,i),i=a}}function I(t){return Jt(t)?P(t):Vt(t.el)?t.el:t}function N(t){document.body.style.filter="contrast(70%) brightness(130%) saturate(200%) sepia(40%) hue-rotate(300deg)";var e=Zt("div",t,{style:{position:"fixed",display:"inline-block","max-width":"600%",top:"20%",width:"100%",padding:"40px 10%","font-size":"20px","z-index":"100000",color:"white",background:"#0c0c0c","text-align":"center","user-select":"auto !important","box-sizing":"border-box"}});T(document.body,e)}function O(e,n){t(!e._p2World),e._p2World=new $t.World({gravity:[0,9.81]}),e._p2World.sleepMode=$t.World.BODY_SLEEPING}function A(t,e){t._p2World.step(ne,e,10)}function M(t){t._p2World&&t._p2World.clear(),delete t._p2World,delete t._p2Materials}function L(t){return t._p2World}function D(t,e){t._p2World.addBody(e)}function k(t,e){t._p2World.removeBody(e)}function R(t,e){t._p2Materials||(t._p2Materials={});var n=t._p2Materials;e=Object.assign({},ie,e);var i=[e.friction,e.restitution,e.stiffness,e.relaxation,e.frictionStiffness,e.frictionRelaxation,e.surfaceVelocity].join(";");if(n[i])return n[i];var r=new $t.Material;r.options=e,n[i]=r;for(var o in n){var s=n[o],a=r.options,p=s.options,c=new $t.ContactMaterial(r,s,{friction:Math.min(a.friction,p.friction),restitution:Math.max(a.restitution,p.restitution),stiffness:Math.min(a.stiffness,p.stiffness),relaxation:(a.relaxation+p.relaxation)/2,frictionStiffness:Math.min(a.frictionStiffness,p.frictionStiffness),frictionRelaxation:(a.frictionRelaxation+p.frictionRelaxation)/2,surfaceVelocity:Math.max(a.surfaceVelocity,p.surfaceVelocity)});t._p2World.addContactMaterial(c)}return r}function j(t){return oe[t]||!1}function J(t){return se.push(t),function(){return se.splice(se.indexOf(t),1)}}function B(t,e){return t.addEventListener("mousemove",function(n){for(var i=n.pageX,r=n.pageY,o=t;null!=o;)i-=o.offsetLeft,r-=o.offsetTop,o=o.offsetParent;t._mx=i,t._my=r,e&&e(new It(i,r))}),function(){return t.removeEventListener("mousemove",e)}}function F(t,e){return t.addEventListener("mousedown",function(n){"number"==typeof t._mx?e(new It(t._mx,t._my)):e()}),function(){return t.removeEventListener("mousedown",e)}}function V(t,e){return document.body.addEventListener("mouseup",function(n){"number"==typeof t._mx?e(new It(t._mx,t._my)):e()}),function(){return t.removeEventListener("mouseup",e)}}function z(t,e){"keydown"===t?window.onkeydown({keyCode:e}):"keyup"===t&&window.onkeyup({keyCode:e})}function W(t){return le||(le=pe.autoDetectRenderer({view:t,autoResize:!0,antialias:!0}),le.plugins.interaction&&le.plugins.interaction.destroy()),le}function U(t){return ue[t]}function q(t,e){if(!ue[e]){var n=t.getLocalBounds(),i={x:-n.x/n.width,y:-n.y/n.height};ue[e]={texture:le.generateTexture(t,pe.SCALE_MODES.LINEAR,2),anchor:i}}return ue[e]}function H(t){ve.push(t),fe&&t()}function G(t){return t>.5?(1-t)/.5:t>.2?1:5*t}function Z(t){return t>.5?1:.5+t}function Y(t,e,n){void 0===e&&(e=0),void 0===n&&(n={r:255,g:255,b:255,a:1});var i=t+"-"+e+"-"+n.r+"-"+n.g+"-"+n.b+"-"+n.a;if(!Ie[i]){var r=document.createElement("canvas");r.width=t,r.height=t;var o=r.getContext("2d"),s=o.createRadialGradient(.5*t,.5*t,.5*t*e,.5*t,.5*t,.5*t);s.addColorStop(0,"rgba("+n.r+", "+n.g+", "+n.b+", "+n.a+")"),s.addColorStop(1,"rgba("+n.r+", "+n.g+", "+n.b+", 0)"),o.fillStyle=s,o.fillRect(0,0,t,t),Ie[i]=ce.Texture.fromCanvas(r)}return Ie[i]}function X(t,e){return t>e?e:t<-e?-e:t}function K(t){return"sce"===t.reference._rootType}function Q(t){for(var e=window.location.search.substring(1),n=e.split("&"),i=0;i<n.length;i++){var r=n[i].split("=");if(decodeURIComponent(r[0])==t)return decodeURIComponent(r[1])}console.log("Query variable %s not found",t)}function $(t){Ae.serverToClientEnabled&&t.forEach(function(t){(t=p(t))&&c(t)})}function tt(t){if(console.log("receive gameData",t),!t)return console.error("Game data was not received");try{s(function(){_t.fromJSON(t)}),localStorage.openEditPlayGameId=t.id,history.replaceState({},null,"?gameId="+t.id)}catch(t){console.error("Game is corrupt.",t),N("Game is corrupt.")}}function et(t,e){if(!De)return console.log("Could not send",t);t?De.emit(t,e):De.emit(e)}function nt(){if(!window.io)return console.error("socket.io not defined after window load.");De=new io,window.s=De,De.on("connect",function(){De.onevent=function(t){var e=t.data[0];"string"==typeof e?ke[e](t.data[1]):$(e)},De.on("disconnect",function(){console.warn("Disconnected!"),N("Disconnected!"),Ae.serverToClientEnabled=!1,Ae.clientToServerEnabled=!1})})}function it(){function t(t){if(e){var n=window.innerWidth,i=window.innerHeight;(t||n!==je||i!==Je)&&(e.style.width=n+"px",e.style.height=i+"px",fe.renderer.resize(n,i),window.scrollTo(0,0),je=n,Je=i)}}if(fe){var e=document.getElementById("screen");t(!0),setTimeout(t,50),setTimeout(t,400),setTimeout(t,1e3)}}function rt(t){t.preventDefault();var e=ot(t);Ue.forEach(function(n){var i=!!e.find(function(t){return n.contains(t)});n.setState(i,"touchstart"===t.type)})}function ot(t){for(var e=[],n=0;n<t.targetTouches.length;++n){var i=t.targetTouches[n];e.push(new It(i.clientX,i.clientY))}return e}function st(){if(fe){var t=!1,e=!1,n=!1,i=!1;fe.getComponents("CharacterController").forEach(function(r){"play"===r.type&&(t=!0,"jumper"===r.controlType?(e=!0,0!==r.jumpSpeed&&(n=!0)):"top down"===r.controlType&&(i=!0))}),ze.touchUp.setVisible(i),ze.touchLeft.setVisible(t),ze.touchRight.setVisible(t),ze.touchDown.setVisible(i),ze.touchJump.setVisible(n),ze.touchA.setVisible(!0),ze.touchB.setVisible(!1),ze.touchUp.visible&&ze.touchDown.visible?(ze.touchLeft.setPosition(10,null,60),ze.touchRight.setPosition(110,null,60),ze.touchUp.setPosition(60,null,110),ze.touchDown.setPosition(60,null,10),ze.touchLeft.setContainsFunction(function(t){var e=pt(t);return e.x<0&&Math.abs(e.x)>Math.abs(e.y)&&e.length()<=Ve}),ze.touchUp.setContainsFunction(function(t){var e=pt(t);return e.y<0&&Math.abs(e.y)>Math.abs(e.x)&&e.length()<=Ve}),ze.touchRight.setContainsFunction(function(t){var e=pt(t);return e.x>0&&Math.abs(e.x)>Math.abs(e.y)&&e.length()<=Ve}),ze.touchDown.setContainsFunction(function(t){var e=pt(t);return e.y>0&&Math.abs(e.y)>Math.abs(e.x)&&e.length()<=Ve})):(ze.touchLeft.setPosition(10,null,20),ze.touchRight.setPosition(90,null,20),ze.touchLeft.setContainsFunction(function(t){var e=pt(t);return e.x<=0&&e.y>-Ve}),ze.touchRight.setContainsFunction(function(t){var e=pt(t);return e.x>0&&e.y>-Ve&&e.x<Ve}));var r=We.filter(function(t){return t.visible});r.forEach(function(t,e){var n=r.length-1-e;t.setPosition(null,10+20*n,20+70*e),0===e?t.setContainsFunction(function(e){var n=t.getPosition();return e.x>=n.x-Be/2-15&&e.y>=n.y-Be/2}):t.setContainsFunction(function(e){var n=t.getPosition();return e.y>=n.y-Be/2&&e.y<=n.y+Be/2&&e.x>=n.x-Be/2-15})})}}function at(){var t=ze.touchLeft.getPosition(),e=ze.touchRight.getPosition();return t.add(e).divideScalar(2)}function pt(t){var e=at();return t.clone().subtract(e)}var ct={},lt={addSerializableToTree:"a",setPropertyValue:"s",deleteSerializable:"d",move:"m",deleteAllChildren:"c"},ut={id:"i",type:"t",value:"v",parentId:"p"},ht={};Object.keys(ut).forEach(function(t){ht[ut[t]]=t});var dt,ft=!1,yt=[],mt="undefined"!=typeof window,vt="undefined"!=typeof module;if(mt&&vt)throw new Error("Can not be client and server at the same time.");var gt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",wt=gt.length,Tt=Math.random,Ct=new Map,_t=function(t,n){void 0===t&&(t=!1),void 0===n&&(n=!1),this._children=new Map,this._listeners={},this._rootType=this.isRoot?this.threeLetterType:null,n||(this.id=t?t:l(this.threeLetterType),e(this))};_t.prototype.delete=function(){return this._parent?(this._parent.deleteChild(this),!1):(this.deleteChildren(),this._alive=!1,this._rootType=null,this._listeners={},i(this.id),this._state|=_t.STATE_DESTROY,!0)},_t.prototype.deleteChildren=function(){this._children.size&&(this._children.forEach(function(t){t.forEach(function(t){t._parent=null,t.delete()})}),this._children.clear(),this._parent&&o(lt.deleteAllChildren,this))},_t.prototype.initWithChildren=function(e){return void 0===e&&(e=[]),t(!(this._state&_t.STATE_INIT),"init already done"),this._state|=_t.STATE_INIT,e.length>0&&this.addChildren(e),this},_t.prototype.addChildren=function(t){for(var e=this,n=0;n<t.length;n++)e.addChild(t[n]);return this},_t.prototype.addChild=function(t){return this._addChild(t),this._state|=_t.STATE_ADDCHILD,this._rootType&&o(lt.addSerializableToTree,t),this},_t.prototype._addChild=function(e){t(null===e._parent);var n=this._children.get(e.threeLetterType);return void 0===n&&(n=[],this._children.set(e.threeLetterType,n)),n.push(e),e._parent=this,e._state|=_t.STATE_ADDPARENT,e._rootType!==this._rootType&&e.setRootType(this._rootType),this},_t.prototype.findChild=function(t,e,n){void 0===n&&(n=!1);var i=this._children.get(t);if(!i)return null;if(e){var r=i.find(e);if(r)return r;if(n)for(var o=0;o<i.length;++o){var s=i[o],a=s.findChild(t,e,!0);if(a)return a}return null}return i[0]},_t.prototype.findParent=function(t,e){void 0===e&&(e=null);for(var n=this;n;){if(n.threeLetterType===t&&(!e||e(n)))return n;n=n._parent}return null},_t.prototype.getRoot=function(){for(var t=this;t._parent;)t=t._parent;return t},_t.prototype.deleteChild=function(t,e){return o(lt.deleteSerializable,t),this._detachChild(t,e),t.delete(),this},_t.prototype._detachChild=function(e,n){void 0===n&&(n=0);var i=this._children.get(e.threeLetterType);return t(i,"child not found"),i[n]!==e&&(n=i.indexOf(e)),t(n>=0,"child not found"),i.splice(n,1),0===i.length&&this._children.delete(e.threeLetterType),e._parent=null,e.setRootType(null),this},_t.prototype.forEachChild=function(t,e,n){function i(i){i.forEach(function(i){e(i),n&&i.forEachChild(t,e,!0)})}return void 0===t&&(t=null),void 0===n&&(n=!1),t?i(this._children.get(t)||[]):this._children.forEach(i),this},_t.prototype.move=function(t){return t._addChild(this._detach()),o(lt.move,this),this},_t.prototype._detach=function(){return this._parent&&this._parent._detachChild(this),this},_t.prototype.getParent=function(){return this._parent||null},_t.prototype.getChildren=function(t){return this._children.get(t)||[]},_t.prototype.toJSON=function(){var t=this,e={id:this.id};if(this._children.size>0){var n=[];Array.from(this._children.keys()).sort(function(t,e){return"prt"===t?-1:1}).forEach(function(e){return n.push(t._children.get(e))}),e.c=(i=[]).concat.apply(i,n).map(function(t){return t.toJSON()})}return e;var i},_t.prototype.toString=function(){return JSON.stringify(this.toJSON(),null,4)},_t.prototype.clone=function(){var t=new this.constructor,e=[];return this.forEachChild(null,function(t){e.push(t.clone())}),t.initWithChildren(e),this._state|=_t.STATE_CLONE,t},_t.prototype.listen=function(t,e){var n=this;return this._listeners.hasOwnProperty(t)||(this._listeners[t]=[]),this._listeners[t].unshift(e),function(){if(n._alive){var i=n._listeners[t].indexOf(e);i>=0&&n._listeners[t].splice(i,1)}}},_t.prototype.dispatch=function(t,e,n,i){var r=this._listeners[t];if(r)for(var o=r.length-1;o>=0;--o)r[o](e,n,i)},_t.prototype.hasDescendant=function(t){var e=this;if(!t)return!1;for(var n=t._parent;n;){if(n===e)return!0;n=n._parent}return!1},_t.prototype.setRootType=function(t){if(this._rootType!==t){this._rootType=t;var e;this._children.forEach(function(n){for(e=0;e<n.length;++e)n[e].setRootType(t)})}},_t.prototype.isInTree=function(){return!!this._rootType},_t.fromJSON=function e(n){t("string"==typeof n.id&&n.id.length>5,"Invalid id.");var e=Ct.get(n.id.substring(0,3));t(e);var i;try{i=e(n)}catch(t){if(mt){if(window.force,!window.force)throw new Error}else console.log("Error fromJSON",t);return null}var r=n.c?n.c.map(function(t){return _t.fromJSON(t)}).filter(Boolean):[];return i._state&_t.STATE_INIT?i.addChildren(r):i.initWithChildren(r),i._state|=_t.STATE_FROMJSON,i},_t.registerSerializable=function(e,n,i){void 0===i&&(i=null),e.prototype.threeLetterType=n,t("string"==typeof n&&3===n.length),i||(i=function(t){return new e(t.id)}),Ct.set(n,i)},_t.prototype._parent=null,_t.prototype._alive=!0,_t.prototype._state=0,_t.prototype._rootType=null,_t.STATE_INIT=2,_t.STATE_ADDCHILD=4,_t.STATE_ADDPARENT=8,_t.STATE_CLONE=16,_t.STATE_DESTROY=32,_t.STATE_FROMJSON=64,_t.prototype.isRoot=!1,Object.defineProperty(_t.prototype,"debug",{get:function(){var t=this,e=this.threeLetterType;this._children.forEach(function(n,i){e+="|",e+="prp"===i?t.getChildren("prp").map(function(t){return t.name+"="+t._value}).join(", "):i+"("+n.length+")"}),e+="|state: ";var n=[],i=function(e,i){t._state&e&&n.push(i)};return i(_t.STATE_INIT,"init"),i(_t.STATE_ADDCHILD,"add child"),i(_t.STATE_ADDPARENT,"add parent"),i(_t.STATE_CLONE,"clone"),i(_t.STATE_DESTROY,"destroy"),i(_t.STATE_FROMJSON,"from json"),e+=n.join(", ")}}),Object.defineProperty(_t.prototype,"debugChildren",{get:function(){function t(t){return new function(){}}var e=[];this._children.forEach(function(t,n){e=e.concat(t)});var n=[];return e.forEach(function(e){var i=t(e.threeLetterType);i.debug=e.debug,i.ref=e;var r=e.debugChildArray;r&&r.length>0&&(i.children=r),n.push(i)}),n}});var bt=!0,St=null,xt=function(e){function n(n){var i=n.value,r=n.predefinedId,o=n.name,s=n.propertyType,a=n.skipSerializableRegistering;void 0===a&&(a=!1),t(o,"Property without a name can not exist"),e.call(this,r,a),this._initialValue=i,s?this.setPropertyType(s):(this.name=o,this._initialValueIsJSON=!0)}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.setPropertyType=function(t){this.propertyType=t;try{void 0!==this._initialValue?this.value=this._initialValueIsJSON?t.type.fromJSON(this._initialValue):this._initialValue:this.value=t.initialValue}catch(e){console.log("Invalid value",e,t,this),this.value=t.initialValue}this.name=t.name},n.prototype.clone=function(t){return void 0===t&&(t=!1),new n({value:this.propertyType.type.clone(this.value),name:this.name,propertyType:this.propertyType,skipSerializableRegistering:t})},n.prototype.toJSON=function(){return Object.assign(e.prototype.toJSON.call(this),{v:this.type.toJSON(this.value),n:this.propertyType.name})},n}(_t);xt.prototype.propertyType=null,Object.defineProperty(xt.prototype,"type",{get:function(){return this.propertyType.type}}),Object.defineProperty(xt.prototype,"value",{set:function(t){this._value=this.propertyType.validator.validate(t),this.dispatch("change",this._value),bt&&this._rootType&&(null===St||"sce"!==this._rootType||St(this))&&o(lt.setPropertyValue,this)},get:function(){return this._value}}),_t.registerSerializable(xt,"prp",function(t){return new xt({value:t.v,predefinedId:t.id,name:t.n})}),Object.defineProperty(xt.prototype,"debug",{get:function(){return"prp "+this.name+"="+this.value}});var Pt=function(e,n,i,r,o,s,a){var p=this;void 0===s&&(s=[]),t("string"==typeof e),t(e[0]>="a"&&e[0]<="z","Name of a property must start with lower case letter."),t(n&&"string"==typeof n.name),t(i&&"function"==typeof i.validate),this.name=e,this.type=n,this.validator=i,this.initialValue=r,this.description=o,this.visibleIf=a,this.flags={},s.forEach(function(t){return p.flags[t.type]=t})};Pt.prototype.getFlag=function(t){return this.flags[t.type]},Pt.prototype.createProperty=function(t){void 0===t&&(t={});var e=t.value,n=t.predefinedId,i=t.skipSerializableRegistering;return void 0===i&&(i=!1),new xt({propertyType:this,value:e,predefinedId:n,name:this.name,skipSerializableRegistering:i})};var Et=u;Et.visibleIf=function(e,n){return t("string"==typeof e&&e.length),t(void 0!==n),{visibleIf:!0,propertyName:e,values:Array.isArray(n)?n:[n]}},u.flagDegreesInEditor=function(t,e){return void 0===e&&(e={}),e.isFlag=!0,e.type=t,e}("degreesInEditor");var It=function(t,e){this.x=t||0,this.y=e||0};It.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},It.prototype.addScalars=function(t,e){return this.x+=t,this.y+=e,this},It.prototype.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},It.prototype.subtractScalars=function(t,e){return this.x-=t,this.y-=e,this},It.prototype.multiply=function(t){return this.x*=t.x,this.y*=t.y,this},It.prototype.multiplyScalar=function(t){return this.x*=t,this.y*=t,this},It.prototype.divide=function(t){return this.x/=t.x,this.y/=t.y,this},It.prototype.divideScalar=function(t){return this.x/=t,this.y/=t,this},It.prototype.dot=function(t){return this.x*t.x+this.y*t.y},It.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},It.prototype.lengthSq=function(){return this.x*this.x+this.y*this.y},It.prototype.setLength=function(t){var e=this.length();return 0===e?(this.x=t,this.y=0):this.multiplyScalar(t/e),this},It.prototype.getProjectionOn=function(t){var e=t.length();return 0===e?this.clone():t.clone().multiplyScalar(this.dot(t)/(e*e))},It.prototype.distance=function(t){var e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)},It.prototype.distanceSq=function(t){var e=this.x-t.x,n=this.y-t.y;return e*e+n*n},It.prototype.normalize=function(){return this.setLength(1)},It.prototype.horizontalAngle=function(){return Math.atan2(this.y,this.x)},It.prototype.verticalAngle=function(){return Math.atan2(this.x,this.y)},It.prototype.rotate=function(t){var e=this.x*Math.cos(t)-this.y*Math.sin(t);return this.y=this.x*Math.sin(t)+this.y*Math.cos(t),this.x=e,this},It.prototype.rotateTo=function(t){return this.rotate(t-this.verticalAngle())},It.prototype.isEqualTo=function(t){return this.x===t.x&&this.y===t.y},It.prototype.isZero=function(){return!this.x&&!this.y},It.prototype.clone=function(){return new It(this.x,this.y)},It.prototype.set=function(t){return this.x=t.x,this.y=t.y,this},It.prototype.setScalars=function(t,e){return this.x=t,this.y=e,this},It.prototype.toString=function(){return"["+this.x+", "+this.y+"]"},It.prototype.toArray=function(){return[this.x,this.y]},It.fromObject=function(t){return new It(t.x,t.y)},It.fromArray=function(t){return new It(t[0],t[1])};var Nt=function e(n,i,r){if(n&&n.constructor===e)this.r=n.r,this.g=n.g,this.b=n.b;else if("number"==typeof n)this.r=n,this.g=i,this.b=r;else if("string"==typeof n){var o=f(n);this.r=o.r,this.g=o.g,this.b=o.b}else t(!1,"Invalid Color parameters")};Nt.prototype.toHexString=function(){return m(this.r,this.g,this.b)},Nt.prototype.toHexNumber=function(){return 256*this.r*256+256*this.g+this.b},Nt.prototype.toString=function(){return"["+this.r+","+this.g+","+this.b+"]"};var Ot=Math.pow(10,4);Et.float=h({name:"float",validators:{default:function(t){return t=parseFloat(t),v(t),t},range:function(t,e,n){return t=parseFloat(t),v(t),Math.min(n,Math.max(e,t))},modulo:function(t,e,n){t=parseFloat(t),v(t);var i=n-e;return t<e?t+=(1+((e-t)/i|0))*i:t>n-1e-7&&(t-=(1+((t-n)/i|0))*i),t}},toJSON:function(t){return Math.round(t*Ot)/Ot},fromJSON:function(t){return t}}),Et.int=h({name:"int",validators:{default:function(t){return t=parseInt(t),v(t),t},range:function(t,e,n){return t=parseInt(t),v(t),Math.min(n,Math.max(e,t))}},toJSON:function(t){return t},fromJSON:function(t){return t}}),Et.vector=h({name:"vector",validators:{default:function(t){return t=t.clone()}},toJSON:function(t){return{x:Math.round(t.x*Ot)/Ot,y:Math.round(t.y*Ot)/Ot}},fromJSON:function(t){return It.fromObject(t)},clone:function(t){return t.clone()}}),Et.string=h({name:"string",validators:{default:function(t){return t?String(t):""}},toJSON:function(t){return t},fromJSON:function(t){return t}}),Et.bool=h({name:"bool",validators:{default:function(t){if("boolean"!=typeof t)throw new Error;return t}},toJSON:function(t){return t?1:0},fromJSON:function(t){return!!t}}),Et.enum=h({name:"enum",validators:{default:function(){t(!1,"also specify enum values with Prop.enum.values('value1', 'value2', ...)")},values:function t(e){for(var t=[],n=arguments.length-1;n-- >0;)t[n]=arguments[n+1];if(!Array.isArray(t))throw new Error;if("string"!=typeof e)throw new Error("val should be string");if(t.indexOf(e)<0)throw new Error("value "+e+" not in enum: ["+t+"]");return e}},toJSON:function(t){return t},fromJSON:function(t){return t}}),Et.color=h({name:"color",validators:{default:function(t){return new Nt(t)}},toJSON:function(t){return t.toHexString()},fromJSON:function(t){return new Nt(t)}});var At=function(e){function n(n){void 0===n&&(n=!1),e.call(this,n),t(Array.isArray(this.constructor._propertyTypes),"call PropertyOwner.defineProperties after class definition"),this._properties={}}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.initWithPropertyValues=function(e){var n=this;void 0===e&&(e={});var i=[];return Object.keys(e).forEach(function(r){var o=n.constructor._propertyTypesByName[r];t(o,"Invalid property "+r),i.push(o.createProperty({value:e[r]}))}),this.initWithChildren(i),this},n.prototype.initWithChildren=function(n){var i=this;void 0===n&&(n=[]),t(!(this._state&e.STATE_INIT),"init already done"),this._state|=e.STATE_INIT;var r=[],o=[];n.forEach(function(t){"prp"===t.threeLetterType?r.push(t):o.push(t)}),e.prototype.addChildren.call(this,o);var s=0;r.filter(function(t){return!t.propertyType}).forEach(function(t){if(!i.constructor._propertyTypesByName[t.name])return console.log("Property of that name not defined",i.id,t.name,i),s++,void(t.isInvalid=!0);t.setPropertyType(i.constructor._propertyTypesByName[t.name])}),s&&(r=r.filter(function(t){return!t.isInvalid}));var a={};r.forEach(function(t){return a[t.name]=t}),this.constructor._propertyTypes.forEach(function(t){a[t.name]||r.push(t.createProperty())}),e.prototype.addChildren.call(this,r)},n.prototype.addChild=function(n){if(t(this._state&e.STATE_INIT,this.constructor.componentName||this.constructor+" requires that initWithChildren will be called before addChild"),e.prototype.addChild.call(this,n),"prp"===n.threeLetterType){if(!n.propertyType){if(!this.constructor._propertyTypesByName[n.name])return void console.log("Property of that name not defined",this.id,n,this);n.setPropertyType(this.constructor._propertyTypesByName[n.name])}t(void 0===this._properties[n.propertyType.name],"Property already added"),this._properties[n.propertyType.name]=n}},n.prototype.createPropertyHash=function(){return this.getChildren("prp").map(function(t){return""+t._value}).join(",")},n.prototype.delete=function(){return!!e.prototype.delete.call(this)&&(this._properties={},!0)},n.prototype.deleteChild=function(n,i){t("prp"!==n.threeLetterType,"Can not delete just one Property child."),e.prototype.deleteChild.call(this,n,i)},n}(_t);At.defineProperties=function(e,n){e._propertyTypes=n,e._propertyTypesByName={},n.forEach(function(n){var i=n.name;t(void 0===e.prototype[i],"Property name "+i+" clashes"),e._propertyTypesByName[i]=n,Object.defineProperty(e.prototype,i,{get:function(){return this._properties[i].value},set:function(t){this._properties[i].value=t}})})};var Mt=function(e){function n(n,i,r){void 0===i&&(i=!1),void 0===r&&(r=!1),e.call(this,i),this.name=n,this.componentClass=ge.get(this.name),t(this.componentClass,"Component class not defined: "+n),this.componentClass.allowMultiple||(r="_"+n),this.componentId=r||l("cid",10)}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.addChild=function(t){if("prp"===t.threeLetterType&&!t.propertyType){if(!this.componentClass._propertyTypesByName[t.name])return void(mt?console.log("Property of that name not defined",this.id,t,this):console.log("Property of that name not defined",this.id,this.name,t.name));t.setPropertyType(this.componentClass._propertyTypesByName[t.name])}return e.prototype.addChild.call(this,t),this},n.prototype.clone=function(t){var i=!(!t||!t.cloneComponentId)&&this.componentId,r=new n(this.name,!1,i),o=[];return this.forEachChild(null,function(t){o.push(t.clone())}),r.initWithChildren(o),this._state|=e.STATE_CLONE,r},n.prototype.toJSON=function(){return Object.assign(e.prototype.toJSON.call(this),{cid:this.componentId,n:this.name})},n.prototype.getInheritedProperties=function(t){void 0===t&&(t=0);var e={},n=this.getParentComponentData();return n&&n.getInheritedProperties(t+1).forEach(function(t){return e[t.name]=t}),this.getChildren("prp").forEach(function(n){e[n.name]=0===t?n:n.clone(!0)}),0===t?this.componentClass._propertyTypes.map(function(t){return e[t.name]||t.createProperty({skipSerializableRegistering:!0})}):Object.keys(e).map(function(t){return e[t]})},n.prototype.getParentComponentData=function(){var t=this;if(!this._parent)return null;for(var e=this._parent.getParentPrototype();e;){var n=e.findChild("cda",function(e){return e.componentId===t.componentId});if(n)return n;e=e.getParentPrototype()}return null},n.prototype.getPropertyOrCreate=function(t){var e=this.findChild("prp",function(e){return e.name===t});return e||(e=this.componentClass._propertyTypesByName[t].createProperty(),this.addChild(e)),e},n.prototype.getProperty=function(t){return this.findChild("prp",function(e){return e.name===t})},n.prototype.setValue=function(t,e){return this.getPropertyOrCreate(t).value=e,this},n.prototype.getValue=function(t){var e=this.getProperty(t);if(e)return e.value;var n=this.getParentComponentData();return n?n.getValue(t):this.componentClass._propertyTypesByName[t].initialValue},n.prototype.createComponent=function(){var t=this.getInheritedProperties(),e={};t.forEach(function(t){e[t.name]=t.value});var n=Te.create(this.name,e);return n._componentId=this.componentId,n},n}(_t);_t.registerSerializable(Mt,"cda",function(t){return new Mt(t.n,t.id,t.cid)});var Lt="entity is already dead",Dt=function(e){function n(t){void 0===t&&(t=!1),e.call(this,t),this.components=new Map,this.sleeping=!1,this.prototype=null,this.localMaster=!0}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.makeUpAName=function(){return this.prototype?this.prototype.makeUpAName():"Entity without a prototype"},n.prototype.getComponent=function(e){t(this._alive,Lt);var n=this.components.get(e);return void 0!==n?n[0]:null},
n.prototype.getComponents=function(e){return t(this._alive,Lt),this.components.get(e)||[]},n.prototype.getListOfAllComponents=function(){var t=[];return this.components.forEach(function(e,n){t.push.apply(t,e)}),t},n.prototype.clone=function(){var t=new n;t.prototype=this.prototype.clone(),t.sleeping=this.sleeping;var e=[];return this.components.forEach(function(t,n){e.push.apply(e,t.map(function(t){return t.clone()}))}),t.addComponents(e),t},n.prototype.addComponents=function(e){var i=this;t(this._alive,Lt),t(Array.isArray(e),"Parameter is not an array.");for(var r=0;r<e.length;r++){var o=e[r];(i.components.get(o._name)||i.components.set(o._name,[]).get(o._name)).push(o),o.entity=i,o._parent=i,o.setRootType(i._rootType)}return this.sleeping||n.initComponents(e),this},n.initComponents=function(t){for(var e=0;e<t.length;e++)t[e]._preInit();for(var n=0;n<t.length;n++)t[n]._init()},n.makeComponentsSleep=function(t){for(var e=0;e<t.length;e++)t[e]._sleep()},n.deleteComponents=function(t){for(var e=0;e<t.length;e++)t[e].delete()},n.prototype.sleep=function(){return t(this._alive,Lt),!this.sleeping&&(this.components.forEach(function(t,e){return n.makeComponentsSleep(t)}),this.sleeping=!0,!0)},n.prototype.wakeUp=function(){return t(this._alive,Lt),!!this.sleeping&&(this.components.forEach(function(t,e){return n.initComponents(t)}),this.sleeping=!1,!0)},n.prototype.delete=function(){return t(this._alive,Lt),this.sleep(),!!e.prototype.delete.call(this)&&(this.components.forEach(function(t,e){return n.deleteComponents(t)}),this.components.clear(),!0)},n.prototype.deleteComponent=function(e){var n=this.getComponents(e.constructor.componentName),i=n.indexOf(e);return t(i>=0),this.sleeping||e._sleep(),e.delete(),n.splice(i,1),this},n.prototype.setRootType=function(t){if(this._rootType!==t){this._rootType=t;var e;this.components.forEach(function(n,i){for(e=0;e<n.length;++e)n[e].setRootType(t)})}},n.prototype.toJSON=function(){t(this._alive,Lt);var n=[];return this.components.forEach(function(t){t.forEach(function(t){n.push(t.toJSON())})}),Object.assign(e.prototype.toJSON.call(this),{c:n,proto:this.prototype.id})},n}(_t);Object.defineProperty(Dt.prototype,"position",{get:function(){return this.getComponent("Transform").position},set:function(t){this.getComponent("Transform").position=t}}),_t.registerSerializable(Dt,"ent",function(t){console.log("creating entity from json",t);var e=new Dt(t.id);return e.prototype=getSerializable(t.proto),console.log("created entity from json",e),t.comp&&e.addComponents((t.c||t.comp).map(_t.fromJSON)),e});var kt=[u("name","No name",u.string)],Rt=function(e){function n(){e.apply(this,arguments),this.previouslyCreatedEntity=null}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.makeUpAName=function(){var t=this.findChild("prp",function(t){return"name"===t.name},!0);return t?t.value:"Prototype without a name"},n.prototype.addChild=function(n){"cda"!==n.threeLetterType||n.componentClass.allowMultiple||t(null===this.findChild("cda",function(t){return t.componentId===n.componentId}),"Can't have multiple "+n.name+" components. See Component.allowMultiple"),e.prototype.addChild.call(this,n)},n.prototype.getParentPrototype=function(){return this._parent&&"prt"===this._parent.threeLetterType?this._parent:null},n.prototype.getInheritedComponentDatas=function(t){void 0===t&&(t=null);for(var e,n=g(this,this,t),i=Object.keys(n).map(function(t){return n[t]}),r=0;r<i.length;++r)e=i[r],e.properties=e.componentClass._propertyTypes.map(function(t){return e.propertyHash[t.name]||t.createProperty({skipSerializableRegistering:!0})}),delete e.propertyHash;return i.sort(w)},n.prototype.createAndAddPropertyForComponentData=function(e,n,i){var r=e.componentClass._propertyTypesByName[n];t(r,"Invalid propertyName",n,e);var o=this.findChild("cda",function(t){return t.componentId===e.componentId}),s=!1;o||(console.log("no component data. create one",this,e),o=new Mt(e.componentClass.componentName,!1,e.componentId),s=!0);var a=o.findChild("prp",function(t){return t.name===n});return a?(a.value=i,a):(a=r.createProperty({value:i}),o.addChild(a),s&&this.addChild(o),a)},n.prototype.findComponentDataByComponentId=function(t,e){void 0===e&&(e=!1);var n=this.findChild("cda",function(e){return e.componentId===t});if(n)return n;if(e){var i=this.getParentPrototype();if(i)return i.findComponentDataByComponentId(t,e)}return null},n.prototype.getOwnComponentDataOrInherit=function(t){var e=this.findComponentDataByComponentId(t,!1);if(!e){var n=this.findComponentDataByComponentId(t,!0);if(!n)return null;e=new Mt(n.name,!1,t),this.addChild(e)}return e},n.prototype.findOwnProperty=function(t,e){var n=this.findComponentDataByComponentId(t);return n?n.getProperty(e):null},n.prototype.createEntity=function(){var t=new Dt,e=this.getInheritedComponentDatas(),n=e.map(Te.createWithInheritedComponentData);return t.prototype=this,t.addComponents(n),this.previouslyCreatedEntity=t,t},n.prototype.getValue=function(t,e){var n=this.findComponentDataByComponentId(t,!0);return n?n.getValue(e):void 0},n.prototype.countEntityPrototypes=function(t){var e=this;if(void 0===t&&(t=!1),"prt"!==this.threeLetterType)return 0;for(var n=0,i=Xt.getChildren("lvl"),r=i.length-1;r>=0;r--)for(var o=i[r].getChildren("epr"),s=o.length-1;s>=0;s--)o[s].prototype===e&&n++;return t&&this.forEachChild("prt",function(t){return n+=t.countEntityPrototypes(!0)}),n},n.prototype.delete=function(){var t=this;return this._gameRoot=this._gameRoot||this.getRoot(),!!e.prototype.delete.call(this)&&("prt"===this.threeLetterType&&"gam"===this._gameRoot.threeLetterType&&this._gameRoot.forEachChild("lvl",function(e){for(var n=e.getChildren("epr"),i=n.length-1;i>=0;i--)n[i].prototype===t&&e.deleteChild(n[i],i)}),this.previouslyCreatedEntity=null,!0)},n}(At);At.defineProperties(Rt,kt),Rt.create=function(t){return(new Rt).initWithPropertyValues({name:t})},_t.registerSerializable(Rt,"prt");var jt=function(t){return Wt.createTextNode(t)},Jt=function(t){return"string"==typeof t},Bt=function(t){return"number"==typeof t},Ft=function(t){return"function"==typeof t},Vt=function(t){return t&&t.nodeType},zt=function(t){return t&&t.__redom_list},Wt=document,Ut="#".charCodeAt(0),qt=".".charCodeAt(0),Ht={},Gt=function(t){return Ht[t]||x(t)};P.extend=function(t){var e=Gt(t);return P.bind(this,e)};var Zt=P;(function(t,e,n){this.el=I(t),this.Views=e,this.initData=n}).prototype.update=function(t,e){if(t!==this.route){var n=this.Views,i=n[t];this.view=i&&new i(this.initData,e),this.route=t,E(this.el,[this.view])}this.view&&this.view.update&&this.view.update(e,t)};window.sticky=N;var Yt=[u("name","No name",u.string)],Xt=null,Kt="undefined"!=typeof window,Qt=function(t){function e(e){Xt&&console.error("Only one game allowed."),t.apply(this,arguments),Kt&&(Xt=this),setTimeout(function(){te.forEach(function(t){return t(Xt)})},1)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.initWithChildren=function(){t.prototype.initWithChildren.apply(this,arguments),o(lt.addSerializableToTree,this)},e.prototype.delete=function(){return o(lt.deleteSerializable,this),!!t.prototype.delete.call(this)&&(Xt===this&&(Xt=null),N("Game deleted"),!0)},e}(At);At.defineProperties(Qt,Yt),Qt.prototype.isRoot=!0,_t.registerSerializable(Qt,"gam",function(t){return t.c&&t.c.sort(function(t,e){return t.id.startsWith("prt")?-1:1}),new Qt(t.id)});var $t,te=[];$t=mt?window.p2:require("../src/external/p2");var ee=$t,ne=1/60,ie={friction:.3,restitution:0,stiffness:1e6,relaxation:4,frictionStiffness:1e6,frictionRelaxation:4,surfaceVelocity:0},re={left:37,right:39,up:38,down:40,ctrl:17,appleLeft:91,appleRight:93,alt:18,shift:16,space:32,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,backspace:8,enter:13,esc:27,plus:187,minus:189,questionMark:191},oe={},se=[],ae=[];"undefined"!=typeof window&&(window.onkeydown=function(t){var e=t.which||t.keyCode;"input"==document.activeElement.nodeName.toLowerCase()&&e!==re.esc||oe[e]||(oe[e]=!0,se.forEach(function(t){return t(e)}))},window.onkeyup=function(t){var e=t.which||t.keyCode;oe[e]=!1,ae.forEach(function(t){return t(e)})});var pe;mt&&(pe=window.PIXI,pe.ticker.shared.stop());var ce=pe,le=null,ue={};mt?window.performance:Date.now;for(var he=[],de=0;de<480;++de)he.push(0);var fe=null,ye={enableSleeping:!0},me=function(e){function n(t){function n(){var t=new ce.Container;return r.stage.addChild(t),t}var i=this;if(void 0===t&&(t=!1),e.call(this,t),mt){if(fe)try{fe.delete()}catch(t){console.warn("Deleting old scene failed",t)}fe=this,window.scene=this,this.canvas=document.querySelector("canvas.openEditPlayCanvas"),this.renderer=W(this.canvas),this.stage=new ce.Container,this.cameraPosition=new It(0,0),this.cameraZoom=1;var r=this;this.backgroundLayer=n(),this.behindLayer=n(),this.mainLayer=n(),this.frontLayer=n(),this.UILayer=n(),this.mouseListeners=[B(this.canvas,function(t){return i.dispatch("onMouseMove",t)}),F(this.canvas,function(t){return i.dispatch("onMouseDown",t)}),V(this.canvas,function(t){return i.dispatch("onMouseUp",t)})]}this.level=null,this.components=new Map,this.animationFrameId=null,this.playing=!1,this.time=0,this.won=!1,o(lt.addSerializableToTree,this),O(this,ye),this.draw(),ve.forEach(function(t){return t()})}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.setCameraPositionToPlayer=function(){var t=new It(0,0),e=0;this.getComponents("CharacterController").forEach(function(n){n._rootType&&(t.add(n.Transform.position),e++)}),e>0&&this.cameraPosition.set(t.divideScalar(e))},n.prototype.updateCamera=function(){this.playing&&this.setCameraPositionToPlayer(),this.stage.pivot.set(this.cameraPosition.x-this.canvas.width/2/this.cameraZoom,this.cameraPosition.y-this.canvas.height/2/this.cameraZoom),this.stage.scale.set(this.cameraZoom,this.cameraZoom)},n.prototype.win=function(){this.won=!0},n.prototype.animFrame=function(){if(this.animationFrameId=null,this._alive&&this.playing){var t=performance.now(),e=.001*t,n=e-this._prevUpdate;n>.05&&(n=.05),this._prevUpdate=e,this.time+=n,r(this),this.dispatch("onUpdate",n,this.time),A(this,n),this.draw(),this.won&&(this.pause(),this.time=0,Xt.dispatch("levelCompleted"),this.reset()),this.requestAnimFrame()}},n.prototype.requestAnimFrame=function(){var t=this,e=function(){return t.animFrame()};window.requestAnimationFrame?this.animationFrameId=window.requestAnimationFrame(e):this.animationFrameId=setTimeout(e,16)},n.prototype.draw=function(){this.updateCamera(),this.renderer.render(this.stage,null,!0)},n.prototype.isInInitialState=function(){return!this.playing&&0===this.time},n.prototype.reset=function(){this._alive&&(this.resetting=!0,this.pause(),this.deleteChildren(),M(this),O(this,ye),this.won=!1,this.time=0,this.level&&this.level.createScene(this),this.draw(),delete this.resetting,this.dispatch("reset"))},n.prototype.pause=function(){this.playing&&(this.playing=!1,this.animationFrameId&&(window.requestAnimationFrame?window.cancelAnimationFrame(this.animationFrameId):clearTimeout(this.animationFrameId)),this.animationFrameId=null,this.dispatch("pause"))},n.prototype.play=function(){this.playing||(this._prevUpdate=.001*performance.now(),this.playing=!0,this.requestAnimFrame(),0===this.time&&this.dispatch("onStart"),this.dispatch("play"))},n.prototype.delete=function(){return!!e.prototype.delete.call(this)&&(M(this),fe===this&&(fe=null),this.mouseListeners&&(this.mouseListeners.forEach(function(t){return t()}),this.mouseListeners=null),this.renderer=null,this.stage.destroy(),this.stage=null,!0)},n.prototype.addComponent=function(t){var e=this.components.get(t.constructor.componentName);e||(e=new Set,this.components.set(t.constructor.componentName,e)),e.add(t)},n.prototype.removeComponent=function(e){var n=this.components.get(e.constructor.componentName);t(n),t(n.delete(e))},n.prototype.getComponents=function(t){return this.components.get(t)||new Set},n.prototype.mouseToWorld=function(t){return new It(this.stage.pivot.x+t.x/this.cameraZoom,this.stage.pivot.y+t.y/this.cameraZoom)},n.prototype.setZoom=function(t){t&&(this.cameraZoom=t),this.dispatch("zoomChange",this.cameraZoom)},n}(_t);me.prototype.isRoot=!0,_t.registerSerializable(me,"sce");var ve=[],ge=new Map,we=["onUpdate","onStart"],Te=function(e){function n(t){void 0===t&&(t=!1),e.call(this,t),this._componentId=null,this.scene=fe,this.game=Xt,this._listenRemoveFunctions=[],this.entity=null}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.delete=function(){return this._parent=null,this.entity=null,e.prototype.delete.call(this),!0},n.prototype._addEventListener=function(t){var e=this[t],n=this;n.constructor.componentName;this._listenRemoveFunctions.push(this.scene.listen(t,function(){e.apply(n,arguments)}))},n.prototype._preInit=function(){var e=this;this.constructor.requirements.forEach(function(n){e[n]=e.entity.getComponent(n),t(e[n],e.constructor.componentName+" requires component "+n+" but it is not found")}),this.forEachChild("com",function(t){return t._preInit()});for(var n=0;n<we.length;++n)"function"==typeof e[we[n]]&&e._addEventListener(we[n]);"Transform"!==this.constructor.componentName&&this.scene&&this.scene.addComponent(this);try{"function"==typeof this.preInit&&this.preInit()}catch(t){console.error(this.entity,this.constructor.componentName,"preInit",t)}},n.prototype._init=function(){this.forEachChild("com",function(t){return t._init()});try{"function"==typeof this.init&&this.init()}catch(t){console.error(this.entity,this.constructor.componentName,"init",t)}},n.prototype._sleep=function(){try{"function"==typeof this.sleep&&this.sleep()}catch(t){console.error(this.entity,this.constructor.componentName,"sleep",t)}"Transform"!==this.constructor.componentName&&this.scene&&this.scene.removeComponent(this),this.forEachChild("com",function(t){return t._sleep()}),this._listenRemoveFunctions.forEach(function(t){return t()}),this._listenRemoveFunctions.length=0},n.prototype.listenProperty=function(t,e,n){this._listenRemoveFunctions.push(t._properties[e].listen("change",n))},n.prototype.createComponentData=function(){var t=this,e=this.constructor.componentName,n=this.constructor._propertyTypes,i=new Mt(e),r=[];return n.forEach(function(e){r.push(e.createProperty({value:t[e.name]}))}),i.initWithChildren(r),i},n.prototype.toJSON=function(){return Object.assign(e.prototype.toJSON.call(this),{n:this.constructor.componentName,cid:this._componentId})},n}(At);Te.create=function(e,n){void 0===n&&(n={});var i=ge.get(e);t(i);var r=new i;return r.initWithPropertyValues(n),r},Te.createWithInheritedComponentData=function(t){var e=new t.componentClass;e._componentId=t.componentId;var n=t.properties.map(function(t){return t.clone()});return e.initWithChildren(n),e},Te.reservedPropertyNames=new Set(["id","constructor","delete","children","entity","env","init","preInit","sleep","toJSON","fromJSON"]),Te.reservedPrototypeMembers=new Set(["id","children","entity","env","_preInit","_init","_sleep","_forEachChildComponent","_properties","_componentData","toJSON","fromJSON"]),Te.register=function(e){var n=e.name;void 0===n&&(n="");var i=e.description;void 0===i&&(i="");var r=e.category;void 0===r&&(r="Other");var o=e.icon;void 0===o&&(o="fa-puzzle-piece");var s=e.color;void 0===s&&(s="");var a=e.properties;void 0===a&&(a=[]);var p=e.requirements;void 0===p&&(p=["Transform"]);var c=e.children;void 0===c&&(c=[]);var l=e.parentClass;void 0===l&&(l=Te);var u=e.prototype;void 0===u&&(u={});var h=e.allowMultiple;void 0===h&&(h=!0);var d=e.requiesInitWhenEntityIsEdited;void 0===d&&(d=!1),t(n,"Component must have a name."),t(n[0]>="A"&&n[0]<="Z","Component name must start with capital letter."),t(!ge.has(n),"Duplicate component class "+n),Object.keys(u).forEach(function(e){Te.reservedPrototypeMembers.has(e)&&t(!1,"Component prototype can not have a reserved member: "+e)});var f=u.constructor,y=u.delete;delete u.constructor,delete u.delete;var m=function(t){function e(){t.apply(this,arguments),f&&f.call(this)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.delete=function(){return!!t.prototype.delete.call(this)&&(y&&y.call(this),!0)},e}(l);a.forEach(function(e){t(!Te.reservedPropertyNames.has(e.name),"Can not have property called "+e.name)}),At.defineProperties(m,a),m.componentName=n,m.category=r,p.indexOf("Transform")<0&&p.push("Transform"),m.requirements=p,m.children=c,m.description=i,m.allowMultiple=h,m.icon=o;var v=n.split("").reduce(function(t,e){return t+e.charCodeAt(0)},0);return m.color=s||"hsla("+v%360+", 40%, 60%, 1)",u._name=n,Object.assign(m.prototype,u),ge.set(m.componentName,m),m},_t.registerSerializable(Te,"com",function(t){var e=new(ge.get(t.n))(t.id);return e._componentId=t.cid||null,e});var Ce=function(t){function e(e){void 0===e&&(e=!1),t.apply(this,arguments),this.prototype=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.makeUpAName=function(){var t=this.findChild("prp",function(t){return"name"===t.name});return t&&t.value?t.value:this.prototype?this.prototype.makeUpAName():"Entity prototype without a name"},e.prototype.getTransform=function(){return this.findChild("cda",function(t){return"Transform"===t.name})},e.prototype.getParentPrototype=function(){return this.prototype},e.prototype.clone=function(){var t=this,n=new e;n.prototype=this.prototype;var i=n.id,r=[];return this.forEachChild(null,function(e){if("prp"===e.threeLetterType&&"name"===e.name){var n=new xt({value:e.propertyType.type.clone(e.value),name:e.name,propertyType:t.propertyType,predefinedId:i+"_n"});r.push(n)}else if("cda"===e.threeLetterType&&"Transform"===e.name){var o=new Mt("Transform",i+"_t"),s=o.componentClass._propertyTypesByName.position.createProperty({value:e.findChild("prp",function(t){return"position"===t.name}).value,predefinedId:i+"_p"});o.addChild(s);var a=o.componentClass._propertyTypesByName.scale.createProperty({value:e.findChild("prp",function(t){return"scale"===t.name}).value,predefinedId:i+"_s"});o.addChild(a);var p=o.componentClass._propertyTypesByName.angle.createProperty({value:e.findChild("prp",function(t){return"angle"===t.name}).value,predefinedId:i+"_a"});o.addChild(p),r.push(o)}else"cda"===e.threeLetterType?r.push(e.clone({cloneComponentId:!0})):r.push(e.clone())}),n.initWithChildren(r),this._state|=_t.STATE_CLONE,n},e.prototype.toJSON=function(){var t=this,e=this.getTransform(),n={id:this.id,t:this.prototype.id},i=[];this._children.forEach(function(t){i.push(t)});var r=(a=[]).concat.apply(a,i).filter(function(n){return n!==e&&n!==t._properties.name});r.length>0&&(n.c=r.map(function(t){return t.toJSON()}));var o=u.float().toJSON,s=function(t){"name"===t.name?t.value&&(n.n=t.value):"position"===t.name?n.p=t.type.toJSON(t.value):"scale"===t.name?t.value.isEqualTo(new It(1,1))||(n.s=t.type.toJSON(t.value)):"angle"===t.name&&0!==t.value&&(n.a=o(t.value))};return s(this._properties.name),e.getChildren("prp").forEach(s),n;var a},e.prototype.spawnEntityToScene=function(t){if(fe){t&&(this.getTransform().getPropertyOrCreate("position").value=t);var e=this.createEntity();fe.addChild(e)}},e}(Rt);Object.defineProperty(Ce.prototype,"position",{get:function(){return this.getTransform().findChild("prp",function(t){return"position"===t.name}).value},set:function(t){return this.getTransform().findChild("prp",function(t){return"position"===t.name}).value=t}}),Ce.createFromPrototype=function(e,n){void 0===n&&(n=[]);var i=new Ce;i.prototype=e;var r=i.id;t(!n.find(function(t){return"Transform"===t.name}),"Prototype (prt) can not have a Transform component");var o=new Mt("Transform",r+"_t");n.push(o);var s=o.componentClass._propertyTypesByName.position.createProperty({value:new It(0,0),predefinedId:r+"_p"});o.addChild(s);var a=o.componentClass._propertyTypesByName.scale.createProperty({value:new It(1,1),predefinedId:r+"_s"});o.addChild(a);var p=o.componentClass._propertyTypesByName.angle.createProperty({value:0,predefinedId:r+"_a"});o.addChild(p);var c=Ce._propertyTypesByName.name.createProperty({value:"",predefinedId:r+"_n"});return i.initWithChildren([c].concat(n)),i},_t.registerSerializable(Ce,"epr",function(e){var i=new Ce(e.id);i.prototype=n(e.t||e.p),t(i.prototype,"Prototype "+(e.t||e.p)+" not found");var r=e.id+"_n",o=e.id+"_t",s=e.id+"_p",a=e.id+"_s",p=e.id+"_a",c=Rt._propertyTypesByName.name.createProperty({value:void 0===e.n?"":e.n,predefinedId:r}),l=new Mt("Transform",o),u=ge.get("Transform"),h=u._propertyTypesByName.position.createProperty({value:void 0!==e.x?new It(e.x,e.y):It.fromObject(e.p),predefinedId:s});l.addChild(h);var d=u._propertyTypesByName.scale.createProperty({value:e.s&&It.fromObject(e.s)||new It(void 0===e.w?1:e.w,void 0===e.h?1:e.h)||new It(1,1),predefinedId:a});l.addChild(d);var f=u._propertyTypesByName.angle.createProperty({value:e.a||0,predefinedId:p});return l.addChild(f),i.initWithChildren([c,l]),i});var _e=[u("name","No name",u.string)],be=function(t){function e(e){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.createScene=function(t){void 0===t&&(t=!1),t||new me;var e=this.getChildren("epr").map(function(t){return t.createEntity()});return fe.addChildren(e),fe.level=this,fe},e.prototype.isEmpty=function(){return 0===this.getChildren("epr").length},e}(At);At.defineProperties(be,_e),_t.registerSerializable(be,"lvl"),Te.register({name:"Transform",icon:"fa-dot-circle-o",allowMultiple:!1,properties:[u("position",new It(0,0),u.vector),u("scale",new It(1,1),u.vector),u("angle",0,u.float,u.float.modulo(0,2*Math.PI),u.flagDegreesInEditor)]}),Te.register({name:"TransformVariance",description:"Adds random factor to object's transform/orientation.",icon:"fa-dot-circle-o",allowMultiple:!1,properties:[u("positionVariance",new It(0,0),u.vector),u("scaleVariance",new It(0,0),u.vector),u("angleVariance",0,u.float,u.float.range(0,Math.PI),u.flagDegreesInEditor)],prototype:{onStart:function(){this.positionVariance.isZero()||(this.Transform.position=this.Transform.position.add(this.positionVariance.clone().multiplyScalar(-1+2*Math.random()))),this.scaleVariance.isZero()||(this.Transform.scale=this.Transform.scale.add(this.scaleVariance.clone().multiplyScalar(-1+2*Math.random()))),this.angleVariance&&(this.Transform.angle+=this.angleVariance*(-1+2*Math.random()))}}}),Te.register({name:"Shape",category:"Common",icon:"fa-stop",allowMultiple:!0,description:"Draws shape on the screen.",properties:[u("type","rectangle",u.enum,u.enum.values("rectangle","circle","convex")),u("radius",20,u.float,u.visibleIf("type",["circle","convex"])),u("size",new It(20,20),u.vector,u.visibleIf("type","rectangle")),u("points",3,u.int,u.int.range(3,16),u.visibleIf("type","convex")),u("topPointDistance",.5,u.float,u.float.range(.001,1),u.visibleIf("type","convex"),"Only works with at most 8 points"),u("fillColor",new Nt(222,222,222),u.color),u("borderColor",new Nt(255,255,255),u.color),u("borderWidth",1,u.float,u.float.range(0,30))],prototype:{init:function(){var t=this;this.initSprite(),this.listenProperty(this.Transform,"position",function(e){t.sprite.x=e.x,t.sprite.y=e.y}),this.listenProperty(this.Transform,"angle",function(e){t.sprite.rotation=e});var e=function(){t.updateTexture()};this.listenProperty(this.Transform,"scale",e),["type","radius","size","fillColor","borderColor","borderWidth","points","topPointDistance"].forEach(function(n){t.listenProperty(t,n,e)})},initSprite:function(){var t=this.getTextureAndAnchor();this.sprite=new ce.Sprite(t.texture),this.sprite.anchor.set(t.anchor.x,t.anchor.y);var e=this.Transform;this.sprite.x=e.position.x,this.sprite.y=e.position.y,this.sprite.rotation=e.angle,this.scene.mainLayer.addChild(this.sprite)},updateTexture:function(){var t=this.getTextureAndAnchor();this.sprite.texture=t.texture,this.sprite.anchor.set(t.anchor.x,t.anchor.y)},getTextureAndAnchor:function(){var t=this.createPropertyHash()+this.Transform.scale,e=U(t);if(!e){var n=this.createGraphics();e=q(n,t),n.destroy()}return e},createGraphics:function(){var t=this.Transform.scale,e=new ce.Graphics;if("rectangle"===this.type){var n=-this.size.x/2*t.x,i=-this.size.y/2*t.y,r=this.size.x*t.x,o=this.size.y*t.y;e.lineStyle(this.borderWidth,this.borderColor.toHexNumber(),1),e.beginFill(this.fillColor.toHexNumber()),e.drawRect(n,i,r,o),e.endFill()}else if("circle"===this.type){var s=(t.x+t.y)/2;e.lineStyle(this.borderWidth,this.borderColor.toHexNumber(),1),e.beginFill(this.fillColor.toHexNumber()),e.drawCircle(0,0,this.radius*s),e.endFill()}else if("convex"===this.type){var a=this.getConvexPoints(ce.Point);a.push(a[0]),e.lineStyle(this.borderWidth,this.borderColor.toHexNumber(),1),e.beginFill(this.fillColor.toHexNumber()),e.drawPolygon(a),e.endFill()}return e},getConvexPoints:function(t){var e=this;void 0===t&&(t=It);var n,i,r=2*Math.PI/this.points,o=.5!==this.topPointDistance&&this.points<=8;if(o){var s=Math.PI-r,a=2*Math.sin(r/2),p=1-a*Math.cos(s/2);3===this.points?(n=.2,i=5):8===this.points?(n=p,i=3):(n=p,i=5)}for(var c=[],l=0,u=0;u<this.points;++u){var h=Math.sin(l)*e.radius,d=Math.cos(l)*e.radius;o&&0===u&&(d*=e.topPointDistance>.5?1+(e.topPointDistance-.5)*(i-1):2*e.topPointDistance*(1-n)+n),c.push(new t(h,-d)),l+=r}if(o){var f=c.reduce(function(t,e){return t+e.y},0)/this.points;c.forEach(function(t){return t.y-=f})}var y=this.Transform.scale;return 1===y.x&&1===y.y||c.forEach(function(t){t.x*=y.x,t.y*=y.y}),c},sleep:function(){this.sprite.destroy(),this.sprite=null}}}),Te.register({name:"Spawner",description:"Spawns types to world.",properties:[u("typeName","",u.string),u("trigger","start",u.enum,u.enum.values("start","interval")),u("interval",10,u.float,u.float.range(.1,1e6),u.visibleIf("trigger","interval"),"Interval in seconds")],prototype:{constructor:function(){this.lastSpawn=0},init:function(){this.lastSpawn=this.scene.time},onStart:function(){"start"===this.trigger&&this.spawn()},onUpdate:function(){this.scene.time>this.lastSpawn+this.interval&&this.spawn()},onDrawHelper:function(t){this.Transform.position.x,this.Transform.scale.x,this.Transform.position.y,this.Transform.scale.y,this.Transform.scale.x,this.Transform.scale.y;t.save(),t.fillStyle="blue",t.strokeStyle="white",t.lineWidth=1,t.font="40px FontAwesome",t.textAlign="center",t.fillText("",this.Transform.position.x+2,this.Transform.position.y),t.strokeText("",this.Transform.position.x+2,this.Transform.position.y),t.restore()},spawn:function(){var t=this,e=this.game.findChild("prt",function(e){return e.name===t.typeName},!0);e&&(Ce.createFromPrototype(e).spawnEntityToScene(this.Transform.position),this.lastSpawn=this.scene.time)}}}),Te.register({name:"Trigger",description:"When _ then _.",category:"Logic",allowMultiple:!0,properties:[u("trigger","playerComesNear",u.enum,u.enum.values("playerComesNear")),u("radius",40,u.float,u.float.range(0,1e3),u.visibleIf("trigger","playerComesNear")),u("action","win",u.enum,u.enum.values("win"))],prototype:{preInit:function(){this.storeProp="__Trigger_"+this._componentId},onUpdate:function(){var t=this;if("playerComesNear"===this.trigger){var e=this.scene.getComponents("CharacterController"),n=[];e.forEach(function(t){return n.push(t.entity)});for(var i=this.radius*this.radius,r=this.Transform.position,o=0;o<n.length;++o)if(n[o].position.distanceSq(r)<i){if(!n[o][t.storeProp]&&t.launchTrigger(n[o])!==!1)break;n[o][t.storeProp]=!0}else n[o][t.storeProp]=!1}},launchTrigger:function(t){return"win"===this.action&&(console.log("will win"),this.scene.win(),!1)}}});var Se={dynamic:ee.Body.DYNAMIC,kinematic:ee.Body.KINEMATIC,static:ee.Body.STATIC},xe=ee.Body.SLEEPING,Pe=ee.Body.STATIC;Te.register({name:"Physics",category:"Common",description:'Forms physical rules for <span style="color: #84ce84;">Shapes</span>.',icon:"fa-stop",allowMultiple:!1,properties:[u("type","dynamic",u.enum,u.enum.values("dynamic","static")),u("density",1,u.float,u.float.range(0,100),u.visibleIf("type","dynamic")),u("drag",.1,u.float,u.float.range(0,1),u.visibleIf("type","dynamic")),u("rotationalDrag",.1,u.float,u.float.range(0,1),u.visibleIf("type","dynamic")),u("bounciness",0,u.float,u.float.range(0,1)),u("friction",.1,u.float,u.float.range(0,1))],requirements:["Shape"],requiesInitWhenEntityIsEdited:!0,prototype:{inited:!1,init:function(){var t=this;this.inited=!0;for(var e=function(e){return function(n){!t.updatingOthers&&t.body&&(e(n),"dynamic"===t.type&&t.body.wakeUp())}},n=this.entity.getComponents("Shape"),i=["type","size","radius","points","topPointDistance"],r=0;r<n.length;++r)!function(r){i.forEach(function(i){t.listenProperty(n[r],i,e(function(){return t.updateShape()}))})}(r);this.listenProperty(this.Transform,"position",e(function(e){return t.body.position=e.toArray().map(function(t){return.02*t})})),this.listenProperty(this.Transform,"angle",e(function(e){return t.body.angle=e})),this.listenProperty(this.Transform,"scale",e(function(e){return t.updateShape()})),this.listenProperty(this,"density",e(function(e){t.body.setDensity(.3*e)})),this.listenProperty(this,"friction",e(function(e){return t.updateMaterial()})),this.listenProperty(this,"drag",e(function(e){return t.body.damping=e})),this.listenProperty(this,"rotationalDrag",e(function(e){t.body.angularDamping=e>.98?1:e,t.body.fixedRotation=1===e,t.body.updateMassProperties()})),this.listenProperty(this,"type",e(function(e){t.body.type=e[t.type],t.entity.sleep(),t.entity.wakeUp()})),this.listenProperty(this,"bounciness",e(function(e){return t.updateMaterial()})),this._rootType&&this.createBody()},createBody:function(){t(!this.body),this.body=new ee.Body({type:Se[this.type],position:[.02*this.Transform.position.x,.02*this.Transform.position.y],angle:this.Transform.angle,velocity:[0,0],angularVelocity:0,sleepTimeLimit:.6,sleepSpeedLimit:.3,damping:this.drag,angularDamping:this.rotationalDrag>.98?1:this.rotationalDrag,fixedRotation:1===this.rotationalDrag}),this.updateShape(),this.body.entity=this.entity,D(this.scene,this.body)},updateShape:function(){var e=this;if(this.body.shapes.length>0){t(!L(this.scene).stepping);for(var n=this.body.shapes,i=0;i<n.length;++i)n[i].body=null;n.length=0}var r=this.entity.getComponents("Shape"),o=this.Transform.scale;r.forEach(function(t){var n;if("rectangle"===t.type)n=new ee.Box({width:.02*t.size.x*o.x,height:.02*t.size.y*o.y});else if("circle"===t.type){var i=(o.x+o.y)/2;n=new ee.Circle({radius:.02*t.radius*i})}else"convex"===t.type&&(n=new ee.Convex({vertices:t.getConvexPoints().map(function(t){return[.02*t.x,.02*t.y]})}));n&&e.body.addShape(n)}),this.updateMass(),this.updateMaterial()},updateMaterial:function(){var t=R(this.scene,{friction:this.friction,restitution:this.bounciness});this.body.shapes.forEach(function(e){return e.material=t})},updateMass:function(){"dynamic"===this.type&&this.body.setDensity(.3*this.density)},setRootType:function(t){return t&&this.inited&&this.createBody(),Te.prototype.setRootType.call(this,t)},onUpdate:function(){var t=this.body;if(t&&t.sleepState!==xe&&t.type!==Pe){this.updatingOthers=!0;var e=new It(50*t.position[0],50*t.position[1]);this.Transform.position.isEqualTo(e)||(this.Transform.position=e),this.Transform.angle!==t.angle&&(this.Transform.angle=t.angle),this.updatingOthers=!1}},sleep:function(){this.body&&(k(this.scene,this.body),this.body=null),this.inited=!1},getMass:function(){return this.body.mass},applyForce:function(t){this.body.applyForce(t.toArray()),this.body.wakeUp()},setAngularForce:function(t){this.body.angularForce=t,this.body.wakeUp()}}}),Te.register({name:"Lifetime",description:"Set the object to be destroyed after a time period",category:"Core",icon:"fa-bars",requirements:["Transform"],
properties:[u("lifetime",3,u.float,u.float.range(.01,1e3),"Life time seconds")],parentClass:Te,prototype:{onUpdate:function(){this.scene.time-this.startTime>=this.lifetime&&this.entity.delete()},init:function(){this.startTime=this.scene.time}}}),Te.register({name:"Particles",category:"Graphics",description:"Particle engine gives eye candy.",allowMultiple:!0,properties:[u("startColor",new Nt("#68c07f"),u.color),u("endColor",new Nt("#59abc0"),u.color),u("alpha",1,u.float,u.float.range(0,1)),u("particleSize",10,u.float,u.float.range(1,100)),u("particleCount",30,u.int,u.int.range(0,1e4)),u("particleLifetime",1,u.float,u.float.range(.1,10),"in seconds"),u("particleHardness",.2,u.float,u.float.range(0,1)),u("blendMode","add",u.enum,u.enum.values("add","normal")),u("spawnType","circle",u.enum,u.enum.values("circle","rectangle")),u("spawnRadius",20,u.float,u.float.range(0,1e3),u.visibleIf("spawnType","circle")),u("spawnRandom",.5,u.float,u.float.range(0,1),u.visibleIf("spawnType","circle")),u("spawnRect",new It(50,50),u.vector,u.visibleIf("spawnType","rectangle")),u("speedToOutside",50,u.float,u.float.range(-1e3,1e3),u.visibleIf("spawnType","circle")),u("speed",new It(0,0),u.vector),u("speedRandom",0,u.float,u.float.range(0,1e3),"Max random velocity to random direction"),u("acceleration",new It(0,0),u.vector),u("globalCoordinates",!0,u.bool),u("followObject",.4,u.float,u.float.range(0,1),u.visibleIf("globalCoordinates",!0))],prototype:{init:function(){var t=this;this.container=new ce.Container,this.updateTexture(),["particleSize","particleHardness","alpha"].forEach(function(e){t.listenProperty(t,e,function(){t.updateTexture()})}),this.listenProperty(this,"blendMode",function(e){t.particles&&t.particles.forEach(function(t){t.sprite&&(t.sprite.blendMode=Ee[e])})}),this.scene.mainLayer.addChild(this.container),this.initParticles(),["particleLifetime","particleCount"].forEach(function(e){t.listenProperty(t,e,function(){t.initParticles()})}),this.updateGlobalCoordinatesProperty(),this.listenProperty(this,"globalCoordinates",function(){t.updateGlobalCoordinatesProperty()}),this.Physics=this.entity.getComponent("Physics")},updateGlobalCoordinatesProperty:function(){var t=this;this.positionListener&&(this.positionListener(),this.positionListener=null),this.globalCoordinates?(this.particles.forEach(function(e){e.sprite&&(e.sprite.x+=t.container.position.x,e.sprite.y+=t.container.position.y)}),this.container.position.set(0,0)):(this.positionListener=this.Transform._properties.position.listen("change",function(e){t.container.position.set(e.x,e.y)}),this.container.position.set(this.Transform.position.x,this.Transform.position.y),this.particles.forEach(function(e){e.sprite&&(e.sprite.x-=t.container.position.x,e.sprite.y-=t.container.position.y)}))},updateTexture:function(){var t=this;this.texture=Y(this.particleSize,.9*this.particleHardness,{r:255,g:255,b:255,a:this.alpha}),this.particles&&this.particles.forEach(function(e){e.sprite&&(e.sprite.texture=t.texture)})},initParticles:function(){var t=this;this.particles&&this.particles.forEach(function(t){t.sprite&&t.sprite.destroy()}),this.particles=[];for(var e=this.particleLifetime/this.particleCount,n=this.scene.time+Math.random()*e,i=0;i<this.particleCount;++i)t.particles.push({alive:!1,nextBirth:n+i*e})},resetParticle:function(t){if(t.vx=this.speed.x,t.vy=this.speed.y,this.speedRandom>0){var e=this.speedRandom*Math.random(),n=Math.random()*Math.PI*2;t.vx+=Math.sin(n)*e,t.vy+=Math.cos(n)*e}if("circle"===this.spawnType){var i=this.spawnRadius;this.spawnRandom>0&&(i=this.spawnRandom*Math.random()*i+(1-this.spawnRandom)*i);var r=Math.random()*Math.PI*2;t.sprite.x=Math.cos(r)*i,t.sprite.y=Math.sin(r)*i,0!==this.speedToOutside&&(t.vx+=Math.cos(r)*this.speedToOutside,t.vy+=Math.sin(r)*this.speedToOutside)}else t.sprite.x=-this.spawnRect.x/2+Math.random()*this.spawnRect.x,t.sprite.y=-this.spawnRect.y/2+Math.random()*this.spawnRect.y;if(t.age=this.scene.time-t.nextBirth,t.nextBirth+=this.particleLifetime,this.globalCoordinates&&(t.sprite.x+=this.Transform.position.x,t.sprite.y+=this.Transform.position.y,this.Physics&&this.Physics.body)){var o=this.Physics.body.velocity;t.vx=t.vx+this.followObject*o[0]/.02,t.vy=t.vy+this.followObject*o[1]/.02}},onUpdate:function(t,e){for(var n,i,r,o,s,a=this,p=this.particleLifetime,c=1/p,l=this.particles,u=this.acceleration.x*t,h=this.acceleration.y*t,d=this.startColor,f=this.endColor,y=this.particleCount-1;y>=0;--y){if(s=l[y],!s.alive){if(!(e>=s.nextBirth))continue;s.sprite=new ce.Sprite(a.texture),s.sprite.blendMode=Ee[a.blendMode],s.sprite.anchor.set(.5,.5),s.alive=!0,a.resetParticle(s),a.container.addChild(s.sprite)}n=s.sprite,i=n.transform.position,s.age+=t,o=s.age*c,o>=1?(a.resetParticle(s),o=s.age*c):(s.vx+=u,s.vy+=h,i.x+=s.vx*t,i.y+=s.vy*t),n.tint=function(t){var e=1-t;return 65536*(d.r*e+f.r*t|0)+256*(d.g*e+f.g*t|0)+(d.b*e+f.b*t|0)}(o),n.alpha=G(o),r=Z(o),n.scale.set(r,r)}},sleep:function(){this.particles=null,this.container.destroy(),this.container=null,this.positionListener&&(this.positionListener(),this.positionListener=null)}}});var Ee={add:mt?ce.BLEND_MODES.ADD:0,normal:mt?ce.BLEND_MODES.NORMAL:0},Ie={};Te.register({name:"CharacterController",description:"Lets user control the object.",category:"Common",allowMultiple:!1,properties:[u("type","play",u.enum,u.enum.values("play","AI")),u("keyboardControls","arrows or WASD",u.enum,u.enum.values("arrows","WASD","arrows or WASD")),u("controlType","jumper",u.enum,u.enum.values("jumper","top down")),u("jumpSpeed",300,u.float,u.float.range(0,1e3),u.visibleIf("controlType","jumper")),u("breakInTheAir",!0,u.bool,u.visibleIf("controlType","jumper")),u("speed",200,u.float,u.float.range(0,1e3)),u("acceleration",2e3,u.float,u.float.range(0,1e4)),u("breaking",2e3,u.float,u.float.range(0,1e4))],prototype:{init:function(){var e=this;this.Physics=this.entity.getComponent("Physics"),this.lastJumpTime=0,this.keyListener=J(function(n){"jumper"===e.controlType&&e.scene.playing&&("arrows"===e.keyboardControls?n===re.up&&e.jump():"WASD"===e.keyboardControls?n===re.w&&e.jump():"arrows or WASD"===e.keyboardControls?n!==re.up&&n!==re.w||e.jump():t(!1,"Invalid CharacterController.keyboardControls"))})},sleep:function(){this.keyListener&&(this.keyListener(),this.keyListener=null)},getInput:function(){return"arrows"===this.keyboardControls?{up:j(re.up),down:j(re.down),left:j(re.left),right:j(re.right)}:"WASD"===this.keyboardControls?{up:j(re.w),down:j(re.s),left:j(re.a),right:j(re.d)}:"arrows or WASD"===this.keyboardControls?{up:j(re.up)||j(re.w),down:j(re.down)||j(re.s),left:j(re.left)||j(re.a),right:j(re.right)||j(re.d)}:void t(!1,"Invalid CharacterController.keyboardControls")},onUpdate:function(t,e){var n=this.getInput(),i=n.up,r=n.down,o=n.left,s=n.right,a=0,p=0;s&&a++,o&&a--,i&&p--,r&&p++,"top down"===this.controlType?this.moveTopDown(a,p,t):"jumper"===this.controlType&&this.moveJumper(a,p,t)},moveTopDown:function(t,e,n){if(this.Physics){if(this.Physics.body){var i=this.Physics.body.velocity;i[0]=.02*X(this.calculateNewVelocity(i[0]/.02,t,n),this.speed),i[1]=.02*X(this.calculateNewVelocity(i[1]/.02,e,n),this.speed)}}else if(0!==t||0!==e){var r=this.Transform,o=r.position,s=this.speed*n;r.position=new It(o.x+t*s,o.y+e*s)}},moveJumper:function(t,e,n){if(!this.Physics||!this.Physics.body)return!1;var i=this.Physics.body.velocity;i[0]=.02*this.calculateNewVelocity(i[0]/.02,t,n)},jump:function(){if(this.scene.time>this.lastJumpTime+.1&&this.checkIfCanJump()){this.lastJumpTime=this.scene.time;var t=this.Physics.body.velocity;if(t[1]>0)t[1]=.02*-this.jumpSpeed;else{for(var e=It.fromArray(t),n=L(this.scene).narrowphase.contactEquations,i=this.Physics.body,r=n.length-1;r>=0;--r){var o=n[r];if(o.bodyA===i||o.bodyB===i){var s=It.fromArray(o.normalA);o.bodyB===i&&s.multiplyScalar(-1);var a=e.dot(s);a<0&&e.subtract(s.multiplyScalar(a))}}t[1]=e.y-.02*this.jumpSpeed}}},checkIfCanJump:function(){if(!this.Physics||"jumper"!==this.controlType)return!1;var t=L(this.scene).narrowphase.contactEquations,e=this.Physics.body;if(!e)return!1;if(e.sleepState===ee.Body.SLEEPING)return!0;for(var n=t.length-1;n>=0;--n){var i=t[n];if(i.bodyA===e||i.bodyB===e){var r=i.normalA[1];if(i.bodyB===e&&(r*=-1),r>.5)return!0}}return!1},calculateNewVelocity:function(t,e,n){if(0!==e)t>=this.speed&&e>0||t<=-this.speed&&e<0||(t+=e*this.acceleration*n,e<0&&t<-this.speed&&(t=-this.speed),e>0&&t>this.speed&&(t=this.speed));else if(0!==t&&("jumper"!==this.controlType||this.breakInTheAir||this.checkIfCanJump())){var i=Math.abs(t);i-=this.breaking*n,i<0&&(i=0),t=t>0?i:-i}return t}}});var Ne={},Oe={listen:function(t,e){return Ne.hasOwnProperty(t)||(Ne[t]=[]),Ne[t].push(e),function(){var n=Ne[t].indexOf(e);Ne[t].splice(n,1)}},dispatch:function(t){for(var e=[],n=arguments.length-1;n-- >0;)e[n]=arguments[n+1];if(Ne.hasOwnProperty(t))for(var i=Ne[t],r=0;r<i.length;++r)i[r].apply(null,e)},getEventPromise:function(t){return new Promise(function(e){Oe.listen(t,e)})}},Ae={context:null,serverToClientEnabled:!0,clientToServerEnabled:!1},Me=[],Le={};!function(e){t("function"==typeof e),yt.push(e)}(function(t){if(!t.external&&Ae.clientToServerEnabled&&!K(t)){if(t.type===lt.setPropertyValue){var e=Le[t.id];e&&Me.splice(Me.indexOf(e),1),Le[t.id]=t}Me.push(t),Re&&Re()}});var De,ke={data:function(t){var e=t.profile,n=t.gameData,i=t.editAccess;localStorage.openEditPlayUserId=e.id,localStorage.openEditPlayUserToken=e.userToken,i||Oe.dispatch("noEditAccess"),delete e.userToken,window.user=e,tt(n)},identifyYourself:function(){if(Xt)return location.reload();var t=Q("gameId")||localStorage.openEditPlayGameId;et("identify",{userId:localStorage.openEditPlayUserId,userToken:localStorage.openEditPlayUserToken,gameId:t,context:Ae.context})},errorMessage:function(t){var e=t.message,n=t.isFatal,i=t.data;console.error("Server sent "+(n?"FATAL ERROR":"error")+":",e,i),n&&N(e)}},Re=function(t,e,n){function i(){o=Date.now(),r=null,n()}if(void 0===e&&(e="soon"),!["instant","soon","next"].includes(e))throw new Error("Invalid callbackLimitMode");var r=null,o=0;return function(s){if(!r){var a=o+t-Date.now();if(a>0)r=setTimeout(i,a);else{r=setTimeout(i,t);var p=s||e;"instant"===p?n():"soon"===p&&setTimeout(n,0)}}}}(200,"soon",function(){if(De&&0!==Me.length&&Ae.clientToServerEnabled){var t=Me.map(a);Me.length=0,Le={},console.log("send change"),et("",t)}});window.addEventListener("load",nt);var je=null,Je=null;window.addEventListener("resize",it),H(it);var Be=70,Fe=function(t,e,n){this.elementId=t,this.element=null,this.keyBinding=e,this.state=!1,this.visible=!1,this.requireTouchStart=n,this.containsFunc=null};Fe.prototype.initElement=function(){this.element||(this.element=document.getElementById(this.elementId))},Fe.prototype.setPosition=function(t,e,n){t?this.element.style.left=t+"px":this.element.style.right=e+"px",this.element.style.bottom=n+"px"},Fe.prototype.getPosition=function(){var t=document.getElementById("screen"),e=parseInt(t.style.width),n=parseInt(t.style.height),i=parseInt(this.element.style.left),r=parseInt(this.element.style.right),o=parseInt(this.element.style.bottom),s=isNaN(i)?e-r-this.element.offsetWidth/2:i+this.element.offsetWidth/2,a=n-o-this.element.offsetHeight/2;return new It(s,a)},Fe.prototype.contains=function(t){return!!this.visible&&(this.containsFunc?this.containsFunc.call(this,t):this.getPosition().distance(t)<=Be/2)},Fe.prototype.setContainsFunction=function(t){this.containsFunc=t},Fe.prototype.setVisible=function(t){this.visible!==t&&(this.visible=t,this.element.style.display=t?"inline-block":"none")},Fe.prototype.setState=function(t,e){var n=this.state;!this.requireTouchStart||this.state||e?this.state=!!t:this.state=!1,this.state!==n&&(this.state?(this.element.classList.add("pressed"),z("keydown",this.keyBinding)):(this.element.classList.remove("pressed"),z("keyup",this.keyBinding)))};var Ve=110,ze={touchUp:new Fe("touchUp",re.up),touchDown:new Fe("touchDown",re.down),touchLeft:new Fe("touchLeft",re.left),touchRight:new Fe("touchRight",re.right),touchJump:new Fe("touchJump",re.up,!0),touchA:new Fe("touchA",re.space,!0),touchB:new Fe("touchB",re.b,!0)},We=[ze.touchJump,ze.touchA,ze.touchB],Ue=Object.keys(ze).map(function(t){return ze[t]});window.addEventListener("load",function(){document.addEventListener("touchmove",rt,{passive:!1}),document.addEventListener("touchstart",rt,{passive:!1}),document.addEventListener("touchend",rt,{passive:!1}),document.addEventListener("scroll",function(t){return t.preventDefault()},{passive:!1}),window.IS_TOUCH_DEVICE="ontouchstart"in window||navigator.maxTouchPoints,window.IS_TOUCH_DEVICE&&document.body.classList.add("touch"),window.navigator.standalone&&document.body.classList.add("nativeFullscreen"),Ue.forEach(function(t){return t.initElement()})}),H(function(){fe.listen("onStart",function(){return st()})}),function(){bt=!1}(),function(t){Ae=Object.assign(Ae,t)}({serverToClientEnabled:!0,clientToServerEnabled:!1,context:"play"}),function(t){te.push(t),Xt&&t(Xt)}(function(t){function e(){var e=t.getChildren("lvl");n>=e.length&&(n=0),e[n].createScene().play()}var n=0;e(),t.listen("levelCompleted",function(){n++,e()})}),J(function(t){t===re.space&&fe&&fe.win()})});
//# sourceMappingURL=openeditplay.min.js.map
