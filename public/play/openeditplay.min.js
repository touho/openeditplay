!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(0,function(){"use strict";function t(t,e){}function e(t){F[t.id]=t}function n(t){return F[t]||null}function r(t){delete F[t]}function o(t){}function i(t,e){if(e.id){var n={type:t,reference:e,id:e.id,external:H,origin:q};t===W.setPropertyValue?n.value=e._value:t===W.move?n.parent=e._parent:t===W.addSerializableToTree&&(n.parent=e._parent,delete n.id);for(var r=0;r<U.length;++r)U[r](n)}}function a(t){if(o("external"),H)return t();H=!0,t(),H=!1}function s(e){t("function"==typeof e),U.push(e)}function p(e){if(e.packedChange)return e.packedChange;var n={};try{e.parent&&(e.parentId=e.parent.id),e.type===W.addSerializableToTree?e.reference?e.value=e.reference.toJSON():t(!1,"invalid change of type addSerializableToTree",e):void 0!==e.value&&(e.value=e.reference.propertyType.type.toJSON(e.value)),Object.keys(B).forEach(function(t){if(void 0!==e[t]){if("type"===t&&e[t]===W.setPropertyValue)return;n[B[t]]=e[t]}})}catch(t){console.log("PACK ERROR",t)}return n}function l(t){var e={packedChange:t};if(Object.keys(t).forEach(function(n){var r=V[n];e[r]=t[n]}),e.type||(e.type=W.setPropertyValue),e.type===W.addSerializableToTree)e.id=e.value.id;else{if(e.reference=n(e.id),!e.reference)return console.error("received a change with unknown id",e,"packed:",t),null;e.id=e.reference.id}return e.parentId&&(e.parent=n(e.parentId)),e}function c(t){var e;a(function(){if(console.log("execute change",t.type,t.id||t.value),t.type===W.setPropertyValue)t.reference.value=t.reference.propertyType.type.fromJSON(t.value);else if(t.type===W.addSerializableToTree)if(t.parent){var n=$.fromJSON(t.value);t.parent.addChild(n),"ent"===n.threeLetterType&&(n.localMaster=!1)}else{var r=$.fromJSON(t.value);"sce"===r.threeLetterType&&(e=r)}else t.type===W.deleteAllChildren?t.reference.deleteChildren():t.type===W.deleteSerializable?t.reference.delete():t.type===W.move&&t.reference.move(t.parent)}),e&&e.play()}function h(t,e){void 0===t&&(t="???"),void 0===e&&(e=16);for(var n=t,r=e-1;r>=0;--r)n+=Z[X()*K|0];return n}function u(e,n,r){for(var o=[],i=arguments.length-3;i-- >0;)o[i]=arguments[i+3];r=r();var a=r.validators.default(),s="",p=[],l=null;return o.forEach(function(e,n){"string"==typeof e?s=e:e&&e.validate?a=e:e&&e.isFlag?p.push(e):e&&e.visibleIf?l=e:t(!1,"invalid parameter "+e+" idx "+n)}),new et(e,r,a,n,s,p,l)}function f(e){var n=e.name;void 0===n&&(n="");var r=e.validators;void 0===r&&(r={default:function(t){return t}});var o=e.toJSON;void 0===o&&(o=function(t){return t});var i=e.fromJSON;void 0===i&&(i=function(t){return t});var a=e.clone;void 0===a&&(a=function(t){return t}),t(n,"name missing from property type"),t("function"==typeof r.default,"default validator missing from property type: "+n),t("function"==typeof o,"invalid toJSON for property type: "+n),t("function"==typeof i,"invalid fromJSON for property type: "+n);var s={name:n,validators:r,toJSON:o,fromJSON:i,clone:a},p=function(){return s};return Object.keys(r).forEach(function(t){p[t]=d(t,r[t]),r[t]=p[t]}),p}function d(t,e){var n=function(){for(var n=arguments.length,r=Array(n);n--;)r[n]=arguments[n];var o=[].concat(r),i=[null].concat(r);return{validatorName:t,validate:function(t){return i[0]=t,e.apply(null,i)},parameters:o}};return n.validatorName=t,n.validate=e,n}function y(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function m(t){var e=t.toString(16);return 1==e.length?"0"+e:e}function v(t,e,n){return"#"+m(t)+m(e)+m(n)}function g(t){if(isNaN(t)||t===1/0||t===-(1/0))throw new Error("Invalid float: "+t)}function _(t,e,n,r){void 0===r&&(r=0);var o,i=t.getParentPrototype();o=i?_(i,e,n,r+1):{};var a=t.getChildren("cda");n&&(a=a.filter(n));for(var s,p=0;p<a.length;++p){s=a[p],o[s.componentId]||(o[s.componentId]={ownComponentData:null,componentClass:s.componentClass,componentId:s.componentId,propertyHash:{},threeLetterType:"icd",generatedForPrototype:e}),0===r&&(o[s.componentId].ownComponentData=s);for(var l=o[s.componentId].propertyHash,c=s.getChildren("prp"),h=void 0,u=0;u<c.length;++u)h=c[u],l[h.name]=0===r?h:h.clone(!0)}return o}function T(t,e){return t.componentClass.componentName.localeCompare(e.componentClass.componentName)}function C(e,n){t(!e._p2World),e._p2World=new mt.World({gravity:[0,9.81]}),e._p2World.sleepMode=mt.World.BODY_SLEEPING}function w(t,e){t._p2World.step(_t,e,10)}function S(t){t._p2World&&t._p2World.clear(),delete t._p2World,delete t._p2Materials}function b(t){return t._p2World}function I(t,e){t._p2World.addBody(e)}function P(t,e){t._p2World.removeBody(e)}function E(t,e){t._p2Materials||(t._p2Materials={});var n=t._p2Materials;e=Object.assign({},Tt,e);var r=[e.friction,e.restitution,e.stiffness,e.relaxation,e.frictionStiffness,e.frictionRelaxation,e.surfaceVelocity].join(";");if(n[r])return n[r];var o=new mt.Material;o.options=e,n[r]=o;for(var i in n){var a=n[i],s=o.options,p=a.options,l=new mt.ContactMaterial(o,a,{friction:Math.min(s.friction,p.friction),restitution:s.restitution*p.restitution,stiffness:Math.min(s.stiffness,p.stiffness),relaxation:(s.relaxation+p.relaxation)/2,frictionStiffness:Math.min(s.frictionStiffness,p.frictionStiffness),frictionRelaxation:(s.frictionRelaxation+p.frictionRelaxation)/2,surfaceVelocity:Math.max(s.surfaceVelocity,p.surfaceVelocity)});t._p2World.addContactMaterial(l)}return o}function N(t){return wt[t]||!1}function x(t){return St.push(t),function(){return St.splice(St.indexOf(t),1)}}function O(t,e){return t.addEventListener("mousemove",function(n){for(var r=n.pageX,o=n.pageY,i=t;null!=i;)r-=i.offsetLeft,o-=i.offsetTop,i=i.offsetParent;t._mx=r,t._my=o,e&&e(new rt(r,o))}),function(){return t.removeEventListener("mousemove",e)}}function A(t,e){return t.addEventListener("mousedown",function(n){"number"==typeof t._mx?e(new rt(t._mx,t._my)):e()}),function(){return t.removeEventListener("mousedown",e)}}function D(t,e){return t.addEventListener("mouseup",function(n){"number"==typeof t._mx?e(new rt(t._mx,t._my)):e()}),function(){return t.removeEventListener("mouseup",e)}}function M(t){return Et||(Et=It.autoDetectRenderer({view:t,autoResize:!0,antialias:!0}),Et.plugins.interaction.destroy()),Et}function L(t,e){return t>e?e:t<-e?-e:t}function J(t,e,n){function r(){i=Date.now(),o=null,n()}if(void 0===e&&(e="soon"),!["instant","soon","next"].includes(e))throw new Error("Invalid callbackLimitMode");var o=null,i=0;return function(a){if(!o){var s=i+t-Date.now();if(s>0)o=setTimeout(r,s);else{o=setTimeout(r,t);var p=a||e;"instant"===p?n():"soon"===p&&setTimeout(n,0)}}}}function k(t){return"sce"===t.reference._rootType}function j(t){for(var e=window.location.search.substring(1),n=e.split("&"),r=0;r<n.length;r++){var o=n[r].split("=");if(decodeURIComponent(o[0])==t)return decodeURIComponent(o[1])}console.log("Query variable %s not found",t)}function R(){if(!window.io)return setTimeout(R,10);Vt=io();var t=[],e={};s(function(r){if(!r.external&&qt&&!k(r)){if(r.type===W.setPropertyValue){var o=e[r.id];o&&t.splice(t.indexOf(o),1),e[r.id]=r}t.push(r),n()}});var n=J(100,"soon",function(){var n=t.map(p);t.length=0,e={},console.log("sending",n),Vt.emit("c",n)});Vt.on("c",function(t){console.log("RECEIVE,",qt),qt&&(console.log("received",t),t.forEach(function(t){(t=l(t))&&c(t)}))}),Vt.on("requestGameId",function(t){ft&&Vt.emit("gameId",ft.id)});var r=Date.now();Vt.on("refreshIfOlderThan",function(t){r<t&&location.reload()}),Vt.on("gameData",function(t){function e(){var t=ft.getChildren("lvl");n>=t.length&&(n=0),t[n].createScene().play()}if(console.log("gameData",t),a(function(){$.fromJSON(t)}),localStorage.openEditPlayGameId=t.id,history.replaceState({},null,"?gameId="+t.id),console.log("replaced with",""+location.origin+location.pathname+"?gameId="+t.id),Ht){var n=0;e(),ft.listen("levelCompleted",function(){n++,e()})}}),setTimeout(function(){var t=j("gameId")||localStorage.openEditPlayGameId;console.log("requestGameData",t),Vt.emit("requestGameData",t)},100)}function z(){if(Ot){var t=Ot.canvas.parentElement;Ot.renderer.resize(t.offsetWidth,t.offsetHeight)}}var F={},W={addSerializableToTree:"a",setPropertyValue:"s",deleteSerializable:"d",move:"m",deleteAllChildren:"c"},B={id:"i",type:"t",value:"v",parentId:"p"},V={};Object.keys(B).forEach(function(t){V[B[t]]=t});var q,H=!1,U=[],G="undefined"!=typeof window,Y="undefined"!=typeof module;if(G&&Y)throw new Error("Can not be client and server at the same time.");var Z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",K=Z.length,X=Math.random,Q=new Map,$=function(t,n){void 0===t&&(t=!1),void 0===n&&(n=!1),this._children=new Map,this._listeners={},this._rootType=this.isRoot?this.threeLetterType:null,n||(this.id=t?t:h(this.threeLetterType),e(this))};$.prototype.delete=function(){return this._parent?(this._parent.deleteChild(this),!1):(this.deleteChildren(),this._alive=!1,this._rootType=null,this._listeners={},r(this.id),this._state|=$.STATE_DESTROY,!0)},$.prototype.deleteChildren=function(){this._children.size&&(this._children.forEach(function(t){t.forEach(function(t){t._parent=null,t.delete()})}),this._children.clear(),this._parent&&i(W.deleteAllChildren,this))},$.prototype.initWithChildren=function(e){return void 0===e&&(e=[]),t(!(this._state&$.STATE_INIT),"init already done"),this._state|=$.STATE_INIT,e.length>0&&this.addChildren(e),this},$.prototype.addChildren=function(t){for(var e=this,n=0;n<t.length;n++)e.addChild(t[n]);return this},$.prototype.addChild=function(t){return this._addChild(t),this._state|=$.STATE_ADDCHILD,this._rootType&&i(W.addSerializableToTree,t),this},$.prototype._addChild=function(e){t(null===e._parent);var n=this._children.get(e.threeLetterType);return void 0===n&&(n=[],this._children.set(e.threeLetterType,n)),n.push(e),e._parent=this,e._state|=$.STATE_ADDPARENT,e._rootType!==this._rootType&&e.setRootType(this._rootType),this},$.prototype.findChild=function(t,e,n){void 0===n&&(n=!1);var r=this._children.get(t);if(!r)return null;if(e){var o=r.find(e);if(o)return o;if(n)for(var i=0;i<r.length;++i){var a=r[i],s=a.findChild(t,e,!0);if(s)return s}return null}return r[0]},$.prototype.findParent=function(t,e){void 0===e&&(e=null);for(var n=this;n;){if(n.threeLetterType===t&&(!e||e(n)))return n;n=n._parent}return null},$.prototype.getRoot=function(){for(var t=this;t._parent;)t=t._parent;return t},$.prototype.deleteChild=function(t,e){return i(W.deleteSerializable,t),this._detachChild(t,e),t.delete(),this},$.prototype._detachChild=function(e,n){void 0===n&&(n=0);var r=this._children.get(e.threeLetterType);return t(r,"child not found"),r[n]!==e&&(n=r.indexOf(e)),t(n>=0,"child not found"),r.splice(n,1),0===r.length&&this._children.delete(e.threeLetterType),e._parent=null,e.setRootType(null),this},$.prototype.forEachChild=function(t,e,n){function r(r){r.forEach(function(r){e(r),n&&r.forEachChild(t,e,!0)})}return void 0===t&&(t=null),void 0===n&&(n=!1),t?r(this._children.get(t)||[]):this._children.forEach(r),this},$.prototype.move=function(t){return t._addChild(this._detach()),i(W.move,this),this},$.prototype._detach=function(){return this._parent&&this._parent._detachChild(this),this},$.prototype.getParent=function(){return this._parent||null},$.prototype.getChildren=function(t){return this._children.get(t)||[]},$.prototype.toJSON=function(){var t=this,e={id:this.id};if(this._children.size>0){var n=[];Array.from(this._children.keys()).sort(function(t,e){return"prt"===t?-1:1}).forEach(function(e){return n.push(t._children.get(e))}),e.c=(r=[]).concat.apply(r,n).map(function(t){return t.toJSON()})}return e;var r},$.prototype.toString=function(){return JSON.stringify(this.toJSON(),null,4)},$.prototype.clone=function(){var t=new this.constructor,e=[];return this.forEachChild(null,function(t){e.push(t.clone())}),t.initWithChildren(e),this._state|=$.STATE_CLONE,t},$.prototype.listen=function(t,e){var n=this;return this._listeners.hasOwnProperty(t)||(this._listeners[t]=[]),this._listeners[t].unshift(e),function(){if(n._alive){var r=n._listeners[t].indexOf(e);n._listeners[t].splice(r,1)}}},$.prototype.dispatch=function(t,e,n,r){if(this._listeners.hasOwnProperty(t))for(var o=this._listeners[t],i=o.length-1;i>=0;--i)o[i](e,n,r)},$.prototype.hasDescendant=function(t){var e=this;if(!t)return!1;for(var n=t._parent;n;){if(n===e)return!0;n=n._parent}return!1},$.prototype.setRootType=function(t){if(this._rootType!==t){this._rootType=t;var e;this._children.forEach(function(n){for(e=0;e<n.length;++e)n[e].setRootType(t)})}},$.prototype.isInTree=function(){return!!this._rootType},$.fromJSON=function e(n){t("string"==typeof n.id&&n.id.length>5,"Invalid id.");var e=Q.get(n.id.substring(0,3));t(e);var r;try{r=e(n)}catch(t){if(G){if(window.force,!window.force)throw new Error}else console.log("Error fromJSON",t);return null}var o=n.c?n.c.map(function(t){return $.fromJSON(t)}).filter(Boolean):[];return r._state&$.STATE_INIT?r.addChildren(o):r.initWithChildren(o),r._state|=$.STATE_FROMJSON,r},$.registerSerializable=function(e,n,r){void 0===r&&(r=null),e.prototype.threeLetterType=n,t("string"==typeof n&&3===n.length),r||(r=function(t){return new e(t.id)}),Q.set(n,r)},$.prototype._parent=null,$.prototype._alive=!0,$.prototype._state=0,$.prototype._rootType=null,$.STATE_INIT=2,$.STATE_ADDCHILD=4,$.STATE_ADDPARENT=8,$.STATE_CLONE=16,$.STATE_DESTROY=32,$.STATE_FROMJSON=64,$.prototype.isRoot=!1,Object.defineProperty($.prototype,"debug",{get:function(){var t=this,e=this.threeLetterType;this._children.forEach(function(n,r){e+="|",e+="prp"===r?t.getChildren("prp").map(function(t){return t.name+"="+t._value}).join(", "):r+"("+n.length+")"}),e+="|state: ";var n=[],r=function(e,r){t._state&e&&n.push(r)};return r($.STATE_INIT,"init"),r($.STATE_ADDCHILD,"add child"),r($.STATE_ADDPARENT,"add parent"),r($.STATE_CLONE,"clone"),r($.STATE_DESTROY,"destroy"),r($.STATE_FROMJSON,"from json"),e+=n.join(", ")}}),Object.defineProperty($.prototype,"debugChildren",{get:function(){function t(t){return new function(){}}var e=[];this._children.forEach(function(t,n){e=e.concat(t)});var n=[];return e.forEach(function(e){var r=t(e.threeLetterType);r.debug=e.debug,r.ref=e;var o=e.debugChildArray;o&&o.length>0&&(r.children=o),n.push(r)}),n}});var tt=function(e){function n(n){var r=n.value,o=n.predefinedId,i=n.name,a=n.propertyType,s=n.skipSerializableRegistering;void 0===s&&(s=!1),t(i,"Property without a name can not exist"),e.call(this,o,s),this._initialValue=r,a?this.setPropertyType(a):(this.name=i,this._initialValueIsJSON=!0)}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.setPropertyType=function(t){this.propertyType=t;try{void 0!==this._initialValue?this.value=this._initialValueIsJSON?t.type.fromJSON(this._initialValue):this._initialValue:this.value=t.initialValue}catch(e){console.log("Invalid value",e,t,this),this.value=t.initialValue}this.name=t.name},n.prototype.clone=function(t){return void 0===t&&(t=!1),new n({value:this.propertyType.type.clone(this.value),name:this.name,propertyType:this.propertyType,skipSerializableRegistering:t})},n.prototype.toJSON=function(){return Object.assign(e.prototype.toJSON.call(this),{v:this.type.toJSON(this.value),n:this.propertyType.name})},n}($);tt.prototype.propertyType=null,Object.defineProperty(tt.prototype,"type",{get:function(){return this.propertyType.type}}),Object.defineProperty(tt.prototype,"value",{set:function(t){this._value=this.propertyType.validator.validate(t),this.dispatch("change",this._value),this._rootType&&i(W.setPropertyValue,this)},get:function(){return this._value}}),$.registerSerializable(tt,"prp",function(t){return new tt({value:t.v,predefinedId:t.id,name:t.n})}),Object.defineProperty(tt.prototype,"debug",{get:function(){return"prp "+this.name+"="+this.value}});var et=function(e,n,r,o,i,a,s){var p=this;void 0===a&&(a=[]),t("string"==typeof e),t(e[0]>="a"&&e[0]<="z","Name of a property must start with lower case letter."),t(n&&"string"==typeof n.name),t(r&&"function"==typeof r.validate),this.name=e,this.type=n,this.validator=r,this.initialValue=o,this.description=i,this.visibleIf=s,this.flags={},a.forEach(function(t){return p.flags[t.type]=t})};et.prototype.getFlag=function(t){return this.flags[t.type]},et.prototype.createProperty=function(t){void 0===t&&(t={});var e=t.value,n=t.predefinedId,r=t.skipSerializableRegistering;return void 0===r&&(r=!1),new tt({propertyType:this,value:e,predefinedId:n,name:this.name,skipSerializableRegistering:r})};var nt=u;nt.visibleIf=function(e,n){return t("string"==typeof e&&e.length),t(void 0!==n),{visibleIf:!0,propertyName:e,values:"string"==typeof n?[n]:n}},u.flagDegreesInEditor=function(t,e){return void 0===e&&(e={}),e.isFlag=!0,e.type=t,e}("degreesInEditor");var rt=function(t,e){this.x=t||0,this.y=e||0};rt.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},rt.prototype.addScalars=function(t,e){return this.x+=t,this.y+=e,this},rt.prototype.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},rt.prototype.subtractScalars=function(t,e){return this.x-=t,this.y-=e,this},rt.prototype.multiply=function(t){return this.x*=t.x,this.y*=t.y,this},rt.prototype.multiplyScalar=function(t){return this.x*=t,this.y*=t,this},rt.prototype.divide=function(t){return this.x/=t.x,this.y/=t.y,this},rt.prototype.divideScalar=function(t){return this.x/=t,this.y/=t,this},rt.prototype.dot=function(t){return this.x*t.x+this.y*t.y},rt.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},rt.prototype.lengthSq=function(){return this.x*this.x+this.y*this.y},rt.prototype.setLength=function(t){var e=this.length();return 0===e?(this.x=t,this.y=0):this.multiplyScalar(t/e),this},rt.prototype.getProjectionOn=function(t){var e=t.length();return 0===e?this.clone():t.clone().multiplyScalar(this.dot(t)/(e*e))},rt.prototype.distance=function(t){var e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)},rt.prototype.distanceSq=function(t){var e=this.x-t.x,n=this.y-t.y;return e*e+n*n},rt.prototype.normalize=function(){return this.setLength(1)},rt.prototype.horizontalAngle=function(){return Math.atan2(this.y,this.x)},rt.prototype.verticalAngle=function(){return Math.atan2(this.x,this.y)},rt.prototype.rotate=function(t){var e=this.x*Math.cos(t)-this.y*Math.sin(t);return this.y=this.x*Math.sin(t)+this.y*Math.cos(t),this.x=e,this},rt.prototype.rotateTo=function(t){return this.rotate(t-this.verticalAngle())},rt.prototype.isEqualTo=function(t){return this.x===t.x&&this.y===t.y},rt.prototype.isZero=function(){return!this.x&&!this.y},rt.prototype.clone=function(){return new rt(this.x,this.y)},rt.prototype.set=function(t){return this.x=t.x,this.y=t.y,this},rt.prototype.toString=function(){return"["+this.x+", "+this.y+"]"},rt.prototype.toArray=function(){return[this.x,this.y]},rt.fromObject=function(t){return new rt(t.x,t.y)},rt.fromArray=function(t){return new rt(t[0],t[1])};var ot=function e(n,r,o){if(n&&n.constructor===e)this.r=n.r,this.g=n.g,this.b=n.b;else if("number"==typeof n)this.r=n,this.g=r,this.b=o;else if("string"==typeof n){var i=y(n);this.r=i.r,this.g=i.g,this.b=i.b}else t(!1,"Invalid Color parameters")};ot.prototype.toHexString=function(){return v(this.r,this.g,this.b)},ot.prototype.toHexNumber=function(){return 256*this.r*256+256*this.g+this.b};var it=Math.pow(10,4);nt.float=f({name:"float",validators:{default:function(t){return t=parseFloat(t),g(t),t},range:function(t,e,n){return t=parseFloat(t),g(t),Math.min(n,Math.max(e,t))},modulo:function(t,e,n){t=parseFloat(t),g(t);var r=n-e;return t<e?t+=(1+((e-t)/r|0))*r:t>n-1e-7&&(t-=(1+((t-n)/r|0))*r),t}},toJSON:function(t){return Math.round(t*it)/it},fromJSON:function(t){return t}}),nt.int=f({name:"int",validators:{default:function(t){return t=parseInt(t),g(t),t},range:function(t,e,n){return t=parseInt(t),g(t),Math.min(n,Math.max(e,t))}},toJSON:function(t){return t},fromJSON:function(t){return t}}),nt.vector=f({name:"vector",validators:{default:function(t){return t=t.clone()}},toJSON:function(t){return{x:Math.round(t.x*it)/it,y:Math.round(t.y*it)/it}},fromJSON:function(t){return rt.fromObject(t)},clone:function(t){return t.clone()}}),nt.string=f({name:"string",validators:{default:function(t){return t?String(t):""}},toJSON:function(t){return t},fromJSON:function(t){return t}}),nt.bool=f({name:"bool",validators:{default:function(t){if("boolean"!=typeof t)throw new Error;return t}},toJSON:function(t){return t?1:0},fromJSON:function(t){return!!t}}),nt.enum=f({name:"enum",validators:{default:function(){t(!1,"also specify enum values with Prop.enum.values('value1', 'value2', ...)")},values:function t(e){for(var t=[],n=arguments.length-1;n-- >0;)t[n]=arguments[n+1];if(!Array.isArray(t))throw new Error;if("string"!=typeof e)throw new Error("val should be string");if(t.indexOf(e)<0)throw new Error("value "+e+" not in enum: ["+t+"]");return e}},toJSON:function(t){return t},fromJSON:function(t){return t}}),nt.color=f({name:"color",validators:{default:function(t){return new ot(t)}},toJSON:function(t){return t.toHexString()},fromJSON:function(t){return new ot(t)}});var at=function(e){function n(n){void 0===n&&(n=!1),t(Array.isArray(this.constructor._propertyTypes),"call PropertyOwner.defineProperties after class definition"),e.call(this,n),this._properties={}}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.initWithPropertyValues=function(e){var n=this;void 0===e&&(e={});var r=[];return Object.keys(e).forEach(function(o){var i=n.constructor._propertyTypesByName[o];t(i,"Invalid property "+o),r.push(i.createProperty({value:e[o]}))}),this.initWithChildren(r),this},n.prototype.initWithChildren=function(n){var r=this;void 0===n&&(n=[]),t(!(this._state&e.STATE_INIT),"init already done"),this._state|=e.STATE_INIT;var o=[],i=[];n.forEach(function(t){"prp"===t.threeLetterType?o.push(t):i.push(t)}),e.prototype.addChildren.call(this,i);var a=0;o.filter(function(t){return!t.propertyType}).forEach(function(t){if(!r.constructor._propertyTypesByName[t.name])return console.log("Property of that name not defined",r.id,t.name,r),a++,void(t.isInvalid=!0);t.setPropertyType(r.constructor._propertyTypesByName[t.name])}),a&&(o=o.filter(function(t){return!t.isInvalid}));var s={};o.forEach(function(t){return s[t.name]=t}),this.constructor._propertyTypes.forEach(function(t){s[t.name]||o.push(t.createProperty())}),e.prototype.addChildren.call(this,o)},n.prototype.addChild=function(n){if(t(this._state&e.STATE_INIT,this.constructor.componentName||this.constructor+" requires that initWithChildren will be called before addChild"),e.prototype.addChild.call(this,n),"prp"===n.threeLetterType){if(!n.propertyType){if(!this.constructor._propertyTypesByName[n.name])return void console.log("Property of that name not defined",this.id,n,this);n.setPropertyType(this.constructor._propertyTypesByName[n.name])}t(void 0===this._properties[n.propertyType.name],"Property already added"),this._properties[n.propertyType.name]=n}},n.prototype.delete=function(){return!!e.prototype.delete.call(this)&&(this._properties={},!0)},n.prototype.deleteChild=function(n,r){t("prp"!==n.threeLetterType,"Can not delete just one Property child."),e.prototype.deleteChild.call(this,n,r)},n}($);at.defineProperties=function(e,n){e._propertyTypes=n,e._propertyTypesByName={},n.forEach(function(n){var r=n.name;t(void 0===e.prototype[r],"Property name "+r+" clashes"),e._propertyTypesByName[r]=n,Object.defineProperty(e.prototype,r,{get:function(){return this._properties[r].value},set:function(t){this._properties[r].value=t}})})};var st=function(e){function n(n,r,o){void 0===r&&(r=!1),void 0===o&&(o=!1),e.call(this,r),this.name=n,this.componentClass=Lt.get(this.name),t(this.componentClass,"Component class not defined: "+n),this.componentClass.allowMultiple||(o="_"+n),this.componentId=o||h("cid",10)}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.addChild=function(t){if("prp"===t.threeLetterType&&!t.propertyType){if(!this.componentClass._propertyTypesByName[t.name])return void(G?console.log("Property of that name not defined",this.id,t,this):console.log("Property of that name not defined",this.id,this.name,t.name));t.setPropertyType(this.componentClass._propertyTypesByName[t.name])}return e.prototype.addChild.call(this,t),this},n.prototype.clone=function(t){var r=!(!t||!t.cloneComponentId)&&this.componentId,o=new n(this.name,!1,r),i=[];return this.forEachChild(null,function(t){i.push(t.clone())}),o.initWithChildren(i),this._state|=e.STATE_CLONE,o},n.prototype.toJSON=function(){return Object.assign(e.prototype.toJSON.call(this),{cid:this.componentId,n:this.name})},n.prototype.getInheritedProperties=function(t){void 0===t&&(t=0);var e={},n=this.getParentComponentData();return n&&n.getInheritedProperties(t+1).forEach(function(t){return e[t.name]=t}),this.getChildren("prp").forEach(function(n){e[n.name]=0===t?n:n.clone(!0)}),0===t?this.componentClass._propertyTypes.map(function(t){return e[t.name]||t.createProperty({skipSerializableRegistering:!0})}):Object.keys(e).map(function(t){return e[t]})},n.prototype.getParentComponentData=function(){var t=this;if(!this._parent)return null;for(var e=this._parent.getParentPrototype();e;){var n=e.findChild("cda",function(e){return e.componentId===t.componentId});if(n)return n;e=e.getParentPrototype()}return null},n.prototype.getPropertyOrCreate=function(t){var e=this.findChild("prp",function(e){return e.name===t});return e||(e=this.componentClass._propertyTypesByName[t].createProperty(),this.addChild(e)),e},n.prototype.getProperty=function(t){return this.findChild("prp",function(e){return e.name===t})},n.prototype.setValue=function(t,e){return this.getPropertyOrCreate(t).value=e,this},n.prototype.getValue=function(t){var e=this.getProperty(t);if(e)return e.value;var n=this.getParentComponentData();return n?n.getValue(t):this.componentClass._propertyTypesByName[t].initialValue},n.prototype.createComponent=function(){var t=this.getInheritedProperties(),e={};t.forEach(function(t){e[t.name]=t.value});var n=kt.create(this.name,e);return n._componentId=this.componentId,n},n}($);$.registerSerializable(st,"cda",function(t){return new st(t.n,t.id,t.cid)});var pt="entity is already dead",lt=function(e){function n(t){void 0===t&&(t=!1),e.call(this,t),this.components=new Map,this.sleeping=!1,this.prototype=null,this.localMaster=!0}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.getComponent=function(e){t(this._alive,pt);var n=this.components.get(e);return void 0!==n?n[0]:null},n.prototype.getComponents=function(e){return t(this._alive,pt),this.components.get(e)||[]},n.prototype.getListOfAllComponents=function(){var t=[];return this.components.forEach(function(e,n){t.push.apply(t,e)}),t},n.prototype.clone=function(){var t=new n;t.prototype=this.prototype.clone(),t.sleeping=this.sleeping;var e=[];return this.components.forEach(function(t,n){e.push.apply(e,t.map(function(t){return t.clone()}))}),t.addComponents(e),t},n.prototype.addComponents=function(e){var r=this;t(this._alive,pt),t(Array.isArray(e),"Parameter is not an array.");for(var o=0;o<e.length;o++){var i=e[o];(r.components.get(i._name)||r.components.set(i._name,[]).get(i._name)).push(i),i.entity=r,i._parent=r,i.setRootType(r._rootType)}return this.sleeping||n.initComponents(e),this},n.initComponents=function(t){for(var e=0;e<t.length;e++)t[e]._preInit();for(var n=0;n<t.length;n++)t[n]._init()},n.makeComponentsSleep=function(t){for(var e=0;e<t.length;e++)t[e]._sleep()},n.deleteComponents=function(t){for(var e=0;e<t.length;e++)t[e].delete()},n.prototype.sleep=function(){return t(this._alive,pt),!this.sleeping&&(this.components.forEach(function(t,e){return n.makeComponentsSleep(t)}),this.sleeping=!0,!0)},n.prototype.wakeUp=function(){return t(this._alive,pt),!!this.sleeping&&(this.components.forEach(function(t,e){return n.initComponents(t)}),this.sleeping=!1,!0)},n.prototype.delete=function(){return t(this._alive,pt),this.sleep(),!!e.prototype.delete.call(this)&&(this.components.forEach(function(t,e){return n.deleteComponents(t)}),this.components.clear(),!0)},n.prototype.deleteComponent=function(e){var n=this.getComponents(e.constructor.componentName),r=n.indexOf(e);return t(r>=0),this.sleeping||e._sleep(),e.delete(),n.splice(r,1),this},n.prototype.setRootType=function(t){if(this._rootType!==t){this._rootType=t;var e;this.components.forEach(function(n,r){for(e=0;e<n.length;++e)n[e].setRootType(t)})}},n.prototype.toJSON=function(){t(this._alive,pt);var n=[];return this.components.forEach(function(t){t.forEach(function(t){n.push(t.toJSON())})}),Object.assign(e.prototype.toJSON.call(this),{comp:n,proto:this.prototype.id})},n}($);Object.defineProperty(lt.prototype,"position",{get:function(){return this.getComponent("Transform").position},set:function(t){this.getComponent("Transform").position=t}}),$.registerSerializable(lt,"ent",function(t){console.log("creating entity from json",t);var e=new lt(t.id);return e.prototype=getSerializable(t.proto),console.log("created entity from json",e),t.comp&&e.addComponents(t.comp.map($.fromJSON)),e});var ct=[u("name","No name",u.string)],ht=function(e){function n(){e.apply(this,arguments),this.previouslyCreatedEntity=null}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.addChild=function(n){"cda"!==n.threeLetterType||n.componentClass.allowMultiple||t(null===this.findChild("cda",function(t){return t.componentId===n.componentId}),"Can't have multiple "+n.name+" components. See Component.allowMultiple"),e.prototype.addChild.call(this,n)},n.prototype.getParentPrototype=function(){return this._parent&&"prt"===this._parent.threeLetterType?this._parent:null},n.prototype.getInheritedComponentDatas=function(t){void 0===t&&(t=null);for(var e,n=_(this,this,t),r=Object.keys(n).map(function(t){return n[t]}),o=0;o<r.length;++o)e=r[o],e.properties=e.componentClass._propertyTypes.map(function(t){return e.propertyHash[t.name]||t.createProperty({skipSerializableRegistering:!0})}),delete e.propertyHash;return r.sort(T)},n.prototype.createAndAddPropertyForComponentData=function(e,n,r){var o=e.componentClass._propertyTypesByName[n];t(o,"Invalid propertyName",n,e);var i=this.findChild("cda",function(t){return t.componentId===e.componentId}),a=!1;i||(console.log("no component data. create one",this,e),i=new st(e.componentClass.componentName,!1,e.componentId),a=!0);var s=i.findChild("prp",function(t){return t.name===n});return s?(s.value=r,s):(s=o.createProperty({value:r}),i.addChild(s),a&&this.addChild(i),s)},n.prototype.findComponentDataByComponentId=function(t,e){void 0===e&&(e=!1);var n=this.findChild("cda",function(e){return e.componentId===t});if(n)return n;if(e){var r=this.getParentPrototype();if(r)return r.findComponentDataByComponentId(t,e)}return null},n.prototype.getOwnComponentDataOrInherit=function(t){var e=this.findComponentDataByComponentId(t,!1);if(!e){var n=this.findComponentDataByComponentId(t,!0);if(!n)return null;e=new st(n.name,!1,t),this.addChild(e)}return e},n.prototype.findOwnProperty=function(t,e){var n=this.findComponentDataByComponentId(t);return n?n.getProperty(e):null},n.prototype.createEntity=function(){var t=new lt,e=this.getInheritedComponentDatas(),n=e.map(kt.createWithInheritedComponentData);return t.addComponents(n),t.prototype=this,this.previouslyCreatedEntity=t,t},n.prototype.getValue=function(t,e){var n=this.findComponentDataByComponentId(t,!0);return n?n.getValue(e):void 0},n.prototype.countEntityPrototypes=function(t){var e=this;if(void 0===t&&(t=!1),"prt"!==this.threeLetterType)return 0;for(var n=0,r=ft.getChildren("lvl"),o=r.length-1;o>=0;o--)for(var i=r[o].getChildren("epr"),a=i.length-1;a>=0;a--)i[a].prototype===e&&n++;return t&&this.forEachChild("prt",function(t){return n+=t.countEntityPrototypes(!0)}),n},n.prototype.delete=function(){
var t=this;return this._gameRoot=this._gameRoot||this.getRoot(),!!e.prototype.delete.call(this)&&("prt"===this.threeLetterType&&"gam"===this._gameRoot.threeLetterType&&this._gameRoot.forEachChild("lvl",function(e){for(var n=e.getChildren("epr"),r=n.length-1;r>=0;r--)n[r].prototype===t&&e.deleteChild(n[r],r)}),this.previouslyCreatedEntity=null,!0)},n}(at);at.defineProperties(ht,ct),ht.create=function(t){return(new ht).initWithPropertyValues({name:t})},$.registerSerializable(ht,"prt");var ut=[u("name","No name",u.string)],ft=null,dt="undefined"!=typeof window,yt=function(t){function e(e){if(dt&&ft)try{ft.delete()}catch(t){console.warn("Deleting old game failed",t)}t.apply(this,arguments),dt&&(ft=this),vt.forEach(function(t){return t()})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.initWithChildren=function(){t.prototype.initWithChildren.apply(this,arguments),i(W.addSerializableToTree,this)},e.prototype.delete=function(){return!!t.prototype.delete.call(this)&&(ft===this&&(ft=null),console.log("game.delete"),!0)},e}(at);at.defineProperties(yt,ut),yt.prototype.isRoot=!0,$.registerSerializable(yt,"gam");var mt,vt=[];mt=G?window.p2:require("../src/external/p2");var gt=mt,_t=1/60,Tt={friction:.3,restitution:0,stiffness:1e6,relaxation:3,frictionStiffness:1e6,frictionRelaxation:4,surfaceVelocity:0},Ct={left:37,right:39,up:38,down:40,ctrl:17,appleLeft:91,appleRight:93,alt:18,shift:16,space:32,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,backspace:8,enter:13,esc:27},wt={},St=[],bt=[];"undefined"!=typeof window&&(window.onkeydown=function(t){var e=t.which||t.keyCode;"input"==document.activeElement.nodeName.toLowerCase()&&e!==Ct.esc||wt[e]||(wt[e]=!0,St.forEach(function(t){return t(e)}))},window.onkeyup=function(t){var e=t.which||t.keyCode;wt[e]=!1,bt.forEach(function(t){return t(e)})});var It;G&&(It=window.PIXI,It.ticker.shared.stop());var Pt=It,Et=null;G?window.performance:Date.now;for(var Nt=[],xt=0;xt<480;++xt)Nt.push(0);var Ot=null,At={enableSleeping:!0},Dt=function(e){function n(t){function n(){var t=new Pt.Container;return o.stage.addChild(t),t}var r=this;if(void 0===t&&(t=!1),e.call(this,t),G){if(Ot)try{Ot.delete()}catch(t){console.warn("Deleting old scene failed",t)}Ot=this,this.canvas=document.querySelector("canvas.openEditPlayCanvas"),this.renderer=M(this.canvas),this.stage=new Pt.Container;var o=this;this.backgroundLayer=n(),this.behindLayer=n(),this.mainLayer=n(),this.frontLayer=n(),this.UILayer=n(),this.mouseListeners=[O(this.canvas,function(t){return r.dispatch("onMouseMove",t)}),A(this.canvas,function(t){return r.dispatch("onMouseDown",t)}),D(this.canvas,function(t){return r.dispatch("onMouseUp",t)})]}this.level=null,this.components=new Map,this.animationFrameId=null,this.playing=!1,this.time=0,this.won=!1,i(W.addSerializableToTree,this),C(this,At),this.draw(),Mt.forEach(function(t){return t()})}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.win=function(){this.won=!0},n.prototype.animFrame=function(){if(this.animationFrameId=null,this._alive&&this.playing){var t=performance.now(),e=.001*t,n=e-this._prevUpdate;n>.05&&(n=.05),this._prevUpdate=e,this.time+=n,o(this),this.dispatch("onUpdate",n,this.time),w(this,n),this.draw(),this.won&&(this.pause(),this.time=0,ft.dispatch("levelCompleted"),this.reset()),this.requestAnimFrame()}},n.prototype.requestAnimFrame=function(){var t=this,e=function(){return t.animFrame()};window.requestAnimationFrame?this.animationFrameId=window.requestAnimationFrame(e):this.animationFrameId=setTimeout(e,16)},n.prototype.draw=function(){this.renderer.render(this.stage,null,!0)},n.prototype.isInInitialState=function(){return!this.playing&&0===this.time},n.prototype.reset=function(){this._alive&&(this.resetting=!0,this.pause(),this.deleteChildren(),S(this),C(this,At),this.won=!1,this.time=0,this.level&&this.level.createScene(this),this.draw(),delete this.resetting,this.dispatch("reset"))},n.prototype.pause=function(){this.playing&&(this.playing=!1,this.animationFrameId&&(window.requestAnimationFrame?window.cancelAnimationFrame(this.animationFrameId):clearTimeout(this.animationFrameId)),this.animationFrameId=null,this.dispatch("pause"))},n.prototype.play=function(){this.playing||(this._prevUpdate=.001*performance.now(),this.playing=!0,this.requestAnimFrame(),0===this.time&&this.dispatch("onStart"),this.dispatch("play"))},n.prototype.delete=function(){return!!e.prototype.delete.call(this)&&(S(this),Ot===this&&(Ot=null),this.mouseListeners&&(this.mouseListeners.forEach(function(t){return t()}),this.mouseListeners=null),this.renderer=null,this.stage.destroy(),this.stage=null,console.log("scene.delete"),!0)},n.prototype.addComponent=function(t){var e=this.components.get(t.constructor.componentName);e||(e=new Set,this.components.set(t.constructor.componentName,e)),e.add(t)},n.prototype.removeComponent=function(e){var n=this.components.get(e.constructor.componentName);t(n),t(n.delete(e))},n.prototype.getComponents=function(t){return this.components.get(t)||new Set},n}($);Dt.prototype.isRoot=!0,$.registerSerializable(Dt,"sce");var Mt=[],Lt=new Map,Jt=["onUpdate","onDraw","onStart"],kt=function(e){function n(t){void 0===t&&(t=!1),e.call(this,t),this._componentId=null,this.scene=Ot,this.game=ft,this._listenRemoveFunctions=[],this.entity=null}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.delete=function(){return this._parent=null,this.entity=null,e.prototype.delete.call(this),!0},n.prototype._addEventListener=function(t){var e=this[t],n=this;n.constructor.componentName;this._listenRemoveFunctions.push(this.scene.listen(t,function(){e.apply(n,arguments)}))},n.prototype._preInit=function(){var e=this;this.constructor.requirements.forEach(function(n){e[n]=e.entity.getComponent(n),t(e[n],e.constructor.componentName+" requires component "+n+" but it is not found")}),this.forEachChild("com",function(t){return t._preInit()});for(var n=0;n<Jt.length;++n)"function"==typeof e[Jt[n]]&&e._addEventListener(Jt[n]);"Transform"!==this.constructor.componentName&&this.scene&&this.scene.addComponent(this);try{"function"==typeof this.preInit&&this.preInit()}catch(t){console.error(this.entity,this.constructor.componentName,"preInit",t)}},n.prototype._init=function(){this.forEachChild("com",function(t){return t._init()});try{"function"==typeof this.init&&this.init()}catch(t){console.error(this.entity,this.constructor.componentName,"init",t)}},n.prototype._sleep=function(){try{"function"==typeof this.sleep&&this.sleep()}catch(t){console.error(this.entity,this.constructor.componentName,"sleep",t)}"Transform"!==this.constructor.componentName&&this.scene&&this.scene.removeComponent(this),this.forEachChild("com",function(t){return t._sleep()}),this._listenRemoveFunctions.forEach(function(t){return t()}),this._listenRemoveFunctions.length=0},n.prototype.listenProperty=function(t,e,n){this._listenRemoveFunctions.push(t._properties[e].listen("change",n))},n.prototype.createComponentData=function(){var t=this,e=this.constructor.componentName,n=this.constructor._propertyTypes,r=new st(e),o=[];return n.forEach(function(e){o.push(e.createProperty({value:t[e.name]}))}),r.initWithChildren(o),r},n.prototype.toJSON=function(){return Object.assign(e.prototype.toJSON.call(this),{n:this.constructor.componentName,cid:this._componentId})},n}(at);kt.create=function(e,n){void 0===n&&(n={});var r=Lt.get(e);t(r);var o=new r;return o.initWithPropertyValues(n),o},kt.createWithInheritedComponentData=function(t){var e=new t.componentClass;e._componentId=t.componentId;var n=t.properties.map(function(t){return t.clone()});return e.initWithChildren(n),e},kt.reservedPropertyNames=new Set(["id","constructor","delete","children","entity","env","init","preInit","sleep","toJSON","fromJSON"]),kt.reservedPrototypeMembers=new Set(["id","children","entity","env","_preInit","_init","_sleep","_forEachChildComponent","_properties","_componentData","toJSON","fromJSON"]),kt.register=function(e){var n=e.name;void 0===n&&(n="");var r=e.description;void 0===r&&(r="");var o=e.category;void 0===o&&(o="Other");var i=e.icon;void 0===i&&(i="fa-puzzle-piece");var a=e.color;void 0===a&&(a="");var s=e.properties;void 0===s&&(s=[]);var p=e.requirements;void 0===p&&(p=["Transform"]);var l=e.children;void 0===l&&(l=[]);var c=e.parentClass;void 0===c&&(c=kt);var h=e.prototype;void 0===h&&(h={});var u=e.allowMultiple;void 0===u&&(u=!0);var f=e.requiesInitWhenEntityIsEdited;void 0===f&&(f=!1),t(n,"Component must have a name."),t(n[0]>="A"&&n[0]<="Z","Component name must start with capital letter."),t(!Lt.has(n),"Duplicate component class "+n),Object.keys(h).forEach(function(e){kt.reservedPrototypeMembers.has(e)&&t(!1,"Component prototype can not have a reserved member: "+e)});var d=h.constructor,y=h.delete;delete h.constructor,delete h.delete;var m=function(t){function e(){t.apply(this,arguments),d&&d.call(this)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.delete=function(){return!!t.prototype.delete.call(this)&&(y&&y.call(this),!0)},e}(c);s.forEach(function(e){t(!kt.reservedPropertyNames.has(e.name),"Can not have property called "+e.name)}),at.defineProperties(m,s),m.componentName=n,m.category=o,p.indexOf("Transform")<0&&p.push("Transform"),m.requirements=p,m.children=l,m.description=r,m.allowMultiple=u,m.icon=i;var v=n.split("").reduce(function(t,e){return t+e.charCodeAt(0)},0);return m.color=a||"hsla("+v%360+", 40%, 60%, 1)",h._name=n,Object.assign(m.prototype,h),Lt.set(m.componentName,m),m},$.registerSerializable(kt,"com",function(t){var e=new(Lt.get(t.n))(t.id);return e._componentId=t.cid||null,e});var jt=function(t){function e(e){void 0===e&&(e=!1),t.apply(this,arguments),this.prototype=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getTransform=function(){return this.findChild("cda",function(t){return"Transform"===t.name})},e.prototype.getParentPrototype=function(){return this.prototype},e.prototype.clone=function(){var t=this,n=new e;n.prototype=this.prototype;var r=n.id,o=[];return this.forEachChild(null,function(e){if("prp"===e.threeLetterType&&"name"===e.name){var n=new tt({value:e.propertyType.type.clone(e.value),name:e.name,propertyType:t.propertyType,predefinedId:r+"_n"});o.push(n)}else if("cda"===e.threeLetterType&&"Transform"===e.name){var i=new st("Transform",r+"_t"),a=i.componentClass._propertyTypesByName.position.createProperty({value:e.findChild("prp",function(t){return"position"===t.name}).value,predefinedId:r+"_p"});i.addChild(a);var s=i.componentClass._propertyTypesByName.scale.createProperty({value:e.findChild("prp",function(t){return"scale"===t.name}).value,predefinedId:r+"_s"});i.addChild(s);var p=i.componentClass._propertyTypesByName.angle.createProperty({value:e.findChild("prp",function(t){return"angle"===t.name}).value,predefinedId:r+"_r"});i.addChild(p),o.push(i)}else"cda"===e.threeLetterType?o.push(e.clone({cloneComponentId:!0})):o.push(e.clone())}),n.initWithChildren(o),this._state|=$.STATE_CLONE,n},e.prototype.toJSON=function(){var t=this,e=this.getTransform(),n={id:this.id,p:this.prototype.id},r=[];this._children.forEach(function(t){r.push(t)});var o=(s=[]).concat.apply(s,r).filter(function(n){return n!==e&&n!==t._properties.name});o.length>0&&(n.c=o.map(function(t){return t.toJSON()}));var i=u.float().toJSON,a=function(t){"name"===t.name?t.value&&(n.n=t.value):"position"===t.name?(n.x=i(t.value.x),n.y=i(t.value.y)):"scale"===t.name?t.value.isEqualTo(new rt(1,1))||(n.w=i(t.value.x),n.h=i(t.value.y)):"angle"===t.name&&0!==t.value&&(n.a=i(t.value))};return a(this._properties.name),e.getChildren("prp").forEach(a),n;var s},e.prototype.spawnEntityToScene=function(t){if(Ot){t&&(this.getTransform().getPropertyOrCreate("position").value=t);var e=this.createEntity();Ot.addChild(e)}},e}(ht);Object.defineProperty(jt.prototype,"position",{get:function(){return this.getTransform().findChild("prp",function(t){return"position"===t.name}).value},set:function(t){return this.getTransform().findChild("prp",function(t){return"position"===t.name}).value=t}}),jt.createFromPrototype=function(e,n){void 0===n&&(n=[]);var r=new jt;r.prototype=e;var o=r.id;t(!n.find(function(t){return"Transform"===t.name}),"Prototype (prt) can not have a Transform component");var i=new st("Transform",o+"_t");n.push(i);var a=i.componentClass._propertyTypesByName.position.createProperty({value:new rt(0,0),predefinedId:o+"_p"});i.addChild(a);var s=i.componentClass._propertyTypesByName.scale.createProperty({value:new rt(1,1),predefinedId:o+"_s"});i.addChild(s);var p=i.componentClass._propertyTypesByName.angle.createProperty({value:0,predefinedId:o+"_r"});i.addChild(p);var l=jt._propertyTypesByName.name.createProperty({value:"",predefinedId:o+"_n"});return r.initWithChildren([l].concat(n)),r},$.registerSerializable(jt,"epr",function(e){var r=new jt(e.id);r.prototype=n(e.p),t(r.prototype,"Prototype "+e.p+" not found");var o=e.id+"_n",i=e.id+"_t",a=e.id+"_p",s=e.id+"_s",p=e.id+"_r",l=ht._propertyTypesByName.name.createProperty({value:void 0===e.n?"":e.n,predefinedId:o}),c=new st("Transform",i),h=Lt.get("Transform"),u=h._propertyTypesByName.position.createProperty({value:new rt(e.x,e.y),predefinedId:a});c.addChild(u);var f=h._propertyTypesByName.scale.createProperty({value:new rt(void 0===e.w?1:e.w,void 0===e.h?1:e.h),predefinedId:s});c.addChild(f);var d=h._propertyTypesByName.angle.createProperty({value:e.a||0,predefinedId:p});return c.addChild(d),r.initWithChildren([l,c]),r});var Rt=[u("name","No name",u.string)],zt=function(t){function e(e){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.createScene=function(t){void 0===t&&(t=!1),t||new Dt;var e=this.getChildren("epr").map(function(t){return t.createEntity()});return Ot.addChildren(e),Ot.level=this,Ot},e.prototype.isEmpty=function(){return 0===this.getChildren("epr").length},e}(at);at.defineProperties(zt,Rt),$.registerSerializable(zt,"lvl"),kt.register({name:"Transform",category:"Core",icon:"fa-dot-circle-o",allowMultiple:!1,properties:[u("position",new rt(0,0),u.vector),u("scale",new rt(1,1),u.vector),u("angle",0,u.float,u.float.modulo(0,2*Math.PI),u.flagDegreesInEditor)]}),kt.register({name:"TransformVariance",category:"Core",icon:"fa-dot-circle-o",allowMultiple:!1,properties:[u("positionVariance",new rt(0,0),u.vector),u("scaleVariance",new rt(0,0),u.vector),u("angleVariance",0,u.float,u.float.range(0,Math.PI),u.flagDegreesInEditor)],prototype:{onStart:function(){this.positionVariance.isZero()||(this.Transform.position=this.Transform.position.add(this.positionVariance.clone().multiplyScalar(-1+2*Math.random()))),this.scaleVariance.isZero()||(this.Transform.scale=this.Transform.scale.add(this.scaleVariance.clone().multiplyScalar(-1+2*Math.random()))),this.angleVariance&&(this.Transform.angle+=this.angleVariance*(-1+2*Math.random()))}}}),kt.register({name:"Mover",properties:[u("change",new rt(10,10),u.vector),u("userControlled",!1,u.bool),u("speed",1,u.float),u("rotationSpeed",0,u.float,"Degrees per second",u.flagDegreesInEditor)],prototype:{init:function(){this.Physics=this.entity.getComponent("Physics")},onUpdate:function(t,e){if(this._rootType)if(this.userControlled){if(!this.entity.localMaster)return;var n=0,r=0;if(N(Ct.left)&&(n-=1),N(Ct.right)&&(n+=1),N(Ct.up)&&(r-=1),N(Ct.down)&&(r+=1),this.Physics){if(n||r){var o=new rt(n*this.Physics.getMass()*this.speed*t,r*this.Physics.getMass()*this.speed*t);this.Physics.applyForce(o)}n&&this.rotationSpeed&&this.Physics.setAngularForce(n*this.rotationSpeed*t)}else n&&(this.Transform.position.x+=n*this.speed*t),r&&(this.Transform.position.y+=r*this.speed*t),(n||r)&&(this.Transform.position=this.Transform.position),n&&this.rotationSpeed&&(this.Transform.angle+=t*n*this.rotationSpeed)}else{var i=new rt(t,0).rotate(e*this.speed).multiply(this.change);this.Transform.position.set(this.Transform.position).add(i),this.rotationSpeed&&(this.Transform.angle+=t*this.rotationSpeed)}}}}),kt.register({name:"Shape",icon:"fa-stop",allowMultiple:!0,properties:[u("type","rectangle",u.enum,u.enum.values("rectangle","circle","convex")),u("radius",10,u.float,u.visibleIf("type",["circle","convex"])),u("size",new rt(10,10),u.vector,u.visibleIf("type","rectangle")),u("points",3,u.int,u.int.range(3,16),u.visibleIf("type","convex")),u("topPointDistance",.5,u.float,u.float.range(.001,1),u.visibleIf("type","convex"),"Only works with at most 8 points"),u("fillColor",new ot(255,255,255),u.color),u("borderColor",new ot(255,255,255),u.color),u("borderWidth",1,u.float)],prototype:{init:function(){var t=this;this.createGraphics(),this.listenProperty(this.Transform,"position",function(e){t.graphics.x=e.x,t.graphics.y=e.y}),this.listenProperty(this.Transform,"angle",function(e){t.graphics.rotation=e});var e=function(){t.graphics&&t.drawGraphics()};this.listenProperty(this.Transform,"scale",e),["type","radius","size","fillColor","borderColor","borderWidth","points","topPointDistance"].forEach(function(n){t.listenProperty(t,n,e)})},createGraphics:function(){this.graphics=new Pt.Graphics,this.drawGraphics(),this.scene.mainLayer.addChild(this.graphics);var t=this.Transform;this.graphics.x=t.position.x,this.graphics.y=t.position.y,this.graphics.rotation=t.angle},drawGraphics:function(){var t=this.Transform.scale;if(this.graphics.clear(),"rectangle"===this.type){var e=-this.size.x/2*t.x,n=-this.size.y/2*t.y,r=this.size.x*t.x,o=this.size.y*t.y;this.graphics.lineStyle(this.borderWidth,this.borderColor.toHexNumber(),1),this.graphics.beginFill(this.fillColor.toHexNumber()),this.graphics.drawRect(e,n,r,o),this.graphics.endFill()}else if("circle"===this.type){var i=(t.x+t.y)/2;this.graphics.lineStyle(this.borderWidth,this.borderColor.toHexNumber(),1),this.graphics.beginFill(this.fillColor.toHexNumber()),this.graphics.drawCircle(0,0,this.radius*i),this.graphics.endFill()}else if("convex"===this.type){var a=this.getConvexPoints(Pt.Point);a.push(a[0]),this.graphics.lineStyle(this.borderWidth,this.borderColor.toHexNumber(),1),this.graphics.beginFill(this.fillColor.toHexNumber()),this.graphics.drawPolygon(a),this.graphics.endFill()}},getConvexPoints:function(t){var e=this;void 0===t&&(t=rt);var n,r,o=2*Math.PI/this.points,i=.5!==this.topPointDistance&&this.points<=8;if(i){var a=Math.PI-o,s=2*Math.sin(o/2),p=1-s*Math.cos(a/2);3===this.points?(n=.2,r=5):8===this.points?(n=p,r=3):(n=p,r=5)}for(var l=[],c=0,h=0;h<this.points;++h){var u=Math.sin(c)*e.radius,f=Math.cos(c)*e.radius;i&&0===h&&(f*=e.topPointDistance>.5?1+(e.topPointDistance-.5)*(r-1):2*e.topPointDistance*(1-n)+n),l.push(new t(u,-f)),c+=o}if(i){var d=l.reduce(function(t,e){return t+e.y},0)/this.points;l.forEach(function(t){return t.y-=d})}var y=this.Transform.scale;return 1===y.x&&1===y.y||l.forEach(function(t){t.x*=y.x,t.y*=y.y}),l},sleep:function(){this.graphics.destroy(),this.graphics=null}}}),kt.register({name:"Spawner",properties:[u("typeName","",u.string),u("trigger","start",u.enum,u.enum.values("start","interval")),u("interval",10,u.float,u.float.range(.1,1e6),u.visibleIf("trigger","interval"),"Interval in seconds")],prototype:{constructor:function(){this.lastSpawn=0},init:function(){this.lastSpawn=this.scene.time},onStart:function(){"start"===this.trigger&&this.spawn()},onUpdate:function(){this.scene.time>this.lastSpawn+this.interval&&this.spawn()},onDrawHelper:function(t){this.Transform.position.x,this.Transform.scale.x,this.Transform.position.y,this.Transform.scale.y,this.Transform.scale.x,this.Transform.scale.y;t.save(),t.fillStyle="blue",t.strokeStyle="white",t.lineWidth=1,t.font="40px FontAwesome",t.textAlign="center",t.fillText("",this.Transform.position.x+2,this.Transform.position.y),t.strokeText("",this.Transform.position.x+2,this.Transform.position.y),t.restore()},spawn:function(){var t=this,e=this.game.findChild("prt",function(e){return e.name===t.typeName},!0);e&&(jt.createFromPrototype(e).spawnEntityToScene(this.Transform.position),this.lastSpawn=this.scene.time)}}}),kt.register({name:"Trigger",allowMultiple:!0,properties:[u("trigger","playerComesNear",u.enum,u.enum.values("playerComesNear")),u("radius",40,u.float,u.float.range(0,1e3),u.visibleIf("trigger","playerComesNear")),u("action","win",u.enum,u.enum.values("win"))],prototype:{onDrawHelper:function(t){this.Transform.position.x,this.Transform.scale.x,this.Transform.position.y,this.Transform.scale.y,this.Transform.scale.x,this.Transform.scale.y;t.save(),t.fillStyle="blue",t.strokeStyle="white",t.lineWidth=1,t.font="40px FontAwesome",t.textAlign="center",t.fillText("",this.Transform.position.x,this.Transform.position.y+15),t.strokeText("",this.Transform.position.x,this.Transform.position.y+15),t.restore()},preInit:function(){this.storeProp="__Trigger_"+this._componentId},onUpdate:function(){var t=this;if("playerComesNear"===this.trigger){var e=this.scene.getComponents("Mover"),n=[];e.forEach(function(t){return n.push(t.entity)});for(var r=this.radius*this.radius,o=this.Transform.position,i=0;i<n.length;++i)if(n[i].position.distanceSq(o)<r){if(!n[i][t.storeProp]&&t.launchTrigger(n[i])!==!1)break;n[i][t.storeProp]=!0}else n[i][t.storeProp]=!1}},launchTrigger:function(t){return"win"===this.action&&(console.log("will win"),this.scene.win(),!1)}}});var Ft={dynamic:gt.Body.DYNAMIC,kinematic:gt.Body.KINEMATIC,static:gt.Body.STATIC},Wt=gt.Body.SLEEPING,Bt=gt.Body.STATIC;kt.register({name:"Physics",icon:"fa-stop",allowMultiple:!1,properties:[u("type","dynamic",u.enum,u.enum.values("dynamic","static")),u("density",1,u.float,u.float.range(0,100),u.visibleIf("type","dynamic")),u("drag",.1,u.float,u.float.range(0,1),u.visibleIf("type","dynamic")),u("rotationalDrag",.1,u.float,u.float.range(0,1),u.visibleIf("type","dynamic")),u("bounciness",0,u.float,u.float.range(0,1)),u("friction",.1,u.float,u.float.range(0,1))],requirements:["Shape"],requiesInitWhenEntityIsEdited:!0,prototype:{inited:!1,init:function(){var t=this;this.inited=!0;for(var e=function(e){return function(n){!t.updatingOthers&&t.body&&(e(n),"dynamic"===t.type&&t.body.wakeUp())}},n=this.entity.getComponents("Shape"),r=["type","size","radius","points","topPointDistance"],o=0;o<n.length;++o)!function(o){r.forEach(function(r){t.listenProperty(n[o],r,e(function(){return t.updateShape()}))})}(o);this.listenProperty(this.Transform,"position",e(function(e){return t.body.position=e.toArray().map(function(t){return.02*t})})),this.listenProperty(this.Transform,"angle",e(function(e){return t.body.angle=e})),this.listenProperty(this.Transform,"scale",e(function(e){return t.updateShape()})),this.listenProperty(this,"density",e(function(e){t.body.setDensity(.1*e)})),this.listenProperty(this,"friction",e(function(e){return t.updateMaterial()})),this.listenProperty(this,"drag",e(function(e){return t.body.damping=e})),this.listenProperty(this,"rotationalDrag",e(function(e){t.body.angularDamping=e>.98?1:e,t.body.fixedRotation=1===e,t.body.updateMassProperties()})),this.listenProperty(this,"type",e(function(e){t.body.type=e[t.type],t.entity.sleep(),t.entity.wakeUp()})),this.listenProperty(this,"bounciness",e(function(e){return t.updateMaterial()})),this._rootType&&this.createBody()},createBody:function(){t(!this.body),this.body=new gt.Body({type:Ft[this.type],position:[.02*this.Transform.position.x,.02*this.Transform.position.y],angle:this.Transform.angle,velocity:[0,0],angularVelocity:0,sleepTimeLimit:.6,sleepSpeedLimit:.3,damping:this.drag,angularDamping:this.rotationalDrag>.98?1:this.rotationalDrag,fixedRotation:1===this.rotationalDrag}),this.updateShape(),this.body.entity=this.entity,I(this.scene,this.body)},updateShape:function(){var e=this;if(this.body.shapes.length>0){t(!b(this.scene).stepping);for(var n=this.body.shapes,r=0;r<n.length;++r)n[r].body=null;n.length=0}var o=this.entity.getComponents("Shape"),i=this.Transform.scale;o.forEach(function(t){var n;if("rectangle"===t.type)n=new gt.Box({width:.02*t.size.x*i.x,height:.02*t.size.y*i.y});else if("circle"===t.type){var r=(i.x+i.y)/2;n=new gt.Circle({radius:.02*t.radius*r})}else"convex"===t.type&&(n=new gt.Convex({vertices:t.getConvexPoints().map(function(t){return[.02*t.x,.02*t.y]})}));n&&e.body.addShape(n)}),this.updateMass(),this.updateMaterial()},updateMaterial:function(){var t=E(this.scene,{friction:this.friction,restitution:this.bounciness});this.body.shapes.forEach(function(e){return e.material=t})},updateMass:function(){"dynamic"===this.type&&this.body.setDensity(.1*this.density)},setRootType:function(t){return t&&this.inited&&this.createBody(),kt.prototype.setRootType.call(this,t)},onUpdate:function(){var t=this.body;if(t&&t.sleepState!==Wt&&t.type!==Bt){this.updatingOthers=!0;var e=new rt(50*t.position[0],50*t.position[1]);this.Transform.position.isEqualTo(e)||(this.Transform.position=e),this.Transform.angle!==t.angle&&(this.Transform.angle=t.angle),this.updatingOthers=!1}},sleep:function(){this.body&&(P(this.scene,this.body),this.body=null),this.inited=!1},getMass:function(){return this.body.mass},applyForce:function(t){this.body.applyForce(t.toArray()),this.body.wakeUp()},setAngularForce:function(t){this.body.angularForce=t,this.body.wakeUp()}}}),kt.register({name:"CharacterController",category:"Core",properties:[u("type","player",u.enum,u.enum.values("player","AI")),u("keyboardControls","arrows or WASD",u.enum,u.enum.values("arrows","WASD","arrows or WASD")),u("controlType","jumper",u.enum,u.enum.values("jumper","top down")),u("jumpSpeed",30,u.float,u.float.range(0,1e3),u.visibleIf("controlType","jumper")),u("speed",500,u.float,u.float.range(0,1e3)),u("acceleration",500,u.float,u.float.range(0,1e3)),u("breaking",500,u.float,u.float.range(0,1e3))],prototype:{init:function(){var e=this;this.Physics=this.entity.getComponent("Physics"),this.keyListener=x(function(n){"jumper"===e.controlType&&e.scene.playing&&("arrows"===e.keyboardControls?n===Ct.up&&e.jump():"WASD"===e.keyboardControls?n===Ct.w&&e.jump():"arrows or WASD"===e.keyboardControls?n!==Ct.up&&n!==Ct.w||e.jump():t(!1,"Invalid CharacterController.keyboardControls"))})},sleep:function(){this.keyListener&&(this.keyListener(),this.keyListener=null)},getInput:function(){return"arrows"===this.keyboardControls?{up:N(Ct.up),down:N(Ct.down),left:N(Ct.left),right:N(Ct.right)}:"WASD"===this.keyboardControls?{up:N(Ct.w),down:N(Ct.s),left:N(Ct.a),right:N(Ct.d)}:"arrows or WASD"===this.keyboardControls?{up:N(Ct.up)||N(Ct.w),down:N(Ct.down)||N(Ct.s),left:N(Ct.left)||N(Ct.a),right:N(Ct.right)||N(Ct.d)}:void t(!1,"Invalid CharacterController.keyboardControls")},onUpdate:function(t,e){var n=this.getInput(),r=n.up,o=n.down,i=n.left,a=n.right,s=0,p=0;a&&s++,i&&s--,r&&p--,o&&p++,"top down"===this.controlType?this.moveTopDown(s,p,t):"jumper"===this.controlType&&this.moveJumper(s,p,t)},moveTopDown:function(t,e,n){if(this.Physics){if(this.Physics.body){var r=this.Physics.body.velocity;r[0]=L(this.calculateNewVelocity(r[0],t,n),this.speed),r[1]=L(this.calculateNewVelocity(r[1],e,n),this.speed)}}else if(0!==t||0!==e){var o=this.Transform,i=o.position,a=this.speed*n;o.position=new rt(i.x+t*a,i.y+e*a)}},moveJumper:function(t,e,n){if(!this.Physics||!this.Physics.body)return!1;var r=this.Physics.body.velocity;r[0]=this.calculateNewVelocity(r[0],t,n)},jump:function(){if(this.checkIfCanJump()){var t=this.Physics.body.velocity;t[1]>0?t[1]=-this.jumpSpeed:t[1]=t[1]-this.jumpSpeed}},checkIfCanJump:function(){if(!this.Physics||"jumper"!==this.controlType)return!1;var t=b(this.scene).narrowphase.contactEquations,e=this.Physics.body;if(e.sleepState===gt.Body.SLEEPING)return!0;for(var n=t.length-1;n>=0;--n){var r=t[n];if(r.bodyA===e||r.bodyB===e){var o=r.normalA[1];if(r.bodyB===e&&(o*=-1),o>.5)return!0}}return!1},calculateNewVelocity:function(t,e,n){if(0!==e)t>=this.speed&&e>0||t<=-this.speed&&e<0||(t+=e*this.acceleration*n,e<0&&t<-this.speed&&(t=-this.speed),e>0&&t>this.speed&&(t=this.speed));else if(0!==t&&(this.checkIfCanJump()||"jumper"!==this.controlType)){var r=Math.abs(t);r-=this.breaking*n,r<0&&(r=0),t=t>0?r:-r}return t}}});var Vt,qt=!1,Ht=!1;G&&R(),function(){Ht=!0}(),function(t){void 0===t&&(t=!0),qt=t}(!0),window.addEventListener("resize",z),function(t){Mt.push(t),Ot&&t()}(z),x(function(t){t===Ct.space&&Ot&&Ot.win()})});
//# sourceMappingURL=openeditplay.min.js.map
